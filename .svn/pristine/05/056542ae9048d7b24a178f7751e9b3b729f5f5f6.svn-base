<?xml version="1.0" encoding="UTF-8"?>
<hqml xmlns="http://hone.hanwha.co.kr/schema/hqml" name="ls.lsm.yealyPlanMgmtDAO">
    <desc>년간계획 관리</desc>

    <!-- 년간계획 수립 조회 DATA를 조회한다. -->
    <statement name="selectList" type="select">
        /*+ com.hwfs.ls.lsm.dao.YealyPlanMgmtDAO.selectList */
        <![CDATA[
/* 년간계획 수립 조회 조회 */
SELECT A.YEAR
     , A.PLAN_CLSFI
     , A.PLANCLASS
     , A.MM
     , A.MCALSS_CD
     , (SELECT SPECM_TYPE FROM LCM_SPECM_TYPE_MCALSS WHERE MCALSS_CD = A.MCALSS_CD) AS SPECM_TYPE
     , (SELECT MCALSS_NM FROM LCM_SPECM_TYPE_MCALSS WHERE MCALSS_CD = A.MCALSS_CD) AS MCALSS_NM
     , ROW_NUMBER() OVER(PARTITION BY A.YEAR, A.PLANCLASS, A.MM ORDER BY A.YEAR, A.PLANCLASS, A.MM, A.MCALSS_CD) AS RN
  FROM LSM_ANNUPLAN_MST A
 WHERE A.YEAR = :planYear
   AND A.PLAN_CLSFI = :planClsfi
   AND A.PLANCLASS = :planclass
 ORDER BY TO_NUMBER(A.MM)
        ]]>
    </statement>

    <!-- 검체유형항목 DATA를 조회한다. -->
    <statement name="selectClassList" type="select">
        /*+ com.hwfs.ls.lsm.dao.YealyPlanMgmtDAO.selectClassList */
        <![CDATA[
/* 검체유형항목 조회 */
SELECT A.SPECM_TYPE
     , A.MGRP_CD
     , A.MGRP_NM
     , B.MCALSS_CD
     , B.MCALSS_NM
  FROM LCM_SPECM_TYPE_MGRP A
     , LCM_SPECM_TYPE_MCALSS B
 WHERE A.SPECM_TYPE = :specmType
<#if mcalssCd?has_content> AND B.MCALSS_CD = :mcalssCd </#if>
<#if edtSearch?has_content> AND B.MCALSS_NM LIKE '%' || :edtSearch || '%' </#if>
   AND A.SPECM_TYPE = B.SPECM_TYPE
   AND A.MGRP_CD = B.MGRP_CD
   AND A.USE_YN = 'Y'
   AND B.USE_YN = 'Y'
 ORDER BY A.SPECM_TYPE
        , A.MGRP_CD
        , B.MCALSS_CD
        ]]>
    </statement>

    <!-- 년간계획 조회 - 년간시료수 DATA를 조회한다. -->
    <statement name="selectTestCnt" type="select">
        /*+ com.hwfs.ls.lsm.dao.YealyPlanMgmtDAO.selectTestCnt */
        <![CDATA[
/* 년간계획 조회 - 년간시료수 조회 */
SELECT A.MM
     , (
        SELECT COUNT(1)
          FROM LSM_ANNUPLAN_DTL Z
         WHERE 1 = 1
           AND Z.YEAR = A.YEAR
           AND Z.PLAN_CLSFI = A.PLAN_CLSFI
           AND Z.PLANCLASS = A.PLANCLASS
           AND Z.MM = A.MM
           AND Z.INSPT_YN = 'Y'
       ) || '(' ||
       (
        (SELECT COUNT(1)    /* 자재에 등록된 품목 */
           FROM HLDC_PO_ITEM_MST Y
          WHERE Y.USE_YN = 'Y'
            AND EXISTS (
                        SELECT 1
                          FROM LSM_ANNUPLAN_DTL X
                         WHERE X.YEAR = A.YEAR
                           AND X.PLAN_CLSFI = A.PLAN_CLSFI
                           AND X.PLANCLASS =  A.PLANCLASS
                           AND X.MM = A.MM
                           AND X.MCALSS_CD = Y.FOODCD
                       )) +
        (SELECT COUNT(1)    /* 기타검체유형에 등록된 품목 */
           FROM LCM_ETC_SPECM_TYPE Y
          WHERE 1 = 1
            AND Y.SPECM_CLASS IN ('102')
            AND Y.SPECM_TYPE = '101'
            AND EXISTS (
                        SELECT 1
                          FROM LSM_ANNUPLAN_DTL X
                         WHERE X.YEAR = A.YEAR
                           AND X.PLAN_CLSFI = A.PLAN_CLSFI
                           AND X.PLANCLASS =  A.PLANCLASS
                           AND X.MM = A.MM
                           AND X.MCALSS_CD = Y.MCALSS_CD
                       ))
       )
       || ')'
       AS TOT_CNT
  FROM LSM_ANNUPLAN_DTL A
 WHERE 1 = 1
   AND A.YEAR = :planYear
   AND A.PLAN_CLSFI = :planClsfi
   AND A.PLANCLASS = :planclass
 GROUP BY A.YEAR, A.PLAN_CLSFI, A.PLANCLASS, A.MM
        ]]>
    </statement>

    <!-- 년간계획 조회 - 화학 검사 수 DATA를 조회한다. -->
    <statement name="selectMicbioCnt" type="select">
        /*+ com.hwfs.ls.lsm.dao.YealyPlanMgmtDAO.selectMicbioCnt */
        <![CDATA[
/* 년간계획 조회 - 화학 검사 수 조회 */
SELECT A.MM
     , COUNT(1)
       || '(' ||
           (
            SELECT NVL(SUM(COUNT(1)), 0)
              FROM LSM_ANNUPLAN_DTL Z
                 , LCM_SPECM_TEST_MAPPING X
                 , LCM_TEST_ARTICLE Y
             WHERE Z.YEAR = :planYear
               AND Z.PLAN_CLSFI = :planClsfi
               AND Z.PLANCLASS = :planclass
               AND Z.INSPT_YN = 'Y'
               AND Z.MICBIO_INSPT_YN = 'Y'
               AND Z.MM = A.MM
               AND Z.INSPT_MTOD = X.INSPT_PURP
               AND Z.MCALSS_CD = X.MCALSS_CD
               AND X.ARTICLE_CD = Y.ARTICLE_CD
               AND Y.INSPT_FLD = '101'
             GROUP BY X.MCALSS_CD, X.ARTICLE_CD
           )
       || ')'
       AS TOT_CNT
  FROM LSM_ANNUPLAN_DTL A
 WHERE 1 = 1
   AND A.YEAR = :planYear
   AND A.PLAN_CLSFI = :planClsfi
   AND A.PLANCLASS = :planclass
   AND A.INSPT_YN = 'Y'
   AND A.MICBIO_INSPT_YN = 'Y'
 GROUP BY A.YEAR, A.PLAN_CLSFI, A.PLANCLASS, A.MM
        ]]>
    </statement>

    <!-- 년간계획 조회 - 생물 검사 수 DATA를 조회한다. -->
    <statement name="selectPhyChemCnt" type="select">
        /*+ com.hwfs.ls.lsm.dao.YealyPlanMgmtDAO.selectPhyChemCnt */
        <![CDATA[
/* 년간계획 조회 - 생물 검사 수 조회 */
SELECT A.MM
     , COUNT(1)
       || '(' ||
           (
            SELECT NVL(SUM(COUNT(1)), 0)
              FROM LSM_ANNUPLAN_DTL Z
                 , LCM_SPECM_TEST_MAPPING X
                 , LCM_TEST_ARTICLE Y
             WHERE Z.YEAR = :planYear
               AND Z.PLAN_CLSFI = :planClsfi
               AND Z.PLANCLASS = :planclass
               AND Z.INSPT_YN = 'Y'
               AND Z.PHYCHEM_INSPT_YN = 'Y'
               AND Z.MM = A.MM
               AND Z.INSPT_MTOD = X.INSPT_PURP
               AND Z.MCALSS_CD = X.MCALSS_CD
               AND X.ARTICLE_CD = Y.ARTICLE_CD
               AND Y.INSPT_FLD = '102'
             GROUP BY X.MCALSS_CD, X.ARTICLE_CD
           )
       || ')'
       AS TOT_CNT
  FROM LSM_ANNUPLAN_DTL A
 WHERE 1 = 1
   AND A.YEAR = :planYear
   AND A.PLAN_CLSFI = :planClsfi
   AND A.PLANCLASS = :planclass
   AND A.INSPT_YN = 'Y'
   AND A.PHYCHEM_INSPT_YN = 'Y'
 GROUP BY A.YEAR, A.PLAN_CLSFI, A.PLANCLASS, A.MM
        ]]>
    </statement>

    <!-- 자재 목록 DATA를 조회한다. -->
    <statement name="selectItemList" type="select">
        /*+ com.hwfs.ls.lsm.dao.YealyPlanMgmtDAO.selectItemList */
        <![CDATA[
/* 자재 목록 조회 */
SELECT A.ITEM_CODE AS MATERIAL_CD				/* 자재코드 */
     , A.ITEM_NAME AS MATERIAL_NM			/* 자재명 */
     , A.FOODCD
     , A.MAKER AS CUSTNM   /* 매입처 */
     , ROUND(NVL((SELECT SUM(C.TRANS_QTY)
              FROM HLDC_PO_TRANSACTION C
             WHERE A.ITEM_CODE = C.ITEM_CODE
               AND C.TRANS_TYPE IN ( 'I001', 'I002' )
               --AND C.MVT = '101'
               AND C.TRANS_DATE BETWEEN :searchTransDateFrom || '01' AND :searchTransDateTo || '31'
            ), 0), 2) AS TRANS_QTY   /* 수량 */
     , ROUND(NVL((SELECT SUM(C.UNIT_PRICE)
              FROM HLDC_PO_TRANSACTION C
             WHERE A.ITEM_CODE = C.ITEM_CODE
               AND C.TRANS_TYPE IN ( 'I001', 'I002' )
               --AND C.MVT = '101'
               AND C.TRANS_DATE BETWEEN :searchTransDateFrom || '01' AND :searchTransDateTo || '31'
            ), 0), 2) AS UNIT_PRICE   /* 매입단가 */
     , ROUND(NVL((SELECT SUM(C.UNIT_AMOUNT)
              FROM HLDC_PO_TRANSACTION C
             WHERE A.ITEM_CODE = C.ITEM_CODE
               AND C.TRANS_TYPE IN ( 'I001', 'I002' )
               --AND C.MVT = '101'
               AND C.TRANS_DATE BETWEEN :searchTransDateFrom || '01' AND :searchTransDateTo || '31'
            ), 0), 2) AS UNIT_AMOUNT   /* 총매입금액(매입단가*수량) */
     , (
        SELECT COUNT(1)
          FROM LRM_SPECM_INFO SI
         WHERE SI.SPECM_CD = A.ITEM_CODE
           AND EXISTS (
                        SELECT 1
                          FROM LRM_TEST_INFO TI
                             , LTM_TEST_DIARY TD
                         WHERE SI.REQ_NUM = TI.REQ_NUM
                           AND SI.ACCEPT_NUM = TI.ACCEPT_NUM
                           AND SI.REQ_NUM = TD.REQ_NUM
                           AND SI.ACCEPT_NUM = TD.ACCEPT_NUM
                           AND TI.ARTICLE_CD = TD.ARTICLE_CD
                           AND TI.INSPT_FLD = '101'
                           AND TD.LAST_DECISION NOT IN ('101')
                      )
       ) AS MICBIO_NOT_FIT_QTY                /* 미생물 부적합건수 */
     , (
        SELECT COUNT(1)
          FROM LRM_SPECM_INFO SI
         WHERE SI.SPECM_CD = A.ITEM_CODE
           AND EXISTS (
                        SELECT 1
                          FROM LRM_TEST_INFO TI
                             , LTM_TEST_DIARY TD
                         WHERE SI.REQ_NUM = TI.REQ_NUM
                           AND SI.ACCEPT_NUM = TI.ACCEPT_NUM
                           AND SI.REQ_NUM = TD.REQ_NUM
                           AND SI.ACCEPT_NUM = TD.ACCEPT_NUM
                           AND TI.ARTICLE_CD = TD.ARTICLE_CD
                           AND TI.INSPT_FLD = '102'
                           AND TD.LAST_DECISION NOT IN ('101')
                      )
       ) AS PHYCHEM_NOT_FIT_QTY                /* 이화학 부적합건수 */
     , (
        SELECT CASE WHEN MAX(X.MICBIO_1_GRADE) = 'Y' THEN '1'
                    WHEN MAX(X.MICBIO_2_GRADE) = 'Y' THEN '2'
                    WHEN MAX(X.MICBIO_3_GRADE) = 'Y' THEN '3'
                    WHEN MAX(X.MICBIO_4_GRADE) = 'Y' THEN '4'
                    WHEN MAX(X.MICBIO_5_GRADE) = 'Y' THEN '5'
               END
          FROM LCM_SPECM_DANGER_MAPPING X
             , LCM_SPECM_TYPE_MCALSS Y
         WHERE X.MCALSS_CD = A.FOODCD
           AND X.SPECM_TYPE = Y.SPECM_TYPE
           AND X.MGRP_CD = Y.MGRP_CD
           AND X.MCALSS_CD = Y.MCALSS_CD
           AND Y.USE_YN = 'Y'
       )
       AS MICBIO_DANGER_GRADE                /* 미생물 위험도 등급 */
     , (
        SELECT CASE WHEN MAX(X.PHYCHEM_1_GRADE) = 'Y' THEN '1'
                    WHEN MAX(X.PHYCHEM_2_GRADE) = 'Y' THEN '2'
                    WHEN MAX(X.PHYCHEM_3_GRADE) = 'Y' THEN '3'
                    WHEN MAX(X.PHYCHEM_4_GRADE) = 'Y' THEN '4'
                    WHEN MAX(X.PHYCHEM_5_GRADE) = 'Y' THEN '5'
               END
          FROM LCM_SPECM_DANGER_MAPPING X
             , LCM_SPECM_TYPE_MCALSS Y
         WHERE X.MCALSS_CD = A.FOODCD
           AND X.SPECM_TYPE = Y.SPECM_TYPE
           AND X.MGRP_CD = Y.MGRP_CD
           AND X.MCALSS_CD = Y.MCALSS_CD
           AND Y.USE_YN = 'Y'
       )
       AS PHYCHEM_DANGER_GRADE              /* 이화학 위험도 등급 */
     , B.INSPT_YN							/* 검사 여부 */
     , B.MICBIO_INSPT_YN					/* 미생물 검사 여부 */
     , B.PHYCHEM_INSPT_YN					/* 이화학 검사 여부 */
     , B.INSPT_MTOD							/* 검사 방법 */
     , (SELECT LISTAGG(T.NOT_FIT_CLSFI_NM||' '||T.NOT_FIT_CNT||'('||X.INSPT_CNT||')건', ',') WITHIN GROUP(ORDER BY T.NOT_FIT_CLSFI_NM)
          FROM (
                SELECT LI.SPECM_CD
                     , COUNT(SPECM_CD) AS INSPT_CNT
                  FROM LRM_SPECM_INFO LI
                 WHERE LI.ACCEPTDD BETWEEN :searchTransDateFromNotFit || '01' AND :searchTransDateToNotFit || '31'
                 GROUP BY LI.SPECM_CD
               ) X
             , (
                SELECT LI.SPECM_CD
                     , H.NOT_FIT_CLSFI_NM
                     , COUNT(SPECM_CD) AS NOT_FIT_CNT
                  FROM LRM_SPECM_INFO LI
                     , (
                         SELECT NF.REQ_NUM
                              , NF.ACCEPT_NUM
                              , NF.NOT_FIT_CLSFI_NM
                           FROM (
                                  SELECT /*+ INDEX_FFS(Y) */
                                         Y.REQ_NUM
                                       , Y.ACCEPT_NUM
                                       , SCC_CODE_NM('NOT_FIT_CLSFI', P.NOT_FIT_CLSFI) AS NOT_FIT_CLSFI_NM
                                       , ROW_NUMBER() OVER(PARTITION BY Y.REQ_NUM, Y.ACCEPT_NUM ORDER BY Y.REQ_NUM, Y.ACCEPT_NUM, P.NOT_FIT_CLSFI DESC) AS RN
                                    FROM LTM_TEST_DIARY Y
                                       , LCM_TEST_ARTICLE P
                                   WHERE 1 = 1
                                     AND Y.ARTICLE_CD = P.ARTICLE_CD
                                     AND Y.LAST_DECISION <> '101'
                                ) NF
                          WHERE NF.RN = 1
                       ) H
                 WHERE LI.ACCEPTDD BETWEEN :searchTransDateFromNotFit || '01' AND :searchTransDateToNotFit || '31'
                   AND LI.REQ_NUM = H.REQ_NUM
                   AND LI.ACCEPT_NUM = H.ACCEPT_NUM
                   AND LTM_TEST_LAST_DECISION_FUN(LI.REQ_NUM, LI.ACCEPT_NUM) <> '101'
                 GROUP BY LI.SPECM_CD, H.NOT_FIT_CLSFI_NM
               ) T
         WHERE X.SPECM_CD = T.SPECM_CD
           AND X.SPECM_CD = A.ITEM_CODE
       ) AS ITEM_NOT_FIT_HISTORY                 /* 자재 부적합 이력 */
     , EPROCUSR.FN_ITEM_PROCURE_MTG_UNS('100', A.ITEM_CODE) AS ITEM_UNS  /* 불용자재 여부 */
     , CASE WHEN (
                   SELECT COUNT(1)
                     FROM LSM_ANNUPLAN_DTL
                    WHERE YEAR = :planYear
                      AND PLAN_CLSFI = :planClsfi
                      AND PLANCLASS = :planclass
                      AND TO_NUMBER(MM) < TO_NUMBER(:planMonth)
                      AND MCALSS_CD = :mcalssCd
                      AND MATERIAL_CD = A.ITEM_CODE
                      AND INSPT_YN = 'Y'
                 ) > 0 THEN '1'
       ELSE
           '0'
       END PRE_USE_YN   /* 검사예정 자재 */
  FROM HLDC_PO_ITEM_MST A
     , (
         SELECT MATERIAL_CD
              , INSPT_YN							/* 검사 여부 */
              , MICBIO_INSPT_YN					/* 미생물 검사 여부 */
              , PHYCHEM_INSPT_YN					/* 이화학 검사 여부 */
              , INSPT_MTOD
            FROM LSM_ANNUPLAN_DTL
           WHERE YEAR = :planYear
             AND PLAN_CLSFI = :planClsfi
             AND PLANCLASS = :planclass
             AND MM = :planMonth
             AND MCALSS_CD = :mcalssCd
       ) B
 WHERE A.ITEM_CLASS1 = 'F'
   --AND A.FOOD_CLS = :specmType
   AND A.FOODCD = :mcalssCd
   AND A.ITEM_CODE = B.MATERIAL_CD(+)
   AND A.USE_YN = 'Y'
UNION ALL
SELECT A.SPECM_CD AS MATERIAL_CD               /* 자재코드 */
     , A.SPECM_NM AS MATERIAL_NM           /* 자재명 */
     , A.MCALSS_CD
     , A.MFGWON AS CUSTNM   /* 매입처 */
     , 0 AS TRANS_QTY   /* 수량 */
     , 0 AS UNIT_PRICE   /* 매입단가 */
     , 0 AS UNIT_AMOUNT   /* 총매입금액(매입단가*수량) */
     , (
        SELECT COUNT(1)
          FROM LRM_SPECM_INFO SI
         WHERE SI.SPECM_CD = A.SPECM_CD
           AND EXISTS (
                        SELECT 1
                          FROM LRM_TEST_INFO TI
                             , LTM_TEST_DIARY TD
                         WHERE SI.REQ_NUM = TI.REQ_NUM
                           AND SI.ACCEPT_NUM = TI.ACCEPT_NUM
                           AND SI.REQ_NUM = TD.REQ_NUM
                           AND SI.ACCEPT_NUM = TD.ACCEPT_NUM
                           AND TI.ARTICLE_CD = TD.ARTICLE_CD
                           AND TI.INSPT_FLD = '101'
                           AND TD.LAST_DECISION NOT IN ('101')
                      )
       ) AS MICBIO_NOT_FIT_QTY                /* 미생물 부적합건수 */
     , (
        SELECT COUNT(1)
          FROM LRM_SPECM_INFO SI
         WHERE SI.SPECM_CD = A.SPECM_CD
           AND EXISTS (
                        SELECT 1
                          FROM LRM_TEST_INFO TI
                             , LTM_TEST_DIARY TD
                         WHERE SI.REQ_NUM = TI.REQ_NUM
                           AND SI.ACCEPT_NUM = TI.ACCEPT_NUM
                           AND SI.REQ_NUM = TD.REQ_NUM
                           AND SI.ACCEPT_NUM = TD.ACCEPT_NUM
                           AND TI.ARTICLE_CD = TD.ARTICLE_CD
                           AND TI.INSPT_FLD = '102'
                           AND TD.LAST_DECISION NOT IN ('101')
                      )
       ) AS PHYCHEM_NOT_FIT_QTY                /* 이화학 부적합건수 */
     , (
        SELECT CASE WHEN MAX(X.MICBIO_1_GRADE) = 'Y' THEN '1'
                    WHEN MAX(X.MICBIO_2_GRADE) = 'Y' THEN '2'
                    WHEN MAX(X.MICBIO_3_GRADE) = 'Y' THEN '3'
                    WHEN MAX(X.MICBIO_4_GRADE) = 'Y' THEN '4'
                    WHEN MAX(X.MICBIO_5_GRADE) = 'Y' THEN '5'
               END
          FROM LCM_SPECM_DANGER_MAPPING X
             , LCM_SPECM_TYPE_MCALSS Y
         WHERE X.MCALSS_CD = A.MCALSS_CD
           AND X.SPECM_TYPE = Y.SPECM_TYPE
           AND X.MGRP_CD = Y.MGRP_CD
           AND X.MCALSS_CD = Y.MCALSS_CD
           AND Y.USE_YN = 'Y'
       )
       AS MICBIO_DANGER_GRADE                /* 미생물 위험도 등급 */
     , (
        SELECT CASE WHEN MAX(X.PHYCHEM_1_GRADE) = 'Y' THEN '1'
                    WHEN MAX(X.PHYCHEM_2_GRADE) = 'Y' THEN '2'
                    WHEN MAX(X.PHYCHEM_3_GRADE) = 'Y' THEN '3'
                    WHEN MAX(X.PHYCHEM_4_GRADE) = 'Y' THEN '4'
                    WHEN MAX(X.PHYCHEM_5_GRADE) = 'Y' THEN '5'
               END
          FROM LCM_SPECM_DANGER_MAPPING X
             , LCM_SPECM_TYPE_MCALSS Y
         WHERE X.MCALSS_CD = A.MCALSS_CD
           AND X.SPECM_TYPE = Y.SPECM_TYPE
           AND X.MGRP_CD = Y.MGRP_CD
           AND X.MCALSS_CD = Y.MCALSS_CD
           AND Y.USE_YN = 'Y'
       )
       AS PHYCHEM_DANGER_GRADE              /* 이화학 위험도 등급 */
     , B.INSPT_YN                           /* 검사 여부 */
     , B.MICBIO_INSPT_YN                    /* 미생물 검사 여부 */
     , B.PHYCHEM_INSPT_YN                   /* 이화학 검사 여부 */
     , SCC_CODE_NM('INSPT_MTOD', B.INSPT_MTOD) AS INSPT_MTOD                         /* 검사 방법 */
     , (SELECT LISTAGG(T.NOT_FIT_CLSFI_NM||' '||T.NOT_FIT_CNT||'('||X.INSPT_CNT||')건', ',') WITHIN GROUP(ORDER BY T.NOT_FIT_CLSFI_NM)
          FROM (
                SELECT LI.SPECM_CD
                     , COUNT(SPECM_CD) AS INSPT_CNT
                  FROM LRM_SPECM_INFO LI
                 WHERE LI.ACCEPTDD BETWEEN :searchTransDateFromNotFit || '01' AND :searchTransDateToNotFit || '31'
                 GROUP BY LI.SPECM_CD
               ) X
             , (
                SELECT LI.SPECM_CD
                     , H.NOT_FIT_CLSFI_NM
                     , COUNT(SPECM_CD) AS NOT_FIT_CNT
                  FROM LRM_SPECM_INFO LI
                     , (
                         SELECT NF.REQ_NUM
                              , NF.ACCEPT_NUM
                              , NF.NOT_FIT_CLSFI_NM
                           FROM (
                                  SELECT /*+ INDEX_FFS(Y) */
                                         Y.REQ_NUM
                                       , Y.ACCEPT_NUM
                                       , SCC_CODE_NM('NOT_FIT_CLSFI', P.NOT_FIT_CLSFI) AS NOT_FIT_CLSFI_NM
                                       , ROW_NUMBER() OVER(PARTITION BY Y.REQ_NUM, Y.ACCEPT_NUM ORDER BY Y.REQ_NUM, Y.ACCEPT_NUM, P.NOT_FIT_CLSFI DESC) AS RN
                                    FROM LTM_TEST_DIARY Y
                                       , LCM_TEST_ARTICLE P
                                   WHERE 1 = 1
                                     AND Y.ARTICLE_CD = P.ARTICLE_CD
                                     AND Y.LAST_DECISION <> '101'
                                ) NF
                          WHERE NF.RN = 1
                       ) H
                 WHERE LI.ACCEPTDD BETWEEN :searchTransDateFromNotFit || '01' AND :searchTransDateToNotFit || '31'
                   AND LI.REQ_NUM = H.REQ_NUM
                   AND LI.ACCEPT_NUM = H.ACCEPT_NUM
                   AND LTM_TEST_LAST_DECISION_FUN(LI.REQ_NUM, LI.ACCEPT_NUM) <> '101'
                 GROUP BY LI.SPECM_CD, H.NOT_FIT_CLSFI_NM
               ) T
         WHERE X.SPECM_CD = T.SPECM_CD
           AND X.SPECM_CD = A.SPECM_CD
       ) AS ITEM_NOT_FIT_HISTORY                 /* 자재 부적합 이력 */
     , <#if specmType=='101'>EPROCUSR.FN_ITEM_PROCURE_MTG_UNS('100', A.SPECM_CD)<#else>'UP'</#if> AS ITEM_UNS /* 불용자재 여부 */
     , CASE WHEN (
                   SELECT COUNT(1)
                     FROM LSM_ANNUPLAN_DTL
                    WHERE YEAR = :planYear
                      AND PLAN_CLSFI = :planClsfi
                      AND PLANCLASS = :planclass
                      AND TO_NUMBER(MM) < TO_NUMBER(:planMonth)
                      AND MCALSS_CD = :mcalssCd
                      AND MATERIAL_CD = A.SPECM_CD
                      AND INSPT_YN = 'Y'
                 ) > 0 THEN '1'
       ELSE
           '0'
       END PRE_USE_YN   /* 검사예정 자재 */
  FROM LCM_ETC_SPECM_TYPE A
     , (
         SELECT MCALSS_CD
              , MATERIAL_CD
              , INSPT_YN                            /* 검사 여부 */
              , MICBIO_INSPT_YN                 /* 미생물 검사 여부 */
              , PHYCHEM_INSPT_YN                    /* 이화학 검사 여부 */
              , INSPT_MTOD
           FROM LSM_ANNUPLAN_DTL
          WHERE YEAR = :planYear
            AND PLAN_CLSFI = :planClsfi
            AND PLANCLASS = :planclass
            AND MM = :planMonth
            AND MCALSS_CD = :mcalssCd
       ) B
 WHERE 1 = 1
   AND A.SPECM_CD = B.MATERIAL_CD(+)
   AND A.MCALSS_CD = :mcalssCd
   AND A.SPECM_CLASS IN ('102')
   AND A.SPECM_TYPE = :specmType
 ORDER BY 5 DESC, 1
        ]]>
    </statement>

    <!-- 자재 목록 위생_기타 DATA를 조회한다. -->
    <statement name="selectEtcItemList" type="select">
        /*+ com.hwfs.ls.lsm.dao.YealyPlanMgmtDAO.selectEtcItemList */
        <![CDATA[
/* 자재 목록(위생_기타) 조회 */
SELECT A.SPECM_CD AS MATERIAL_CD           /* 자재코드 */
     , A.SPECM_NM AS MATERIAL_NM       /* 자재명 */
     , A.SPECM_TYPE
     , A.MCALSS_CD
     , A.MFGWON AS CUSTNM   /* 매입처 */
     , 0 AS TRANS_QTY   /* 수량 */
     , 0 AS UNIT_PRICE   /* 매입단가 */
     , 0 AS UNIT_AMOUNT   /* 총매입금액(매입단가*수량) */
     , (
        SELECT COUNT(1)
          FROM LRM_SPECM_INFO SI
         WHERE SI.SPECM_CD = A.SPECM_CD
           AND EXISTS (
                        SELECT 1
                          FROM LRM_TEST_INFO TI
                             , LTM_TEST_DIARY TD
                         WHERE SI.REQ_NUM = TI.REQ_NUM
                           AND SI.ACCEPT_NUM = TI.ACCEPT_NUM
                           AND SI.REQ_NUM = TD.REQ_NUM
                           AND SI.ACCEPT_NUM = TD.ACCEPT_NUM
                           AND TI.ARTICLE_CD = TD.ARTICLE_CD
                           AND TI.INSPT_FLD = '101'
                           AND TD.LAST_DECISION NOT IN ('101')
                      )
       ) AS MICBIO_NOT_FIT_QTY                /* 미생물 부적합건수 */
     , (
        SELECT COUNT(1)
          FROM LRM_SPECM_INFO SI
         WHERE SI.SPECM_CD = A.SPECM_CD
           AND EXISTS (
                        SELECT 1
                          FROM LRM_TEST_INFO TI
                             , LTM_TEST_DIARY TD
                         WHERE SI.REQ_NUM = TI.REQ_NUM
                           AND SI.ACCEPT_NUM = TI.ACCEPT_NUM
                           AND SI.REQ_NUM = TD.REQ_NUM
                           AND SI.ACCEPT_NUM = TD.ACCEPT_NUM
                           AND TI.ARTICLE_CD = TD.ARTICLE_CD
                           AND TI.INSPT_FLD = '102'
                           AND TD.LAST_DECISION NOT IN ('101')
                      )
       ) AS PHYCHEM_NOT_FIT_QTY                /* 이화학 부적합건수 */
     , (
        SELECT CASE WHEN MAX(X.MICBIO_1_GRADE) = 'Y' THEN '1'
                    WHEN MAX(X.MICBIO_2_GRADE) = 'Y' THEN '2'
                    WHEN MAX(X.MICBIO_3_GRADE) = 'Y' THEN '3'
                    WHEN MAX(X.MICBIO_4_GRADE) = 'Y' THEN '4'
                    WHEN MAX(X.MICBIO_5_GRADE) = 'Y' THEN '5'
               END
          FROM LCM_SPECM_DANGER_MAPPING X
             , LCM_SPECM_TYPE_MCALSS Y
         WHERE X.MCALSS_CD = A.MCALSS_CD
           AND X.SPECM_TYPE = Y.SPECM_TYPE
           AND X.MGRP_CD = Y.MGRP_CD
           AND X.MCALSS_CD = Y.MCALSS_CD
           AND Y.USE_YN = 'Y'
       )
       AS MICBIO_DANGER_GRADE                /* 미생물 위험도 등급 */
     , (
        SELECT CASE WHEN MAX(X.PHYCHEM_1_GRADE) = 'Y' THEN '1'
                    WHEN MAX(X.PHYCHEM_2_GRADE) = 'Y' THEN '2'
                    WHEN MAX(X.PHYCHEM_3_GRADE) = 'Y' THEN '3'
                    WHEN MAX(X.PHYCHEM_4_GRADE) = 'Y' THEN '4'
                    WHEN MAX(X.PHYCHEM_5_GRADE) = 'Y' THEN '5'
               END
          FROM LCM_SPECM_DANGER_MAPPING X
             , LCM_SPECM_TYPE_MCALSS Y
         WHERE X.MCALSS_CD = A.MCALSS_CD
           AND X.SPECM_TYPE = Y.SPECM_TYPE
           AND X.MGRP_CD = Y.MGRP_CD
           AND X.MCALSS_CD = Y.MCALSS_CD
           AND Y.USE_YN = 'Y'
       )
       AS PHYCHEM_DANGER_GRADE              /* 이화학 위험도 등급 */
     , B.INSPT_YN                           /* 검사 여부 */
     , B.MICBIO_INSPT_YN                    /* 미생물 검사 여부 */
     , B.PHYCHEM_INSPT_YN                   /* 이화학 검사 여부 */
     , B.INSPT_MTOD                         /* 검사 방법 */
     , (SELECT LISTAGG(T.NOT_FIT_CLSFI_NM||' '||T.NOT_FIT_CNT||'('||X.INSPT_CNT||')건', ',') WITHIN GROUP(ORDER BY T.NOT_FIT_CLSFI_NM)
          FROM (
                SELECT LI.SPECM_CD
                     , COUNT(SPECM_CD) AS INSPT_CNT
                  FROM LRM_SPECM_INFO LI
                 WHERE LI.ACCEPTDD BETWEEN :searchTransDateFromNotFit || '01' AND :searchTransDateToNotFit || '31'
                 GROUP BY LI.SPECM_CD
               ) X
             , (
                SELECT LI.SPECM_CD
                     , H.NOT_FIT_CLSFI_NM
                     , COUNT(SPECM_CD) AS NOT_FIT_CNT
                  FROM LRM_SPECM_INFO LI
                     , (
                         SELECT NF.REQ_NUM
                              , NF.ACCEPT_NUM
                              , NF.NOT_FIT_CLSFI_NM
                           FROM (
                                  SELECT /*+ INDEX_FFS(Y) */
                                         Y.REQ_NUM
                                       , Y.ACCEPT_NUM
                                       , SCC_CODE_NM('NOT_FIT_CLSFI', P.NOT_FIT_CLSFI) AS NOT_FIT_CLSFI_NM
                                       , ROW_NUMBER() OVER(PARTITION BY Y.REQ_NUM, Y.ACCEPT_NUM ORDER BY Y.REQ_NUM, Y.ACCEPT_NUM, P.NOT_FIT_CLSFI DESC) AS RN
                                    FROM LTM_TEST_DIARY Y
                                       , LCM_TEST_ARTICLE P
                                   WHERE 1 = 1
                                     AND Y.ARTICLE_CD = P.ARTICLE_CD
                                     AND Y.LAST_DECISION <> '101'
                                ) NF
                          WHERE NF.RN = 1
                       ) H
                 WHERE LI.ACCEPTDD BETWEEN :searchTransDateFromNotFit || '01' AND :searchTransDateToNotFit || '31'
                   AND LI.REQ_NUM = H.REQ_NUM
                   AND LI.ACCEPT_NUM = H.ACCEPT_NUM
                   AND LTM_TEST_LAST_DECISION_FUN(LI.REQ_NUM, LI.ACCEPT_NUM) <> '101'
                 GROUP BY LI.SPECM_CD, H.NOT_FIT_CLSFI_NM
               ) T
         WHERE X.SPECM_CD = T.SPECM_CD
           AND X.SPECM_CD = A.SPECM_CD
       ) AS ITEM_NOT_FIT_HISTORY                 /* 자재 부적합 이력 */
     , 'UP' AS ITEM_UNS /* 불용자재여부 */
     , CASE WHEN (
                   SELECT COUNT(1)
                     FROM LSM_ANNUPLAN_DTL
                    WHERE YEAR = :planYear
                      AND PLAN_CLSFI = :planClsfi
                      AND PLANCLASS = :planclass
                      AND TO_NUMBER(MM) < TO_NUMBER(:planMonth)
                      AND MCALSS_CD = :mcalssCd
                      AND MATERIAL_CD = A.SPECM_CD
                      AND INSPT_YN = 'Y'
                 ) > 0 THEN '1'
       ELSE
           '0'
       END PRE_USE_YN   /* 검사예정 자재 */
  FROM LCM_ETC_SPECM_TYPE A
     , (
         SELECT MATERIAL_CD
              , INSPT_YN                            /* 검사 여부 */
              , MICBIO_INSPT_YN                 /* 미생물 검사 여부 */
              , PHYCHEM_INSPT_YN                    /* 이화학 검사 여부 */
              , INSPT_MTOD
            FROM LSM_ANNUPLAN_DTL
           WHERE YEAR = :planYear
             AND PLAN_CLSFI = :planClsfi
             AND PLANCLASS = :planclass
             AND MM = :planMonth
             AND MCALSS_CD = :mcalssCd
       ) B
 WHERE 1 = 1
   AND A.MCALSS_CD = :mcalssCd
   AND A.SPECM_CLASS = '103'
   AND A.SPECM_CD = B.MATERIAL_CD(+)

 ORDER BY 5 DESC, 1
        ]]>
    </statement>

    <!-- 년간계획 Master 생성한다. -->
    <statement name="insertMstList" type="insert">
        /*+ com.hwfs.ls.lsm.dao.YealyPlanMgmtDAO.insertMstList */
        <![CDATA[
/* 년간계획 Master 생성 */
MERGE INTO LSM_ANNUPLAN_MST
USING DUAL
ON (
    YEAR = :planYear
    AND PLAN_CLSFI = :planClsfi
    AND PLANCLASS = :planclass
    AND MM = :planMonth
    AND MCALSS_CD = :mcalssCd
)
WHEN NOT MATCHED THEN
    INSERT
    (
     YEAR,
     PLAN_CLSFI,
     PLANCLASS,
     MM,
     SPECM_TYPE,
     MGRP_CD,
     MCALSS_CD,
     CUSER,
     CDATE,
     UUSER,
     UDATE
    ) VALUES (
     :planYear,
     :planClsfi,
     :planclass,
     :planMonth,
    <#if specmType?exists> :specmType, <#else> null, </#if>
    <#if mgrpCd?exists> :mgrpCd, <#else> null, </#if>
    <#if mcalssCd?exists> :mcalssCd, <#else> null, </#if>
     :loginSabun,
     SYSDATE,
     :loginSabun,
     SYSDATE
    )
        ]]>
    </statement>

    <!-- 년간계획 Master 삭제한다. -->
    <statement name="deleteMstList" type="delete">
        /*+ com.hwfs.ls.lsm.dao.YealyPlanMgmtDAO.deleteMstList */
        <![CDATA[
/* 년간계획 Master 삭제 */
DELETE
FROM   LSM_ANNUPLAN_MST
WHERE  YEAR = :planYear
AND    PLAN_CLSFI = :planClsfi
AND    PLANCLASS = :planclass
AND    MM = :planMonth
AND    MCALSS_CD = :mcalssCd
        ]]>
    </statement>

    <!-- 년간계획 Detail 생성/수정 한다. -->
    <statement name="updateDtlList" type="update">
        /*+ com.hwfs.ls.lsm.dao.YealyPlanMgmtDAO.deleteMstList */
        <![CDATA[
/* 년간계획 Detail 생성/수정 */
MERGE INTO LSM_ANNUPLAN_DTL
USING DUAL
ON (
    YEAR = :planYear
    AND PLAN_CLSFI = :planClsfi
    AND PLANCLASS = :planclass
    AND MM = :planMonth
    AND MCALSS_CD = :mcalssCd
    AND MATERIAL_CD = :materialCd
)
WHEN MATCHED THEN
  UPDATE SET
    <#if materialNm?exists> MATERIAL_NM = :materialNm, </#if>
    <#if micbioNotFitQty?exists> MICBIO_NOT_FIT_QTY = :micbioNotFitQty, </#if>
    <#if phychemNotFitQty?exists> PHYCHEM_NOT_FIT_QTY = :phychemNotFitQty, </#if>
    <#if micbioDangerGrade?exists> MICBIO_DANGER_GRADE = :micbioDangerGrade, </#if>
    <#if phychemDangerGrade?exists> PHYCHEM_DANGER_GRADE = :phychemDangerGrade, </#if>
    <#if insptYn?exists> INSPT_YN = :insptYn, </#if>
    <#if micbioInsptYn?exists> MICBIO_INSPT_YN = :micbioInsptYn, </#if>
    <#if phychemInsptYn?exists> PHYCHEM_INSPT_YN = :phychemInsptYn, </#if>
    <#if insptMtod?exists> INSPT_MTOD = :insptMtod, </#if>
       UUSER = :loginSabun,
       UDATE = SYSDATE
WHEN NOT MATCHED THEN
    INSERT (
         YEAR,
         PLAN_CLSFI,
         PLANCLASS,
         MM,
         MCALSS_CD,
         MATERIAL_CD,
         MATERIAL_NM,
         MICBIO_NOT_FIT_QTY,
         PHYCHEM_NOT_FIT_QTY,
         MICBIO_DANGER_GRADE,
         PHYCHEM_DANGER_GRADE,
         INSPT_YN,
         MICBIO_INSPT_YN,
         PHYCHEM_INSPT_YN,
         INSPT_MTOD,
         CUSER,
         CDATE,
         UUSER,
         UDATE
    ) VALUES (
         :planYear,
         :planClsfi,
         :planclass,
         :planMonth,
         :mcalssCd,
         :materialCd,
        <#if materialNm?exists> :materialNm, <#else> null, </#if>
        <#if micbioNotFitQty?exists> :micbioNotFitQty, <#else> null, </#if>
        <#if phychemNotFitQty?exists> :phychemNotFitQty, <#else> null, </#if>
        <#if micbioDangerGrade?exists> :micbioDangerGrade, <#else> null, </#if>
        <#if phychemDangerGrade?exists> :phychemDangerGrade, <#else> null, </#if>
        <#if insptYn?exists> :insptYn, <#else> null, </#if>
        <#if micbioInsptYn?exists> :micbioInsptYn, <#else> null, </#if>
        <#if phychemInsptYn?exists> :phychemInsptYn, <#else> null, </#if>
        <#if insptMtod?exists> :insptMtod, <#else> null, </#if>
         :loginSabun,
         SYSDATE,
         :loginSabun,
         SYSDATE
    )
        ]]>
    </statement>

    <!-- 년간계획 Detail 삭제한다. -->
    <statement name="deleteDtlList" type="delete">
        /*+ com.hwfs.ls.lsm.dao.YealyPlanMgmtDAO.deleteDtlList */
        <![CDATA[
/* 년간계획 Detail 삭제 */
DELETE
FROM   LSM_ANNUPLAN_DTL
WHERE  YEAR = :planYear
AND    PLAN_CLSFI = :planClsfi
AND    PLANCLASS = :planclass
AND    MM = :planMonth
AND    MCALSS_CD = :mcalssCd
        ]]>
    </statement>

    <!-- 년간계획 세부 내역를 조회한다. -->
    <statement name="selectItemDtlList" type="select">
        /*+ com.hwfs.ls.lsm.dao.YealyPlanMgmtDAO.selectItemDtlList */
        <![CDATA[
/* 년간계획 세부 내역 조회 */
SELECT SCC_CODE_NM('SPECM_TYPE', (
                                  SELECT U.SPECM_TYPE
                                    FROM LCM_SPECM_TYPE_MCALSS U
                                   WHERE U.MCALSS_CD = B.MCALSS_CD
                                 )
       ) AS SPECM_TYPE_NM
     , (SELECT P.MGRP_NM
          FROM LCM_SPECM_TYPE_MGRP P
         WHERE P.MGRP_CD = (
                            SELECT U.MGRP_CD
                              FROM LCM_SPECM_TYPE_MCALSS U
                             WHERE U.MCALSS_CD = B.MCALSS_CD
                           )
       ) AS MGRP_NM
     , (SELECT U.MCALSS_NM
          FROM LCM_SPECM_TYPE_MCALSS U
         WHERE U.MCALSS_CD = B.MCALSS_CD
       ) AS MCALSS_NM
     , A.ITEM_CODE AS MATERIAL_CD               /* 자재코드 */
     , A.ITEM_NAME AS MATERIAL_NM           /* 자재명 */
     , A.FOODCD
     , A.MAKER AS CUSTNM   /* 매입처 */
     , ROUND(NVL((SELECT SUM(C.TRANS_QTY)
              FROM HLDC_PO_TRANSACTION C
             WHERE A.ITEM_CODE = C.ITEM_CODE
               AND C.TRANS_TYPE IN ( 'I001', 'I002' )
               --AND C.MVT = '101'
               AND C.TRANS_DATE BETWEEN :searchTransDateFrom || '01' AND :searchTransDateTo || '31'
            ), 0), 2) AS TRANS_QTY   /* 수량 */
     , ROUND(NVL((SELECT SUM(C.UNIT_PRICE)
              FROM HLDC_PO_TRANSACTION C
             WHERE A.ITEM_CODE = C.ITEM_CODE
               AND C.TRANS_TYPE IN ( 'I001', 'I002' )
               --AND C.MVT = '101'
               AND C.TRANS_DATE BETWEEN :searchTransDateFrom || '01' AND :searchTransDateTo || '31'
            ), 0), 2) AS UNIT_PRICE   /* 매입단가 */
     , ROUND(NVL((SELECT SUM(C.UNIT_AMOUNT)
              FROM HLDC_PO_TRANSACTION C
             WHERE A.ITEM_CODE = C.ITEM_CODE
               AND C.TRANS_TYPE IN ( 'I001', 'I002' )
               --AND C.MVT = '101'
               AND C.TRANS_DATE BETWEEN :searchTransDateFrom || '01' AND :searchTransDateTo || '31'
            ), 0), 2) AS UNIT_AMOUNT   /* 총매입금액(매입단가*수량) */
     , (
        SELECT COUNT(1)
          FROM LRM_SPECM_INFO SI
         WHERE SI.SPECM_CD = A.ITEM_CODE
           AND EXISTS (
                        SELECT 1
                          FROM LRM_TEST_INFO TI
                             , LTM_TEST_DIARY TD
                         WHERE SI.REQ_NUM = TI.REQ_NUM
                           AND SI.ACCEPT_NUM = TI.ACCEPT_NUM
                           AND SI.REQ_NUM = TD.REQ_NUM
                           AND SI.ACCEPT_NUM = TD.ACCEPT_NUM
                           AND TI.ARTICLE_CD = TD.ARTICLE_CD
                           AND TI.INSPT_FLD = '101'
                           AND TD.LAST_DECISION NOT IN ('101')
                      )
       ) AS MICBIO_NOT_FIT_QTY                /* 미생물 부적합건수 */
     , (
        SELECT COUNT(1)
          FROM LRM_SPECM_INFO SI
         WHERE SI.SPECM_CD = A.ITEM_CODE
           AND EXISTS (
                        SELECT 1
                          FROM LRM_TEST_INFO TI
                             , LTM_TEST_DIARY TD
                         WHERE SI.REQ_NUM = TI.REQ_NUM
                           AND SI.ACCEPT_NUM = TI.ACCEPT_NUM
                           AND SI.REQ_NUM = TD.REQ_NUM
                           AND SI.ACCEPT_NUM = TD.ACCEPT_NUM
                           AND TI.ARTICLE_CD = TD.ARTICLE_CD
                           AND TI.INSPT_FLD = '102'
                           AND TD.LAST_DECISION NOT IN ('101')
                      )
       ) AS PHYCHEM_NOT_FIT_QTY                /* 이화학 부적합건수 */
     , (
        SELECT CASE WHEN MAX(X.MICBIO_1_GRADE) = 'Y' THEN '1'
                    WHEN MAX(X.MICBIO_2_GRADE) = 'Y' THEN '2'
                    WHEN MAX(X.MICBIO_3_GRADE) = 'Y' THEN '3'
                    WHEN MAX(X.MICBIO_4_GRADE) = 'Y' THEN '4'
                    WHEN MAX(X.MICBIO_5_GRADE) = 'Y' THEN '5'
               END
          FROM LCM_SPECM_DANGER_MAPPING X
             , LCM_SPECM_TYPE_MCALSS Y
         WHERE X.MCALSS_CD = A.FOODCD
           AND X.SPECM_TYPE = Y.SPECM_TYPE
           AND X.MGRP_CD = Y.MGRP_CD
           AND X.MCALSS_CD = Y.MCALSS_CD
           AND Y.USE_YN = 'Y'
       )
       AS MICBIO_DANGER_GRADE                /* 미생물 위험도 등급 */
     , (
        SELECT CASE WHEN MAX(X.PHYCHEM_1_GRADE) = 'Y' THEN '1'
                    WHEN MAX(X.PHYCHEM_2_GRADE) = 'Y' THEN '2'
                    WHEN MAX(X.PHYCHEM_3_GRADE) = 'Y' THEN '3'
                    WHEN MAX(X.PHYCHEM_4_GRADE) = 'Y' THEN '4'
                    WHEN MAX(X.PHYCHEM_5_GRADE) = 'Y' THEN '5'
               END
          FROM LCM_SPECM_DANGER_MAPPING X
             , LCM_SPECM_TYPE_MCALSS Y
         WHERE X.MCALSS_CD = A.FOODCD
           AND X.SPECM_TYPE = Y.SPECM_TYPE
           AND X.MGRP_CD = Y.MGRP_CD
           AND X.MCALSS_CD = Y.MCALSS_CD
           AND Y.USE_YN = 'Y'
       )
       AS PHYCHEM_DANGER_GRADE              /* 이화학 위험도 등급 */
     , B.INSPT_YN                           /* 검사 여부 */
     , B.MICBIO_INSPT_YN                    /* 미생물 검사 여부 */
     , B.PHYCHEM_INSPT_YN                   /* 이화학 검사 여부 */
     , SCC_CODE_NM('INSPT_MTOD', B.INSPT_MTOD) AS INSPT_MTOD                         /* 검사 방법 */
     , (SELECT LISTAGG(T.NOT_FIT_CLSFI_NM||' '||T.NOT_FIT_CNT||'('||X.INSPT_CNT||')건', ',') WITHIN GROUP(ORDER BY T.NOT_FIT_CLSFI_NM)
          FROM (
                SELECT LI.SPECM_CD
                     , COUNT(SPECM_CD) AS INSPT_CNT
                  FROM LRM_SPECM_INFO LI
                 WHERE LI.ACCEPTDD BETWEEN :searchTransDateFromNotFit || '01' AND :searchTransDateToNotFit || '31'
                 GROUP BY LI.SPECM_CD
               ) X
             , (
                SELECT LI.SPECM_CD
                     , H.NOT_FIT_CLSFI_NM
                     , COUNT(SPECM_CD) AS NOT_FIT_CNT
                  FROM LRM_SPECM_INFO LI
                     , (
                         SELECT NF.REQ_NUM
                              , NF.ACCEPT_NUM
                              , NF.NOT_FIT_CLSFI_NM
                           FROM (
                                  SELECT /*+ INDEX_FFS(Y) */
                                         Y.REQ_NUM
                                       , Y.ACCEPT_NUM
                                       , SCC_CODE_NM('NOT_FIT_CLSFI', P.NOT_FIT_CLSFI) AS NOT_FIT_CLSFI_NM
                                       , ROW_NUMBER() OVER(PARTITION BY Y.REQ_NUM, Y.ACCEPT_NUM ORDER BY Y.REQ_NUM, Y.ACCEPT_NUM, P.NOT_FIT_CLSFI DESC) AS RN
                                    FROM LTM_TEST_DIARY Y
                                       , LCM_TEST_ARTICLE P
                                   WHERE 1 = 1
                                     AND Y.ARTICLE_CD = P.ARTICLE_CD
                                     AND Y.LAST_DECISION <> '101'
                                ) NF
                          WHERE NF.RN = 1
                       ) H
                 WHERE LI.ACCEPTDD BETWEEN :searchTransDateFromNotFit || '01' AND :searchTransDateToNotFit || '31'
                   AND LI.REQ_NUM = H.REQ_NUM
                   AND LI.ACCEPT_NUM = H.ACCEPT_NUM
                   AND LTM_TEST_LAST_DECISION_FUN(LI.REQ_NUM, LI.ACCEPT_NUM) <> '101'
                 GROUP BY LI.SPECM_CD, H.NOT_FIT_CLSFI_NM
               ) T
         WHERE X.SPECM_CD = T.SPECM_CD
           AND X.SPECM_CD = A.ITEM_CODE
       ) AS ITEM_NOT_FIT_HISTORY                 /* 자재 부적합 이력 */
     , EPROCUSR.FN_ITEM_PROCURE_MTG_UNS('100', A.ITEM_CODE) AS ITEM_UNS  /* 불용자재 여부 */
     , CASE WHEN (
                   SELECT COUNT(1)
                     FROM LSM_ANNUPLAN_DTL
                    WHERE YEAR = SUBSTR(:yymm, 1, 4)
                      AND PLAN_CLSFI = :planClsfi
                      AND PLANCLASS = :planclass
                      AND TO_NUMBER(MM) < TO_NUMBER(SUBSTR(:yymm, 5, 2))
                      AND MATERIAL_CD = A.ITEM_CODE
                      AND INSPT_YN = 'Y'
                 ) > 0 THEN '1'
       ELSE
           '0'
       END PRE_USE_YN   /* 검사예정 자재 */
  FROM HLDC_PO_ITEM_MST A
     , (
         SELECT MCALSS_CD
              , MATERIAL_CD
              , INSPT_YN                            /* 검사 여부 */
              , MICBIO_INSPT_YN                 /* 미생물 검사 여부 */
              , PHYCHEM_INSPT_YN                    /* 이화학 검사 여부 */
              , INSPT_MTOD
            FROM LSM_ANNUPLAN_DTL
           WHERE YEAR = SUBSTR(:yymm, 1, 4)
             AND PLAN_CLSFI = :planClsfi
             AND PLANCLASS = :planclass
             AND MM = TO_NUMBER(SUBSTR(:yymm, 5, 2))
       ) B
 WHERE A.ITEM_CLASS1 = 'F'
   AND A.ITEM_CODE = B.MATERIAL_CD
   AND A.USE_YN = 'Y'
UNION ALL
SELECT SCC_CODE_NM('SPECM_TYPE', (
                                  SELECT U.SPECM_TYPE
                                    FROM LCM_SPECM_TYPE_MCALSS U
                                   WHERE U.MCALSS_CD = B.MCALSS_CD
                                 )
       ) AS SPECM_TYPE_NM
     , (SELECT P.MGRP_NM
          FROM LCM_SPECM_TYPE_MGRP P
         WHERE P.MGRP_CD = (
                            SELECT U.MGRP_CD
                              FROM LCM_SPECM_TYPE_MCALSS U
                             WHERE U.MCALSS_CD = B.MCALSS_CD
                           )
       ) AS MGRP_NM
     , (SELECT U.MCALSS_NM
          FROM LCM_SPECM_TYPE_MCALSS U
         WHERE U.MCALSS_CD = B.MCALSS_CD
       ) AS MCALSS_NM
     , A.SPECM_CD AS MATERIAL_CD               /* 자재코드 */
     , A.SPECM_NM AS MATERIAL_NM           /* 자재명 */
     , A.MCALSS_CD
     , A.MFGWON AS CUSTNM   /* 매입처 */
     , 0 AS TRANS_QTY   /* 수량 */
     , 0 AS UNIT_PRICE   /* 매입단가 */
     , 0 AS UNIT_AMOUNT   /* 총매입금액(매입단가*수량) */
     , (
        SELECT COUNT(1)
          FROM LRM_SPECM_INFO SI
         WHERE SI.SPECM_CD = A.SPECM_CD
           AND EXISTS (
                        SELECT 1
                          FROM LRM_TEST_INFO TI
                             , LTM_TEST_DIARY TD
                         WHERE SI.REQ_NUM = TI.REQ_NUM
                           AND SI.ACCEPT_NUM = TI.ACCEPT_NUM
                           AND SI.REQ_NUM = TD.REQ_NUM
                           AND SI.ACCEPT_NUM = TD.ACCEPT_NUM
                           AND TI.ARTICLE_CD = TD.ARTICLE_CD
                           AND TI.INSPT_FLD = '101'
                           AND TD.LAST_DECISION NOT IN ('101')
                      )
       ) AS MICBIO_NOT_FIT_QTY                /* 미생물 부적합건수 */
     , (
        SELECT COUNT(1)
          FROM LRM_SPECM_INFO SI
         WHERE SI.SPECM_CD = A.SPECM_CD
           AND EXISTS (
                        SELECT 1
                          FROM LRM_TEST_INFO TI
                             , LTM_TEST_DIARY TD
                         WHERE SI.REQ_NUM = TI.REQ_NUM
                           AND SI.ACCEPT_NUM = TI.ACCEPT_NUM
                           AND SI.REQ_NUM = TD.REQ_NUM
                           AND SI.ACCEPT_NUM = TD.ACCEPT_NUM
                           AND TI.ARTICLE_CD = TD.ARTICLE_CD
                           AND TI.INSPT_FLD = '102'
                           AND TD.LAST_DECISION NOT IN ('101')
                      )
       ) AS PHYCHEM_NOT_FIT_QTY                /* 이화학 부적합건수 */
     , (
        SELECT CASE WHEN MAX(X.MICBIO_1_GRADE) = 'Y' THEN '1'
                    WHEN MAX(X.MICBIO_2_GRADE) = 'Y' THEN '2'
                    WHEN MAX(X.MICBIO_3_GRADE) = 'Y' THEN '3'
                    WHEN MAX(X.MICBIO_4_GRADE) = 'Y' THEN '4'
                    WHEN MAX(X.MICBIO_5_GRADE) = 'Y' THEN '5'
               END
          FROM LCM_SPECM_DANGER_MAPPING X
             , LCM_SPECM_TYPE_MCALSS Y
         WHERE X.MCALSS_CD = A.MCALSS_CD
           AND X.SPECM_TYPE = Y.SPECM_TYPE
           AND X.MGRP_CD = Y.MGRP_CD
           AND X.MCALSS_CD = Y.MCALSS_CD
           AND Y.USE_YN = 'Y'
       )
       AS MICBIO_DANGER_GRADE                /* 미생물 위험도 등급 */
     , (
        SELECT CASE WHEN MAX(X.PHYCHEM_1_GRADE) = 'Y' THEN '1'
                    WHEN MAX(X.PHYCHEM_2_GRADE) = 'Y' THEN '2'
                    WHEN MAX(X.PHYCHEM_3_GRADE) = 'Y' THEN '3'
                    WHEN MAX(X.PHYCHEM_4_GRADE) = 'Y' THEN '4'
                    WHEN MAX(X.PHYCHEM_5_GRADE) = 'Y' THEN '5'
               END
          FROM LCM_SPECM_DANGER_MAPPING X
             , LCM_SPECM_TYPE_MCALSS Y
         WHERE X.MCALSS_CD = A.MCALSS_CD
           AND X.SPECM_TYPE = Y.SPECM_TYPE
           AND X.MGRP_CD = Y.MGRP_CD
           AND X.MCALSS_CD = Y.MCALSS_CD
           AND Y.USE_YN = 'Y'
       )
       AS PHYCHEM_DANGER_GRADE              /* 이화학 위험도 등급 */
     , B.INSPT_YN                           /* 검사 여부 */
     , B.MICBIO_INSPT_YN                    /* 미생물 검사 여부 */
     , B.PHYCHEM_INSPT_YN                   /* 이화학 검사 여부 */
     , SCC_CODE_NM('INSPT_MTOD', B.INSPT_MTOD) AS INSPT_MTOD                         /* 검사 방법 */
     , (SELECT LISTAGG(T.NOT_FIT_CLSFI_NM||' '||T.NOT_FIT_CNT||'('||X.INSPT_CNT||')건', ',') WITHIN GROUP(ORDER BY T.NOT_FIT_CLSFI_NM)
          FROM (
                SELECT LI.SPECM_CD
                     , COUNT(SPECM_CD) AS INSPT_CNT
                  FROM LRM_SPECM_INFO LI
                 WHERE LI.ACCEPTDD BETWEEN :searchTransDateFromNotFit || '01' AND :searchTransDateToNotFit || '31'
                 GROUP BY LI.SPECM_CD
               ) X
             , (
                SELECT LI.SPECM_CD
                     , H.NOT_FIT_CLSFI_NM
                     , COUNT(SPECM_CD) AS NOT_FIT_CNT
                  FROM LRM_SPECM_INFO LI
                     , (
                         SELECT NF.REQ_NUM
                              , NF.ACCEPT_NUM
                              , NF.NOT_FIT_CLSFI_NM
                           FROM (
                                  SELECT /*+ INDEX_FFS(Y) */
                                         Y.REQ_NUM
                                       , Y.ACCEPT_NUM
                                       , SCC_CODE_NM('NOT_FIT_CLSFI', P.NOT_FIT_CLSFI) AS NOT_FIT_CLSFI_NM
                                       , ROW_NUMBER() OVER(PARTITION BY Y.REQ_NUM, Y.ACCEPT_NUM ORDER BY Y.REQ_NUM, Y.ACCEPT_NUM, P.NOT_FIT_CLSFI DESC) AS RN
                                    FROM LTM_TEST_DIARY Y
                                       , LCM_TEST_ARTICLE P
                                   WHERE 1 = 1
                                     AND Y.ARTICLE_CD = P.ARTICLE_CD
                                     AND Y.LAST_DECISION <> '101'
                                ) NF
                          WHERE NF.RN = 1
                       ) H
                 WHERE LI.ACCEPTDD BETWEEN :searchTransDateFromNotFit || '01' AND :searchTransDateToNotFit || '31'
                   AND LI.REQ_NUM = H.REQ_NUM
                   AND LI.ACCEPT_NUM = H.ACCEPT_NUM
                   AND LTM_TEST_LAST_DECISION_FUN(LI.REQ_NUM, LI.ACCEPT_NUM) <> '101'
                 GROUP BY LI.SPECM_CD, H.NOT_FIT_CLSFI_NM
               ) T
         WHERE X.SPECM_CD = T.SPECM_CD
           AND X.SPECM_CD = A.SPECM_CD
       ) AS ITEM_NOT_FIT_HISTORY                 /* 자재 부적합 이력 */
     , 'UP' AS ITEM_UNS  /* 불용자재 여부 */
     , CASE WHEN (
                   SELECT COUNT(1)
                     FROM LSM_ANNUPLAN_DTL
                    WHERE YEAR = SUBSTR(:yymm, 1, 4)
                      AND PLAN_CLSFI = :planClsfi
                      AND PLANCLASS = :planclass
                      AND TO_NUMBER(MM) < TO_NUMBER(SUBSTR(:yymm, 5, 2))
                      AND MATERIAL_CD = A.SPECM_CD
                      AND INSPT_YN = 'Y'
                 ) > 0 THEN '1'
       ELSE
           '0'
       END PRE_USE_YN   /* 검사예정 자재 */
  FROM LCM_ETC_SPECM_TYPE A
     , (
         SELECT MCALSS_CD
              , MATERIAL_CD
              , INSPT_YN                            /* 검사 여부 */
              , MICBIO_INSPT_YN                 /* 미생물 검사 여부 */
              , PHYCHEM_INSPT_YN                    /* 이화학 검사 여부 */
              , INSPT_MTOD
            FROM LSM_ANNUPLAN_DTL
           WHERE YEAR = SUBSTR(:yymm, 1, 4)
             AND PLAN_CLSFI = :planClsfi
             AND PLANCLASS = :planclass
             AND MM = TO_NUMBER(SUBSTR(:yymm, 5, 2))
       ) B
 WHERE 1 = 1
   AND A.SPECM_CD = B.MATERIAL_CD
   AND A.SPECM_CLASS IN ('102', '103')
 ORDER BY 1, 2, 3, 4
        ]]>
    </statement>

</hqml>
