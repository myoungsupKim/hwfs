<?xml version="1.0" encoding="utf-8"?>
<FDL version="1.4">
  <TypeDefinition url="..\..\..\default_typedef.xml"/>
  <Form id="CnslMgmt" classname="COMP_GUIDE_13" inheritanceid="" position="absolute 0 0 1252 725" titletext="상담관리(메인)" scrollbars="autoboth" onload="form_onload" ontimer="CnslMgmt_ontimer" onkeydown="CnslMgmt_onkeydown" onbeforeclose="CnslMgmt_onbeforeclose" onclose="CnslMgmt_onclose">
    <Layouts>
      <Layout>
        <Static id="Static15" text="h13" class="Guide01_AreaRed" visible="false" position="absolute 0 29 1237 34" anchor="left top"/>
        <Static id="Static00" position="absolute 0 0 907 29" class="sta_WF_SoftPInfoBg" anchor="left top right"/>
        <Static id="Static06" text="w15" class="Guide01_AreaRed" visible="false" position="absolute 1237 0 1252 710" anchor="top right"/>
        <Static id="Static71" text="h15" class="Guide01_AreaRed" visible="false" position="absolute 0 710 1252 725" anchor="left bottom"/>
        <Static id="Static01" class="sta_WF_SoftPIcon" position="absolute 0 0 37 29" anchor="left top" onclick="Static01_onclick"/>
        <Static id="sta_Status" class="sta_WF_SoftPInfoTxt" position="absolute 37 0 167 29" anchor="left top" usedecorate="true"/>
        <Static id="Static03" text="전화번호" class="sta_WF_SoftPInfoTxt" position="absolute 175 0 238 29" anchor="top right"/>
        <Static id="Static04" text="상담" class="sta_WF_SoftPInfoTxt" position="absolute 412 0 449 29" anchor="top right"/>
        <Static id="Static05" text="건" class="sta_WF_SoftPInfoTxt" position="absolute 503 0 564 29" anchor="top right"/>
        <Static id="Static07" text="미처리" class="sta_WF_SoftPInfoTxt" position="absolute 563 0 613 29" anchor="top right"/>
        <Static id="Static08" text="건" class="sta_WF_SoftPInfoTxt" position="absolute 667 0 728 29" anchor="top right"/>
        <Static id="Static09" text="내선/직통" class="sta_WF_SoftPInfoTxt" position="absolute 727 0 797 29" anchor="top right" onclick="Static09_onclick"/>
        <Button id="btn_Login" taborder="1" position="absolute 1102 0 1237 29" class="btn_WF_SoftPLogin" text="CTI 로그인" anchor="top right" onclick="btn_Login_onclick"/>
        <Button id="btn_Logout" taborder="2" text="CTI 로그아웃" class="btn_WF_SoftPLogout" position="absolute 1102 0 1237 29" enable="true" visible="false" anchor="top right" onclick="btn_Logout_onclick"/>
        <Button id="btn_Inbd" taborder="3" class="btn_WF_SoftPCallIn" position="absolute 910 0 1005 29" enable="true" anchor="top right" onclick="btn_Inbd_onclick"/>
        <Button id="btn_Outbd" taborder="4" position="absolute 1004 0 1099 29" enable="true" anchor="top right" onclick="btn_Outbd_onclick" class="btn_WF_SoftPCallOut"/>
        <Button id="btn_Dial" taborder="5" text="전화걸기" position="absolute 607 34 697 63" class="btn_WF_SoftPCall1" enable="false" anchor="top right" onclick="btn_Dial_onclick"/>
        <Button id="btn_Hangup" taborder="6" text="전화끊기" class="btn_WF_SoftPCall2" position="absolute 700 34 790 63" enable="false" anchor="top right" onclick="btn_Hangup_onclick"/>
        <Button id="btn_HoldCan" taborder="8" text="보류해제" class="btn_WF_SoftPCall4" position="absolute 793 34 883 63" enable="false" anchor="top right" onclick="btn_HoldCan_onclick"/>
        <Button id="btn_ConsCan" taborder="9" text="전환취소" position="absolute 886 34 976 63" enable="false" anchor="top right" onclick="btn_ConsCan_onclick" style=":disabled {background:#c2c2c2ff URL('theme://images/new/btn_WF_SoftPCall8.png') 12px 50px;border:1 solid #b3b3b3ff ;padding:1 0 0 29;align:left middle;}" class="btn_WF_SoftPCall6"/>
        <Button id="btn_TransConsReq" taborder="10" text="전환요청" class="btn_WF_SoftPCall5" position="absolute 886 34 976 63" enable="false" anchor="top right" onclick="btn_TransConsReq_onclick" style=":disabled {padding:1 0 0 30;}"/>
        <Button id="btn_Etc" taborder="11" text="기타" class="btn_WF_SoftPCti5" position="absolute 210 34 277 63" enable="false" anchor="default" onclick="btn_Etc_onclick"/>
        <Button id="btn_Edu" taborder="12" text="교육" class="btn_WF_SoftPCti4" position="absolute 140 34 207 63" enable="false" anchor="default" onclick="btn_Edu_onclick"/>
        <Button id="btn_Meet" taborder="13" text="회의" class="btn_WF_SoftPCti3" position="absolute 373 34 440 63" enable="false" anchor="default" onclick="btn_Meet_onclick" visible="false"/>
        <Button id="btn_Meal" taborder="14" text="식사" class="btn_WF_SoftPCti2" position="absolute 70 34 137 63" enable="false" anchor="default" onclick="btn_Meal_onclick"/>
        <Button id="btn_Rest" taborder="15" text="휴식" class="btn_WF_SoftPCti1" position="absolute 0 34 67 63" enable="false" anchor="default" onclick="btn_Rest_onclick"/>
        <Static id="Static10" text="w03" class="Guide01_AreaRed" visible="false" position="absolute 697 40 700 55" anchor="top right" enable="false"/>
        <Static id="Static12" text="w03" class="Guide01_AreaRed" visible="false" position="absolute 790 40 793 55" anchor="top right" enable="false"/>
        <Static id="Static14" text="w03" class="Guide01_AreaRed" visible="false" position="absolute 883 40 886 55" anchor="top right" enable="false"/>
        <Static id="Static16" text="w03" class="Guide01_AreaRed" visible="false" position="absolute 67 40 70 55" anchor="default" enable="false"/>
        <Static id="Static17" text="w03" class="Guide01_AreaRed" visible="false" position="absolute 137 40 140 55" anchor="default" enable="false"/>
        <Static id="Static18" text="w03" class="Guide01_AreaRed" visible="false" position="absolute 207 40 210 55" anchor="default" enable="false"/>
        <Static id="Static20" text="w03" class="Guide01_AreaRed" visible="false" position="absolute 907 7 910 22" anchor="left top"/>
        <Static id="Static21" text="w03" class="Guide01_AreaRed" visible="false" position="absolute 1099 7 1102 22" anchor="left top"/>
        <Static id="Static22" text="w50" class="Guide01_AreaRed" visible="false" position="absolute 362 6 412 21" anchor="left top"/>
        <Static id="Static23" text="w04" class="Guide01_AreaRed" visible="false" position="absolute 903 7 907 22" anchor="left top"/>
        <Static id="Static24" text="h04" class="Guide01_AreaRed" visible="false" position="absolute 318 0 341 4" anchor="left top"/>
        <Static id="Static25" text="h04" class="Guide01_AreaRed" visible="false" position="absolute 318 25 341 29" anchor="left top"/>
        <Static id="sta_telno" position="absolute 241 4 362 25" class="sta_WF_SoftPData" anchor="top right" style="align:center middle;"/>
        <Static id="sta_cnslCnt" class="sta_WF_SoftPData" position="absolute 449 4 499 25" anchor="top right"/>
        <Static id="sta_cBak" class="sta_WF_SoftPData" position="absolute 613 4 663 25" anchor="top right"/>
        <Static id="Static29" text="w03" class="Guide01_AreaRed" visible="false" position="absolute 515 7 519 22" anchor="left top"/>
        <Static id="Static30" text="w03" class="Guide01_AreaRed" visible="false" position="absolute 679 7 683 22" anchor="left top"/>
        <Static id="sta_telGubun" class="sta_WF_SoftPData" position="absolute 797 4 903 25" anchor="top right" style="align:center middle;"/>
        <Div id="div_CnslInQuery" taborder="18" style="border:0 none #808080ff ;" position="absolute 0 561 1237 710" anchor="all" url="X_CCS::CnslMgmtTabCnslInQuery.xfdl"/>
        <Div id="div_CnslSave" taborder="19" style="border:0 none #808080ff ;" anchor="default" position="fixed 0 227 446 559" positiontype="position" url="X_CCS::CnslMgmtDivCnslSave.xfdl"/>
        <Div id="div_Unattend" taborder="20" style="border:0 none #808080ff ;" position="fixed 446 228 1237 561" positiontype="position" url="X_CCS::CnslMgmtTabUnattend.xfdl" anchor="left top right"/>
        <Static id="Static02" text="w03" class="Guide01_AreaRed" enable="false" visible="false" position="absolute 976 40 979 55" anchor="top right"/>
        <Button id="btn_ConsComplete" taborder="21" text="전환완료" class="btn_WF_SoftPCall6" enable="false" position="absolute 979 34 1069 63" anchor="top right" style=":disabled {background:#c2c2c2ff URL('theme://images/new/btn_WF_SoftPCall7.png') 12px 50px;border:1 solid #b3b3b3ff ;padding:1 0 0 29;align:left middle;}" onclick="btn_ConsComplete_onclick"/>
        <Static id="Static13" text="w03" class="Guide01_AreaRed" enable="false" visible="false" position="absolute 883 40 886 55" anchor="top right"/>
        <Div id="div_CustInQuery" anchor="left top right" taborder="22" url="X_CCS::CnslMgmtDivCust.xfdl" style="border:0 none #808080ff ;" position="absolute 0 63 1237 230"/>
        <Button id="btn_Vendor" taborder="23" text="협력업체" enable="false" position="absolute 1072 34 1207 63" anchor="top right" style=":disabled {background:#c2c2c2ff;padding:0 0 0 0;align:center middle;}" class="btn_WF_CRUD" onclick="btn_Vendor_onclick"/>
        <Static id="Static11" text="w03" class="Guide01_AreaRed" enable="false" visible="false" position="absolute 370 40 373 55" anchor="default"/>
        <Static id="Static27" text="w03" class="Guide01_AreaRed" visible="false" position="absolute 1069 40 1072 55" anchor="left top"/>
        <Button id="btn_doneSave" taborder="24" text="후처리저장" enable="false" position="absolute 280 34 370 63" anchor="default" style=":disabled {background:#c2c2c2ff;border:1 solid #b3b3b3ff ;padding:0 0 0 0;align:center middle;}" onclick="btn_doneSave_onclick" class="btn_WF_CRUD"/>
        <Static id="Static19" text="w03" class="Guide01_AreaRed" enable="false" visible="false" position="absolute 277 40 280 55"/>
        <Button id="btn_Hold" taborder="7" text="보류하기" class="btn_WF_SoftPCall3" position="absolute 793 34 883 63" enable="false" anchor="top right" onclick="btn_Hold_onclick" style=":disabled {align:left middle;}"/>
        <Button id="btn_popup" taborder="25" onclick="fn_popupDocking" class="btn_WF_WinIn" position2="absolute r:15 w:28 t:34 h:29" positiontype="position2" tooltiptext="창 빼기" visible="true"/>
        <Edit id="edt_recordPath" taborder="27" position="absolute 1110 552 1228 581" displaynulltext="녹취파일저장주소" visible="false"/>
        <Div id="div_download" taborder="29" position="absolute 750 33 1237 163" style="background:papayawhip;border:2 solid #515d6fff ;" anchor="top right" visible="false">
          <Layouts>
            <Layout>
              <Static id="stc_title" text="설치파일을 다운로드하고 있습니다.&#13;&#10;&#13;&#10;다운로드가 완료되면 설치프로그램이 자동 실행됩니다.&#13;&#10;안내에 따라 설치 진행하세요." position="absolute 14 16 472 76" style="align:center middle;font:Gulim,9,bold;" anchor="default"/>
              <ProgressBar id="prb_down" taborder="1" max="100" min="0" onclick="ProgressBar01_onclick" position="absolute 86 94 401 114" style="smooth:false;" anchor="default"/>
            </Layout>
          </Layouts>
        </Div>
        <ActiveX id="WebPBX" position="absolute 126 6 146 25" useautobitmapcache="1" anchor="default" taborder="30" progid="{299A7F9F-9B16-4DAB-8C7F-679CF82185D3}" OnCallAnswer="WebPBX_OnCallAnswer" OnCallDialing="WebPBX_OnCallDialing" OnCallDisconnect="WebPBX_OnCallDisconnect" OnCallIncoming="WebPBX_OnCallIncoming" OnCallRecorded="WebPBX_OnCallRecorded" OnCallRinging="WebPBX_OnCallRinging" OnCallStatus="WebPBX_OnCallStatus" OnRequestResult="WebPBX_OnRequestResult" OnSessionResult="WebPBX_OnSessionResult" visible="false" windowed="true"/>
        <Grid id="grd_csList" taborder="31" useinputpanel="false" position="absolute 647 293 954 516" binddataset="ds_csList" autofittype="col" visible="false">
          <Formats>
            <Format id="default">
              <Columns>
                <Col size="80"/>
                <Col size="80"/>
              </Columns>
              <Rows>
                <Row band="head" size="24"/>
                <Row band="body" size="24"/>
              </Rows>
              <Band id="head">
                <Cell col="0" disptype="normal" text="agentId"/>
                <Cell col="1" disptype="normal" text="name"/>
              </Band>
              <Band id="body">
                <Cell col="0" disptype="normal" text="bind:agentId"/>
                <Cell col="1" disptype="normal" text="bind:name"/>
              </Band>
            </Format>
          </Formats>
        </Grid>
        <Button id="btn_check" taborder="32" text="check" position="absolute 541 300 613 328" onclick="btn_check_onclick" visible="false"/>
      </Layout>
    </Layouts>
    <Objects>
      <Dataset id="ds_searchUpjangCnt" firefirstcount="0" firenextcount="0" useclientlayout="false" updatecontrol="true" enableevent="true" loadkeymode="keep" loadfiltermode="keep" reversesubsum="false">
        <ColumnInfo>
          <Column id="partTelNo" type="STRING" size="256"/>
          <Column id="cnt" type="STRING" size="256"/>
        </ColumnInfo>
        <Rows>
          <Row/>
        </Rows>
      </Dataset>
      <Dataset id="ds_search" firefirstcount="0" firenextcount="0" useclientlayout="false" updatecontrol="true" enableevent="true" loadkeymode="keep" loadfiltermode="keep" reversesubsum="false">
        <ColumnInfo>
          <Column id="upjangnmDisp" type="STRING" size="256"/>
          <Column id="partTelNo" type="STRING" size="256"/>
          <Column id="upjang" type="STRING" size="256"/>
        </ColumnInfo>
        <Rows>
          <Row/>
        </Rows>
      </Dataset>
      <Dataset id="ds_user" firefirstcount="0" firenextcount="0" useclientlayout="false" updatecontrol="true" enableevent="true" loadkeymode="keep" loadfiltermode="keep" reversesubsum="false">
        <ColumnInfo>
          <Column id="userSabun" type="STRING" size="256"/>
        </ColumnInfo>
        <Rows>
          <Row/>
        </Rows>
      </Dataset>
      <VirtualFile id="vFile"/>
      <HttpObject id="httpObj" onload="httpObj_onload" onstatus="httpObj_onstatus"/>
      <Dataset id="ds_csList" firefirstcount="0" firenextcount="0" useclientlayout="false" updatecontrol="true" enableevent="true" loadkeymode="keep" loadfiltermode="keep" reversesubsum="false">
        <ColumnInfo>
          <Column id="agentId" type="STRING" size="256"/>
          <Column id="name" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
    </Objects>
    <Script type="xscript4.0"><![CDATA[/*
  화 면 명 : 상담관리(메인)
  파 일 명 : CnslMgmt.xfdl
  기    능 : Design 및 Script Template 

    수정일    수정자                  수정내용
  ----------   -------  --------------------------------------------------
  2015.03.11   이규훈   최초 생성
*/

/*
	-- e.Status --
	5  : 통화중
	6  : 실패
	7  : 취소
	8  : 받지 않음
	9  : 전화기 꺼짐
	10 :수신거부
	11 : 성공
	12 : 전달
	13 :
*/
/************************************************************************************************
 * 공통 라이브러리 INCLUDE 영역 (필수)
************************************************************************************************/
include "lib::lib_com.xjs";
include "lib::SCCti.xjs";
/************************************************************************************************
 * FORM 변수 선언 영역 (필수)
************************************************************************************************/
var fv_processCnt = 0;//저장완료건수
var fv_toDayLogCnt = 0; //상담건수
var fv_unTreatLogCnt = 0; //미처리건수
var fv_custTelno = 0;//발신번호건수
var fv_partTelNo = "";//고객발신전화번호
var outJsonResult = "";
var clickYN = "";
var clickEventInfo = new ClickEventInfo();
var udata = {
 user_id:  '',
 agent_id: ''
};
var fv_userInfo;		
var fv_callTypeCd = 10;	// 10:in 20:out
/************************************************************************************************
 * FORM EVENT 영역 (필수)
************************************************************************************************/
/*----------------------------------------------------------------------------------------------
 * 설명      : Form Load (필수)
 *---------------------------------------------------------------------------------------------*/
function form_onload(obj:Form, e:LoadEventInfo)
{	
	gfn_formOnLoad(this);// Form Load 시 공통 기능 처리(obj:Form, bCreateEvent:이벤트 생성 여부)

	fn_init();// 초기값 셋팅
}

/*----------------------------------------------------------------------------------------------
 * 설명      : 초기값 셋팅
 *---------------------------------------------------------------------------------------------*/
function fn_init()
{
	// 실행모듈을 체크해서 local에서 띄운경우 테스트id를 부여 한다.
	if (gv_runMode == "L") {
		WebPBX.visible = true;
		WebPBX.IsDebug = true;
		
		grd_csList.visible = true;
		btn_check.visible = true;
	} else {
		grd_csList.visible = false;
		btn_check.visible = false;
		
		if (gfn_isNull(g_CtiUserId) || gfn_isNull(g_CtiUseYn)) {
			gfn_alert("상담원 등록을 하십시오!");
			
			btn_Login.enable = false;
			div_CnslSave.btn_save.enable = false;
			
			div_CustInQuery.btn_pop02.enable = false;
			div_CustInQuery.btn_upjangCall_1.enable = false;
			div_CustInQuery.btn_upjangCall_2.enable = false;
			div_Unattend.btn_complete.enable = false;
			div_Unattend.btn_refresh.enable = false;
			div_Unattend.btn_cnslContentsSave.enable = false;
					
			return;
		}
	
		udata.user_id = g_CtiUserId;
		udata.agent_id = 'agent' + g_CtiUserId.substring(5, 8);
	}
		
    //Grid Clear
    div_Unattend.ds_unTreatLogList.clearData();
    div_Unattend.ds_toDayLogList.clearData();
    div_CnslInQuery.ds_ccsCnslLog.clearData();
    
    //상담저장, 처리완료 버튼 disable
    div_CnslSave.btn_save.enable = false;
    div_CnslSave.btn_pop3.enable = false;
    div_Unattend.btn_complete.enable = false;
    div_Unattend.btn_refresh.enable = false;
    div_Unattend.btn_cnslContentsSave.enable = false;
    
    //사업장조회, 영업사원전화연결, CS전화연결 버튼 disable
    div_CustInQuery.btn_pop02.enable = false;
    div_CustInQuery.btn_upjangCall_1.enable = false;
    div_CustInQuery.btn_upjangCall_2.enable = false;    
    div_CustInQuery.edt_upjangnmDisp.enable = false;
}

/************************************************************************************************
 * TRANSACTION 및 CallBack 영역 (필수)
************************************************************************************************/
/*----------------------------------------------------------------------------------------------
 * 설명      : 트랜잭션 콜백 함수 (필수)
 *---------------------------------------------------------------------------------------------*/
function fn_callBack(strSvcID, nErrorCode, strErrorMsg)
{
	// 에러시 gfn_callBack에서 메시지 제공, 화면별 특정 에러 발생시에만 사용하세요.
	if (nErrorCode < 0) 
	{
		return;
	}
	
    switch(strSvcID)
    {
		//내용저장 버튼 클릭 시
		case "contentsUpdate" :
			div_Unattend.fn_selectCnslUntreatLogList();//미처리현황 목록 조회
			
			break;
			
        // 저장
        case "save" :
			gfn_alert("msg.save.success");	// 저장 되었습니다.
			
			div_CnslSave.cbo_cnslProcTypeCd.value 	= "";
			div_CnslSave.cbo_cnslTypeCd.value 		= "";
			div_CnslSave.cbo_custResponseCd.value 	= "";
			div_CnslSave.chk_onlyCounSel.value 		= "";
			div_CnslSave.edt_cntcTelno.value 		= "";
			div_CnslSave.edt_mainContents.value 	= "";
			div_CnslSave.txt_cnslContents.value 	= "";
			
			div_CnslSave.ds_ccsCnslSave.setColumn(0, "cnslStartDate", "");
			div_CnslSave.ds_ccsCnslSave.setColumn(0, "callEndDate", "");
			div_CnslSave.ds_ccsCnslSave.setColumn(0, "cnslEndDate", "");
			div_CnslSave.ds_ccsCnslSave.setColumn(0, "upjangCd", null);
			div_CnslSave.ds_ccsCnslSave.setColumn(0, "upjangRegYn","0");
 			
 			fn_allClear();
			
			if (SCCti.getPBXStatus() == "INBOUND" || btn_Inbd.enable ) {
				fn_ButtonControl("INBD");
				SCCti.actionPBX("DoDone");
			} else {
				fn_ButtonControl("OUTBD");
				SCCti.actionPBX("DoObAfter");
			}
			
			this.killTimer(4);
			this.killTimer(5);
			_fv_stop = 61;
			
			div_CnslSave.btn_save.enable = false;
			div_CnslSave.fn_init();//상담저장 DIV Refresh
			fn_div_selectCnslUntreatLogList();//미처리,상담현황 DIV, 상담,미처리 건수 Refresh
			
			div_CnslSave.ds_ccsCnslSave.setColumn(0, "procUser", g_EmpNo);
			div_CnslSave.ds_ccsCnslSave.setColumn(0, "procUser_tmp", g_Name);
			div_CnslSave.edt_procUser.value = div_CnslSave.ds_ccsCnslSave.getColumn(0, "procUser_tmp");
					
			fn_checkStatus();
            break;  
            
        // 상담, 미처리 건 수 조회
        case "selectCnslTodayLogCnt" :			
			sta_cnslCnt.text = fv_toDayLogCnt;//상담건수
			sta_cBak.text = fv_unTreatLogCnt; //미처리건수
			div_Unattend.fn_selectCnslUntreatLogList();//미처리현황 목록 조회
            break;
        
        // 미처리 현황 조회 후 상담현황 조회
        case "selectCnslUntreatLogList" :
			// 미처리현황 기존 데이터와 비교후 새로 추가된 내역 색상 변경
			var nRow;
			var findRowCnt = "";
			if (div_Unattend.ds_unTreatLogListTmp.rowposition != -1) {
				for (var i = 0; i < div_Unattend.ds_unTreatLogList.rowcount; i++)
				{
					findRowCnt = "cnslStartDateT1 == '"+div_Unattend.ds_unTreatLogList.getColumn(i, "cnslStartDateT1")+"' && "
							   + "cnslStartDateT2 == '"+div_Unattend.ds_unTreatLogList.getColumn(i, "cnslStartDateT2")+"' && "
							   + "acceptUser == '"+div_Unattend.ds_unTreatLogList.getColumn(i, "acceptUser")+"'";
					nRow = div_Unattend.ds_unTreatLogListTmp.findRowExpr(findRowCnt);
					// 검색결과가 없으면
					if (nRow == -1) {
						div_Unattend.ds_unTreatLogList.setColumn(i, "chk", '1');
					}
				}
			}
			div_Unattend.ds_unTreatLogListTmp.clearData();
        
			div_Unattend.fn_selectCnslTodayLogList();//상담현황 목록 조회
            break;
        
        // 상담현황 목록 조회
        case "selectCnslTodayLogList" :
            break;
                
        // 상담이력, SMS이력 조회
        case "selectCnslLogList" :
            break;    
        
        // 처리완료 버튼 클릭 시
        case "updateProcessComplete" :
			gfn_alert("msg.action.success");// 처리 되었습니다.
			
			//미처리, 상담 목록 조회
			fn_div_selectCnslUntreatLogList();
            break;
            
        //전환요청 하기 전 메모 Setting 후에 전환요청 팝업 실행
        case "ctiCallSetMemo" : 
			fn_TransReq();//전환요청 팝업 실행
            break;
            
		case "searchUpjangCnt" :
			// 1 이 아니면 사업장조회팝업 오픈
			if (fv_custTelno != 1)
			{
				var arrParam = new Array();
				
				arrParam[0] = "custInQuery";
				arrParam[1] = fv_partTelNo + "^" + (div_CustInQuery.edt_upjang.value != "" ? div_CustInQuery.edt_upjang.value : "");
				
				var rtnVal = gfn_dialog("CnslMgmtPopCustInQuery"			// dialogId
							   , "X_CCS::CnslMgmtPopCustInQuery.xfdl"		// Url
							   , {fv_Contents:arrParam}					// 배열
							   , null, null, null, null, null, false, true, -1);
					
				if (rtnVal != null)
				{
					div_CustInQuery.edt_upjang.value = rtnVal[0];//사업장코드
					div_CustInQuery.edt_upjangnmDisp.value = rtnVal[1];//사업자명
					div_CustInQuery.edt_upjangnmDispCust.value = rtnVal[1];//사업자명(고객용)
					div_CustInQuery.edt_custType.value= rtnVal[5];//고객구분	
					div_CustInQuery.edt_attr08.value = rtnVal[6] == "N" ? "No" : "Yes";//간편발주여부
					div_CustInQuery.edt_zipCd.value = rtnVal[7];//우편번호
					div_CustInQuery.edt_addr.value = rtnVal[9];//상세주소
					
					div_CustInQuery.edt_csSabun.value = rtnVal[10];//담당CS사번	
					div_CustInQuery.edt_csTelNo.value = rtnVal[19];//담당CS전화번호(복호화)	
					//div_CnslSave.edt_procUser.value = rtnVal[10];//담당CS이름
					div_CnslSave.edt_procUser.value = "";
					
					if (rtnVal[22] != null && rtnVal[22] != "" && typeof rtnVal[22] != "undefined")
					{
						div_CnslSave.ds_ccsCnslSave.setColumn(0, "procUser", rtnVal[22]);
					}								
					
					div_CustInQuery.edt_partSalesSabun.value = rtnVal[12];//영업사원사번
					div_CustInQuery.edt_partSalesTelNo.value = rtnVal[18];//영업사원전화번호(복호화)
					
					div_CustInQuery.edt_mainUpjang.value = rtnVal[14];//본사그룹코드
					div_CustInQuery.edt_mainUpjangnmDisp.value = rtnVal[15];//본사그룹명
					div_CustInQuery.edt_saupno.value = rtnVal[16];//사업자번호
					
					if (rtnVal[0] == rtnVal[14])
					{
						div_CustInQuery.edt_codeGubun.value = "본사";
					}
					else 
					{
						div_CustInQuery.edt_codeGubun.value = "사업장";
					}
			
					//상담이력 조회
					if (typeof div_CustInQuery.edt_upjang.value != "undefined"  && div_CustInQuery.edt_upjang.value != "")
					{
						
						div_CnslInQuery.ds_search.setColumn(0, "upjangCd", div_CustInQuery.edt_upjang.value);
						div_CustInQuery.fn_getCnslInQuery();
						div_CustInQuery.fn_selectFmsUpjangCust(div_CustInQuery.edt_upjang.value);//담당자,영양사 조회
					}
				}
			}
			// 1 이면 사업장 바로 조회
			else
			{
				div_CustInQuery.fn_selectCnslMgmtCustInQueryList();
			}
			
			if (Bix.Phase == "DONE")
			{
				fn_ButtonControl("HANG");
			}
			else
			{
				fn_ButtonControl("ANSW");
			}
            
            break;
                    
        case "ctiCall" :
			ds_csList.clearData();
            
            if ( gfn_isNull(outJsonResult) || outJsonResult.indexOf("[]") != -1 ) {
				return;
			}
            var jsonResult = gfn_jsonStringToObject(outJsonResult);          
			var jsonConvert = (jsonResult.result)[0];
				
			for(var i=0; i<jsonConvert.length; i++) {
				if ( jsonConvert[i].line != "2010" && jsonConvert[i].line != "3010" && jsonConvert[i].line != "6200" ) {
					var nRow = ds_csList.addRow();
					ds_csList.setColumn(nRow, "agentId", jsonConvert[i].line );
					ds_csList.setColumn(nRow, "name"   , jsonConvert[i].name);
				}
            }
            
            var rtn = SCAuth.getLoginUserInfo(this);
			var tel = rtn["telNo3"];
			
			if ( (btn_Inbd.enable == true) && (ds_csList.findRow("agentId", tel) != -1) ) {
				// outbound 상태일때
				gfn_alert("착신전환 설정이 해제된 상태입니다.\r\n전화대기상태가 아닌 경우 상담관리 프로그램을 재시작하시기바랍니다.");
			} else if ( (btn_Outbd.enable == true) && (ds_csList.findRow("agentId", tel) == -1) ) {
				// inbound 상태일때
				if ((sta_Status.text).indexOf("후처리") == -1 ) {
					gfn_alert("착신전환이 설정된 상태입니다.\r\n전화대기상태인 경우 상담관리 프로그램을 재시작하시기바랍니다.");
				}
			}
            break;       
    }
}

// 전화걸기
function fn_DoDail(pNum, bOnPhone) {
	if ( gfn_isNull(bOnPhone) ) {
		bOnPhone = false;
	}
	var arrParam = new Array();
		arrParam[0] = pNum;
		arrParam[1] = "";
		arrParam[2] = "";
		arrParam[3] = "";
		arrParam[4] = "";
		arrParam[5] = "";
	
	
	if ( bOnPhone ) {
		sta_telno.text = pNum;
	
	} else {
		var rtnVal = gfn_dialog("CnslMgmtPopTelDial"			// dialogId
					   , "X_CCS::CnslMgmtPopTelDial.xfdl"		// Url
					   , {fv_Contents:arrParam}					// 배열
					   , null, null, null, null, null, false, true, -1);	
		
		if (!gfn_isNull(rtnVal)) {
			sta_telno.text = rtnVal;
			SCCti.actionPBX("DoDial", rtnVal);
			fv_callTypeCd = 20;
			fn_ButtonControl("BELL");
		}
	}
	
}


/************************************************************************************************
 * 각 COMPONENT 별 EVENT 영역 (필수)
************************************************************************************************/
/*----------------------------------------------------------------------------------------------
 * 설명      : 로그인 버튼 클릭
 *---------------------------------------------------------------------------------------------*/
function btn_Login_onclick(obj:Button,  e:ClickEventInfo)
{
	if ( !WebPBX.isLoaded() ) {
		this.setTimer(1, 1300);
		return;
	}
	
	var extComm = new ExtCommon();
	//var oPrcs = extComm.getProcessNameHandle("LocalPBX.exe"); 
	var oPrcs = extComm.getFindWindowEx("LocalPBX.exe");
	if ( !oPrcs ) {
		gfn_alert("WebPBX Server가 구동되지 않았습니다.");
		return;
	} 
	
	div_CnslSave.btn_pop3.enable = true;          
	div_CnslSave.ds_ccsCnslSave.setColumn(0, "procUser", g_EmpNo);
	div_CnslSave.ds_ccsCnslSave.setColumn(0, "procUser_tmp", g_Name);
	div_CnslSave.edt_procUser.value = div_CnslSave.ds_ccsCnslSave.getColumn(0, "procUser_tmp");
	
	//상담건수, 미처리건수 5분마다 refresh
    setTimer(2, 300000);
    
	btn_Login.visible  = false;
	btn_Logout.visible = true;
	btn_Logout.enable  = true;
	btn_Vendor.enable = true;
	btn_doneSave.enable = true;
	
	//사업장조회, 영업사원전화연결, CS전화연결 버튼 disable
    div_CustInQuery.btn_pop02.enable = true;
    div_CustInQuery.btn_upjangCall_1.enable = true;
    div_CustInQuery.btn_upjangCall_2.enable = true;    
    div_CustInQuery.edt_upjangnmDisp.enable = true;
    
	var rtn = SCAuth.getLoginUserInfo(this);
	fv_userInfo = rtn;
	var tel = rtn["telNo3"];
	var nExtNm = tel.toString().slice(0,4);
	var sPwd = "skb_"+nExtNm.split("").reverse().join("")+"()"; // [passwd rule] callID : 1234 passwd : skb_4321() 
	trace("callid:"+nExtNm+", passwd:"+sPwd+", group:"+g_CtiUserId);
	
	fn_setWaitCursor(true);
	
	SCCti.actionPBX("Connect", "", {callid:nExtNm, passwd:sPwd, group:g_CtiUserId});
	//SCCti.actionPBX("Connect", "", {callid:"9401", passwd:"111aaaaa", group:2000});
	
	fn_ButtonControl("INBD");
	SCCti.setPBXStatus("INBOUND", 1);
	div_Unattend.btn_complete.enable = true;//처리완료 버튼 활성화
	div_Unattend.btn_refresh.enable = true;//새로고침 버튼 활성화
	div_Unattend.btn_cnslContentsSave.enable = true;//내용저장 버튼 활성화
	fn_div_selectCnslUntreatLogList();//미처리, 상담 목록 조회	
	
}

/*----------------------------------------------------------------------------------------------
 * 설명      : 미처리, 상담 목록 조회
 *---------------------------------------------------------------------------------------------*/
function fn_div_selectCnslUntreatLogList()
{
	//미처리, 상담 건 수 조회
	fn_selectCnslTodayLogCnt();
}

/*----------------------------------------------------------------------------------------------
 * 설명      : 미처리, 상담 건 수 조회
 *---------------------------------------------------------------------------------------------*/
function fn_selectCnslTodayLogCnt()
{
	ds_user.setColumn(0, "userSabun", g_EmpNo);
	
	var strSvcID    = "selectCnslTodayLogCnt";
    var strURL      = "cs/ccs/cnslMgnt/selectCnslTodayLogCnt.xdo";
    var strInDs     = "ds_user=ds_user";
    var strOutDs    = "";
    var strArg      = "";
    var strCallback = "fn_callBack";
    var bAsync      = true;
    
    gfn_transaction(this, strSvcID, strURL, strInDs, strOutDs, strArg, strCallback, bAsync, false);  
}

/*----------------------------------------------------------------------------------------------
 * 설명      : 로그아웃 버튼 클릭
 *---------------------------------------------------------------------------------------------*/
function btn_Logout_onclick(obj:Button,  e:ClickEventInfo)
{
	if (sta_Status.text != "대기" && sta_Status.text != "") {
		gfn_alert("통화종료 후 저장 하시기 바랍니다.");
		return;
	}
	
	fn_setWaitCursor(true);
	//SCCti.actionPBX("DoAct");	// 상담관리를 사용하지 않아도 전화를 받을 수 있도록;
	//SCCti.actionPBX("Disconnect");
	WebPBX.DoLogout();
	
	fn_allClear();//조회 된 데이터 클리어
	
	fn_ButtonControl("LOUT");
	
	btn_Login.visible  = true;
	btn_Logout.visible = false;	
	btn_Vendor.enable = false;
	btn_doneSave.enable = false;
	div_CnslSave.edt_procUser.value = "";
	
	sta_telGubun.text = "";
	
	//Grid Clear
    div_Unattend.ds_unTreatLogList.clearData();
    div_Unattend.ds_toDayLogList.clearData();
    div_CnslInQuery.ds_ccsCnslLog.clearData();
    
    //상담저장, 처리완료 버튼 disable
    div_CnslSave.btn_save.enable = false;
    div_CnslSave.btn_pop3.enable = false;
    div_Unattend.btn_complete.enable = false;
    div_Unattend.btn_refresh.enable = false;
    div_Unattend.btn_cnslContentsSave.enable = false;
    
    //사업장조회, 영업사원전화연결, CS전화연결 버튼 disable
    div_CustInQuery.btn_pop02.enable = false;
    div_CustInQuery.btn_upjangCall_1.enable = false;
    div_CustInQuery.btn_upjangCall_2.enable = false;    
    div_CustInQuery.edt_upjangnmDisp.enable = false;
    
    killTimer(1);
    killTimer(2);
}

/*----------------------------------------------------------------------------------------------
 * 설명      : 인바운드 버튼 클릭
 *---------------------------------------------------------------------------------------------*/
function btn_Inbd_onclick(obj:Button,  e:ClickEventInfo)
{
	btn_Vendor.enable = false;
	
	if (sta_Status.text != "대기" && sta_Status.text != "" ) return;
	
	fn_setWaitCursor(true);
	try {
		SCCti.actionPBX("DoAct");
		SCCti.setPBXStatus("INBOUND", 1);
		fn_ButtonControl("INBD");	
		
		if (SCCti.getPBXStatus() == "INBOUND") {
			div_CnslSave.cbo_callResultCd.value = "11";
			div_CnslSave.cbo_callResultCd.enable = false;
		}
		div_CnslSave.btn_save.enable = false;
	} catch (e) {
		fn_ButtonControl("INBD");
		div_CnslSave.btn_save.enable = false;
	}
}

/*----------------------------------------------------------------------------------------------
 * 설명      : 아웃바운드 버튼 클릭 
 *---------------------------------------------------------------------------------------------*/
function btn_Outbd_onclick(obj:Button,  e:ClickEventInfo)
{
	btn_Vendor.enable = true;
	
	if (sta_Status.text != "대기" && sta_Status.text != "" ) return;
	
	fn_setWaitCursor(true);
		try {
			//SCCti.actionPBX("DoEtc");
			SCCti.actionPBX("DoNotAct", "", {mode:"ETC"});
			SCCti.setPBXStatus("OUTBOUND", 1);
			fn_ButtonControl("OUTBD");
			
			// 아웃바운드인 경우 통화결과 활성화	
			if (SCCti.getPBXStatus() == "OUTBOUND") {
				div_CnslSave.cbo_callResultCd.value = null;
				div_CnslSave.cbo_callResultCd.enable = true;
			}
			div_CnslSave.btn_save.enable = false;
	} catch (e) {
		fn_ButtonControl("OUTBD");
		div_CnslSave.btn_save.enable = false;
	}
}

function fn_setOutbound() {
	//
}

/*---------------------------------------------------------------------------------------------
 * 설명      : 전화걸기 버튼 클릭
 *---------------------------------------------------------------------------------------------*/
function btn_Dial_onclick(obj:Button,  e:ClickEventInfo)
{
	fn_DoDail();
}

/*----------------------------------------------------------------------------------------------
 * 설명      : 전화끊기 버튼 클릭
 *---------------------------------------------------------------------------------------------*/
function btn_Hangup_onclick(obj:Button,  e:ClickEventInfo)
{
	div_CnslSave.btn_save.enable = true;
	
	fn_ButtonControl("HANG");
	SCCti.actionPBX("DoHangup");
}

/*---------------------------------------------------------------------------------------------
 * 설명      : 보류 버튼 클릭
 *---------------------------------------------------------------------------------------------*/
function btn_Hold_onclick(obj:Button,  e:ClickEventInfo)
{
	div_CustInQuery.btn_pop02.enable = false;
	div_CustInQuery.btn_upjangCall_1.enable = false;
	div_CustInQuery.btn_upjangCall_2.enable = false;
	div_CnslSave.btn_save.enable = false;
	
	fn_ButtonControl("HOLD");
	SCCti.actionPBX("DoHold");
}

/*---------------------------------------------------------------------------------------------
 * 설명      : 보류해제 버튼 클릭
 *---------------------------------------------------------------------------------------------*/
function btn_HoldCan_onclick(obj:Button,  e:ClickEventInfo)
{
	div_CustInQuery.btn_pop02.enable = true;
	div_CustInQuery.btn_upjangCall_1.enable = true;
	div_CustInQuery.btn_upjangCall_2.enable = true;
	div_CnslSave.btn_save.enable = false;
	
	fn_ButtonControl("HOLDC");
	SCCti.actionPBX("DoHold");
}

/*---------------------------------------------------------------------------------------------
 * 설명      : 전환요청 하기 전 메모 Setting
 *---------------------------------------------------------------------------------------------*/
function btn_TransConsReq_onclick(obj:Button,  e:ClickEventInfo)
{
	fn_TransReq();
}

/*---------------------------------------------------------------------------------------------
 * 설명      : 전환요청 팝업 실행
 *---------------------------------------------------------------------------------------------*/
function fn_TransReq()
{
	var arrParam = new Array();
	/*
	var rtnVal = gfn_dialog("CnslCsListPop"			// dialogId
				   , "X_CCS::CnslCsListPop.xfdl"		// Url
				   , {fv_Contents:arrParam}					// 배열
				   , null, null, null, null, null, false, true, -1);
	*/
	var rtnVal = gfn_dialog("CnslMgmtPopTransReq"			// dialogId
				   , "X_CCS::CnslMgmtPopTransReq.xfdl"		// Url
				   , {fv_Contents:arrParam}					// 배열
				   , null, null, null, null, null, false, true, -1);
	trace(rtnVal);
	if ( !gfn_isNull(rtnVal) ){
		SCCti.actionPBX("DoTransfer", rtnVal["telNo"]);
		fn_ButtonControl("TRANSOK");
	}
}

/*---------------------------------------------------------------------------------------------
 * 설명      : 전환취소 버튼 클릭
 *---------------------------------------------------------------------------------------------*/
function btn_ConsCan_onclick(obj:Button,  e:ClickEventInfo)
{
	gfn_alert("지원하지 않는 기능입니다.");
}

/*----------------------------------------------------------------------------------------------
 * 설명      : 휴식 버튼 클릭
 *---------------------------------------------------------------------------------------------*/
function btn_Rest_onclick(obj:Button,  e:ClickEventInfo)
{
	fn_setWaitCursor(true);
	div_CnslSave.btn_save.enable = false;
	if ( btn_Rest.text == "휴식" ) 
	{
		btn_Rest.text 	= "해제";
		fn_ButtonControl("REST");
		
		div_CustInQuery.btn_pop02.enable = false;
		div_CustInQuery.btn_upjangCall_1.enable = false;
		div_CustInQuery.btn_upjangCall_2.enable = false;
		
		//SCCti.actionPBX("DoRest");
		SCCti.actionPBX("DoNotAct", "", {mode:"DoRest"});
	} 
	else 
	{
	    btn_Rest.text = "휴식";
	    sta_Status.text = "";
	    div_CustInQuery.btn_pop02.enable = true;
		div_CustInQuery.btn_upjangCall_1.enable = true;
		div_CustInQuery.btn_upjangCall_2.enable = true;
			
	    //SCCti.actionPBX("DoRest");
	    SCCti.actionPBX("DoAct");
	}
}

/*----------------------------------------------------------------------------------------------
 * 설명      : 식사 버튼 클릭
 *---------------------------------------------------------------------------------------------*/
function btn_Meal_onclick(obj:Button,  e:ClickEventInfo)
{
	fn_setWaitCursor(true);
	if ( btn_Meal.text == "식사" ) 
	{
		btn_Meal.text = "해제";
		fn_ButtonControl("MEAL");
		//SCCti.actionPBX("DoMeal");
		SCCti.actionPBX("DoNotAct", "", {mode:"DoMeal"});
	} 
	else 
	{
	    btn_Meal.text = "식사";
	    //SCCti.actionPBX("DoMeal");
	    SCCti.actionPBX("DoAct");
	}	
}

/*----------------------------------------------------------------------------------------------
 * 설명      : 회의 버튼 클릭
 *---------------------------------------------------------------------------------------------*/
function btn_Meet_onclick(obj:Button,  e:ClickEventInfo)
{
	fn_setWaitCursor(true);
	if ( btn_Meet.text == "회의" ) 
	{
		btn_Meet.text = "해제";
		fn_ButtonControl("MEET");
		//SCCti.actionPBX("DoMeet");
		SCCti.actionPBX("DoNotAct", "", {mode:"DoMeet"});
	} 
	else 
	{
	    btn_Meet.text = "회의";
	    //SCCti.actionPBX("DoMeet");
	    SCCti.actionPBX("DoAct");
	}	
}

/*----------------------------------------------------------------------------------------------
 * 설명      : 교육 버튼 클릭
 *---------------------------------------------------------------------------------------------*/
function btn_Edu_onclick(obj:Button,  e:ClickEventInfo)
{
	fn_setWaitCursor(true);
	if ( btn_Edu.text == "교육" ) 
	{
		btn_Edu.text = "해제";
		fn_ButtonControl("EDU");
		//SCCti.actionPBX("DoEdu");
		SCCti.actionPBX("DoNotAct", "", {mode:"DoEdu"});
	} 
	else 
	{
	    btn_Edu.text = "교육";
	    //SCCti.actionPBX("DoEdu");
	    SCCti.actionPBX("DoAct");
	}		
}

/*---------------------------------------------------------------------------------------------
 * 설명      : 기타 버튼 클릭
 *---------------------------------------------------------------------------------------------*/
function btn_Etc_onclick(obj:Button,  e:ClickEventInfo)
{
	fn_setWaitCursor(true);
	if ( btn_Etc.text == "기타" ) 
	{
		btn_Etc.text = "해제";
		fn_ButtonControl("ETC");
		//SCCti.actionPBX("DoEtc");
		SCCti.actionPBX("DoNotAct", "", {mode:"DoEtc"});
	} 
	else 
	{
	    btn_Etc.text = "기타";
	    //SCCti.actionPBX("DoEtc");
	    SCCti.actionPBX("DoAct");
	}		
}

function WebPBX_OnCallDialing(obj:ActiveX, e) {
	trace("##WebPBX_OnCallDialing##");
	//fn_callIncoming(obj, e);
	fn_ButtonControl("BELL");
}

// 
function WebPBX_OnCallIncoming(obj:ActiveX, e) {	
	trace("##WebPBX_OnCallIncoming##");
	fn_callIncoming(obj, e);
}

function fn_callIncoming(obj:ActiveX, e) {
	trace("### fn_callIncoming ###");
	trace("@@@"+sta_Status.text);
	if ( sta_Status.text != "대기" && sta_Status.text != "" ) {
		// 통화중 다시 전화가 인입시..
		return;
	}
	
	var objPop = application.popupframes["CnslMgmtPopTelRcv"];
	if ( !gfn_isNull(objPop) ) {
		// 중복이벤트 방지
		return;
	}
	
	div_CustInQuery.edt_upjang.value 			= "";
	div_CustInQuery.edt_upjangnmDisp.value 		= "";
	div_CustInQuery.edt_mainUpjang.value 		= "";
	div_CustInQuery.edt_mainUpjangnmDisp.value 	= "";
	div_CustInQuery.edt_attr08.value 			= "";
	div_CustInQuery.edt_upjangnmDispCust.value 	= "";
	div_CustInQuery.edt_saupno.value 			= "";
	div_CustInQuery.edt_zipCd.value 			= "";
	div_CustInQuery.edt_addr.value 				= "";
	div_CustInQuery.edt_partSalesSabun.value 	= "";
	div_CustInQuery.edt_partSalesTelNo.value 	= "";
	div_CustInQuery.edt_csSabun.value 			= "";
	div_CustInQuery.edt_csTelNo.value 			= "";
	div_CustInQuery.edt_custType.value			= "";
	
	if ( gv_runMode == "L" ) {
		for ( var q in e ) {
			trace( q +"==" + e[q] );
		}
	}
	
	var arrParam = new Array();
		arrParam[0] = e.callee;
		arrParam[1] = e.caller;
		arrParam[2] = e.caller_session_id;
		arrParam[3] = e.caller_channel;
		arrParam[4] = e.callee_channel;
		arrParam[5] = e.Status;
	
	this.killTimer(3);
	this.killTimer(4);
	_fv_stop = 61;
	sta_telno.text = e.caller;
	trace("before POPUP");
	
	fn_ButtonControl("BELL");
	
	var rtnVal = gfn_dialog("CnslMgmtPopTelRcv"					// dialogId
					   , "X_CCS::CnslMgmtPopTelRcv.xfdl"		// Url
					   , {fv_Contents:arrParam}					// 배열
					   , null, null, null, null, null, false, true, -1);
	
	trace("after POPUP");				   
	if ( !gfn_isNull(rtnVal) ) {
		switch ( rtnVal ) {
			case "DoAnswer" :
				fv_callTypeCd = 10;
				
				div_CnslSave.ds_ccsCnslSave.setColumn(0, "callId", e.callee); //CallId
				div_CnslSave.ds_ccsCnslSave.setColumn(0, "cnslStartDate", gfn_todayTime()); //상담시작일시
				SCCti.actionPBX("DoAnswer");
				break;
		}
		
	}
}

/*----------------------------------------------------------------------------------------------
 * 설명      : 고객전화번호로 저장 된 사업장 정보 Count 조회
 *---------------------------------------------------------------------------------------------*/
function fn_upjangCnt()
{
	//고객 발신번호로 조회 시 건 수 조회(건 수가 1이 아니면 사업장 조회 팝업 띄움)
	var strSvcID    = "searchUpjangCnt";
    var strURL      = "cs/ccs/cnslMgnt/searchUpjangCnt.xdo";
    var strInDs     = "ds_search=ds_search";
    var strOutDs    = "";
    var strArg      = "";
    var strCallback = "fn_callBack";
    var bAsync      = true;
    
    gfn_transaction(this, strSvcID, strURL, strInDs, strOutDs, strArg, strCallback, bAsync);
}

function WebPBX_OnCallAnswer(obj:ActiveX, e) {
	trace("##WebPBX_OnCallAnswer##");
	for (var o in e ) {
		trace(o+"=="+e[o]);
	}
	
	var objPop = application.popupframes["CnslMgmtPopTelRcv"];
	if ( !gfn_isNull(objPop) ) {
		objPop.form.close();
	}
	
	var rtn = SCAuth.getLoginUserInfo(this);
	var tel = rtn["telNo3"];
	
	if ( e.caller == tel ) {
		if ( (e.callee).indexOf("*7") == 0 ) {
			return;
		} else {
			fn_ButtonControl("ANSWOUTBD");
			sta_telno.text = e.callee;
		}
	} else {
		if ( (e.caller).indexOf("*7") == 0 ) {
			return;
		} else {		
			fn_ButtonControl("ANSW");
			sta_telno.text = e.caller;
		}
	}
	
	this.killTimer(3);
	this.killTimer(4);
	_fv_stop = 61;
			
	div_CnslSave.fn_init();
	div_CnslSave.ds_ccsCnslSave.setColumn(0, "cnslStartDate", gfn_todayTime()); //상담시작일시
}

function WebPBX_OnCallDisconnect(obj:ActiveX, e) {
	trace("## WebPBX_OnCallDisconnect ##");
	
	for ( var w in e ) {
		trace(w+"=="+e[w]);
	}
	
	var objPop = application.popupframes["CnslMgmtPopTelRcv"];
	if ( !gfn_isNull(objPop) ) {
		objPop.form.close();
	}
	
	if ( sta_Status.text != "대기" && sta_Status.text != "" ) {
		// 통화중 다시 전화가 인입시..
		if ( sta_Status.text == "벨울림" ) {
			fn_ButtonControl(btn_Inbd.enable == true ? "OUTBD" : "INBD");
		}
		return;
	}
}



/*----------------------------------------------------------------------------------------------
 * 설명      : 이벤트 버튼 제어
 *---------------------------------------------------------------------------------------------*/
function fn_ButtonControl(btnFlag) {	
    switch(btnFlag)
    {
		// 아웃바운드
        case "OUTBD" :
            sta_Status.text      = "대기";
          	btn_Inbd.enable     = true;
			btn_Outbd.enable    = false;
			btn_Dial.enable     = true;
			btn_Hangup.enable   = false; 
			btn_Hold.enable     = false; 
			btn_HoldCan.enable  = false; 
			btn_TransConsReq.enable = false; 
			btn_ConsCan.enable  = false; 
			btn_Rest.enable     = true;
			btn_Meal.enable     = true;
			btn_Meet.enable     = true;
			btn_Edu.enable      = true;
			btn_Etc.enable      = true;
			btn_ConsComplete.enable = false;
			btn_Vendor.enable = true;
            break;
        
        // 인바운드
        case "INBD" :
            sta_Status.text      = "대기";
          	btn_Inbd.enable     = false;
			btn_Outbd.enable    = true;
			btn_Dial.enable     = false;
			btn_Hangup.enable   = false; 
			btn_Hold.enable     = false; 
			btn_HoldCan.enable  = false; 
			btn_TransConsReq.enable = false; 
			btn_ConsCan.enable  = false; 
			btn_Rest.enable     = true;
			btn_Meal.enable     = true;
			btn_Meet.enable     = true;
			btn_Edu.enable      = true;
			btn_Etc.enable      = true;
			btn_ConsComplete.enable = false;
			btn_Vendor.enable = false;
            break;    
        
        // 벨울림
        case "BELL" :
            sta_Status.text      = "벨울림";
			btn_Dial.enable     = false;
			btn_Hangup.enable   = true; 
			btn_Hold.enable     = false; 
			btn_HoldCan.enable  = false; 
			btn_TransConsReq.enable = false; 
			btn_ConsCan.enable  = false; 
			btn_Rest.enable     = false;
			btn_Meal.enable     = false;
			btn_Meet.enable     = false;
			btn_Edu.enable      = false;
			btn_Etc.enable      = false;
			btn_ConsComplete.enable = false;
			btn_Vendor.enable = false;
            break;
            
        // 전화걸기
        case "DIAL" :
            sta_Status.text      = "통화중(OUT)";
			btn_Dial.enable     = false;
			btn_Hangup.enable   = true; 
			btn_Hold.enable     = false; 
			btn_HoldCan.enable  = false; 
			btn_TransConsReq.enable = false; 
			btn_ConsCan.enable  = false; 
			btn_Rest.enable     = false;
			btn_Meal.enable     = false;
			btn_Meet.enable     = false;
			btn_Edu.enable      = false;
			btn_Etc.enable      = false;
			btn_ConsComplete.enable = false;
			btn_Vendor.enable = false;
            break;   

        // 전화받기
        case "ANSW" :
            sta_Status.text      = "통화중(IN)";
			btn_Dial.enable     = false;
			btn_Hangup.enable   = true; 
			btn_Hold.enable     = true; 
			btn_HoldCan.enable  = false; 			
			btn_TransConsReq.enable = true; 
			btn_TransConsReq.visible = true; 			
			btn_ConsCan.enable  = false; 
			btn_Rest.enable     = false;
			btn_Meal.enable     = false;
			btn_Meet.enable     = false;
			btn_Edu.enable      = false;
			btn_Etc.enable      = false;
			btn_ConsComplete.enable = false;
			btn_Vendor.enable = false;
			killTimer(1);
            break;   
            
        // 아웃바운드 고객과 통화연결
        case "ANSWOUTBD" :
            sta_Status.text      = "통화중(OUT)";
			btn_Dial.enable     = false;
			btn_Hangup.enable   = true; 
			btn_Hold.enable     = true; 
			btn_HoldCan.enable  = false; 
			btn_TransConsReq.enable = false; 
			btn_ConsCan.enable  = false; 
			btn_Rest.enable     = false;
			btn_Meal.enable     = false;
			btn_Meet.enable     = false;
			btn_Edu.enable      = false;
			btn_Etc.enable      = false;
			btn_ConsComplete.enable = false;
			btn_Vendor.enable = false;
            break;  
                    
        // 전화끊기
        case "HANG" :
            sta_Status.text      = "후처리";
			btn_Dial.enable     = false;
			btn_Hangup.enable   = false; 
			btn_Hold.enable     = false; 
			btn_HoldCan.enable  = false; 
			btn_TransConsReq.enable = false; 
			btn_ConsCan.enable  = false; 
			btn_Rest.enable     = false;
			btn_Meal.enable     = false;
			btn_Meet.enable     = false;
			btn_Edu.enable      = false;
			btn_Etc.enable      = false;
			btn_ConsComplete.enable = false;
			btn_Vendor.enable = false;
            break;   
                                    
        // 휴식
        case "REST" :
			sta_Status.text 		= "휴식";
			btn_Dial.enable     = false;
			btn_Hangup.enable   = false; 
			btn_Hold.enable     = false; 
			btn_HoldCan.enable  = false; 
			btn_TransConsReq.enable = false; 
			btn_ConsCan.enable  = false; 
			btn_Rest.enable     = true;
			btn_Meal.enable     = false;
			btn_Meet.enable     = false;
			btn_Edu.enable      = false;
			btn_Etc.enable      = false;
			btn_ConsComplete.enable = false;
			btn_Vendor.enable = false;
            break;    
            
        // 식사
        case "MEAL" :
            sta_Status.text      = "식사";
			btn_Dial.enable     = false;
			btn_Hangup.enable   = false; 
			btn_Hold.enable     = false; 
			btn_HoldCan.enable  = false; 
			btn_TransConsReq.enable = false; 
			btn_ConsCan.enable  = false; 
			btn_Rest.enable     = false;
			btn_Meal.enable     = true;
			btn_Meet.enable     = false;
			btn_Edu.enable      = false;
			btn_Etc.enable      = false;
			btn_ConsComplete.enable = false;
			btn_Vendor.enable = false;
            break; 
            
        // 회의
        case "MEET" :
            sta_Status.text      = "회의";
			btn_Dial.enable     = false;
			btn_Hangup.enable   = false; 
			btn_Hold.enable     = false; 
			btn_HoldCan.enable  = false; 
			btn_TransConsReq.enable = false; 
			btn_ConsCan.enable  = false; 
			btn_Rest.enable     = false;
			btn_Meal.enable     = false;
			btn_Meet.enable     = true;
			btn_Edu.enable      = false;
			btn_Etc.enable      = false;
			btn_ConsComplete.enable = false;
			btn_Vendor.enable = false;
            break; 
            
        // 교육
        case "EDU" :
            sta_Status.text      = "교육";
			btn_Dial.enable     = false;
			btn_Hangup.enable   = false; 
			btn_Hold.enable     = false; 
			btn_HoldCan.enable  = false; 
			btn_TransConsReq.enable = false; 
			btn_ConsCan.enable  = false; 
			btn_Rest.enable     = false;
			btn_Meal.enable     = false;
			btn_Meet.enable     = false;
			btn_Edu.enable      = true;
			btn_Etc.enable      = false;
			btn_ConsComplete.enable = false;
			btn_Vendor.enable = false;
            break;  
            
        // 기타
        case "ETC" :
            sta_Status.text      = "기타";
			btn_Dial.enable     = false;
			btn_Hangup.enable   = false; 
			btn_Hold.enable     = false; 
			btn_HoldCan.enable  = false; 
			btn_TransConsReq.enable = false; 
			btn_ConsCan.enable  = false; 
			btn_Rest.enable     = false;
			btn_Meal.enable     = false;
			btn_Meet.enable     = false;
			btn_Edu.enable      = false;
			btn_Etc.enable      = true;
			btn_ConsComplete.enable = false;
			btn_Vendor.enable = false;
            break;   
                   
        // 보류
        case "HOLD" :
			btn_Dial.enable     = false;
			btn_Hangup.enable   = false; 			
			btn_Hold.enable     = false; 
			btn_Hold.visible     = false; 			
			btn_HoldCan.enable  = true;
			btn_HoldCan.visible  = true;			
			btn_TransConsReq.enable = false; 
			btn_ConsCan.enable  = false; 
			btn_Rest.enable     = false;
			btn_Meal.enable     = false;
			btn_Meet.enable     = false;
			btn_Edu.enable      = false;
			btn_Etc.enable      = false;
			btn_ConsComplete.enable = false;
			btn_Vendor.enable = false;
            break;                     

        // 보류해제
        case "HOLDC" :
			btn_Dial.enable     = false;
			btn_Hangup.enable   = true; 			
			btn_Hold.enable     = true; 
			btn_Hold.visible    = true; 			
			btn_HoldCan.enable  = false; 
			btn_HoldCan.visible  = false; 
			
			if ( SCCti.getPBXStatus("DoStatus") == "INBOUND" )
			{
				btn_TransConsReq.enable = true; 
			}
			else
			{
				btn_TransConsReq.enable = false; 
			}
			
			btn_ConsCan.enable  = false; 
			btn_Rest.enable     = false;
			btn_Meal.enable     = false;
			btn_Meet.enable     = false;
			btn_Edu.enable      = false;
			btn_Etc.enable      = false;
			btn_ConsComplete.enable = false;
			btn_Vendor.enable = false;
            break;  

        // 로그아웃
        case "LOUT" :
            sta_Status.text      = "";
            btn_Inbd.enable     = true;
            btn_Outbd.enable    = true;
			btn_Dial.enable     = false;
			btn_Hangup.enable   = false; 
			btn_Hold.enable     = false; 
			btn_HoldCan.enable  = false; 
			btn_TransConsReq.enable = false; 
			btn_ConsCan.enable  = false; 
			btn_Rest.enable     = false;
			btn_Meal.enable     = false;
			btn_Meet.enable     = false;
			btn_Edu.enable      = false;
			btn_Etc.enable      = false;
			btn_ConsComplete.enable = false;
			btn_Vendor.enable = false;
            break;
            
        //전환요청                  
        case "TRANSREQ" :
			/*
            btn_Dial.enable     = false;
			btn_Hangup.enable   = true; 
			btn_Hold.enable     = false; 
			btn_HoldCan.enable  = false;			
			btn_TransConsReq.enable = false; 
			btn_TransConsReq.visible = false; 			
			btn_ConsCan.enable  = true; 
			btn_ConsCan.visible  = true; 			
			btn_Rest.enable     = false;
			btn_Meal.enable     = false;
			btn_Meet.enable     = false;
			btn_Edu.enable      = false;
			btn_Etc.enable      = false;
			btn_ConsComplete.enable = false;
			btn_Vendor.enable = false;
			*/
            break;   
        
		//전환요청(상담전환)                  
        case "TRANSOK" :
            btn_Dial.enable     = false;
			btn_Hangup.enable   = true; 
			btn_Hold.enable     = false; 
			btn_HoldCan.enable  = false;			
			btn_TransConsReq.enable = false; 
			btn_TransConsReq.visible = false; 			
			btn_ConsCan.enable  = true; 
			btn_ConsCan.visible  = true; 			
			btn_Rest.enable     = false;
			btn_Meal.enable     = false;
			btn_Meet.enable     = false;
			btn_Edu.enable      = false;
			btn_Etc.enable      = false;
			btn_ConsComplete.enable = false;
			btn_Vendor.enable = false;
            break;              
    }
}

/*----------------------------------------------------------------------------------------------
 * 설명      : 타이머 설정
 *---------------------------------------------------------------------------------------------*/
 var _fv_stop = 61;
function CnslMgmt_ontimer(obj:Form, e:TimerEventInfo)
{
	switch ( e.timerid ) {
		case 1 :
			this.killTimer(e.timerid);
			fn_getPBXServer();
			break;
		case 2 :
			//5분마다 상담, 미처리 건수 및 현황 Refresh
			fn_selectCnslTodayLogCnt();
			fn_checkSetStatus();
			break;
			
		case 3 :
			this.killTimer(e.timerid);
			this.killTimer(4);
			_fv_stop = 61;
			
			if ( SCCti.getPBXStatus() == "INBOUND" ) {	
				fn_ButtonControl("INBD");
				SCCti.actionPBX("DoAct");
			} else {				
				fn_ButtonControl("OUTBD");
				SCCti.actionPBX("DoNotAct", "", {mode:"ETC"});
			}
			
			//SCCti.actionPBX("DoEtc"); // etc 상태 해제
			//SCCti.actionPBX("DoAct");
			//gfn_alert("통화 종료 후 1분내 후처리가 저장되지 않아 자동으로 대기 상태로 전환되었습니다.");
			break;
			
		case 4 :
			if ( 0 >= _fv_stop ) {
				this.killTimer(e.timerid);
				fn_checkStatus();
				_fv_stop = 61;
				return;
			}
			var textColor = (_fv_stop > 10) ? '#ea5424ff' : 'red';
			sta_Status.text = "후처리[<fc v='"+textColor+"'>"+(--_fv_stop)+"초</fc>]";
			
			break;
			
		case 5 :	// 대기상태 확인 후 미설정시 재로그인
			this.killTimer(e.timerid);
			SCCti.actionPBX("DoAct");
			isLast = true;
			break;
		
		case 6 :
			this.killTimer(e.timerid);
			trace("call WebPBX.DoLogout()");
			WebPBX.DoLogout();
			this.setTimer(9, 1500);
			break;
			
		case 7 :
			this.killTimer(e.timerid);
			fn_setWaitCursor(false);
			//SCCti.actionPBX("DoAct");
			break;
			
		case 8 :
			this.killTimer(e.timerid);
			fn_setWaitCursor(false);
			SCCti.actionPBX("DoNotAct", "", {mode:"ETC"});
			div_CnslSave.btn_save.enable = true;
			this.setTimer(3, 61000);
			this.setTimer(4, 1000);
			break;
			
		case 9 : // 상담관리 종료시 착신전환 해제 후 로그아웃처리
			this.killTimer(e.timerid);
			this.getOwnerFrame().form.close();	// 종료전 초기화
			break;
	}
}

/*----------------------------------------------------------------------------------------------
 * 설명      : 조회 된 데이터 클리어
 *---------------------------------------------------------------------------------------------*/
function fn_allClear()
{
    div_CnslInQuery.ds_ccsCnslLog.clearData();
    div_CustInQuery.ds_fmsUpjangCust.clearData();
    div_CustInQuery.ds_fmsUpjang.clearData();
    
    div_CustInQuery.btn_pop02.enable = true;
    div_CustInQuery.btn_upjangCall_1.enable = true;
    div_CustInQuery.btn_upjangCall_2.enable = true;
      
    sta_telno.text = "";
    sta_cnslCnt.text = "";
    sta_cBak.text = "";
    
    div_CustInQuery.edt_custType.value = "";
    div_CustInQuery.edt_addr.value = "";
    div_CustInQuery.edt_attr08.value = "";
    div_CustInQuery.edt_codeGubun.value = "";
    div_CustInQuery.edt_csSabun.value = "";
    div_CustInQuery.edt_csTelNo.value = "";
    div_CustInQuery.edt_mainUpjang.value = "";
    div_CustInQuery.edt_mainUpjangnmDisp.value = "";
    div_CustInQuery.edt_partSalesSabun.value = "";
    div_CustInQuery.edt_partSalesTelNo.value = "";
    div_CustInQuery.edt_upjang.value = "";
    div_CustInQuery.edt_upjangnmDisp.value = "";
    div_CustInQuery.edt_upjangnmDispCust.value = "";
    div_CustInQuery.edt_zipCd.value = "";
    div_CustInQuery.edt_saupno.value = ""; 
}

/*----------------------------------------------------------------------------------------------
 * 설명      : 전환완료 버튼 클릭
 *---------------------------------------------------------------------------------------------*/
function btn_ConsComplete_onclick(obj:Button,  e:ClickEventInfo)
{
	fn_ButtonControl("HANG");
	
	div_CnslSave.btn_save.enable = true;
}

/*----------------------------------------------------------------------------------------------
 * 설명      : 협력업체 버튼 클릭
 *---------------------------------------------------------------------------------------------*/
function btn_Vendor_onclick(obj:Button,  e:ClickEventInfo)
{
	//fn_allClear();
	var arrParam = new Array();
	var rtnVal = gfn_dialog("CnslMgmtPopVendor"			// dialogId
				   , "X_CCS::CnslMgmtPopVendor.xfdl"		// Url
				   , {fv_Contents:""}					// 배열
				   , null, null, null, null, null, false, true, -1);	
	
	if (rtnVal != null) 
	{       
		arrParam[0] = gfn_replace(rtnVal[5], '-', '');	// 전화번호 2016.05.16 키폰교환기 작업으로 외부발신번호 9 -> 0으로 변경
		var rtnVal_2 = gfn_dialog("CnslMgmtPopTelDial"			// dialogId
				   , "X_CCS::CnslMgmtPopTelDial.xfdl"		// Url
				   , {fv_Contents:arrParam}					// 배열
				   , null, null, null, null, null, false, true, -1);	
	
		if (!gfn_isNull(rtnVal_2)) {	
			SCCti.actionPBX("DoDial", rtnVal_2);
			fn_ButtonControl("BELL");
		}		
	}
}

function CnslMgmt_onkeydown(obj:Form, e:KeyEventInfo)
{
	// 전화걸기 : Ctrl + 1 키
	if ( e.keycode == 49 && e.ctrlKey) {
		btn_Dial_onclick();
	} 
	// 전화끊기 : Ctrl + 2 키
	else if ( e.keycode == 50 && e.ctrlKey) {
		btn_Hangup_onclick(btn_Hangup,  clickEventInfo);
	} 
	// 인/아웃바운드 : Ctrl + 3 키
	else if ( e.keycode == 51 && e.ctrlKey) {
		if ( SCCti.getPBXStatus() == "INBOUND" || btn_Inbd.enable ) 
		{
			btn_Outbd_onclick();
		}
		else 
		{
			btn_Inbd_onclick();
		}
	}
}

function btn_doneSave_onclick(obj:Button,  e:ClickEventInfo)
{
	if (sta_Status.text != "대기" 
		&& sta_Status.text != "" 
		&& (sta_Status.text).indexOf("통화") >= 0 ) {
		gfn_alert("통화종료 후 사용 하시기 바랍니다.");
		return;
	}
	
	var rtnVal = gfn_dialog("CnslMgmtDivCnslSavePop"			// dialogId
				   , "X_CCS::CnslMgmtDivCnslSavePop.xfdl"		// Url
				   , {fv_Contents:sta_telno.text}					// 배열
				   , null, null, null, null, null, false, true, -1);	
				   
	if (rtnVal != null) 
	{
		if (rtnVal == "save") {
			div_CnslSave.ds_ccsCnslSave.setColumn(0, "cnslStartDate", "");
			div_CnslSave.ds_ccsCnslSave.setColumn(0, "callEndDate", "");
			div_CnslSave.ds_ccsCnslSave.setColumn(0, "cnslEndDate", "");
 			 			
 			fn_allClear();
			if ( gfn_isNull(SCCti.getPBXStatus()) ) {
				SCCti.setPBXStatus(btn_Inbd.enable ? "INBOUND" : "OUTBOUND", 1);
			}
			
			if ( SCCti.getPBXStatus() == "INBOUND" ) 
			{	
				if ( true ) {
					fn_ButtonControl("INBD");
				}
			}
			else
			{				
				if ( true ) {
					fn_ButtonControl("OUTBD");
				}
			}
			
			//SCCti.actionPBX("DoEtc"); // etc 상태 해제
			
			div_CnslSave.fn_init();//상담저장 DIV Refresh
			fn_div_selectCnslUntreatLogList();//미처리,상담현황 DIV, 상담,미처리 건수 Refresh
			div_CnslSave.btn_save.enable = false;
			this.killTimer(3);
			this.killTimer(4);
			_fv_stop = 61;
			SCCti.setPBXStatus("INBOUND", 1);
			fn_ButtonControl("INBD");
			div_CnslSave.ds_ccsCnslSave.setColumn(0, "procUser", g_EmpNo);
			div_CnslSave.ds_ccsCnslSave.setColumn(0, "procUser_tmp", g_Name);
			div_CnslSave.edt_procUser.value = div_CnslSave.ds_ccsCnslSave.getColumn(0, "procUser_tmp");
			
			fn_checkStatus();
		}
	}
}

function fn_popupDocking(obj:Button,  e:ClickEventInfo)
{
	// Frame이 아니면 return;
	if (gv_mdi != "Y") return;
	
	fn_changePopup(getOwnerFrame().name);	
}

// 화면을 SDI/MDI 전환
function fn_changePopup(sFormId)
{
	var objChildFrame;
	var iFindRow = gds_openPage.findRow("formId", sFormId);
	if (iFindRow == -1) return;
	
	// SDI로 창 빼기
	if (gfn_isNull(gds_openPage.getColumn(iFindRow, "isPopup")) || gds_openPage.getColumn(iFindRow, "isPopup") == "N")
	{		
		objChildFrame = afrm_MDI.removeChild(sFormId);

		if (objChildFrame != undefined)
		{
			btn_popup.class = "btn_WF_WinIn";
			btn_popup.tooltiptext = "창 넣기";
			
			if (!objChildFrame.showtitlebar)
			{
				objChildFrame.showtitlebar = true;
				objChildFrame.style.bordertype = "normal";				

				// SPOON 일때
				if(g_SystemId == "SPOON" || g_SystemId == "FICS")
				{
					objChildFrame.style.border = "2 solid #515d6f";        
					objChildFrame.titlebar.style.background = "#696cc3";
					objChildFrame.titlebar.style.border = "0 none, 0 none, 1 solid #5a5daf, 0 none"; 
				}
				else {   
					objChildFrame.style.border = "2 solid #515d6f";        
					objChildFrame.titlebar.style.background = "#02a7ad";
					objChildFrame.titlebar.style.border = "0 none, 0 none, 1 solid #48888b, 0 none";
				}		
			}
			
			objChildFrame.openstatus = "normal";

			gds_openPage.setColumn(iFindRow, "isPopup", "Y");
			
			afrm_Tab.form.fn_DelTitle(sFormId, false);
			
			objChildFrame.showModeless(sFormId + "_POP");
		}
	}
	// MDI로 창 넣기
	else {	
		objChildFrame = application.popupframes[sFormId + "_POP"];

		if (objChildFrame != undefined)
		{
			var rtn = objChildFrame.hideModeless();
			afrm_MDI.addChild(sFormId, objChildFrame);
			
			var sMenuNm = gds_openPage.getColumn(iFindRow, gv_menuNameCol);
			afrm_Tab.form.fn_AddTitle(sFormId, sMenuNm);
			
			gds_openPage.setColumn(iFindRow, "isPopup", "N");

			objChildFrame.openstatus = "maximize";			
			objChildFrame.showtitlebar = false;
			objChildFrame.style.border = "0px none #ffffffff";
		
			btn_popup.class = "btn_WF_WinOut";
			btn_popup.tooltiptext = "창 분리";
		}
	}

	//창 뺄때... Intro 처리
	if(afrm_Tab.form.tab_WorkTitle.getTabpageCount() == 0) 
	{
		if(!afrm_Intro.visible)
		{
			afrm_MDI.visible   = false;
			afrm_Intro.visible = true;
			afrm_Tab.form.btn_home.class = "btn_MDI_HomeS";
		}
	}
	else
	{
		if(!afrm_MDI.visible)
		{
			afrm_MDI.visible   = true;
			afrm_Intro.visible = false;
			afrm_Tab.form.btn_home.class = "btn_MDI_Home";
		}
	}
}


function WebPBX_OnSessionResult(obj:ActiveX, e) {
	trace("## WebPBX_OnSessionResult ##");
	for (var p in e ) {
		trace("["+p +"]="+ e[p]);
	}
}

function WebPBX_OnCallRinging(obj:ActiveX, e) {
	trace("## WebPBX_OnCallRinging ##");
	
	for (var p in e ) {
		trace("["+p +"]="+ e[p]);
	}
	
	//fn_callIncoming(obj, e);
}

function WebPBX_OnCallStatus(obj:ActiveX, e) {
	trace("## WebPBX_OnCallStatus ##");
	for ( var u in e ) {
		trace( u+"=="+e[u]);
	}
	
	fn_setWaitCursor(false);
	
	if ( !gfn_isNull(e.Status) ) {
		if ( e.Status == "ETC" ) {
			SCCti.setPBXStatus(e.Status, e.Value);
			fn_ButtonControl(e.Value == 0 ? "INBD":"OUTBD");
			
		} else {
			SCCti.setPBXStatus(e.Status, e.Value);
		}
	}
	
	/*
	if ( e.Status == "OUTBOUND" && e.Value == "0" ) {
		fn_ButtonControl("OUTBD");
		SCCti.actionPBX("DoEtc");
	} else if ( e.Status == "ETC" ) {
	
	} else if ( e.Status == "" ) {
	
	} else {
		//fn_ButtonControl("INBD");
	}
	*/
	//fn_ButtonControl("INBD");
}

function CnslMgmt_onbeforeclose(obj:Form, e:CloseEventInfo) {
	trace("CnslMgmt_onbeforeclose");
}

function WebPBX_OnCallRecorded(obj:ActiveX, e) {
	trace("###WebPBX_OnCallRecorded###");
	for ( var w in e ) {
		trace(w+"==="+e[w]);
	}
	edt_recordPath.value = (e.file_path).replace("/nvdata/ftproot/record", "");
	
	var objPop = application.popupframes["CnslMgmtPopTelRcv"];
	if ( !gfn_isNull(objPop) ) {
		objPop.form.close();
	}	
	
	if ( toNumber(e.record_duration) < 2 ) {
		
		var rtn = SCAuth.getLoginUserInfo(this);
		var tel = rtn["telNo3"];
		
		if ( e.caller == tel ) {
			if ( (e.callee).indexOf("*") == -1 ) {
				fn_ButtonControl("OUTBD");
			} else {
				fn_ButtonControl("INBD");
			}
		} else {
			fn_ButtonControl("INBD");
		}
		// 통화시간이 2초 미만, 후처리 남길필요 없음
		return;
	} else if ((e.callee).indexOf("*") != -1) {
		trace("(e.callee)"+(e.callee));
		return;	// 잘못된 명령어
	}
	
	
	var objPop = application.popupframes["CnslMgmtPopTelRcv"];
	if ( !gfn_isNull(objPop) ) {
		objPop.form.close();
	}
	
	if ( e.caller == "#####" ) {
		//
	} else {
		//
	}
	trace("[pass return]");
	fn_ButtonControl("HANG");
	
	this.setTimer(8, 1500);
	
	/*
	SCCti.actionPBX("DoNotAct", "", {mode:"ETC"});
	this.setTimer(3, 62000);
	this.setTimer(4, 1000);
	*/
	
}

function fn_getPBXServer() {
	div_download.visible = true;
	this.updateWindow();
	vFile.open("WebPBX.exe", VirtualFile.openWrite); //내문서로 다운로드 받음. 파일명 지정함.
	httpObj.download("https://hwfc.hanwhafoodist.co.kr/install/pbx/WebPBX.exe", vFile, false);
	//httpObj.download("http://172.16.1.121:8091/install/pbx/WebPBX.exe", vFile, false);
}

function httpObj_onload(obj:HttpObject, e:HttpObjLoadEventInfo) {
	trace("httpObj_onload");
	div_download.visible = false;
	
	var path = system.convertRealPath("%DOCUMENT%")+"WebPBX.exe";
	var extComm = new ExtCommon();
	var bSucc = extComm.executeProcess(path,"","");
	trace(bSucc);
	
	gfn_alert("프로그램 설치를 위해 상담관리 화면을 닫습니다. \r\n프로그램이 설치가 완료된 후 \r\n[상담관리] 화면을 다시 열어주세요.");
	
	this.getOwnerFrame().form.close();
}

function httpObj_onstatus(obj:HttpObject, e:HttpObjStatusEventInfo) {
	this.updateWindow();
	div_download.prb_down.pos = e.status;
	div_download.prb_down.text = e.status+"%";
}

function fn_initPBX() {
	trace("call DoAct & logOut");
	//SCCti.actionPBX("DoAct");
	WebPBX.DoAct();
	trace("call WebPBX.DoAct()");
	this.setTimer(6, 2000);
}

var isLast = false;
function fn_close() {
	trace("##close##");
	fn_initPBX();
	
	return isLast;	// 지연처리
}

function CnslMgmt_onclose(obj:Form, e:CloseEventInfo) {
	trace("CnslMgmt_onclose");
}

function fn_checkStatus() {
	this.setTimer(5, 4000);	// 4초 후 상태확인후 미대기상태시 재로그인
}

function fn_checkSetStatus() {
    //웹서비스 호출
	//var url = "/agents?cmd=state&format=json&comp_id=5&agent_id=";
	var url = "/joysys/rest/TUserInfo/UserList/";
	
	//CTI 서버 호출 : 업무에 맞게 파라미터 조정
	var callParams = url;
	
    var strSvcID    = "ctiCall";
    var strURL      = "sc/cmn/ctiCall.xdo";
    var strInDs     = "";
    var strOutDs    = "";
    var strArg      = "ctiParams=" + wrapQuote(callParams);
    var strCallback = "fn_callBack";
    var bAsync      = false;
    
    gfn_transaction(this, strSvcID, strURL, strInDs, strOutDs, strArg, strCallback, bAsync);
}

function Static01_onclick(obj:Static,  e:ClickEventInfo) {
	SCCti.actionPBX("DoAct");
}

function fn_setWaitCursor(bAction) {
	if ( bAction ) {
		this.setWaitCursor(true, true);
		this.setTimer(7, 3000);
	} else {
		this.killTimer(7);
		this.setWaitCursor(false, true);
	
	}
}
function WebPBX_OnRequestResult(obj:ActiveX, e)
{
	
}

function btn_check_onclick(obj:Button,  e:ClickEventInfo) {
	fn_checkSetStatus();
}
]]></Script>
  </Form>
</FDL>
