<?xml version="1.0" encoding="utf-8"?>
<FDL version="1.5">
  <TypeDefinition url="..\default_typedef.xml"/>
  <Form id="Frm_Main" classname="Frm_Main" left="0" top="0" width="541" height="363" titletext="New Form" onload="Frm_Main_onload">
    <Layouts>
      <Layout>
        <FileUpload id="FileUpload00" taborder="0" retry="0" index="0" left="8" top="26" width="452" height="80" style="itemheight:35;buttonsize:40;buttonbackground:darkorange;buttoncolor:black;buttontext:Find;font:antialias 10 Helvetica;" onsuccess="FileUpload00_onsuccess" onerror="FileUpload00_onerror" multiselect="true"/>
      </Layout>
    </Layouts>
    <Objects>
      <Dataset id="Dataset00" firefirstcount="0" firenextcount="0" useclientlayout="false" updatecontrol="true" enableevent="true" loadkeymode="keep" loadfiltermode="keep" reversesubsum="false">
        <ColumnInfo>
          <Column id="FILENAME" type="STRING" size="256"/>
          <Column id="SIZE" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_msg" firefirstcount="0" firenextcount="0" useclientlayout="false" updatecontrol="true" enableevent="true" loadkeymode="keep" loadfiltermode="keep" reversesubsum="false">
        <ColumnInfo>
          <Column id="MSG" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
    </Objects>
    <Script type="xscript5.0"><![CDATA[//*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*
// ファイルアップロードダウンロードサンプル
//
//   ファイルアップロードダウンロードのコードサンプルになります。
//   Typedefinitionにnexacro.FileUpload,nexacro.FileDownloadが
//   追加されていることに留意してください。
//
//*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*


//************************************************************
// ファイルアップロードダウンロードサンプルの初期化
//************************************************************
//------------------------------------------------------------
// FormOnloadイベント
//  
// サーバーにアップロードされているファイル群をデータセットに取得します。
//
//------------------------------------------------------------
this.Frm_Main_onload = function(obj:Form, e:nexacro.LoadEventInfo)
{
	// PATH : サーバーのファイルの位置をパラメータで指定
	//this.transaction("getFile", "SVC::fileServer.jsp?PATH=sampleFile","","Dataset00=outds","","fn_callback");
}

//************************************************************
// ファイルアップロード
//************************************************************
//------------------------------------------------------------
// アップロードボタン押下イベント
//  
//------------------------------------------------------------
this.Btn_upload_onclick = function(obj:Button,  e:nexacro.ClickEventInfo)
{
	var strLogoFilePath = this.FileUpload00.value;
	if (this.gfn_IsNull(strLogoFilePath)){
		this.alert("ファイルを指定してください。");
		return true;
	}
	// URLの指定では引数としてアップロードするパスを渡しています。->PATH
	this.FileUpload00.set_uploadurl("SVC::fileUpload.jsp?PATH=sampleFile");
	this.FileUpload00.upload();
}

this.FileUpload00_onsuccess = function(obj:FileUpload,  e:nexacro.FileUploadEventInfo)
{
	this.alert("アップロード成功");
	
	var dstList = e.datasets;
	trace(e.datasets.length);
	trace(e.datasets[0].saveXML());

	var strFileName = e.datasets[0].getColumn(0, "fileName");
	var fileSize = e.datasets[0].getColumn(0, "fileSize");
	var nRow = this.Dataset00.addRow();
	this.Dataset00.setColumn(nRow, "FILENAME", strFileName);
	this.Dataset00.setColumn(nRow, "SIZE", fileSize);
	
//	this.FileUpload00.deleteItem(0);
}

this.FileUpload00_onerror = function(obj:FileUpload,  e:nexacro.FileUploadErrorEventInfo)
{
	this.alert("アップロード失敗");
}

//--------------------------------------------------------------------------------
// ファイルダウンロード関数
// 　データセットのファイル名情報からファイルダウンロードをする。
//--------------------------------------------------------------------------------
this.fn_fileDownload = function(){
	var curRow = this.Dataset00.rowposition;
	if (curRow < 0){
		this.alert("ダウンロードファイルするファイルリストがありません。");
		return true;
	}
	var strFileName = this.Dataset00.getColumn(curRow,"FILENAME");

	// ファイルダウンロードサービスにパラメータで
	// ファイルのあるパス(PATH)とファイル名(file)を渡し、
	// クライアントにファイルを転送してもらう。
//	this.FileDownload00.set_downloadurl("SVC::fileDownload.jsp?PATH=sampleFile&file="+strFileName);
	this.FileDownload00.set_downloadurl("SVC::fileDownload2.jsp?PATH=sampleFile&file="+strFileName);
	var bSucc = this.FileDownload00.download();
}

//--------------------------------------------------------------------------------
// ファイルダウンロードのイベント(FileDownload)
//--------------------------------------------------------------------------------
this.FileDownload00_onclick = function(obj:FileDownload,  e:nexacro.ClickEventInfo)
{
	this.fn_fileDownload() ;
}

//--------------------------------------------------------------------------------
// ファイルダウンロードのイベント(Button)
//--------------------------------------------------------------------------------
this.Btn_download_onclick = function(obj:Button,  e:nexacro.ClickEventInfo)
{
	this.fn_fileDownload() ;
}



this.FileDownload00_onsuccess = function(obj:FileDownload,  e:nexacro.FileDownloadEventInfo)
{
	trace(obj.name+":"+e.eventid);
	this.alert("ダウンロード成功");
}

this.FileDownload00_onerror = function(obj:FileDownload,  e:nexacro.FileDownloadErrorEventInfo)
{
	trace(obj.name+":"+e.eventid+":"+e.errormsg);
	var	idx ;
	idx = this.ds_msg.addRow();
	this.ds_msg.setColumn(idx,"MSG",e.eventid);

	idx = this.ds_msg.addRow();
	this.ds_msg.setColumn(idx,"MSG",e.errormsg);

	idx = this.ds_msg.addRow();
	this.ds_msg.setColumn(idx,"MSG",e.errortype);
	
}


//------------------------------------------------------------
// トランザクションコールバック 
//------------------------------------------------------------
this.fn_callback = function (strID, strErrCode, strErrMsg)
{
	alert(strID + "[" + strErrCode + "] " + strErrMsg);
	if(strErrCode < 0){
		return true;
	}

	if (strID == "getFile"){
		trace(this.Dataset00.saveXML());
		return true;
	}
}


//------------------------------------------------------------
// 統合nullチェック
//------------------------------------------------------------
this.gfn_IsNull = function (objValue){
	if(objValue == undefined) return true;
	if(objValue == null) return true;
	if(objValue == "") return true;
	return false;
}

]]></Script>
  </Form>
</FDL>
