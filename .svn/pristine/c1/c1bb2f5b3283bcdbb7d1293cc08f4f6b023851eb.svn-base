<?xml version="1.0" encoding="euc-kr"?>
<query dynamic="true">
	<type>select</type>
	<description><![CDATA[]]></description>
	<reload>true</reload>
	<monitoring>true</monitoring>
	<result-count>1</result-count>
	<statement>
SELECT A.ITEM_CODE
      ,A.ITEM_NAME
      ,D.FEATURE_NAME
      ,A.ITEM_SIZE
      ,A.PO_UOM
      ,NVL(B.OP_PRICE,0) AS ITEM_PRICE
      ,A.KG_CONVERT_RATE
      ,NVL(B.G_ITEM_PRICE,0) AS G_ITEM_PRICE
     /* ,C.RESTRICT_START
      ,C.RESTRICT_END
      ,C.RESTRICT_REASON
      ,C.RESTRICT_PERIOD
      ,C.CNL_START
      ,C.CNL_END
      ,C.CNL_REASON
      ,C.CNL_PERIOD*/
      ,B.SALE_PRICE
      ,B.OP_RATE
  FROM
       (
	SELECT	A.ITEM_CODE,	A.ITEM_NAME,	A.ITEM_SIZE,	A.PO_UOM,	A.KG_CONVERT_RATE
		,B.CAL,		B.WATER,	B.PROT,		B.FAT,		B.CARBO
		,B.FIBER,	B.ASH,		B.CA,		B.P,		B.FE
		,B.NA,		B.K,		B.VITA_A,	B.RETIN,	B.B_CAROT
		,B.THIA,	B.RIBO,		B.NIACIN,	B.VITA_C,	B.CHOLE, B.DISUSE_RATE
		,A.ITEM_CLASS1,A.ITEM_CLASS2,A.ITEM_CLASS3,A.ITEM_CLASS4
	FROM (		SELECT	B.ITEM_CODE,	B.ITEM_NAME,	B.ITEM_SIZE,	B.PO_UOM,	B.TAX_CODE,	B.KG_CONVERT_RATE
				,B.ITEM_CLASS1,B.ITEM_CLASS2,B.ITEM_CLASS3,B.ITEM_CLASS4
			FROM	HLDC_PO_ITEM_MST B,
				    HLDC_PO_TREAT_UPJANG A
			WHERE   A.ITEM_CODE = B.ITEM_CODE
			AND B.ITEM_CODE BETWEEN '010000000000' AND '019999999999'
			AND A.UPJANG = (SELECT C.AP_UNITPRICE_UPJANG FROM HLDC_ST_UPJANG C WHERE C.UPJANG = #UPJANG#)
			AND A.USE_YN = 'Y' AND B.USE_YN = 'Y'
			UNION ALL
			SELECT A.ITEM_CODE,	A.ITEM_NAME,	A.ITEM_SIZE,	A.PO_UOM,	A.TAX_CODE,	A.KG_CONVERT_RATE
				 ,A.ITEM_CLASS1,A.ITEM_CLASS2,A.ITEM_CLASS3,A.ITEM_CLASS4
			FROM	FMP_OTCUST_ITEM A,
				    FMP_OTCUST_PRICE_AVA_V B,
				(
				SELECT UPJANG, ITEM_CODE, MAX(SDATE) AS SDATE
				FROM FMP_OTCUST_PRICE_AVA_V
				WHERE UPJANG = (SELECT Z.OTCUST_PRICE_UPJANG FROM FMS_UPJANG Z WHERE Z.UPJANG = #UPJANG#)
				AND SDATE &lt;= NVL(#MENU_DATE#,TO_CHAR(SYSDATE,'YYYYMMDD'))
				GROUP BY UPJANG, ITEM_CODE
				) C
			WHERE	A.ITEM_CODE	= B.ITEM_CODE
			AND	B.UPJANG	= C.UPJANG
			AND	B.SDATE		= C.SDATE
			AND	B.ITEM_CODE	= C.ITEM_CODE
			AND	A.USE_YN	= 'Y'
			AND	B.USE_YN	= 'Y'
			) A,
			(	SELECT	ITEM_CODE, CAL, WATER, PROT, FAT, CARBO, FIBER, ASH, CA, P, FE, NA, K, VITA_A, RETIN, B_CAROT, THIA, RIBO, NIACIN, VITA_C, CHOLE, DISUSE_RATE
			FROM	FMP_ITEM_NUT
			WHERE	UPJANG = #UPJANG#
			UNION ALL
			(
				SELECT	ITEM_CODE, CAL, WATER, PROT, FAT, CARBO, FIBER, ASH, CA, P, FE, NA, K, VITA_A, RETIN, B_CAROT, THIA, RIBO, NIACIN, VITA_C, CHOLE, DISUSE_RATE
				FROM	FSI_ITEM_NUT
				MINUS
				SELECT	ITEM_CODE, CAL, WATER, PROT, FAT, CARBO, FIBER, ASH, CA, P, FE, NA, K, VITA_A, RETIN, B_CAROT, THIA, RIBO, NIACIN, VITA_C, CHOLE, DISUSE_RATE
				FROM	FMP_ITEM_NUT
				WHERE	UPJANG = #UPJANG#
			)
		) B
	WHERE A.ITEM_CODE = B.ITEM_CODE(+)
       )A
     ,(
        SELECT /*+ USE_HASH(A C) */ A.UPJANG, A.ITEM_CODE
             , A.UNIT_PRICE, A.SALE_PRICE, NVL(C.OP_RATE,0) OP_RATE
             , DECODE(NVL(C.OP_PRICE, 0), 0, SCC_CEIL(A.SALE_PRICE + (A.SALE_PRICE * NVL(C.OP_RATE,0) / 100),C.CEIL_VAL), C.OP_PRICE) OP_PRICE
             , ROUND(DECODE(NVL(C.OP_PRICE, 0), 0, SCC_CEIL(A.SALE_PRICE + (A.SALE_PRICE * NVL(C.OP_RATE,0) / 100),C.CEIL_VAL), C.OP_PRICE) / KG_CONVERT_RATE/1000,2) AS G_ITEM_PRICE
          FROM (
                SELECT A.ITEM_CODE, A.OP_RATE, A.CEIL_VAL, A.OP_PRICE 
                  FROM FMU_OP_RATE A
                 WHERE UPJANG = #UPJANG#
                   AND #MENU_DATE# BETWEEN SDATE AND EDATE
                   AND A.USE_YN = 'Y'
                ) C
               , (SELECT Z.*, #UPJANG# AS UPJANG, TO_CHAR(SYSDATE, 'YYYYMMDD') AS NEED_DATE FROM FMS_ITEM_V Z) B
               ,(
			     SELECT /*+ INDEX_DESC(A PO_CONTRACT_FSALE_PK) */ #UPJANG# AS UPJANG , 
				    NVL(#MENU_DATE#, TO_CHAR(SYSDATE,'YYYYMMDD' ) ) AS NEED_DATE , 
				    A.ITEM_CODE, A.CONTRACT_PRICE AS UNIT_PRICE, A.SALE_PRICE, A.CENTER_CODE, A.CUSTCD 
			       FROM HLDC_PO_CONTRACT_FSALE A 
			       WHERE A.CENTER_CODE = 
					   ( 
					   SELECT A.CENTER_CODE 
					     FROM HLDC_PO_UPJANG_CENTER A, HLDC_ST_UPJANG B 
					    WHERE A.UPJANG = B.AP_UNITPRICE_UPJANG 
					      AND B.UPJANG = #UPJANG# 
					   ) 
				       AND A.UPJANG = 
					   ( 
					   SELECT AP_UNITPRICE_UPJANG 
					     FROM HLDC_ST_UPJANG 
					    WHERE UPJANG = #UPJANG# 
					   ) 
				       AND NVL( #MENU_DATE#, TO_CHAR(SYSDATE,'YYYYMMDD' ) ) BETWEEN A.CONTRACT_START AND NVL(A.CONTRACT_END,'20201231') 
				AND A.SALE_PRICE > 0 
				AND A.USE_YN = 'Y' 
				AND EXISTS 
				    ( 
				    SELECT 1 
				      FROM HLDC_PO_TREAT_UPJANG X 
				     WHERE X.ITEM_CODE = A.ITEM_CODE 
				       AND X.UPJANG = A.UPJANG 
				    ) 
                 -----------
                  UNION ALL
                 -----------
                 SELECT #UPJANG# AS UPJANG
                      , NVL(#MENU_DATE#, TO_CHAR(SYSDATE,'YYYYMMDD')) AS NEED_DATE
                      , A.ITEM_CODE, A.UNIT_PRICE, A.SALE_PRICE,0 CENTER_CODE,0 CUSTCD 
                   FROM FMP_OTCUST_PRICE_AVA_V A
                      ,(SELECT UPJANG, ITEM_CODE, MAX(SDATE) AS SDATE
                          FROM FMP_OTCUST_PRICE_AVA_V
                         WHERE UPJANG = (SELECT OTCUST_PRICE_UPJANG FROM FMS_UPJANG WHERE UPJANG = #UPJANG#)
                           AND SDATE &lt;= NVL(#MENU_DATE#, TO_CHAR(SYSDATE,'YYYYMMDD'))
                         GROUP BY UPJANG, ITEM_CODE) B
                  WHERE A.UPJANG = B.UPJANG
                    AND A.SDATE = B.SDATE
                    AND A.ITEM_CODE = B.ITEM_CODE
                    AND A.SALE_PRICE > 0
                    AND A.USE_YN = 'Y'
                ) A
         WHERE A.ITEM_CODE = B.ITEM_CODE
           AND B.ITEM_CODE BETWEEN C.ITEM_CODE(+) AND C.ITEM_CODE(+)||'9999'
      ) B -- 단가, g당 단가
     ,(
	SELECT  ITEM_CODE,
		(SELECT CODE_NAME FROM SCC_COMMON_CODE WHERE GROUP_CODE = 'FS0033' AND CODE = ITEM_FEATURE) AS FEATURE_NAME
	FROM    FSI_ITEM_FEATURE
	WHERE   (ITEM_CODE, CDATE) IN (
				      SELECT ITEM_CODE, MAX(CDATE) AS CDATE
				      FROM   FSI_ITEM_FEATURE
				      WHERE (1=1)
				      AND  (CENTER_CODE, CUSTCD, ITEM_CODE, APPLY_DATE) IN (
											   SELECT CENTER_CODE,
												  CUSTCD,
												  ITEM_CODE,
												  MAX(APPLY_DATE) AS APPLY_DATE
											    FROM  FSI_ITEM_FEATURE
											    WHERE  CENTER_CODE  = '300001'
											    AND  APPLY_DATE BETWEEN TO_CHAR(SYSDATE,'YYYYMMDD') AND TO_CHAR(ADD_MONTHS(TO_DATE(APPLY_DATE,'YYYYMMDD'),1)-1,'YYYYMMDD')
											    GROUP BY CENTER_CODE, CUSTCD, ITEM_CODE
					)
					GROUP BY ITEM_CODE
					)
      ) D --자재특성
 WHERE A.ITEM_CODE = B.ITEM_CODE(+)
   --AND A.ITEM_CODE = C.ITEM_CODE(+)
   AND A.ITEM_CODE = D.ITEM_CODE(+)
   --AND A.ITEM_CODE BETWEEN '010100000001' AND '019000000000'
 <isNotNull col="BIG_CODE">
   AND A.ITEM_CLASS2 =#BIG_CODE# || '0000'
 </isNotNull>
 <isNotNull col="MID_CODE">
   AND A.ITEM_CLASS3 =#MID_CODE# || '00'
 </isNotNull>
 <isNotNull col="SMALL_CODE">
   AND A.ITEM_CLASS4 =#SMALL_CODE#
 </isNotNull>
 <isNotNull col="ITEM_NAME">
   AND A.ITEM_NAME LIKE '%'|| #ITEM_NAME# ||'%'
 </isNotNull>	</statement>
	<input default-name="ds_Input">
	</input>
	<output default-name="ds_ListItem">
	</output>
</query>
