<?xml version="1.0" encoding="utf-8"?>
<FDL version="1.4">
  <TypeDefinition url="..\..\..\default_typedef.xml"/>
  <Form id="TestDiaryRegPop" classname="COMP_GUIDE_13" inheritanceid="" position="absolute 0 0 1040 664" titletext="시험일지등록" scrollbars="autoboth" onload="form_onload">
    <Layouts>
      <Layout>
        <Static id="Static06" text="w15" class="Guide01_AreaRed" visible="false" position="absolute 1025 0 1040 554" anchor="top right"/>
        <Static id="Static71" text="h15" class="Guide01_AreaRed" visible="false" position="absolute 5 649 1022 664" anchor="left bottom"/>
        <Div id="div_testDiary" taborder="40" text="div_testDiary" position="absolute 15 37 1025 649" style="border:0 none #808080ff ;">
          <Layouts>
            <Layout>
              <Static id="Static34" class="sta_WFDA_Labelbg" position="absolute 0 585 490 612" anchor="left top"/>
              <Static id="Static31" class="sta_WFDA_Labelbg" position="absolute 8 27 1010 54" anchor="left top"/>
              <Static id="Static49" class="sta_WFDA_Labelbg" position="absolute 8 1 1010 28" anchor="left top"/>
              <Static id="Static67" class="sta_WFDA_Labelbg" position="absolute 8 53 1010 80" anchor="left top"/>
              <Static id="Static26" text="접수번호" class="sta_WFDA_Label01" position="absolute 31 1 125 28" anchor="left top"/>
              <Static id="Static27" text="접수일자" class="sta_WFDA_Label01" position="absolute 31 27 125 54" anchor="left top"/>
              <Static id="Static15" text="검체명" class="sta_WFDA_Label01" position="absolute 31 53 125 80" anchor="left top"/>
              <Edit id="edt_specmNm" taborder="10" value="국진이빵" enable="true" position="absolute 127 56 486 77" anchor="left top" readonly="true" style="background:#ecececff;"/>
              <Edit id="edt_acceptdd" taborder="11" value="2014-12-01" enable="true" position="absolute 127 30 244 51" anchor="left top" style="background:#ecececff;align:center middle; :disabled {background:#e4e4e4ff;}" readonly="true"/>
              <Static id="Static02" text="의뢰기관" class="sta_WFDA_Label01" position="absolute 488 1 582 28" anchor="left top"/>
              <Edit id="edt_upjangNm" taborder="12" value="공주교도소" enable="true" position="absolute 584 4 1007 25" anchor="left top" readonly="true" style="background:#ecececff;"/>
              <Static id="Static03" text="판정일자" class="sta_WFDA_Label01" position="absolute 488 27 582 54" anchor="left top"/>
              <Static id="Static14" class="sta_WFDA_Labelbg" position="absolute 8 79 1010 106" anchor="left top"/>
              <Edit id="edt_reqNum" taborder="9" value="20141201-B0001" enable="true" position="absolute 127 4 244 25" anchor="left top" readonly="true" style="background:#ecececff;"/>
              <Static id="Static04" text="제품유형" class="sta_WFDA_Label01" position="absolute 488 53 582 80" anchor="left top"/>
              <Edit id="edt_specmTypeNm" taborder="13" value="특수용도식품 / 영아용 조제식 / 영아용 조제식" enable="true" position="absolute 584 56 1007 77" anchor="left top" readonly="true" style="background:#ecececff;"/>
              <Static id="Static00" class="sta_WFDA_Labelbg" position="absolute 8 105 1010 132" anchor="left top"/>
              <Edit id="edt_userNm" taborder="14" value="김대현" enable="true" position="absolute 127 108 334 129" anchor="left top" readonly="true" style="background:#ecececff;"/>
              <Static id="Static01" text="접수담당자" class="sta_WFDA_Label01" position="absolute 31 105 125 132" anchor="left top"/>
              <Static id="Static40" text="최종판정" class="sta_WFDA_Label01" position="absolute 488 105 582 132" anchor="left top"/>
              <Combo id="cbo_lastDecision" taborder="8" value="0" text="적합" codecolumn="code" datacolumn="codeName" index="0" position="absolute 584 108 733 129" anchor="left top" innerdataset="@ds_lastDecision" canitemchange="div_testDiary_cbo_lastDecision_canitemchange"/>
              <Static id="Static41" text="기본정보" onclick="Static41_onclick" class="sta_WFDA_Label03" position="absolute 0 1 32 132" anchor="left top"/>
              <Static id="Static05" text="h13" class="Guide01_AreaRed" visible="false" position="absolute 0 132 450 145" anchor="left top"/>
              <Static id="Static08" text="시험항목" class="sta_WF_Title01" position="absolute 0 145 450 163" anchor="left top"/>
              <Static id="Static16" text="글자기준간격 h05" class="Guide01_AreaRed" visible="false" position="absolute 0 158 450 163" anchor="left top"/>
              <Grid id="grd_testArticleList" taborder="1" binddataset="ds_testArticleList" autoenter="select" useinputpanel="false" cellsizingtype="col" autofittype="col" position="absolute 0 163 1010 213" anchor="all" onkillfocus="div_testDiary_grd_testArticleList_onkillfocus">
                <Formats>
                  <Format id="default">
                    <Columns>
                      <Column size="115"/>
                      <Column size="141"/>
                      <Column size="228"/>
                      <Column size="86"/>
                      <Column size="97"/>
                      <Column size="222"/>
                    </Columns>
                    <Rows>
                      <Row size="24" band="head"/>
                      <Row size="24"/>
                    </Rows>
                    <Band id="head">
                      <Cell text="항목명"/>
                      <Cell col="1" text="기준규격"/>
                      <Cell col="2" class="grd_WF_Essential" text="결과"/>
                      <Cell col="3" text="담당자"/>
                      <Cell col="4" class="grd_WF_Essential" text="판정"/>
                      <Cell col="5" class="grd_WF_Essential" text="비고"/>
                    </Band>
                    <Band id="body">
                      <Cell edittype="none" text="bind:articleNm"/>
                      <Cell col="1" displaytype="text" text="bind:basisStand"/>
                      <Cell col="2" displaytype="text" edittype="text" style="align: ;" text="bind:result" editdisplay="edit"/>
                      <Cell col="3" text="bind:procUserNm"/>
                      <Cell col="4" displaytype="combo" edittype="combo" text="bind:decision" editdisplay="display" combodataset="ds_decision" combocodecol="code" combodatacol="codeName" combodisplay="edit"/>
                      <Cell col="5" displaytype="text" edittype="text" style="align: ;" text="bind:remark" editdisplay="edit"/>
                    </Band>
                  </Format>
                </Formats>
              </Grid>
              <Static id="Static07" text="h13" class="Guide01_AreaRed" visible="false" position="absolute 0 213 450 226" anchor="left top"/>
              <Static id="Static09" text="시험방법" class="sta_WF_Title01" position="absolute 0 226 164 244" anchor="left top"/>
              <Static id="Static11" text="글자기준간격 h05" class="Guide01_AreaRed" visible="false" position="absolute 0 239 450 244" anchor="left top"/>
              <Grid id="grd_testDiaryList" taborder="2" binddataset="ds_testDiaryList" autoenter="select" useinputpanel="false" cellsizingtype="col" autofittype="col" position="absolute 0 244 1010 468" anchor="all" scrollbars="autoboth" autosizingtype="row" extendsizetype="row">
                <Formats>
                  <Format id="default">
                    <Columns>
                      <Column size="44"/>
                      <Column size="766"/>
                    </Columns>
                    <Rows>
                      <Row size="24" band="head"/>
                      <Row size="47"/>
                    </Rows>
                    <Band id="head">
                      <Cell text="No."/>
                      <Cell col="1" class="grd_WF_Essential" text="시험방법"/>
                    </Band>
                    <Band id="body">
                      <Cell text="expr:currow+1"/>
                      <Cell col="1" displaytype="text" edittype="textarea" style="align: ;" text="bind:testMethod" wordwrap="word" editscrollbar="fixedvert" editautoselect="true" editacceptsenter="true" autosizerow="limitmin"/>
                    </Band>
                  </Format>
                </Formats>
              </Grid>
              <Static id="Static12" text="h05" class="Guide01_AreaRed" visible="false" position="absolute 952 239 1010 244" anchor="top right"/>
              <Static id="Static13" text="h06" class="Guide01_AreaRed" visible="false" position="absolute 952 213 1010 219" anchor="top right"/>
              <Button id="btn_addTestArticleDiary" taborder="3" onclick="div_testDiary_btn_addTestArticleDiary_onclick" class="btn_WF_GrdPlus" position="absolute 972 219 990 239" anchor="top right" tooltiptext="추가"/>
              <Button id="btn_delTestArticleDiary" taborder="4" onclick="div_testDiary_btn_delTestArticleDiary_onclick" class="btn_WF_GrdMinus" position="absolute 992 219 1010 239" anchor="top right" tooltiptext="삭제"/>
              <Static id="Static17" text="w02" class="Guide01_AreaRed" visible="false" position="absolute 990 219 992 239" anchor="top right"/>
              <Static id="Static18" class="sta_WFDA_Labelbg" position="absolute 0 481 490 586" anchor="left top"/>
              <Static id="Static19" text="실험노트" class="sta_WFDA_Label01" position="absolute 31 481 125 586" anchor="left top"/>
              <TextArea id="txt_labBook" taborder="5" scrollbars="fixedvert" wordwrap="word" position="absolute 127 484 487 583" anchor="left top"/>
              <Static id="Static06" text="시험항목" class="sta_WFDA_Label01" position="absolute 31 79 125 106" anchor="left top"/>
              <Edit id="edt_articleNm" taborder="15" value="납" enable="true" position="absolute 127 82 486 103" anchor="left top" readonly="true" style="background:#ecececff;"/>
              <Static id="Static33" text="기술책임자" class="sta_WFDA_Label01" position="absolute 31 585 125 612" anchor="left top"/>
              <Combo id="cbo_techrespUser" taborder="6" innerdataset="@ds_userList" codecolumn="sabun" datacolumn="userNm" position="absolute 127 588 283 609" anchor="left top" class="cmb_WF_Essential" index="-1"/>
              <ObjCalendar id="cal_testdd" anchor="left top" titletext="캘린더" taborder="0" text="ObjCalendar00" scrollbars="none" position="absolute 584 30 688 51"/>
              <Static id="Static10" text="시험정보" onclick="Static41_onclick" class="sta_WFDA_Label03" position="absolute 0 481 32 612" anchor="left top"/>
              <Static id="Static20" text="h13" class="Guide01_AreaRed" visible="false" position="absolute 0 468 450 481" anchor="left top"/>
              <Static id="Static21" class="sta_WFDA_Labelbg" position="absolute 500 481 1010 612" anchor="left top"/>
              <ObjAtchFile id="ObjAtchFile" anchor="all" titletext="Attach File Object" taborder="7" position="absolute 511 482 999 603" enable="true"/>
              <Static id="Static32" text="w10" class="Guide01_AreaRed" visible="false" position="absolute 490 482 500 611" anchor="default"/>
              <Static id="Static22" text="w10" class="Guide01_AreaRed" visible="false" position="absolute 999 482 1009 611" anchor="default"/>
              <Static id="Static25" class="Guide01_AreaRed" visible="false" position="absolute 500 603 727 611" anchor="default"/>
              <Static id="Static23" text="w10" class="Guide01_AreaRed" visible="false" position="absolute 501 482 511 611" anchor="default"/>
              <Button id="btn_addSvrFile" taborder="16" text="서버사진" onclick="div_evntDtl_btn_addSvrFile_onclick" class="btn_WF_Function" position="absolute 733 492 798 512" anchor="top right"/>
            </Layout>
          </Layouts>
        </Div>
        <Static id="Static01" text="w15" class="Guide01_AreaRed" visible="false" position="absolute 0 0 15 341"/>
        <Static id="Static15" text="h10" class="Guide01_AreaRed" visible="false" position="absolute 15 0 1027 10"/>
        <Static id="sta_title" text="시험일지등록" class="sta_WF_Title" position="absolute 15 16 215 40"/>
        <Static id="Static00" text="h06" class="Guide01_AreaRed" visible="false" position="absolute 15 10 215 16"/>
        <Static id="Static04" text="h05" class="Guide01_AreaRed" visible="false" position="absolute 778 35 1025 40"/>
        <Button id="btn_close" taborder="42" text="닫기" onclick="fn_close" class="btn_WF_CRUD" position="absolute 980 10 1025 35" anchor="top right"/>
        <Static id="Static05" text="아이콘기준 h08" class="Guide01_AreaRed" visible="false" position="absolute 15 32 215 40"/>
        <Static id="Static20" text="W102" visible="false" position="absolute 978 10 980 35" anchor="top right" style="background:#ff000055;align:center middle;"/>
        <Button id="btn_save" taborder="43" text="저장" class="btn_WF_CRUD" position="absolute 933 10 978 35" anchor="top right" onclick="fn_save"/>
        <Static id="Static02" text="W102" visible="false" position="absolute 931 10 933 35" anchor="top right" style="background:#ff000055;align:center middle;"/>
        <Button id="btn_modify" taborder="44" text="수정" class="btn_WF_CRUD" position="absolute 886 10 931 35" anchor="top right" onclick="fn_modify"/>
      </Layout>
    </Layouts>
    <Bind>
      <BindItem id="item0" compid="div_testDiary.cbo_techrespUser" propid="value" datasetid="ds_testArticleList" columnid="techrespUser"/>
      <BindItem id="item1" compid="div_testDiary.txt_labBook" propid="value" datasetid="ds_testArticleList" columnid="labBook"/>
      <BindItem id="item2" compid="div_testDiary.cbo_lastDecision" propid="value" datasetid="ds_testArticleList" columnid="lastDecision"/>
      <BindItem id="item3" compid="div_testDiary.edt_userNm" propid="value" datasetid="ds_testArticleList" columnid="userNm"/>
      <BindItem id="item4" compid="div_testDiary.edt_articleNm" propid="value" datasetid="ds_testArticleList" columnid="articleNm"/>
      <BindItem id="item5" compid="div_testDiary.edt_specmTypeNm" propid="value" datasetid="ds_testArticleList" columnid="specmTypeNm"/>
      <BindItem id="item6" compid="div_testDiary.edt_specmNm" propid="value" datasetid="ds_testArticleList" columnid="specmNm"/>
      <BindItem id="item7" compid="div_testDiary.edt_acceptdd" propid="value" datasetid="ds_testArticleList" columnid="acceptdd"/>
      <BindItem id="item8" compid="div_testDiary.edt_upjangNm" propid="value" datasetid="ds_testArticleList" columnid="upjangNm"/>
      <BindItem id="item9" compid="div_testDiary.edt_reqNum" propid="value" datasetid="ds_testArticleList" columnid="acceptNum"/>
    </Bind>
    <Objects>
      <Dataset id="ds_testArticleList" firefirstcount="0" firenextcount="0" useclientlayout="true" updatecontrol="true" enableevent="true" loadkeymode="keep" loadfiltermode="keep" reversesubsum="false">
        <ColumnInfo>
          <Column id="reqNum" type="STRING" size="255"/>
          <Column id="reqDate" type="STRING" size="255"/>
          <Column id="acceptNum" type="STRING" size="255"/>
          <Column id="upjangNm" type="STRING" size="255"/>
          <Column id="acceptdd" type="STRING" size="255"/>
          <Column id="testdd" type="STRING" size="255"/>
          <Column id="specmNm" type="STRING" size="255"/>
          <Column id="specmTypeNm" type="STRING" size="255"/>
          <Column id="articleNm" type="STRING" size="255"/>
          <Column id="userNm" type="STRING" size="255"/>
          <Column id="lastDecision" type="STRING" size="255"/>
          <Column id="basisStand" type="STRING" size="255"/>
          <Column id="result" type="STRING" size="255"/>
          <Column id="sabun" type="STRING" size="255"/>
          <Column id="procUserNm" type="STRING" size="255"/>
          <Column id="decision" type="STRING" size="255"/>
          <Column id="remark" type="STRING" size="255"/>
          <Column id="labBook" type="STRING" size="255"/>
          <Column id="techrespUser" type="STRING" size="255"/>
          <Column id="refSeq" type="STRING" size="255"/>
          <Column id="completeYn" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_testDiaryList" firefirstcount="0" firenextcount="0" useclientlayout="true" updatecontrol="true" enableevent="true" loadkeymode="keep" loadfiltermode="keep" reversesubsum="false">
        <ColumnInfo>
          <Column id="reqNum" type="STRING" size="256"/>
          <Column id="acceptNum" type="STRING" size="256"/>
          <Column id="articleCd" type="STRING" size="256"/>
          <Column id="sabun" type="STRING" size="256"/>
          <Column id="seq" type="STRING" size="256"/>
          <Column id="testMethod" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_search" firefirstcount="0" firenextcount="0" useclientlayout="true" updatecontrol="true" enableevent="true" loadkeymode="keep" loadfiltermode="keep" reversesubsum="false">
        <ColumnInfo>
          <Column id="reqNum" type="STRING" size="256"/>
          <Column id="acceptNum" type="STRING" size="256"/>
          <Column id="articleCd" type="STRING" size="256"/>
          <Column id="sabun" type="STRING" size="256"/>
          <Column id="authCd" type="STRING" size="256"/>
        </ColumnInfo>
        <Rows>
          <Row/>
        </Rows>
      </Dataset>
      <Dataset id="ds_userList" firefirstcount="0" firenextcount="0" useclientlayout="false" updatecontrol="true" enableevent="true" loadkeymode="keep" loadfiltermode="keep" reversesubsum="false">
        <ColumnInfo>
          <Column id="sabun" type="STRING" size="255"/>
          <Column id="userNm" type="STRING" size="255"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_decision" firefirstcount="0" firenextcount="0" useclientlayout="false" updatecontrol="true" enableevent="true" loadkeymode="keep" loadfiltermode="keep" reversesubsum="false">
        <ColumnInfo>
          <Column id="code" type="STRING" size="256"/>
          <Column id="codeName" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_lastDecision" firefirstcount="0" firenextcount="0" useclientlayout="false" updatecontrol="true" enableevent="true" loadkeymode="keep" loadfiltermode="keep" reversesubsum="false">
        <ColumnInfo>
          <Column id="code" type="STRING" size="256"/>
          <Column id="codeName" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_file" preload="true" firefirstcount="0" firenextcount="0" useclientlayout="true" updatecontrol="true" enableevent="true" loadkeymode="keep" loadfiltermode="keep">
        <ColumnInfo>
          <Column id="refSeq" type="STRING" size="256"/>
          <Column id="appendSeq" type="STRING" size="256"/>
          <Column id="orgnlPath" type="STRING" size="256"/>
          <Column id="orgnlFileNm" type="STRING" size="256"/>
          <Column id="saveFileNm" type="STRING" size="256"/>
          <Column id="relPath" type="STRING" size="256"/>
          <Column id="fileSize" type="STRING" size="256"/>
          <Column id="fileExt" type="STRING" size="256"/>
          <Column id="encYn" type="STRING" size="256"/>
          <Column id="fileDesc" type="STRING" size="256"/>
          <Column id="fileUploadNm" type="STRING" size="256"/>
          <Column id="chk" type="INT" size="1"/>
          <Column id="preView" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_testArticleListValid" firefirstcount="0" firenextcount="0" useclientlayout="true" updatecontrol="true" enableevent="true" loadkeymode="keep" loadfiltermode="keep" reversesubsum="false">
        <ColumnInfo>
          <Column id="testdd" type="STRING" size="255"/>
          <Column id="techrespUser" type="STRING" size="256"/>
        </ColumnInfo>
        <Rows>
          <Row>
            <Col id="testdd">title:시험일자,required:true</Col>
            <Col id="techrespUser">title:기술책임자,required:true</Col>
          </Row>
        </Rows>
      </Dataset>
      <Dataset id="ds_testDiaryListValid" firefirstcount="0" firenextcount="0" useclientlayout="true" updatecontrol="true" enableevent="true" loadkeymode="keep" loadfiltermode="keep" reversesubsum="false">
        <ColumnInfo>
          <Column id="testMethod" type="STRING" size="256"/>
        </ColumnInfo>
        <Rows>
          <Row>
            <Col id="testMethod">title:시험방법,required:true</Col>
          </Row>
        </Rows>
      </Dataset>
    </Objects>
    <Script type="xscript4.0"><![CDATA[/*
  화 면 명 : TestDiaryRegPop
  파 일 명 : TestDiaryRegPop.xfdl
  기    능 : 시험일지등록
             자신으로 지정된 담당자에 한해 수정이 가능하다.
             1차 통합테스트 결과 기술책임자에도 수정권한을 부여 한다.

    수정일    수정자                  수정내용
  ----------   -------  --------------------------------------------------
  2015.03.20   jshoon   최초 생성
*/

/************************************************************************************************
 * 공통 라이브러리 INCLUDE 영역 (필수)
************************************************************************************************/
include "lib::lib_com.xjs";
include "lib::LimsUtil.xjs";

/************************************************************************************************
 * FORM 변수 선언 영역 (필수)
************************************************************************************************/
var fv_iProcessCnt = 0;  	// 저장건수를 저장한다.(Controller Class에서만 할당함.)
var curDate = gfn_today();
var bCompAuth = false;
var bCompleteYn = false;
var objArgs;
var fv_RefSeq;
var codeList = "DECISION,LAST_DECISION";

/************************************************************************************************
 * FORM EVENT 영역 (필수)
************************************************************************************************/
/*----------------------------------------------------------------------------------------------
 * 설명      : Form Load (필수)
 *---------------------------------------------------------------------------------------------*/
function form_onload(obj:Form, e:LoadEventInfo)
{
    // Form Load 시 공통 기능 처리(obj:Form, bCreateEvent:이벤트 생성 여부)
    // bCreateEvent -> false로 해야 Grid의 TextArea에 엔터키가 먹는다.
    gfn_formOnLoad(this, false);
    this.onkeydown.addHandler(fn_formKeyDown);

    objArgs = this.getOwnerFrame().fv_Contents;
    if (typeof objArgs != "undefined" && objArgs != null)
    {
        ds_search.setColumn(0, "reqNum", objArgs.reqNum);		// 의뢰번호
        ds_search.setColumn(0, "acceptNum", objArgs.acceptNum);	// 접수번호
        ds_search.setColumn(0, "articleCd", objArgs.articleCd);	// 시험항목
        ds_search.setColumn(0, "sabun", objArgs.sabun);	// 담당자사번
        if (objArgs.completeYn == 'Y')	// 시험완료 승인이 났으면...
        {
            bCompleteYn = true;
        }
        bCompAuth = objArgs.diaryWriteYn;	// 일지작성 여부
    }

    // 초기값 셋팅
    fn_init();
}

/*----------------------------------------------------------------------------------------------
 * 설명      : 초기값 셋팅
 *---------------------------------------------------------------------------------------------*/
function fn_init()
{
    // 화면의 Combo 처리
//     SCCombo.bind(this, "ComCode", "ds_decision", ds_decision, {groupCode:"DECISION", useYn:"Y"});
//     SCCombo.bind(this, "ComCode", "ds_lastDecision", ds_lastDecision, {groupCode:"LAST_DECISION", useYn:"Y"}, SCCombo.CHOOSE);

	// LIMS 권한 세팅
	LimsUtil.setLimsAuthLevels (this);

	// 사용 코드를 한번에 가져와서 Dataset에 순차적으로 binding 시킨다.
	LimsUtil.selectCodeBatchList(this, null, codeList);

    div_testDiary.cal_testdd.fn_initMonthCal(this, curDate, "", ds_testArticleList, "testdd", "Y");

    fn_selectInsptUser();	// 검사항목리스트에 보여질 검사자 조회 후 DataSet Setting

    //fn_setModifyAuthCheck(bCompAuth);

    // 첨부파일 연결
    div_testDiary.ObjAtchFile.setDataset("ds_file");
    //div_testDiary.ObjAtchFile.grd_file.oncellclick.clear();
    //div_testDiary.ObjAtchFile.grd_file.setFormatColProperty(3, 'size', '0');

    fn_search();
}

/*----------------------------------------------------------------------------------------------
 * 설명      : 공통코드 binding 조회 후 callback function
 *---------------------------------------------------------------------------------------------*/
function fn_codeBatchCallback()
{
	ds_lastDecision.insertRow(0);
	ds_lastDecision.setColumn(0, "code", "");
	ds_lastDecision.setColumn(0, "codeName", "");
}

/*----------------------------------------------------------------------------------------------
 * 설명      : 화면 닫기 전 변경 유무 체크 (필수-Frame에서 창 닫힐때 호출됨)
 *---------------------------------------------------------------------------------------------*/
function fn_close()
{
    this.close("OK");
}

/************************************************************************************************
 * 공통기능 FUNCTION 영역 (필수)
************************************************************************************************/
/*----------------------------------------------------------------------------------------------
 * 설명      : 조회 (필수-공통버튼에서 호출됨)
 *---------------------------------------------------------------------------------------------*/
function fn_search()
{
    if (gfn_isNull(objArgs))
    {
        gfn_alert("의뢰번호가 없습니다.\n확인하여 주십시오!");
        return;
    }
    
    ds_testArticleList.clearData();
    ds_testDiaryList.clearData();
    ds_file.clearData();

    var strSvcID    = "selectList";
    var strURL      = "ls/ltm/testResultInquery/selectTestDiaryList.xdo";
    var strInDs     = "ds_search=ds_search:A";
    var strOutDs    = "ds_testArticleList=ds_testArticleList ds_testDiaryList=ds_testDiaryList ds_file=ds_file";
    var strArg      = "";
    var strCallback = "fn_callBack";
    var bAsync      = true;

    gfn_transaction(this, strSvcID, strURL, strInDs, strOutDs, strArg, strCallback, bAsync);
}

/*----------------------------------------------------------------------------------------------
 * 설명      : 저장버튼 클릭
 *---------------------------------------------------------------------------------------------*/
function fn_save()
{
    // 자료를 저장 하시겠습니까?
    if (!gfn_confirm("confirm.before.save")) return false;

    // 저장시 Validation Check
    if (gfn_validCheck(ds_testArticleList, ds_testArticleListValid) == false)	return;
    if (gfn_validCheck(ds_testDiaryList, ds_testDiaryListValid) == false)	return;

	// 판정결과는 필수에서 제외 시킨다.
// 	if (ds_testArticleList.getColumn(ds_testArticleList.rowposition, "lastDecision") != "" &&
// 	    ds_testArticleList.getColumn(ds_testArticleList.rowposition, "decision") == "")
// 	{
// 		gfn_alert("판정내역을 선택하여 주십시오!");
// 		return;
// 	}

    if (ds_testDiaryList.rowposition == -1)
    {
        gfn_alert("시험방법을 등록하여 주십시오!");
        return;
    }

    // 첨부파일 여부를 체크한다.
    // 첨부 파일 추가가 있을때만
    if (div_testDiary.ObjAtchFile.fn_countDs("insert") > 0)
    {
        //var rtn = div_testDiary.ObjAtchFile.fn_uploadFile();
        var rtn = fn_uploadFile();
        if (rtn < 0)	return;

        if (ds_testArticleList.getRowType(ds_testArticleList.rowposition) == Dataset.ROWTYPE_NORMAL)
        {
            ds_testArticleList.updatecontrol = false;
            ds_testArticleList.setRowType(ds_testArticleList.rowposition, Dataset.ROWTYPE_UPDATE);
            ds_testArticleList.updatecontrol = true;
        }
    }
    
    ds_testDiaryList.updatecontrol = false;
    for (var i = 0; i < ds_testDiaryList.getRowCount(); i++) 
    {
		if (ds_testDiaryList.getRowType(i) != Dataset.ROWTYPE_DELETE)
		{
			ds_testDiaryList.setRowType(i, Dataset.ROWTYPE_INSERT);
		}
	}
	ds_testDiaryList.updatecontrol = true;

    if (!gfn_dsIsUpdated(ds_testArticleList) && !gfn_dsIsUpdated(ds_testDiaryList) && !gfn_dsIsUpdated(ds_file))
    {
        gfn_alert("msg.save.nochange");	// 변경된 내역이 없습니다.
        return;
    }

    var strSvcID    = "saveList";
    var strURL      = "ls/ltm/testResultInquery/saveList.xdo";
    var strInDs     = "ds_search=ds_search:A ds_testArticleList=ds_testArticleList:U ds_testDiaryList=ds_testDiaryList:A ds_file=ds_file:A";
    var strOutDs    = "";
    var strArg      = "";
    var strCallback = "fn_callBack";
    var bAsync      = true;

    //trace(ds_specmArticleList.saveXML());

    gfn_transaction(this, strSvcID, strURL, strInDs, strOutDs, strArg, strCallback, bAsync);
}

/*----------------------------------------------------------------------------------------------
 * 설명   : 파일 업로드
 *---------------------------------------------------------------------------------------------*/
function fn_uploadFile()
{
    var v_bSuccess = false;
    var v_sUrl = "svc::sc/cmn/uploadFile.do?" + gfn_getGlobalVariableUrl(); //공통변수 추가 by kksoo
    var nRow;

    this.setWaitCursor(true);

    // FileUpload 사용 첨부파일 전체 업로드 : (FileUpload)_callback에서 Dataset 사용하기 위해
    for (var i = 0; i < ds_file.getRowCount(); i++) {
        if (ds_file.getRowType(i) == 2) {
            if (gfn_isNull(ds_file.getColumn(i, "preView"))) {
                div_testDiary.ObjAtchFile.fileUpload.appendItem();
                nRow = div_testDiary.ObjAtchFile.ds_uploadFile.addRow();
                div_testDiary.ObjAtchFile.ds_uploadFile.copyRow(nRow, ds_file, i);
            } else {
				ds_file.setRowType(i, Dataset.ROWTYPE_NORMAL);
            }
        }
    }

    div_testDiary.ObjAtchFile.fileUpload.innerdataset = "ds_uploadFile";
    div_testDiary.ObjAtchFile.fileUpload.filecolumn   = "orgnlPath";

    v_bSuccessUpload = div_testDiary.ObjAtchFile.fileUpload.upload(v_sUrl);
    if (v_bSuccessUpload) {
        v_bSuccess = true;
    }

    this.setWaitCursor(false);
    return v_bSuccess;
}

/************************************************************************************************
 * TRANSACTION 및 CallBack 영역 (필수)
************************************************************************************************/
/*----------------------------------------------------------------------------------------------
 * 설명      : 트랜잭션 콜백 함수 (필수)
 *---------------------------------------------------------------------------------------------*/
function fn_callBack(strSvcID, nErrorCode, strErrorMsg)
{
    // 에러시 gfn_callBack에서 메시지 제공, 화면별 특정 에러 발생시에만 사용하세요.
    if (nErrorCode < 0)
    {
        return;
    }

    switch(strSvcID)
    {
        // 조회
        case "selectList" :
            fn_setModifyAuthCheck(false);
            if (gfn_isNull(div_testDiary.cal_testdd.fn_getValue()))
            {
                div_testDiary.cal_testdd.fn_setValue(curDate);
            }
            
            // 기술책임자가 없으면 첫번째 사람으로 세팅
            if (gfn_isNull(ds_testArticleList.getColumn(0, "techrespUser"))) {
                //담당자관리에서 기술책임자로 선택되 있는 모든 사람 표시 20171218
				div_testDiary.cbo_techrespUser.index = 0;
			}
            break;
        case "selectInsptUserList" :	// 기술책임자
            break;
        // 저장
        case "saveList" :
            if (fv_iProcessCnt > 0) gfn_alert("msg.save.success");	// 저장 되었습니다.

            fn_setModifyAuthCheck(false);

            fn_search();
            break;
    }
}

/************************************************************************************************
 * 사용자 FUNCTION 영역 (필수)
************************************************************************************************/
/*----------------------------------------------------------------------------------------------
 * 설명      : 시험 기술책임자 조회
 *---------------------------------------------------------------------------------------------*/
function fn_selectInsptUser()
{
    ds_search.setColumn(0, "authCd", "105");	// 기술책임자

    var strSvcID    = "selectInsptUserList";
    var strURL      = "ls/lcm/userMgmt/selectUserList.xdo";
    var strInDs     = "ds_search=ds_search:A";
    var strOutDs    = "ds_userList=ds_userList";
    var strArg      = "";
    var strCallback = "fn_callBack";
    var bAsync      = true;

    gfn_transaction(this, strSvcID, strURL, strInDs, strOutDs, strArg, strCallback, bAsync, false);
}

/*----------------------------------------------------------------------------------------------
 * 설명      : 수정버튼 클릭 폼 활성화
 *---------------------------------------------------------------------------------------------*/
function fn_modify()
{
    fn_setModifyAuthCheck(true);
}

/*----------------------------------------------------------------------------------------------
 * 설명      : 일지작성 권한 체크 세팅
 *---------------------------------------------------------------------------------------------*/
function fn_setModifyAuthCheck(bCompAuth)
{
    //trace(bCompleteYn + " , " + gfn_nvl(ds_testArticleList.getColumn(ds_testArticleList.rowposition, "completeYn"), 'N'));
    if (bCompleteYn == true || gfn_nvl(ds_testArticleList.getColumn(ds_testArticleList.rowposition, "completeYn"), 'N') == 'Y')
    {
        btn_save.enable = false;
        btn_modify.enable = false;
        div_testDiary.btn_addSvrFile.enable = false;
        div_testDiary.ObjAtchFile.btn_addFile.enable = false;
        div_testDiary.ObjAtchFile.btn_delFile.enable = false;
        div_testDiary.ObjAtchFile.grd_file.setCellProperty('body', 3, 'edittype', 'none');
    }
    else if (bCompAuth == false)
    {
        // 자신것이 아니면 false
        if (objArgs.sabun != gfn_getUserId())
        {
            objArgs.modifyYn = false;
        }
        // 기술책임자면 true
        if (gds_limsAuthLevels.findRow('authCd', '105') != -1)
        {
            objArgs.modifyYn = true;
        }
        
        btn_save.enable = false;
        btn_modify.enable = (objArgs.modifyYn == undefined?true:(objArgs.modifyYn==true?true:false));
        div_testDiary.btn_addSvrFile.enable = false;
        div_testDiary.ObjAtchFile.btn_addFile.enable = false;
        div_testDiary.ObjAtchFile.btn_delFile.enable = false;
        div_testDiary.ObjAtchFile.grd_file.setCellProperty('body', 3, 'edittype', 'none');
        //div_testDiary.ObjAtchFile.btn_multiDown.enable = false;
    }
    else if (bCompAuth == true)
    {
		// 기술책임자면 true
        btn_save.enable = (objArgs.sabun != gfn_getUserId()?(gds_limsAuthLevels.findRow('authCd', '105') != -1?true:false):true);
        btn_modify.enable = false;
        div_testDiary.btn_addSvrFile.enable = (objArgs.sabun != gfn_getUserId()?(gds_limsAuthLevels.findRow('authCd', '105') != -1?true:false):true);
        div_testDiary.ObjAtchFile.btn_addFile.enable = (objArgs.sabun != gfn_getUserId()?(gds_limsAuthLevels.findRow('authCd', '105') != -1?true:false):true);
        div_testDiary.ObjAtchFile.btn_delFile.enable = (objArgs.sabun != gfn_getUserId()?(gds_limsAuthLevels.findRow('authCd', '105') != -1?true:false):true);
        div_testDiary.ObjAtchFile.grd_file.setCellProperty('body', 3, 'edittype', 'normal');
        //div_testDiary.ObjAtchFile.btn_multiDown.enable = true;
    }
    var objSkipComp = [
        "edt_reqNum"
       ,"edt_upjangNm"
       ,"edt_acceptdd"
       ,"edt_specmNm"
       ,"edt_specmTypeNm"
       ,"edt_specmNm"
       ,"edt_articleNm"
       ,"edt_userNm"
       ,"btn_addSvrFile"
    ];
    LimsUtil.setComponentAuth(this.div_testDiary, bCompAuth, objSkipComp);
}

/*----------------------------------------------------------------------------------------------
 * 설명      : 시험방법 추가버튼 클릭
 *---------------------------------------------------------------------------------------------*/
function div_testDiary_btn_addTestArticleDiary_onclick(obj:Button,  e:ClickEventInfo)
{
    var nIdx = ds_testDiaryList.addRow();
    div_testDiary.grd_testDiaryList.setCellPos(nIdx);
    div_testDiary.grd_testDiaryList.showEditor(true);
}

/*----------------------------------------------------------------------------------------------
 * 설명      : 시험방법 삭제버튼 클릭
 *---------------------------------------------------------------------------------------------*/
function div_testDiary_btn_delTestArticleDiary_onclick(obj:Button,  e:ClickEventInfo)
{
    ds_testDiaryList.deleteRow(ds_testDiaryList.rowposition);
}

/*----------------------------------------------------------------------------------------------
 * 설명      : 판정내역 없이 최종판정 선택 시
 *---------------------------------------------------------------------------------------------*/
function div_testDiary_cbo_lastDecision_canitemchange(obj:Combo, e:ItemChangeEventInfo)
{
    if (obj.value != "" &&
        ds_testArticleList.getColumn(ds_testArticleList.rowposition, "decision") == "")
    {
        gfn_alert("판정내역을 선택하여 주십시오!");
        return;
    }
    
   
}

/*----------------------------------------------------------------------------------------------
 * 설명      : 모바일에서 서버에 등록된 파일 선택 시
 *---------------------------------------------------------------------------------------------*/
function div_evntDtl_btn_addSvrFile_onclick(obj:Button,  e:ClickEventInfo)
{
	var arrParam = {"GUBUN" : "08"};
    var arrRtn   = gfn_dialog( "MobileFileUploadInqueryPop"                                  // Dialog ID
                             , "X_LTM::MobileFileUploadInqueryPop.xfdl"                      // Form URL
                             , {fv_Contents:arrParam}                           // 배열
                             , null, null, null, null, null, false, true, -1);

    if ( arrRtn instanceof Object ) {
        arr = arrRtn.datas;
        for (var i = 0; i < arrRtn.dataRow; i++) {
            var nRow = ds_file.addRow();
            
            ds_file.setColumn(nRow, "refSeq", gfn_trim(arr[i].rgstSeq));
            ds_file.setColumn(nRow, "orgnlPath", gfn_trim(arr[i].relPath));
            ds_file.setColumn(nRow, "orgnlFileNm", gfn_trim(arr[i].fileNm));
            ds_file.setColumn(nRow, "fileSize", gfn_trim(arr[i].fileSize));
            ds_file.setColumn(nRow, "fileExt", gfn_trim(arr[i].fileExt));
            ds_file.setColumn(nRow, "preView", gfn_trim(arr[i].preView));
            ds_file.setColumn(nRow, "fileDesc", gfn_trim(arr[i].bigo));
            ds_file.setColumn(nRow, "saveFileNm", "");
            ds_file.setColumn(nRow, "relPath", "");
        }
    }
}

/*----------------------------------------------------------------------------------------------
 * 설명      : 공통적용 Key Event function을 Ctrl+C 기능을 제외하고 별도로 구현한다.
 *---------------------------------------------------------------------------------------------*/
function fn_formKeyDown(obj, e)
{
    var obj = getFocus();
    var componentType = gfn_getObjType(obj);
    var strCssclass = obj.class;					// CSS Class

    var objNextComponent = getNextComponent(obj);
    var nextComponentType = gfn_getObjType(objNextComponent);

    if (componentType == "Grid") {
        // Ctrl + P	: Grid 인쇄
        if (e.ctrlKey == true && e.keycode == 80) {
            application.alert("준비중입니다.");
        }
        // Ctrl + C	: Cell clipboard 복사
        else if (e.ctrlKey == true && e.keycode == 67) {
            // Grid Binddataset
			var strGrdDsNm = obj.binddataset;
			var v_clip = "";
			var strSeperate = "	";
			//trace(obj.currentcell);
			for (var i = obj.selectstartrow; i <= obj.selectendrow; i++) {
				for (var j = obj.selectstartcol; j <= obj.selectendcol; j++) {
					if (j == -1) {
						v_clip += obj.getCellValue(i, obj.currentcell);
						continue;
					}
					if (obj.getCellValue(i,j) == undefined) {
						v_clip += "";
					} else {
						if (j < obj.selectendcol) {
							v_clip += obj.getCellValue(i,j) + strSeperate;
						} else {
							v_clip += obj.getCellValue(i,j);
						}
					}
				}
				if (i < obj.selectendrow) {
					v_clip += "\r\n";
				}
			}
			v_clip += "\r\n";
			system.clearClipboard();
			system.setClipboard("CF_TEXT", v_clip);
        }
        // Ctrl + L	: Line clipboard 복사
        else if (e.ctrlKey == true && e.keycode == 76) {
            var v_clip = "";
            for ( var i = 0; i < obj.getCellCount("Body"); i++ ) {
                v_clip += ", " + obj.getCellText(obj.currentrow, i);
            }
            system.clearClipboard();
            system.setClipboard("CF_TEXT",gfn_subStr(v_clip,2));
        }
        // Ctrl + A	: 전체 clipboard 복사
        else if (e.ctrlKey == true && e.keycode == 65) {
            system.clearClipboard();
            system.setClipboard("CF_TEXT",obj.getCsvData(false));
        }
        // Ctrl + V	: Paste
        else if (e.ctrlKey == true && e.keycode == 86) {
            gfn_gridPaste(obj, e);
        }
        // Ctrl + E	: 엑셀 다운로드
        else if (e.ctrlKey == true && e.keycode == 69) {
            gfn_exportExcel(obj);
        }
        // Ctrl + M	: Multi Sort
        else if (e.ctrlKey == true && e.keycode == 77) {
            gfn_gridMultiSort(obj);
        }
        // Ctrl + F	: Find
        else if (e.ctrlKey == true && e.keycode == 70) {
            gfn_gridFind(this, obj);
        }
        // Ctrl + T	: Filter
        else if (e.ctrlKey == true && e.keycode == 84) {
            gfn_gridFilter(this, obj);
        }
        // Enter 키
        else if (e.keycode == 13) {
            //var bSuccess = obj.moveToNextCell();	// 수정이 가능한 다음 셀로 이동
            //if (!bSuccess) objNextComponent.setFocus();	// 수정이 가능한 다음 셀 없을때 Next Comp로 이동
        }
    }

    // Enter 키
    if (e.keycode == 13 && componentType != "Grid") {
        // 현재 Component 기준
        if (componentType == "TextArea") {
            return;
        }
        else if (componentType == "Tab") {
            var objTemp = obj.components[tabindex];
            objTemp.setFocus();
        }
        // Next Component 기준
        else if (nextComponentType == "Tab") {		// Tab은 필요할지 확인 필요
            var objTemp = objNextComponent.components[objNextComponent.tabindex];
            objTemp.setFocus();
        }
        else if (nextComponentType == "Combo") {
            objNextComponent.setFocus();
            objNextComponent.dropdown();
        }
        else {
            objNextComponent.setFocus();
        }
    }

    // 팝업에서 ESC 키 시 창닫기
    var objOpener = opener;
    if (e.keycode == 27 && gfn_isNull(objOpener) == false) {
        this.close();
    }
}
 
//시험항목의 판정이 선택되면 최종판정도 자동으로 세팅되도록 변경 11/20 맹수영   요청자:김민채
function div_testDiary_grd_testArticleList_onkillfocus(obj:Grid, e:KillFocusEventInfo)
{
	 ds_testArticleList.setColumn(ds_testArticleList.rowposition, "lastDecision",ds_testArticleList.getColumn(ds_testArticleList.rowposition,"decision"));
}
]]></Script>
  </Form>
</FDL>
