<%
/*-----------------------------------------------------------------------------
■ 시스템명     : 식재영업/급식채권관리
■ 프로그램ID   : MAK10170S_T003.jsp
■ 프로그램명   : 입금 및 여신현황조회(전체업장)
■ 작성일자     : 
■ 작성자       : 
■ 이력관리     : 
* HISTORY    : 
-----------------------------------------------------------------------------*/
%>

<%@ page contentType="text/html; charset=EUC-KR" %>
<%@ include file = "../../sc/main/common.jsp" %>
<%
	try	{
		PlatformRequest platformRequest = this.proc_input(request);
		in_vl = platformRequest.getData().getVariableList();
		in_dl = platformRequest.getData().getDataSetList();
	
		//jsp log 서비스 시작 
		logger.startIndividualLog(in_vl.getString("titLogId"));		

		//입력 데이타
		DataSet ds_Cond     = in_dl.get("ds_Cond");
		//입력 파라메터
		String g_Upjang     = nullToBlank(in_vl.getString("g_Upjang"));
		String g_EmpNo      = nullToBlank(in_vl.getString("g_EmpNo"));
		//FileLog.println("d:\\aaa.txt", ds_Cond);

		//out 데이타
		DataSet ds_List, ds_ListTmp;
		//sql문 버퍼생성
		StringBuffer sbSql = new StringBuffer();

		//본사 통합 업장 대상 여신체크할 최종 발주일자 조회
		sbSql.delete(0,sbSql.length());
		sbSql.append("SELECT \n");
		sbSql.append("       MAX(A.NEED_DATE) AS NEED_DATE \n");
		sbSql.append("  FROM SO_PR A, FMS_UPJANG B\n");
		sbSql.append(" WHERE A.RC_UPJANG = B.UPJANG \n");
		sbSql.append("   AND A.NEED_DATE BETWEEN '" + nullToBlank(ds_Cond.getString(0, "JDATE")) + "' AND GREATEST(TO_CHAR(SYSDATE+31,'YYYYMMDD'),'" + nullToBlank(ds_Cond.getString(0, "JDATE")) + "') \n");
		sbSql.append("   AND A.SUBINV_CODE LIKE 'S1%' \n");
		sbSql.append("   AND A.LINE_STATUS NOT IN ('003', '005','999')  --신청취소, 결의반려 제외 \n");
		
		pstmt = conn.prepareStatement(sbSql.toString());
		rs = pstmt.executeQuery();
		
		String strDate;	//최종발주일자
		String jDate;	//기준일자
		
		jDate = nullToBlank(ds_Cond.getString(0, "JDATE"));
		
		if(rs.next())
			strDate = rs.getString("NEED_DATE");
		else
			strDate = nullToBlank(ds_Cond.getString(0, "JDATE"));
		rs.close();
		pstmt.close();

		if (nullToBlank(strDate)=="") strDate = nullToBlank(ds_Cond.getString(0, "JDATE"));


		//본사통합 업장내역조회(속도관계상 운영율은 적용하지 않는다.)
		//여신연장금액 삭제
		sbSql.delete(0,sbSql.length());
		sbSql.append("/* MAK10170S_T003_tun1.jsp */ \n");
        sbSql.append("WITH FMS_UPJANG_WITH AS                                                                                                                                                                                                                                    \n");
        sbSql.append("(                                                                                                                                                                                                                                                          \n");
        sbSql.append("SELECT /*+ MATERIALIZE */                                                                                                                                                                                                                                  \n");
        sbSql.append("        A.MAIN_UPJANG                                                                                                                                                                                                                                      \n");
        sbSql.append("       ,A.UPJANG                                                                                                                                                                                                                                           \n");
        sbSql.append("       ,A.UPJANGNM_DISP                                                                                                                                                                                                                                    \n");
        sbSql.append("       ,A.CREDIT_AMOUNT                                                                                                                                                                                                                                    \n");
        sbSql.append("       ,A.HEAD_CREDIT_YN                                                                                                                                                                                                                                   \n");
        sbSql.append("       ,A.CREDIT_CONTROL_YN                                                                                                                                                                                                                                \n");
        sbSql.append("       ,A.CREDIT_TURN_CONTROL_YN                                                                                                                                                                                                                           \n");
        sbSql.append("       ,A.CREDIT_AMOUNT_CONTROL_YN                                                                                                                                                                                                                         \n");
        sbSql.append("       ,A.CREDIT_TURN_DAYS                                                                                                                                                                                                                                 \n");
        sbSql.append("       ,A.CREDIT_START                                                                                                                                                                                                                                     \n");
        sbSql.append("       ,A.CREDIT_END                                                                                                                                                                                                                                       \n");
        sbSql.append("       ,A.CREDIT_OVER_END                                                                                                                                                                                                                                  \n");
        sbSql.append("       ,A.CREDIT_OVER_AMOUNT                                                                                                                                                                                                                               \n");
        sbSql.append("       FROM FMS_UPJANG A                                                                                                                                                                                                                                   \n");
        if (! nullToBlank(ds_Cond.getString(0, "CENTER_CODE")).equals(""))				
		{
            sbSql.append("									INNER JOIN ST_UPJANG Y ON A.UPJANG = Y.UPJANG \n");
            sbSql.append("									INNER JOIN HLDC_PO_UPJANG_CENTER X ON X.CENTER_CODE = '" + nullToBlank(ds_Cond.getString(0, "CENTER_CODE")) + "' \n");
            sbSql.append("																						    AND Y.AP_UNITPRICE_UPJANG = X.UPJANG \n");
		}
        sbSql.append("       WHERE A.HEAD_CREDIT_YN = 'Y'                                                                                                                                                                                                                        \n");
        if (! nullToBlank(ds_Cond.getString(0, "USE_YN")).equals(""))				
    		sbSql.append("   AND A.USE_YN = '" + nullToBlank(ds_Cond.getString(0, "USE_YN")) + "' \n");
        if (! nullToBlank(ds_Cond.getString(0, "SALE_SABUN")).equals(""))
			sbSql.append("   AND A.PART_SALES_SABUN = '" + nullToBlank(ds_Cond.getString(0, "SALE_SABUN")) + "' \n");
        sbSql.append(")                                                                                                                                                                                                                                                          \n");
        sbSql.append(",                                                                                                                                                                                                                                                          \n");
        sbSql.append("HLDC_PO_PO_WITH AS                                                                                                                                                                                                                                         \n");
        sbSql.append("(                                                                                                                                                                                                                                                          \n");
        sbSql.append(" SELECT /*+  LEADING(B)  */                                                                                                                                                                                                                                \n");
        sbSql.append(" SAL.SHOP_CD          AS RC_UPJANG   -- 입고업장 코드 SAL.SHOP_CD                                                                                                                                                                                          \n");
        sbSql.append(",CASE                                                                                                                                                                                                                                                      \n");
        sbSql.append("    WHEN PODT.DUTY_FREE_YN ='1' THEN '100'                                                                                                                                                                                                                 \n");
        sbSql.append("    WHEN PODT.DUTY_FREE_YN ='3' THEN '210'                                                                                                                                                                                                                 \n");
        sbSql.append("    WHEN PODT.DUTY_FREE_YN ='2' THEN '220'                                                                                                                                                                                                                 \n");
        sbSql.append("END  AS TAX_CODE   -- 과세구분코드                                                                                                                                                                                                                         \n");
        sbSql.append(", CASE WHEN PODT.PROC_TYP_CD IN('DC', 'TC') THEN PODT.ITEM_QTY ELSE 0 END  AS CENTER_DELI_QTY  -- 센터입고수량                                                                                                                                             \n");
        sbSql.append(", CASE PODT.PROC_TYP_CD WHEN 'VC' THEN PODT.ITEM_QTY ELSE 0 END  AS DIRECT_DELI_QTY  -- 직송 수량                                                                                                                                                          \n");
        sbSql.append(", CASE PODT.PROC_TYP_CD WHEN 'VC' THEN NVL(PODT.GR_QTY,0) ELSE NVL(PODT.GR_QTY_WMS,0) END  AS DELIVERED_QTY    --업장입고수량(센터출고)                                                                                                                    \n");
        sbSql.append(", CASE                                                                                                                                                                                                                                                     \n");
        sbSql.append("       WHEN PODT.PO_COMP_YN='Y' OR PODT.GR_COMP_YN='Y' THEN NVL(PODT.ITEM_QTY,0) - NVL(PODT.GR_QTY,0) -- 입고완료                                                                                                                                          \n");
        sbSql.append("       ELSE 0                                                                                                                                                                                                                                              \n");
        sbSql.append("   END AS UNDELIVERED_QTY -- 감량수량                                                                                                                                                                                                                      \n");
        sbSql.append(", SAL.CUST_GR_DATE                AS NEED_DATE -- 입고희망일자                                                                                                                                                                                             \n");
        sbSql.append("   , NVL(CASE WHEN POHD.PO_TYP = 'BP' THEN                                                                                                                                                                                                                 \n");
        sbSql.append("             CASE                                                                                                                                                                                                                                          \n");
        sbSql.append("               WHEN PODT.GR_COMP_YN='N' AND POHD.APRV_STS = 'T'         THEN 'RW' --통합영업에서 뷰 불가                                                                                                                                                   \n");
        sbSql.append("               WHEN PODT.GR_COMP_YN='N' AND POHD.APRV_STS = 'P'         THEN 'PW'                                                                                                                                                                          \n");
        sbSql.append("               WHEN PODT.GR_COMP_YN='N' AND POHD.APRV_STS IN ('R', 'W') THEN 'PD'                                                                                                                                                                          \n");
        sbSql.append("               WHEN PODT.GR_COMP_YN='N' AND POHD.APRV_STS = 'B'         THEN 'PD'                                                                                                                                                                          \n");
        sbSql.append("               WHEN PODT.GR_COMP_YN='Y' AND POHD.APRV_STS = 'B'         THEN 'GC'                                                                                                                                                                          \n");
        sbSql.append("               WHEN PODT.GR_COMP_YN='Y' AND POHD.APRV_STS IN ('C', 'K') THEN 'GC'                                                                                                                                                                          \n");
        sbSql.append("             END                                                                                                                                                                                                                                           \n");
        sbSql.append("       --ELSE NVL(PRDT.PR_PROG_STS, 'PC')                                                                                                                                                                                                                  \n");
        sbSql.append("          ELSE DECODE(PODT.GR_COMP_YN, 'Y', 'GC', NVL(PRDT.PR_PROG_STS,'PC'))                                                                                                                                                                              \n");
        sbSql.append("       END,'PC') AS LINE_STATUS  -- 라인 상태 코드                                                                                                                                                                                                         \n");
        sbSql.append("     , NVL(SAL.SAL_PRICE,0)      AS SALE_PRICE -- 판매 단가 AS SALE_PRICE                                                                                                                                                                                  \n");
        sbSql.append("     --                                                                                                                                                                                                                                                    \n");
        sbSql.append("     ,B.MAIN_UPJANG                                                                                                                                                                                                                                        \n");
        sbSql.append("  FROM EPROCUSR.ESPPOHD POHD   -- PO 헤더                                                                                                                                                                                                                  \n");
        sbSql.append("     , EPROCUSR.ESPPODT PODT   -- PO 상세(품목)                                                                                                                                                                                                            \n");
        sbSql.append("     , EPROCUSR.ESMMTGL MTGL   -- 자재마스터                                                                                                                                                                                                               \n");
        sbSql.append("     , EPROCUSR.ESPPODTSAL SAL -- 판매단가정보[통합영업]                                                                                                                                                                                                   \n");
        sbSql.append("     , EPROCUSR.ESPPRDT PRDT   -- PR 상세(품목)                                                                                                                                                                                                            \n");
        sbSql.append("     ,                                                                                                                                                                                                                                                     \n");
        sbSql.append("       (                                                                                                                                                                                                                                                   \n");
        sbSql.append("        SELECT /*+ NO_MERGE LEADING(B) */                                                                                                                                                                                                                  \n");
        sbSql.append("        B.MAIN_UPJANG, B.UPJANG,                                                                                                                                                                                                                           \n");
        sbSql.append("        SAL.ROWID AS SAL_ID,                                                                                                                                                                                                                               \n");
        sbSql.append("        PODT.ROWID AS PODT_ID                                                                                                                                                                                                                              \n");
        sbSql.append("        FROM  EPROCUSR.ESPPODTSAL SAL -- 판매단가정보[통합영업]                                                                                                                                                                                            \n");
        sbSql.append("        ,EPROCUSR.ESPPODT PODT  -- PO 상세(품목)                                                                                                                                                                                                           \n");
        sbSql.append("        ,FMS_UPJANG_WITH B                                                                                                                                                                                                                                 \n");
        sbSql.append("        WHERE                                                                                                                                                                                                                                              \n");
        sbSql.append("            B.UPJANG = SAL.SHOP_CD                                                                                                                                                                                                                         \n");
        sbSql.append("        AND SAL.CUST_GR_DATE BETWEEN TO_CHAR(ADD_MONTHS(SYSDATE,-1),'YYYYMMDD') AND '"+strDate+"'                                                                                                                                                                                                                 \n");
        //sbSql.append("        AND SAL.CUST_GR_DATE <= '"+strDate+"'                                                                                                                                                                                                                 \n");
        sbSql.append("        AND SAL.SYS_ID  = PODT.SYS_ID                                                                                                                                                                                                                      \n");
        sbSql.append("        AND SAL.COMP_CD = PODT.COMP_CD                                                                                                                                                                                                                     \n");
        sbSql.append("        AND SAL.PO_NO   = PODT.PO_NO                                                                                                                                                                                                                       \n");
        sbSql.append("        AND SAL.PO_LNO  = PODT.PO_LNO                                                                                                                                                                                                                      \n");
        sbSql.append("        AND SAL.SYS_ID  = '100'                                                                                                                                                                                                                            \n");
        sbSql.append("        AND SAL.COMP_CD = 'HFC'                                                                                                                                                                                                                            \n");
        sbSql.append("        ORDER BY PODT.ROWID                                                                                                                                                                                                                                \n");
        sbSql.append("    ) B                                                                                                                                                                                                                                                    \n");
        sbSql.append(" WHERE PODT.SYS_ID  = POHD.SYS_ID(+)                                                                                                                                                                                                                       \n");
        sbSql.append("   AND PODT.COMP_CD = POHD.COMP_CD (+)                                                                                                                                                                                                                     \n");
        sbSql.append("   AND PODT.PO_NO   = POHD.PO_NO(+)                                                                                                                                                                                                                        \n");
        sbSql.append("--   AND PODT.SYS_ID  = SAL.SYS_ID(+)                                                                                                                                                                                                                      \n");
        sbSql.append("--   AND PODT.COMP_CD = SAL.COMP_CD(+)                                                                                                                                                                                                                     \n");
        sbSql.append("--   AND PODT.PO_NO   = SAL.PO_NO(+)                                                                                                                                                                                                                       \n");
        sbSql.append("--   AND PODT.PO_LNO  = SAL.PO_LNO(+)                                                                                                                                                                                                                      \n");
        sbSql.append("   AND PODT.SYS_ID  = MTGL.SYS_ID                                                                                                                                                                                                                          \n");
        sbSql.append("   AND PODT.ITEM_CD = MTGL.ITEM_CD                                                                                                                                                                                                                         \n");
        sbSql.append("   AND PODT.PR_NO   = PRDT.PR_NO(+)                                                                                                                                                                                                                        \n");
        sbSql.append("   AND PODT.PR_LNO  = PRDT.PR_LNO(+)                                                                                                                                                                                                                       \n");
        sbSql.append("   AND PODT.SYS_ID  = PRDT.SYS_ID(+)                                                                                                                                                                                                                       \n");
        sbSql.append("   AND PODT.COMP_CD = PRDT.COMP_CD(+)                                                                                                                                                                                                                      \n");
        sbSql.append("   AND PODT.SYS_ID  = '100'                                                                                                                                                                                                                                \n");
        sbSql.append("   AND PODT.COMP_CD = 'HFC'                                                                                                                                                                                                                                \n");
        sbSql.append("   AND PODT.SHOP_TYP_CD = '02'                                                                                                                                                                                                                             \n");
        sbSql.append("   AND PODT.STS    <> 'D'                                                                                                                                                                                                                                  \n");
        sbSql.append("   ---                                                                                                                                                                                                                                                     \n");
        sbSql.append("   AND POHD.PO_TYP IN ('UP','BP') -- 첫번째  조건 'UP' 2015.10.19 최학진 정산용 PO 추가조건 'BP'                                                                                                                                                           \n");
        sbSql.append("   --                                                                                                                                                                                                                                                      \n");
        sbSql.append("--  AND SAL.CUST_GR_DATE BETWEEN TO_CHAR(ADD_MONTHS(SYSDATE,-1),'YYYYMMDD') AND '"+strDate+"'                                                                                                                                                                                                                     \n");
        //sbSql.append("--  AND SAL.CUST_GR_DATE <= '"+strDate+"'                                                                                                                                                                                                                     \n");
        sbSql.append("--  AND SAL.SHOP_CD = B.UPJANG                                                                                                                                                                                                                             \n");
        sbSql.append("AND B.SAL_ID = SAL.ROWID                                                                                                                                                                                                                                   \n");
        sbSql.append("AND B.PODT_ID = PODT.ROWID                                                                                                                                                                                                                                 \n");
        sbSql.append("UNION ALL                                                                                                                                                                                                                                                  \n");
        sbSql.append("SELECT /*+ LEADING(B) */                                                                                                                                                                                                                                   \n");
        sbSql.append("   PODT.SHOP_CD             AS RC_UPJANG   -- 입고업장 코드                                                                                                                                                                                                \n");
        sbSql.append("    , CASE                                                                                                                                                                                                                                                 \n");
        sbSql.append("         WHEN PODT.DUTY_FREE_YN ='1' THEN '100'                                                                                                                                                                                                            \n");
        sbSql.append("         WHEN PODT.DUTY_FREE_YN ='3' THEN '210'                                                                                                                                                                                                            \n");
        sbSql.append("         WHEN PODT.DUTY_FREE_YN ='2' THEN '220'                                                                                                                                                                                                            \n");
        sbSql.append("       END  AS TAX_CODE   -- 과세구분코드                                                                                                                                                                                                                  \n");
        sbSql.append("  , CASE WHEN PODT.PROC_TYP_CD IN('DC', 'TC') THEN PODT.ITEM_QTY ELSE 0 END  AS CENTER_DELI_QTY  -- 센터입고수량                                                                                                                                           \n");
        sbSql.append("  , CASE PODT.PROC_TYP_CD WHEN 'VC' THEN PODT.ITEM_QTY ELSE 0 END  AS DIRECT_DELI_QTY  -- 직송 수량                                                                                                                                                        \n");
        sbSql.append("  , CASE PODT.PROC_TYP_CD WHEN 'VC' THEN NVL(PODT.GR_QTY,0) ELSE NVL(PODT.GR_QTY_WMS,0) END  AS DELIVERED_QTY    --업장입고수량(센터출고)                                                                                                                  \n");
        sbSql.append("  , CASE                                                                                                                                                                                                                                                   \n");
        sbSql.append("    WHEN PODT.PO_COMP_YN='Y' OR PODT.GR_COMP_YN='Y' THEN NVL(PODT.ITEM_QTY,0) - NVL(PODT.GR_QTY,0) -- 입고완료                                                                                                                                             \n");
        sbSql.append("    ELSE 0                                                                                                                                                                                                                                                 \n");
        sbSql.append("  END AS UNDELIVERED_QTY -- 감량수량                                                                                                                                                                                                                       \n");
        sbSql.append("  , PODT.GR_REQ_DATE                AS NEED_DATE -- 입고희망일자                                                                                                                                                                                           \n");
        sbSql.append("  , NVL(CASE WHEN POHD.PO_TYP = 'BP' THEN                                                                                                                                                                                                                  \n");
        sbSql.append("             CASE                                                                                                                                                                                                                                          \n");
        sbSql.append("               WHEN PODT.GR_COMP_YN='N' AND POHD.APRV_STS = 'T'         THEN 'RW' --통합영업에서 뷰 불가                                                                                                                                                   \n");
        sbSql.append("               WHEN PODT.GR_COMP_YN='N' AND POHD.APRV_STS = 'P'         THEN 'PW'                                                                                                                                                                          \n");
        sbSql.append("               WHEN PODT.GR_COMP_YN='N' AND POHD.APRV_STS IN ('R', 'W') THEN 'PD'                                                                                                                                                                          \n");
        sbSql.append("               WHEN PODT.GR_COMP_YN='N' AND POHD.APRV_STS = 'B'         THEN 'PD'                                                                                                                                                                          \n");
        sbSql.append("               WHEN PODT.GR_COMP_YN='Y' AND POHD.APRV_STS = 'B'         THEN 'GC'                                                                                                                                                                          \n");
        sbSql.append("               WHEN PODT.GR_COMP_YN='Y' AND POHD.APRV_STS IN ('C', 'K') THEN 'GC'                                                                                                                                                                          \n");
        sbSql.append("             END                                                                                                                                                                                                                                           \n");
        sbSql.append("       --ELSE NVL(PRDT.PR_PROG_STS, 'PC')                                                                                                                                                                                                                  \n");
        sbSql.append("          ELSE DECODE(PODT.GR_COMP_YN, 'Y', 'GC', NVL(PRDT.PR_PROG_STS,'PC'))                                                                                                                                                                              \n");
        sbSql.append("       END,'PC') AS LINE_STATUS  -- 라인 상태 코드                                                                                                                                                                                                         \n");
        sbSql.append(", NVL(SAL.SAL_PRICE,0)      AS SALE_PRICE -- 판매 단가                                                                                                                                                                                                     \n");
        sbSql.append("--                                                                                                                                                                                                                                                         \n");
        sbSql.append(", B.MAIN_UPJANG                                                                                                                                                                                                                                            \n");
        sbSql.append("  FROM EPROCUSR.ESPPOHD POHD   -- PO 헤더                                                                                                                                                                                                                  \n");
        sbSql.append("     , EPROCUSR.ESPPODT PODT   -- PO 상세(품목)                                                                                                                                                                                                            \n");
        sbSql.append("     , EPROCUSR.ESMMTGL MTGL   -- 자재마스터                                                                                                                                                                                                               \n");
        sbSql.append("     , EPROCUSR.ESPPODTSAL SAL -- 판매단가정보[통합영업]                                                                                                                                                                                                   \n");
        sbSql.append("     , EPROCUSR.ESPPRDT PRDT   -- PR 상세(품목)                                                                                                                                                                                                            \n");
        sbSql.append("     , (                                                                                                                                                                                                                                                   \n");
        sbSql.append("        SELECT /*+ NO_MERGE USE_HASH(B PDOT) LEADING(B) */                                                                                                                                                                                                 \n");
        sbSql.append("        B.MAIN_UPJANG,B.UPJANG,                                                                                                                                                                                                                            \n");
        sbSql.append("        PODT.ROWID AS PODT_ID                                                                                                                                                                                                                              \n");
        sbSql.append("        FROM                                                                                                                                                                                                                                               \n");
        sbSql.append("        EPROCUSR.ESPPODT PODT                                                                                                                                                                                                                              \n");
        sbSql.append("        , FMS_UPJANG_WITH B                                                                                                                                                                                                                                \n");
        sbSql.append("         WHERE PODT.GR_REQ_DATE BETWEEN TO_CHAR(ADD_MONTHS(SYSDATE,-1),'YYYYMMDD') AND '"+strDate+"'                                                                                                                                                                                                              \n");
        sbSql.append("         AND PODT.SHOP_CD = B.UPJANG                                                                                                                                                                                                                       \n");
        sbSql.append("         AND PODT.SYS_ID  = '100'                                                                                                                                                                                                                          \n");
        sbSql.append("         AND PODT.COMP_CD = 'HFC'                                                                                                                                                                                                                          \n");
        sbSql.append("         ORDER BY PODT.ROWID                                                                                                                                                                                                                               \n");
        sbSql.append("       ) B                                                                                                                                                                                                                                                 \n");
        sbSql.append(" WHERE PODT.SYS_ID  = POHD.SYS_ID (+)                                                                                                                                                                                                                      \n");
        sbSql.append("   AND PODT.COMP_CD = POHD.COMP_CD(+)                                                                                                                                                                                                                      \n");
        sbSql.append("   AND PODT.PO_NO   = POHD.PO_NO  (+)                                                                                                                                                                                                                      \n");
        sbSql.append("   AND PODT.SYS_ID  = SAL.SYS_ID(+)                                                                                                                                                                                                                        \n");
        sbSql.append("   AND PODT.COMP_CD = SAL.COMP_CD(+)                                                                                                                                                                                                                       \n");
        sbSql.append("   AND PODT.PO_NO   = SAL.PO_NO(+)                                                                                                                                                                                                                         \n");
        sbSql.append("   AND PODT.PO_LNO  = SAL.PO_LNO(+)                                                                                                                                                                                                                        \n");
        sbSql.append("   AND PODT.SYS_ID  = MTGL.SYS_ID                                                                                                                                                                                                                          \n");
        sbSql.append("   AND PODT.ITEM_CD = MTGL.ITEM_CD                                                                                                                                                                                                                         \n");
        sbSql.append("   AND PODT.PR_NO   = PRDT.PR_NO(+)                                                                                                                                                                                                                        \n");
        sbSql.append("   AND PODT.PR_LNO  = PRDT.PR_LNO(+)                                                                                                                                                                                                                       \n");
        sbSql.append("   AND PODT.SYS_ID  = PRDT.SYS_ID(+)                                                                                                                                                                                                                       \n");
        sbSql.append("   AND PODT.COMP_CD = PRDT.COMP_CD(+)                                                                                                                                                                                                                      \n");
        sbSql.append("   AND PODT.SHOP_TYP_CD <> '02'                                                                                                                                                                                                                            \n");
        sbSql.append("   --AND PODT.SYS_ID  = '100'                                                                                                                                                                                                                              \n");
        sbSql.append("  -- AND PODT.COMP_CD = 'HFC'                                                                                                                                                                                                                              \n");
        sbSql.append("   -- AND POHD.STS    <> 'D'                                                                                                                                                                                                                               \n");
        sbSql.append("   AND PODT.STS    <> 'D'                                                                                                                                                                                                                                  \n");
        sbSql.append("   --- 두번째 UNION ALL 조건                                                                                                                                                                                                                               \n");
        sbSql.append("   AND ((PRDT.STS    <> 'D'                                                                                                                                                                                                                                \n");
        sbSql.append("   AND PODT.REQ_SYS_CD = 'FR') OR                                                                                                                                                                                                                          \n");
        sbSql.append("   -- 세번째 UNION ALL 조건                                                                                                                                                                                                                                \n");
        sbSql.append("    (PODT.REQ_SYS_CD <> 'FR')                                                                                                                                                                                                                              \n");
        sbSql.append("   )                                                                                                                                                                                                                                                       \n");
        sbSql.append("   -- 조건                                                                                                                                                                                                                                                 \n");
        sbSql.append(" AND PODT.ROWID = B.PODT_ID                                                                                                                                                                                                                                \n");
        sbSql.append("    )                                                                                                                                                                                                                                                      \n");
        sbSql.append(",FMS_TRANSACTION_WITH AS                                                                                                                                                                                                                                   \n");
        sbSql.append("(                                                                                                                                                                                                                                                          \n");
        sbSql.append("SELECT  A.MAIN_UPJANG,                                                                                                                                                                                                                                     \n");
        sbSql.append("       A.TRANS_UPJANG AS UPJANG,                                                                                                                                                                                                                           \n");
        sbSql.append("       SUM(DECODE(SUBSTR(A.TRANS_TYPE,1,1),'I',1,-1) * ROUND(DECODE(A.TAX_CODE,'100',1.1,1) * ROUND(A.SALE_PRICE * A.TRANS_QTY) ) ) AS TR_AMT                                                                                                              \n");
        sbSql.append("FROM (                                                                                                                                                                                                                                                     \n");
        sbSql.append("       SELECT        A.TRANS_ID,                                                                                                                                                                                                                           \n");
        sbSql.append("               A.MG_DATE,                                                                                                                                                                                                                                  \n");
        sbSql.append("               A.SOURCE_TYPE,                                                                                                                                                                                                                              \n");
        sbSql.append("               A.TRANS_TYPE,                                                                                                                                                                                                                               \n");
        sbSql.append("               A.TRANS_QTY,                                                                                                                                                                                                                                \n");
        sbSql.append("               A.TRANS_UPJANG,                                                                                                                                                                                                                             \n");
        sbSql.append("               A.TAX_CODE,                                                                                                                                                                                                                                 \n");
        sbSql.append("               A.SALE_PRICE,                                                                                                                                                                                                                               \n");
        sbSql.append("               A.MAIN_UPJANG                                                                                                                                                                                                                               \n");
        sbSql.append("        FROM (                                                                                                                                                                                                                                             \n");
        sbSql.append("            SELECT /*+ LEADING(UP)  */ DT.MG_NO AS TRANS_ID,/* 자재수불번호 */                                                                                                                                                                             \n");
        sbSql.append("                       DT.MG_DATE AS MG_DATE,/* 수불일자*/                                                                                                                                                                                                 \n");
        sbSql.append("                           CASE WHEN SUBSTR(DT.MOVEMENT_TYP,0,2) = '25'                                                                                                                                                                                    \n");
        sbSql.append("                        THEN 'FO'                                                                                                                                                                                                                          \n");
        sbSql.append("                        WHEN DT.PROC_TYP_CD IS NULL                                                                                                                                                                                                        \n");
        sbSql.append("                            AND DT.IVT_INSP_NO IS NOT NULL                                                                                                                                                                                                 \n");
        sbSql.append("                        THEN '재고조정'                                                                                                                                                                                                                    \n");
        sbSql.append("                        WHEN DT.PROC_TYP_CD IS NULL                                                                                                                                                                                                        \n");
        sbSql.append("                            AND DT.IVT_INSP_NO IS NULL                                                                                                                                                                                                     \n");
        sbSql.append("                        THEN 'INV'                                                                                                                                                                                                                         \n");
        sbSql.append("                        ELSE 'PO'                                                                                                                                                                                                                          \n");
        sbSql.append("                        END                                                                                                                                                                                                                                \n");
        sbSql.append("                    AS SOURCE_TYPE,/* FO,PO,INV,재고조정 */                                                                                                                                                                                                \n");
        sbSql.append("                       DT.MOVEMENT_TYP AS MVT,                                                      /*이동유형 */                                                                                                                                          \n");
        sbSql.append("                           CASE WHEN SUBSTR(DT.MOVEMENT_TYP,0,1) = '3'                                                                                                                                                                                     \n");
        sbSql.append("                            AND DT.GR_QTY IS NULL                                                                                                                                                                                                          \n");
        sbSql.append("                        THEN 'O002'         /* 재고이동 - 이동출고   */                                                                                                                                                                                    \n");
        sbSql.append("                        WHEN SUBSTR(DT.MOVEMENT_TYP,0,1) = '3'                                                                                                                                                                                             \n");
        sbSql.append("                            AND DT.GR_QTY IS NOT NULL                                                                                                                                                                                                      \n");
        sbSql.append("                        THEN 'I002'      /*재고이동 - 이동입고  */                                                                                                                                                                                         \n");
        sbSql.append("                        WHEN DT.MOVEMENT_TYP = '251'                                                                                                                                                                                                       \n");
        sbSql.append("                            OR DT.MOVEMENT_TYP = '252'                                                                                                                                                                                                     \n");
        sbSql.append("                        THEN 'O001'      /* POS 매출 유형  */                                                                                                                                                                                              \n");
        sbSql.append("                        WHEN DT.MOVEMENT_TYP = '701'                                                                                                                                                                                                       \n");
        sbSql.append("                            OR DT.MOVEMENT_TYP = '702'                                                                                                                                                                                                     \n");
        sbSql.append("                        THEN 'O004'      /* 재고실사 */                                                                                                                                                                                                    \n");
        sbSql.append("                        ELSE 'I001'                                                                                                                                                                                                                        \n");
        sbSql.append("                        END                                                                                                                                                                                                                                \n");
        sbSql.append("                    AS TRANS_TYPE,                                                                                                                                                                                                                         \n");
        sbSql.append("                           CASE WHEN MOD(TO_NUMBER(DT.MOVEMENT_TYP),2) = 0                                                                                                                                                                                 \n");
        sbSql.append("                            AND DT.PROC_TYP_CD IS NOT NULL                                                                                                                                                                                                 \n");
        sbSql.append("                        THEN DECODE(                                                                                                                                                                                                                       \n");
        sbSql.append("                                DT.GR_QTY,                                                                                                                                                                                                                 \n");
        sbSql.append("                                NULL,                                                                                                                                                                                                                      \n");
        sbSql.append("                                DT.GI_PURC_QTY *-1,                                                                                                                                                                                                        \n");
        sbSql.append("                                DT.GR_PURC_QTY *-1                                                                                                                                                                                                         \n");
        sbSql.append("                            )                                                                                                                                                                                                                              \n");
        sbSql.append("                        WHEN MOD(TO_NUMBER(DT.MOVEMENT_TYP),2) = 1                                                                                                                                                                                         \n");
        sbSql.append("                            AND DT.PROC_TYP_CD IS NOT NULL                                                                                                                                                                                                 \n");
        sbSql.append("                        THEN DECODE(DT.GR_QTY,NULL,DT.GI_PURC_QTY,DT.GR_PURC_QTY)                                                                                                                                                                          \n");
        sbSql.append("                        WHEN MOD(TO_NUMBER(DT.MOVEMENT_TYP),2) = 0                                                                                                                                                                                         \n");
        sbSql.append("                            AND DT.PROC_TYP_CD IS NULL                                                                                                                                                                                                     \n");
        sbSql.append("                        THEN DECODE(                                                                                                                                                                                                                       \n");
        sbSql.append("                                DT.GR_QTY,                                                                                                                                                                                                                 \n");
        sbSql.append("                                NULL,                                                                                                                                                                                                                      \n");
        sbSql.append("                                DT.GI_QTY *-1,                                                                                                                                                                                                             \n");
        sbSql.append("                                DT.GR_QTY *-1                                                                                                                                                                                                              \n");
        sbSql.append("                            )                                                                                                                                                                                                                              \n");
        sbSql.append("                        WHEN MOD(TO_NUMBER(DT.MOVEMENT_TYP),2) = 1                                                                                                                                                                                         \n");
        sbSql.append("                            AND DT.PROC_TYP_CD IS NULL                                                                                                                                                                                                     \n");
        sbSql.append("                        THEN DECODE(DT.GR_QTY,NULL,DT.GI_QTY,DT.GR_QTY)                                                                                                                                                                                    \n");
        sbSql.append("                        END                                                                                                                                                                                                                                \n");
        sbSql.append("                    AS TRANS_QTY,      /* 수량 */                                                                                                                                                                                                          \n");
        sbSql.append("                       SL.SHOP_CD AS TRANS_UPJANG,/* 업장코드 */                                                                                                                                                                                           \n");
        sbSql.append("                       DECODE(MT.ACC_TAX_CD,'1','100','3','210','220') AS TAX_CODE,      /* 과면세 코드 */                                                                                                                                                 \n");
        sbSql.append("                       SL.SAL_PRICE AS SALE_PRICE,                        /* 외부판매단가 */                                                                                                                                                               \n");
        sbSql.append("                       SL.MAIN_UPJANG -- 201609 튜닝추가  메인 업장코드                                                                                                                                                                                    \n");
        sbSql.append("                FROM (   /* ESIMGDT 테이블과 인덱스간의 클러스터링팩터가 좋지 않아 ROWID로 정렬후 SCAN하기 위한 VIEW                                                                                                                                       \n");
        sbSql.append("                           ESIMGDT_PK 인덱스도 UNIQUE SCAN을 하게 되면 성능이 좋지 않아 FAST SCAN또는 RANGE SCAN 을 위한 HASH JOIN */                                                                                                                      \n");
        sbSql.append("                        SELECT /*+  NO_MERGE USE_NL(BB SL) USE_HASH(SL DT) INDEX_FFS(DT ESIMGDT_PK)  */ SL.ROWID AS SL_ID,                                                                                                                                 \n");
        sbSql.append("                               DT.ROWID AS DT_ID                                                                                                                                                                                                           \n");
        sbSql.append("                        FROM EPROCUSR.ESIMGDT DT,                                                                                                                                                                                                          \n");
        sbSql.append("                            EPROCUSR.ESISALP SL                                                                                                                                                                                                            \n");
        sbSql.append("                            INNER JOIN FMS_UPJANG_WITH BB                                                                                                                                                                                                  \n");
        sbSql.append("                            ON SL.SHOP_CD = BB.UPJANG                                                                                                                                                                                                      \n");
        sbSql.append("                        WHERE DT.SYS_ID = SL.SYS_ID                                                                                                                                                                                                        \n");
        sbSql.append("                        AND DT.COMP_CD = SL.COMP_CD                                                                                                                                                                                                        \n");
        sbSql.append("                        AND DT.MG_NO = SL.MG_NO                                                                                                                                                                                                            \n");
        sbSql.append("                        AND SL.SYS_ID = '100'                                                                                                                                                                                                              \n");
        sbSql.append("                        AND SL.COMP_CD = 'HFC'                                                                                                                                                                                                             \n");
        sbSql.append("                        ORDER BY DT.ROWID                                                                                                                                                                                                                  \n");
        sbSql.append("                    ) UP,                                                                                                                                                                                                                                  \n");
        sbSql.append("                     EPROCUSR.ESIMGHD HD,                                         /* 수불헤더*/                                                                                                                                                            \n");
        sbSql.append("                     EPROCUSR.ESIMGDT DT,                                        /* 수불상세 */                                                                                                                                                            \n");
        sbSql.append("                     EPROCUSR.ESMMTGL MT,                                       /* 품목마스터 */                                                                                                                                                           \n");
        sbSql.append("                     ( -- ESISALP 테이블과 인덱스간의 클러스터링팩터가 좋지 않아 ROWID로 정렬후 SCAN까지한 VIEW                                                                                                                                            \n");
        sbSql.append("                        SELECT  /*+ NO_MERGE LEADING(SL) USE_NL(SLD) */                                                                                                                                                                                    \n");
        sbSql.append("                                SL.SL_ID AS SL_ID,                                                                                                                                                                                                         \n");
        sbSql.append("                               SLD.SHOP_CD,                                                                                                                                                                                                                \n");
        sbSql.append("                               SLD.SAL_PRICE,                                                                                                                                                                                                              \n");
        sbSql.append("                               SL.MAIN_UPJANG   -- GROUP 합계용 MAIN_UPJANG 데이터                                                                                                                                                                         \n");
        sbSql.append("                        FROM EPROCUSR.ESISALP SLD,                                                                                                                                                                                                         \n");
        sbSql.append("                             (                                                                                                                                                                                                                             \n");
        sbSql.append("                                SELECT /*+ NO_MERGE */ SL.ROWID AS SL_ID,                                                                                                                                                                                  \n");
        sbSql.append("                                       BB.MAIN_UPJANG                                                                                                                                                                                                      \n");
        sbSql.append("                                FROM EPROCUSR.ESISALP SL                                               /* 판매단가 */                                                                                                                                      \n");
        sbSql.append("                                    INNER JOIN FMS_UPJANG_WITH BB                                                                                                                                                                                          \n");
        sbSql.append("                                    ON SL.SHOP_CD = BB.UPJANG                                                                                                                                                                                              \n");
        sbSql.append("                                ORDER BY SL.ROWID                                                                                                                                                                                                          \n");
        sbSql.append("                            ) SL                                                                                                                                                                                                                           \n");
        sbSql.append("                        WHERE SLD.ROWID = SL.SL_ID                                                                                                                                                                                                         \n");
        sbSql.append("                        ORDER BY SL.SL_ID                                                                                                                                                                                                                  \n");
        sbSql.append("                    ) SL                                                                                                                                                                                                                                   \n");
        sbSql.append("                WHERE UP.SL_ID = SL.SL_ID                                                                                                                                                                                                                  \n");
        sbSql.append("                AND UP.DT_ID = DT.ROWID                                                                                                                                                                                                                    \n");
        sbSql.append("                AND DT.SYS_ID = HD.SYS_ID                                                                                                                                                                                                                  \n");
        sbSql.append("                AND DT.COMP_CD = HD.COMP_CD                                                                                                                                                                                                                \n");
        sbSql.append("                AND DT.WH_CD = HD.WH_CD                                                                                                                                                                                                                    \n");
        sbSql.append("                AND DT.ITEM_CD = HD.ITEM_CD                                                                                                                                                                                                                \n");
        sbSql.append("                AND HD.SYS_ID = '100'                                                                                                                                                                                                                      \n");
        sbSql.append("                AND HD.COMP_CD = 'HFC'                                                                                                                                                                                                                     \n");
        sbSql.append("                AND HD.BU_CD = '2000'                                                                                                                                                                                                                      \n");
        sbSql.append("                AND DT.MOVEMENT_TYP NOT IN (                                                                                                                                                                                                               \n");
        sbSql.append("                        '561','562','998','999','901','902','801','802','111','112','211','212'                                                                                                                                                            \n");
        sbSql.append("                    )   /* 기초 ,기말 재고,배송입출고,직송 가상입출고  제외 */                                                                                                                                                                             \n");
        sbSql.append("                AND DT.STS <> 'D'                                                                                                                                                                                                                          \n");
        sbSql.append("                AND DT.SYS_ID = MT.SYS_ID                                                                                                                                                                                                                  \n");
        sbSql.append("                AND DT.ITEM_CD = MT.ITEM_CD                                                                                                                                                                                                                \n");
        sbSql.append("                AND DT.MG_DATE <= '"+strDate+"' -- 조건절 추가                                                                                                                                                                                                \n");
        sbSql.append("                ) A                                                                                                                                                                                                                                        \n");
        sbSql.append("                UNION ALL                                                                                                                                                                                                                                  \n");
        sbSql.append("                SELECT FB.TRANS_ID ,             /* 자재수불번호 : M+'0000000000' : 조정분 */                                                                                                                                                              \n");
        sbSql.append("                FB.TRANS_DATE AS MG_DATE,                                                                                                                                                                                                                  \n");
        sbSql.append("                FB.SOURCE_TYPE,                                                                                                                                                                                                                            \n");
        sbSql.append("                FB.TRANS_TYPE,                                                                                                                                                                                                                             \n");
        sbSql.append("                FB.TRANS_QTY,                                                                                                                                                                                                                              \n");
        sbSql.append("                TO_CHAR(FB.TRANS_UPJANG) AS TRANS_UPJANG,                                                                                                                                                                                                  \n");
        sbSql.append("                FB.TAX_CODE,                                                                                                                                                                                                                               \n");
        sbSql.append("                FB.SALE_PRICE,                                                                                                                                                                                                                             \n");
        sbSql.append("                BB.MAIN_UPJANG                                                                                                                                                                                                                             \n");
        sbSql.append("                FROM FMS_TRANSACTION FB INNER JOIN FMS_UPJANG_WITH BB                                                                                                                                                                                      \n");
        sbSql.append("                                    ON FB.TRANS_UPJANG = BB.UPJANG                                                                                                                                                                                         \n");
        sbSql.append("                                WHERE FB.TRANS_DATE <= '"+strDate+"' -- MG_DATE <= 조건                                                                                                                                                                       \n");
        sbSql.append("            ) A                                                                                                                                                                                                                                            \n");
        sbSql.append("        LEFT JOIN (                                                                                                                                                                                                                                        \n");
        sbSql.append("                   SELECT                                                                                                                                                                                                                                  \n");
        sbSql.append("                      UPJANG                                                                                                                                                                                                                               \n");
        sbSql.append("                    ,  MAX(SALE_DATE) AS SALE_DATE                                                                                                                                                                                                         \n");
        sbSql.append("                   FROM   FMS_SALES                                                                                                                                                                                                                        \n");
        sbSql.append("                   WHERE  SALE_DATE <= '"+strDate+"'                                                                                                                                                                                                          \n");
        sbSql.append("                    AND     TRANS_YN = 'Y'                                                                                                                                                                                                                 \n");
        sbSql.append("                    GROUP BY UPJANG                                                                                                                                                                                                                        \n");
        sbSql.append("                   ) C ON A.TRANS_UPJANG = C.UPJANG                                                                                                                                                                                                        \n");
        sbSql.append("    WHERE    -- A.MG_DATE <= '"+strDate+"'                                                                                                                                                                                                                    \n");
        sbSql.append("     A.MG_DATE >= DECODE(C.SALE_DATE, NULL, GREATEST(TO_CHAR(ADD_MONTHS(TO_DATE('"+strDate+"', 'YYYYMMDD'), -1), 'YYYYMM') || '01', NVL(TO_CHAR(TO_DATE(C.SALE_DATE, 'YYYYMMDD')+1, 'YYYYMMDD'),' ')),  TO_CHAR(TO_DATE(C.SALE_DATE, 'YYYYMMDD')+1, 'YYYYMMDD')) \n");
        sbSql.append("     AND    (A.TRANS_TYPE = 'I001' OR (A.TRANS_TYPE LIKE '_002' AND A.SOURCE_TYPE = 'PO') )                                                                                                                                                                \n");
        sbSql.append("     GROUP BY                                                                                                                                                                                                                                              \n");
        sbSql.append("     A.MAIN_UPJANG,                                                                                                                                                                                                                                        \n");
        sbSql.append("     A.TRANS_UPJANG                                                                                                                                                                                                                                        \n");
        sbSql.append(")                                                                                                                                                                                                                                                          \n");
        sbSql.append(" SELECT  /*+ optimizer_features_enable('10.2.0.5') */                                                                                                                                                                                                      \n");
        sbSql.append("       A.MAIN_UPJANG, DECODE(A.MAIN_UPJANG,A.UPJANG,'0','1') AS BON_GB                                                                                                                                                                                     \n");
        sbSql.append("     , A.UPJANG                                                                                                                                                                                                                                            \n");
        sbSql.append("     , DECODE(A.MAIN_UPJANG,A.UPJANG,NULL,' - ')||A.UPJANGNM_DISP AS UPJANGNM_DISP                                                                                                                                                                         \n");
        sbSql.append("      ,(CASE WHEN NVL(A.CREDIT_END,'99999999') >= TO_CHAR(SYSDATE, 'YYYYMMDD') THEN DECODE(A.MAIN_UPJANG,A.UPJANG,NVL(A.CREDIT_AMOUNT,0)) ELSE 0 END) AS AMT1                                                                                              \n");
        sbSql.append("      ,(CASE WHEN NVL(A.CREDIT_END,'99999999') >= TO_CHAR(SYSDATE, 'YYYYMMDD') THEN DECODE(A.MAIN_UPJANG,A.UPJANG,NVL(A.CREDIT_AMOUNT,0)) ELSE 0 END) AS AMT1_0                                                                                            \n");
        sbSql.append("     , DECODE(A.MAIN_UPJANG,A.UPJANG,0) AS AMT1_1                                                                                                                                                                                                          \n");
        sbSql.append("     , DECODE(A.MAIN_UPJANG,A.UPJANG,NVL(E.PO_AMT,0) + NVL(F.PR_AMT,0)) AS AMT1_2                                                                                                                                                                          \n");
        sbSql.append("     , DECODE(A.MAIN_UPJANG,A.UPJANG,NVL(D.TR_AMT,0),NVL(D_1.TR_AMT,0)) AS AMT1_3                                                                                                                                                                          \n");
        sbSql.append("  , DECODE(A.MAIN_UPJANG,A.UPJANG,NVL(C0.RMN_AMT,0)) AS AMT2_0                                                                                                                                                                                             \n");
        sbSql.append("  , DECODE(A.MAIN_UPJANG,A.UPJANG,NVL(C1.PRE_AMT,0)) AS AMT2_3                                                                                                                                                                                             \n");
        sbSql.append("     , 0 AS AMT2                                                                                                                                                                                                                                           \n");
        sbSql.append("     , 0 AS AMT2_1                                                                                                                                                                                                                                         \n");
        sbSql.append("     , DECODE(A.MAIN_UPJANG,A.UPJANG,CASE WHEN  '"+strDate+"' BETWEEN NVL(A.CREDIT_START,'00000000') AND NVL(A.CREDIT_END,'99999999')  THEN NVL(A.CREDIT_AMOUNT,0) ELSE 0 END                                                                                 \n");
        sbSql.append("       - NVL(C0.RMN_AMT,0) + NVL(C1.PRE_AMT,0) - NVL(D.TR_AMT,0) - NVL(E.PO_AMT,0) - NVL(F.PR_AMT,0)) AS AMT3                                                                                                                                              \n");
        sbSql.append("     , A.HEAD_CREDIT_YN AS TOT_YN                                                                                                                                                                                                                          \n");
        sbSql.append("     , DECODE(A.CREDIT_CONTROL_YN||A.CREDIT_TURN_CONTROL_YN||A.CREDIT_AMOUNT_CONTROL_YN                                                                                                                                                                    \n");
        sbSql.append("             ,'YYY','금액+회전일'                                                                                                                                                                                                                          \n");
        sbSql.append("             ,'YYN','회전일통제'                                                                                                                                                                                                                           \n");
        sbSql.append("             ,'YNY','금액통제','무통제') AS CTRL                                                                                                                                                                                                           \n");
        sbSql.append("     , A.CREDIT_TURN_DAYS AS CREDIT_TURN_DAYS                                                                                                                                                                                                              \n");
        sbSql.append("     , NVL(A.CREDIT_START,'00000000')||' ~ '||NVL(A.CREDIT_END,'99999999') AS PERIOD                                                                                                                                                                       \n");
        sbSql.append("     , DECODE(A.MAIN_UPJANG,A.UPJANG,'Y','N') AS SUM_FLAG                                                                                                                                                                                                  \n");
        sbSql.append("      ,(CASE WHEN NVL(A.CREDIT_OVER_END,'99999999') >= TO_CHAR(SYSDATE, 'YYYYMMDD') THEN DECODE(A.MAIN_UPJANG,A.UPJANG,A.CREDIT_OVER_AMOUNT) ELSE 0 END) AS CREDIT_OVER_AMOUNT                                                                             \n");
        sbSql.append("      ,(CASE WHEN NVL(A.CREDIT_OVER_END,'99999999') >= TO_CHAR(SYSDATE, 'YYYYMMDD') THEN TO_CHAR(TO_DATE(A.CREDIT_OVER_END,'YYYYMMDD'),'YYYY-MM-DD') ELSE '' END) AS CREDIT_OVER_END                                                                       \n");
        sbSql.append("  FROM FMS_UPJANG_WITH A                                                                                                                                                                                                                                   \n");
        sbSql.append("       LEFT JOIN                                                                                                                                                                                                                                           \n");
        sbSql.append("   --C0.외상잔액정보(AR)                                                                                                                                                                                                                                   \n");
        sbSql.append("  (                                                                                                                                                                                                                                                        \n");
        sbSql.append("  SELECT                                                                                                                                                                                                                                                   \n");
        sbSql.append("    S.MAIN_UPJANG                                                                                                                                                                                                                                          \n");
        sbSql.append("  , SUM(NVL(S.AR_AMT,0) - NVL(S.RECEIVE_AMT,0)) AS RMN_AMT                                                                                                                                                                                                 \n");
        sbSql.append("  FROM                                                                                                                                                                                                                                                     \n");
        sbSql.append("      (SELECT B.MAIN_UPJANG                                                                                                                                                                                                                                \n");
        sbSql.append("    , NVL(M.AR_AMT,0) AS AR_AMT                                                                                                                                                                                                                            \n");
        sbSql.append("    , (SELECT NVL(SUM(D.RECEIVE_AMT),0) FROM SLA_AR_RECEIVE_DETAIL D WHERE D.RECD_STATUS  = 'L'                                                                                                                                                            \n");
        sbSql.append("                              AND D.RECEIVE_DATE <= '"+jDate+"'                                                                                                                                                                                             \n");
        sbSql.append("                              AND D.AR_NUM = M.AR_NUM) AS RECEIVE_AMT                                                                                                                                                                                      \n");
        sbSql.append("       FROM SLA_AR_MST M                                                                                                                                                                                                                                   \n");
        sbSql.append("            INNER JOIN FMS_UPJANG_WITH B                                                                                                                                                                                                                   \n");
        sbSql.append("                      ON M.UPJANG_CD = B.UPJANG                                                                                                                                                                                                            \n");
        sbSql.append("  WHERE M.SYS_CLASS IN ('13', '14')                                                                                                                                                                                                                        \n");
        sbSql.append("  AND    M.RECD_STATUS = 'L'                                                                                                                                                                                                                               \n");
        sbSql.append("  AND    M.OCCUR_DATE <= '"+jDate+"'                                                                                                                                                                                                                        \n");
        sbSql.append("        ) S                                                                                                                                                                                                                                                \n");
        sbSql.append("    GROUP BY S.MAIN_UPJANG                                                                                                                                                                                                                                 \n");
        sbSql.append(" ) C0                                                                                                                                                                                                                                                      \n");
        sbSql.append("        ON A.MAIN_UPJANG = C0.MAIN_UPJANG                                                                                                                                                                                                                  \n");
        sbSql.append("       LEFT JOIN                                                                                                                                                                                                                                           \n");
        sbSql.append("       --C1.선수잔액정보                                                                                                                                                                                                                                   \n");
        sbSql.append("  (                                                                                                                                                                                                                                                        \n");
        sbSql.append("  SELECT                                                                                                                                                                                                                                                   \n");
        sbSql.append("    S.MAIN_UPJANG                                                                                                                                                                                                                                          \n");
        sbSql.append("  , SUM(NVL(S.OCCUR_AMT,0) - NVL(S.APPLY_AMT,0)) AS PRE_AMT                                                                                                                                                                                                \n");
        sbSql.append("  FROM                                                                                                                                                                                                                                                     \n");
        sbSql.append("      (SELECT B.MAIN_UPJANG                                                                                                                                                                                                                                \n");
        sbSql.append("    , NVL(M.OCCUR_AMT, 0) AS OCCUR_AMT                                                                                                                                                                                                                     \n");
        sbSql.append("    , (SELECT NVL(SUM(D.APPLY_AMT),0) FROM SLA_ADVANCE_ALT_DETAIL D WHERE D.RECD_STATUS  = 'L'                                                                                                                                                             \n");
        sbSql.append("                              AND D.ALT_DATE <= '"+jDate+"'                                                                                                                                                                                                 \n");
        sbSql.append("                              AND D.ADVANCE_NUM = M.ADVANCE_NUM) AS APPLY_AMT                                                                                                                                                                              \n");
        sbSql.append("       FROM SLA_ADVANCE_MST M                                                                                                                                                                                                                              \n");
        sbSql.append("            INNER JOIN FMS_UPJANG_WITH B                                                                                                                                                                                                                   \n");
        sbSql.append("                      ON M.UPJANG_CD = B.UPJANG                                                                                                                                                                                                            \n");
        sbSql.append("  WHERE M.SYS_CLASS IN ('13', '14')                                                                                                                                                                                                                        \n");
        sbSql.append("  AND    M.RECD_STATUS = 'L'                                                                                                                                                                                                                               \n");
        sbSql.append("  AND    M.OCCUR_DATE <= '"+jDate+"'                                                                                                                                                                                                                        \n");
        sbSql.append("       ) S                                                                                                                                                                                                                                                 \n");
        sbSql.append("    GROUP BY S.MAIN_UPJANG                                                                                                                                                                                                                                 \n");
        sbSql.append(" ) C1                                                                                                                                                                                                                                                      \n");
        sbSql.append("        ON A.MAIN_UPJANG = C1.MAIN_UPJANG                                                                                                                                                                                                                  \n");
        sbSql.append("       LEFT JOIN                                                                                                                                                                                                                                           \n");
        sbSql.append("       --D.당월 미매출마감된 검수금액  -- 216초                                                                                                                                                                                                            \n");
        sbSql.append("      (SELECT X.MAIN_UPJANG                                                                                                                                                                                                                                \n");
        sbSql.append("    , SUM(X.TR_AMT) AS TR_AMT                                                                                                                                                                                                                              \n");
        sbSql.append("        FROM                                                                                                                                                                                                                                               \n");
        sbSql.append("       FMS_TRANSACTION_WITH X                                                                                                                                                                                                                              \n");
        sbSql.append("     GROUP BY X.MAIN_UPJANG                                                                                                                                                                                                                                \n");
        sbSql.append("     ) D                                                                                                                                                                                                                                                   \n");
        sbSql.append("        ON A.MAIN_UPJANG = D.MAIN_UPJANG                                                                                                                                                                                                                   \n");
        sbSql.append("       LEFT JOIN                                                                                                                                                                                                                                           \n");
        sbSql.append("       --E.당월 미검수 발주금액                                                                                                                                                                                                                            \n");
        sbSql.append("      (SELECT                                                                                                                                                                                                                                              \n");
        sbSql.append("              A.MAIN_UPJANG                                                                                                                                                                                                                                \n");
        sbSql.append("            , SUM(ROUND(DECODE(A.TAX_CODE,'100',1.1,1) * ROUND((A.CENTER_DELI_QTY + A.DIRECT_DELI_QTY - A.DELIVERED_QTY - A.UNDELIVERED_QTY) * A.SALE_PRICE))) AS PO_AMT                                                                                   \n");
        sbSql.append("       FROM HLDC_PO_PO_WITH A                                                                                                                                                                                                                              \n");
        sbSql.append("  WHERE -- A.NEED_DATE <= '"+strDate+"'  AND                                                                                                                                                                                                                  \n");
        sbSql.append("        A.LINE_STATUS IN ('PW', 'PC', 'DL')                                                                                                                                                                                                                \n");
        sbSql.append("        GROUP BY A.MAIN_UPJANG) E                                                                                                                                                                                                                          \n");
        sbSql.append("        ON A.MAIN_UPJANG = E.MAIN_UPJANG                                                                                                                                                                                                                   \n");
        sbSql.append("       LEFT JOIN                                                                                                                                                                                                                                           \n");
        sbSql.append("       --F.당월 미발주 주문금액                                                                                                                                                                                                                            \n");
        sbSql.append("      (SELECT                                                                                                                                                                                                                                              \n");
        sbSql.append("              B.MAIN_UPJANG                                                                                                                                                                                                                                \n");
        sbSql.append("            , SUM(ROUND(DECODE(A.TAX_CODE,'100',1.1,1) * ROUND(A.PR_QTY * A.SALE_PRICE))) AS PR_AMT                                                                                                                                                        \n");
        sbSql.append("  FROM SO_PR A INNER JOIN FMS_UPJANG_WITH B                                                                                                                                                                                                                \n");
        sbSql.append("                   ON A.RC_UPJANG = B.UPJANG                                                                                                                                                                                                               \n");
        sbSql.append("  WHERE A.NEED_DATE <= '"+strDate+"'                                                                                                                                                                                                                          \n");
        sbSql.append("  AND    A.LINE_STATUS IN ('001')                                                                                                                                                                                                                          \n");
        sbSql.append("        GROUP BY B.MAIN_UPJANG) F                                                                                                                                                                                                                          \n");
        sbSql.append("        ON A.MAIN_UPJANG = F.MAIN_UPJANG                                                                                                                                                                                                                   \n");
        sbSql.append("       LEFT JOIN                                                                                                                                                                                                                                           \n");
        sbSql.append("       --D_1.당월 미매출마감된 검수금액                                                                                                                                                                                                                    \n");
        sbSql.append("      (SELECT X.UPJANG                                                                                                                                                                                                                                     \n");
        sbSql.append("    , SUM(X.TR_AMT) AS TR_AMT                                                                                                                                                                                                                              \n");
        sbSql.append("        FROM                                                                                                                                                                                                                                               \n");
        sbSql.append("      FMS_TRANSACTION_WITH X                                                                                                                                                                                                                               \n");
        sbSql.append(" GROUP BY X.UPJANG                                                                                                                                                                                                                                         \n");
        sbSql.append(" ) D_1                                                                                                                                                                                                                                                     \n");
        sbSql.append("        ON A.UPJANG = D_1.UPJANG                                                                                                                                                                                                                           \n");

		pstmt = conn.prepareStatement(sbSql.toString());		
		rs = pstmt.executeQuery(); 
		ds_List = this.makeDataSet(rs, "ds_List");
		rs.close();
		pstmt.close();
		
		//본사 미 통합 업장 대상 여신체크할 최종 발주일자 조회
		sbSql.delete(0,sbSql.length());
		sbSql.append("SELECT \n");
		sbSql.append("       MAX(A.NEED_DATE) AS NEED_DATE \n");
		sbSql.append("  FROM SO_PR A, FMS_UPJANG B\n");
		sbSql.append(" WHERE A.RC_UPJANG = B.UPJANG \n");
		sbSql.append("   AND A.NEED_DATE BETWEEN '" + nullToBlank(ds_Cond.getString(0, "JDATE")) + "' AND GREATEST(TO_CHAR(SYSDATE+31,'YYYYMMDD'),'" + nullToBlank(ds_Cond.getString(0, "JDATE")) + "') \n");
		sbSql.append("   AND A.SUBINV_CODE LIKE 'S1%' \n");
		sbSql.append("   AND A.LINE_STATUS NOT IN ('003', '005','999')  --신청취소, 결의반려 제외 \n");

		pstmt = conn.prepareStatement(sbSql.toString());
		rs = pstmt.executeQuery();
		if(rs.next())
			strDate = rs.getString("NEED_DATE");
		else
			strDate = nullToBlank(ds_Cond.getString(0, "JDATE"));
		rs.close();
		pstmt.close();

		if (nullToBlank(strDate)=="") strDate = nullToBlank(ds_Cond.getString(0, "JDATE"));


		//본사 미 통합 업장내역조회(속도관계상 운영율은 적용하지 않는다.)
		//여신연장금액 정보 삭제
		sbSql.delete(0,sbSql.length());
		sbSql.append("/* MAK10170S_T003_tun2.jsp */ \n");
        sbSql.append("WITH FMS_UPJANG_WITH AS                                                                                                                                                                                                                                    \n");
        sbSql.append(" (                                                                                                                                                                                                                                                         \n");
        sbSql.append("SELECT /*+ MATERIALIZE */                                                                                                                                                                                                                                  \n");
        sbSql.append("        A.MAIN_UPJANG                                                                                                                                                                                                                                      \n");
        sbSql.append("       ,A.UPJANG                                                                                                                                                                                                                                           \n");
        sbSql.append("       ,A.UPJANGNM_DISP                                                                                                                                                                                                                                    \n");
        sbSql.append("       ,A.CREDIT_AMOUNT                                                                                                                                                                                                                                    \n");
        sbSql.append("       ,A.HEAD_CREDIT_YN                                                                                                                                                                                                                                   \n");
        sbSql.append("       ,A.CREDIT_CONTROL_YN                                                                                                                                                                                                                                \n");
        sbSql.append("       ,A.CREDIT_TURN_CONTROL_YN                                                                                                                                                                                                                           \n");
        sbSql.append("       ,A.CREDIT_AMOUNT_CONTROL_YN                                                                                                                                                                                                                         \n");
        sbSql.append("       ,A.CREDIT_TURN_DAYS                                                                                                                                                                                                                                 \n");
        sbSql.append("       ,A.CREDIT_START                                                                                                                                                                                                                                     \n");
        sbSql.append("       ,A.CREDIT_END                                                                                                                                                                                                                                       \n");
        sbSql.append("       ,A.CREDIT_OVER_END                                                                                                                                                                                                                                  \n");
        sbSql.append("       ,A.CREDIT_OVER_AMOUNT                                                                                                                                                                                                                               \n");
        sbSql.append("       FROM FMS_UPJANG A                                                                                                                                                                                                                                   \n");
        if (! nullToBlank(ds_Cond.getString(0, "CENTER_CODE")).equals(""))				
		{
            sbSql.append("									INNER JOIN ST_UPJANG Y ON A.UPJANG = Y.UPJANG \n");
            sbSql.append("									INNER JOIN HLDC_PO_UPJANG_CENTER X ON X.CENTER_CODE = '" + nullToBlank(ds_Cond.getString(0, "CENTER_CODE")) + "' \n");
            sbSql.append("																						    AND Y.AP_UNITPRICE_UPJANG = X.UPJANG \n");
		}
        sbSql.append("       WHERE A.HEAD_CREDIT_YN = 'N'                                                                                                                                                                                                                        \n");
        if (! nullToBlank(ds_Cond.getString(0, "USE_YN")).equals(""))				
    		sbSql.append("   AND A.USE_YN = '" + nullToBlank(ds_Cond.getString(0, "USE_YN")) + "' \n");
        if (! nullToBlank(ds_Cond.getString(0, "SALE_SABUN")).equals(""))
			sbSql.append("   AND A.PART_SALES_SABUN = '" + nullToBlank(ds_Cond.getString(0, "SALE_SABUN")) + "' \n");
        
        sbSql.append("),                                                                                                                                                                                                                                                         \n");
        sbSql.append("HLDC_PO_PO_WITH AS                                                                                                                                                                                                                                         \n");
        sbSql.append("(                                                                                                                                                                                                                                                          \n");
        sbSql.append(" SELECT /*+  LEADING(B)  */                                                                                                                                                                                                                                \n");
        sbSql.append(" SAL.SHOP_CD          AS RC_UPJANG   -- 입고업장 코드 SAL.SHOP_CD                                                                                                                                                                                          \n");
        sbSql.append(",CASE                                                                                                                                                                                                                                                      \n");
        sbSql.append("    WHEN PODT.DUTY_FREE_YN ='1' THEN '100'                                                                                                                                                                                                                 \n");
        sbSql.append("    WHEN PODT.DUTY_FREE_YN ='3' THEN '210'                                                                                                                                                                                                                 \n");
        sbSql.append("    WHEN PODT.DUTY_FREE_YN ='2' THEN '220'                                                                                                                                                                                                                 \n");
        sbSql.append("END  AS TAX_CODE   -- 과세구분코드                                                                                                                                                                                                                         \n");
        sbSql.append(", CASE WHEN PODT.PROC_TYP_CD IN('DC', 'TC') THEN PODT.ITEM_QTY ELSE 0 END  AS CENTER_DELI_QTY  -- 센터입고수량                                                                                                                                             \n");
        sbSql.append(", CASE PODT.PROC_TYP_CD WHEN 'VC' THEN PODT.ITEM_QTY ELSE 0 END  AS DIRECT_DELI_QTY  -- 직송 수량                                                                                                                                                          \n");
        sbSql.append(", CASE PODT.PROC_TYP_CD WHEN 'VC' THEN NVL(PODT.GR_QTY,0) ELSE NVL(PODT.GR_QTY_WMS,0) END  AS DELIVERED_QTY    --업장입고수량(센터출고)                                                                                                                    \n");
        sbSql.append(", CASE                                                                                                                                                                                                                                                     \n");
        sbSql.append("       WHEN PODT.PO_COMP_YN='Y' OR PODT.GR_COMP_YN='Y' THEN NVL(PODT.ITEM_QTY,0) - NVL(PODT.GR_QTY,0) -- 입고완료                                                                                                                                          \n");
        sbSql.append("       ELSE 0                                                                                                                                                                                                                                              \n");
        sbSql.append("   END AS UNDELIVERED_QTY -- 감량수량                                                                                                                                                                                                                      \n");
        sbSql.append(", SAL.CUST_GR_DATE                AS NEED_DATE -- 입고희망일자                                                                                                                                                                                             \n");
        sbSql.append("   , NVL(CASE WHEN POHD.PO_TYP = 'BP' THEN                                                                                                                                                                                                                 \n");
        sbSql.append("             CASE                                                                                                                                                                                                                                          \n");
        sbSql.append("               WHEN PODT.GR_COMP_YN='N' AND POHD.APRV_STS = 'T'         THEN 'RW' --통합영업에서 뷰 불가                                                                                                                                                   \n");
        sbSql.append("               WHEN PODT.GR_COMP_YN='N' AND POHD.APRV_STS = 'P'         THEN 'PW'                                                                                                                                                                          \n");
        sbSql.append("               WHEN PODT.GR_COMP_YN='N' AND POHD.APRV_STS IN ('R', 'W') THEN 'PD'                                                                                                                                                                          \n");
        sbSql.append("               WHEN PODT.GR_COMP_YN='N' AND POHD.APRV_STS = 'B'         THEN 'PD'                                                                                                                                                                          \n");
        sbSql.append("               WHEN PODT.GR_COMP_YN='Y' AND POHD.APRV_STS = 'B'         THEN 'GC'                                                                                                                                                                          \n");
        sbSql.append("               WHEN PODT.GR_COMP_YN='Y' AND POHD.APRV_STS IN ('C', 'K') THEN 'GC'                                                                                                                                                                          \n");
        sbSql.append("             END                                                                                                                                                                                                                                           \n");
        sbSql.append("       --ELSE NVL(PRDT.PR_PROG_STS, 'PC')                                                                                                                                                                                                                  \n");
        sbSql.append("          ELSE DECODE(PODT.GR_COMP_YN, 'Y', 'GC', NVL(PRDT.PR_PROG_STS,'PC'))                                                                                                                                                                              \n");
        sbSql.append("       END,'PC') AS LINE_STATUS  -- 라인 상태 코드                                                                                                                                                                                                         \n");
        sbSql.append("     , NVL(SAL.SAL_PRICE,0)      AS SALE_PRICE -- 판매 단가 AS SALE_PRICE                                                                                                                                                                                  \n");
        sbSql.append("     --                                                                                                                                                                                                                                                    \n");
        sbSql.append("     ,B.MAIN_UPJANG                                                                                                                                                                                                                                        \n");
        sbSql.append("  FROM EPROCUSR.ESPPOHD POHD   -- PO 헤더                                                                                                                                                                                                                  \n");
        sbSql.append("     , EPROCUSR.ESPPODT PODT   -- PO 상세(품목)                                                                                                                                                                                                            \n");
        sbSql.append("     , EPROCUSR.ESMMTGL MTGL   -- 자재마스터                                                                                                                                                                                                               \n");
        sbSql.append("     , EPROCUSR.ESPPODTSAL SAL -- 판매단가정보[통합영업]                                                                                                                                                                                                   \n");
        sbSql.append("     , EPROCUSR.ESPPRDT PRDT   -- PR 상세(품목)                                                                                                                                                                                                            \n");
        sbSql.append("     ,                                                                                                                                                                                                                                                     \n");
        sbSql.append("       (                                                                                                                                                                                                                                                   \n");
        sbSql.append("        SELECT /*+ NO_MERGE LEADING(B) */                                                                                                                                                                                                                  \n");
        sbSql.append("        B.MAIN_UPJANG, B.UPJANG,                                                                                                                                                                                                                           \n");
        sbSql.append("        SAL.ROWID AS SAL_ID,                                                                                                                                                                                                                               \n");
        sbSql.append("        PODT.ROWID AS PODT_ID                                                                                                                                                                                                                              \n");
        sbSql.append("        FROM  EPROCUSR.ESPPODTSAL SAL -- 판매단가정보[통합영업]                                                                                                                                                                                            \n");
        sbSql.append("        ,EPROCUSR.ESPPODT PODT  -- PO 상세(품목)                                                                                                                                                                                                           \n");
        sbSql.append("        ,FMS_UPJANG_WITH B                                                                                                                                                                                                                                 \n");
        sbSql.append("        WHERE                                                                                                                                                                                                                                              \n");
        sbSql.append("            B.UPJANG = SAL.SHOP_CD                                                                                                                                                                                                                         \n");
        sbSql.append("        AND SAL.CUST_GR_DATE BETWEEN TO_CHAR(ADD_MONTHS(SYSDATE,-1),'YYYYMMDD') AND '"+strDate+"'                                                                                                                                                                                                                 \n");
        sbSql.append("        AND SAL.SYS_ID  = PODT.SYS_ID                                                                                                                                                                                                                      \n");
        sbSql.append("        AND SAL.COMP_CD = PODT.COMP_CD                                                                                                                                                                                                                     \n");
        sbSql.append("        AND SAL.PO_NO   = PODT.PO_NO                                                                                                                                                                                                                       \n");
        sbSql.append("        AND SAL.PO_LNO  = PODT.PO_LNO                                                                                                                                                                                                                      \n");
        sbSql.append("        AND SAL.SYS_ID  = '100'                                                                                                                                                                                                                            \n");
        sbSql.append("        AND SAL.COMP_CD = 'HFC'                                                                                                                                                                                                                            \n");
        sbSql.append("        ORDER BY PODT.ROWID                                                                                                                                                                                                                                \n");
        sbSql.append("    ) B                                                                                                                                                                                                                                                    \n");
        sbSql.append(" WHERE PODT.SYS_ID  = POHD.SYS_ID(+)                                                                                                                                                                                                                       \n");
        sbSql.append("   AND PODT.COMP_CD = POHD.COMP_CD (+)                                                                                                                                                                                                                     \n");
        sbSql.append("   AND PODT.PO_NO   = POHD.PO_NO(+)                                                                                                                                                                                                                        \n");
        sbSql.append("--   AND PODT.SYS_ID  = SAL.SYS_ID(+)                                                                                                                                                                                                                      \n");
        sbSql.append("--   AND PODT.COMP_CD = SAL.COMP_CD(+)                                                                                                                                                                                                                     \n");
        sbSql.append("--   AND PODT.PO_NO   = SAL.PO_NO(+)                                                                                                                                                                                                                       \n");
        sbSql.append("--   AND PODT.PO_LNO  = SAL.PO_LNO(+)                                                                                                                                                                                                                      \n");
        sbSql.append("   AND PODT.SYS_ID  = MTGL.SYS_ID                                                                                                                                                                                                                          \n");
        sbSql.append("   AND PODT.ITEM_CD = MTGL.ITEM_CD                                                                                                                                                                                                                         \n");
        sbSql.append("   AND PODT.PR_NO   = PRDT.PR_NO(+)                                                                                                                                                                                                                        \n");
        sbSql.append("   AND PODT.PR_LNO  = PRDT.PR_LNO(+)                                                                                                                                                                                                                       \n");
        sbSql.append("   AND PODT.SYS_ID  = PRDT.SYS_ID(+)                                                                                                                                                                                                                       \n");
        sbSql.append("   AND PODT.COMP_CD = PRDT.COMP_CD(+)                                                                                                                                                                                                                      \n");
        sbSql.append("   AND PODT.SYS_ID  = '100'                                                                                                                                                                                                                                \n");
        sbSql.append("   AND PODT.COMP_CD = 'HFC'                                                                                                                                                                                                                                \n");
        sbSql.append("   AND PODT.SHOP_TYP_CD = '02'                                                                                                                                                                                                                             \n");
        sbSql.append("   AND PODT.STS    <> 'D'                                                                                                                                                                                                                                  \n");
        sbSql.append("   ---                                                                                                                                                                                                                                                     \n");
        sbSql.append("   AND POHD.PO_TYP IN ('UP','BP') -- 첫번째  조건 'UP' 2015.10.19 최학진 정산용 PO 추가조건 'BP'                                                                                                                                                           \n");
        sbSql.append("   --                                                                                                                                                                                                                                                      \n");
        sbSql.append("--  AND SAL.CUST_GR_DATE BETWEEN TO_CHAR(ADD_MONTHS(SYSDATE,-1),'YYYYMMDD') AND '"+strDate+"'                                                                                                                                                                                                                     \n");
        sbSql.append("--  AND SAL.SHOP_CD = B.UPJANG                                                                                                                                                                                                                             \n");
        sbSql.append("AND B.SAL_ID = SAL.ROWID                                                                                                                                                                                                                                   \n");
        sbSql.append("AND B.PODT_ID = PODT.ROWID                                                                                                                                                                                                                                 \n");
        sbSql.append("UNION ALL                                                                                                                                                                                                                                                  \n");
        sbSql.append("SELECT /*+ LEADING(B) */                                                                                                                                                                                                                                   \n");
        sbSql.append("   PODT.SHOP_CD             AS RC_UPJANG   -- 입고업장 코드                                                                                                                                                                                                \n");
        sbSql.append("    , CASE                                                                                                                                                                                                                                                 \n");
        sbSql.append("         WHEN PODT.DUTY_FREE_YN ='1' THEN '100'                                                                                                                                                                                                            \n");
        sbSql.append("         WHEN PODT.DUTY_FREE_YN ='3' THEN '210'                                                                                                                                                                                                            \n");
        sbSql.append("         WHEN PODT.DUTY_FREE_YN ='2' THEN '220'                                                                                                                                                                                                            \n");
        sbSql.append("       END  AS TAX_CODE   -- 과세구분코드                                                                                                                                                                                                                  \n");
        sbSql.append("  , CASE WHEN PODT.PROC_TYP_CD IN('DC', 'TC') THEN PODT.ITEM_QTY ELSE 0 END  AS CENTER_DELI_QTY  -- 센터입고수량                                                                                                                                           \n");
        sbSql.append("  , CASE PODT.PROC_TYP_CD WHEN 'VC' THEN PODT.ITEM_QTY ELSE 0 END  AS DIRECT_DELI_QTY  -- 직송 수량                                                                                                                                                        \n");
        sbSql.append("  , CASE PODT.PROC_TYP_CD WHEN 'VC' THEN NVL(PODT.GR_QTY,0) ELSE NVL(PODT.GR_QTY_WMS,0) END  AS DELIVERED_QTY    --업장입고수량(센터출고)                                                                                                                  \n");
        sbSql.append("  , CASE                                                                                                                                                                                                                                                   \n");
        sbSql.append("    WHEN PODT.PO_COMP_YN='Y' OR PODT.GR_COMP_YN='Y' THEN NVL(PODT.ITEM_QTY,0) - NVL(PODT.GR_QTY,0) -- 입고완료                                                                                                                                             \n");
        sbSql.append("    ELSE 0                                                                                                                                                                                                                                                 \n");
        sbSql.append("  END AS UNDELIVERED_QTY -- 감량수량                                                                                                                                                                                                                       \n");
        sbSql.append("  , PODT.GR_REQ_DATE                AS NEED_DATE -- 입고희망일자                                                                                                                                                                                           \n");
        sbSql.append("  , NVL(CASE WHEN POHD.PO_TYP = 'BP' THEN                                                                                                                                                                                                                  \n");
        sbSql.append("             CASE                                                                                                                                                                                                                                          \n");
        sbSql.append("               WHEN PODT.GR_COMP_YN='N' AND POHD.APRV_STS = 'T'         THEN 'RW' --통합영업에서 뷰 불가                                                                                                                                                   \n");
        sbSql.append("               WHEN PODT.GR_COMP_YN='N' AND POHD.APRV_STS = 'P'         THEN 'PW'                                                                                                                                                                          \n");
        sbSql.append("               WHEN PODT.GR_COMP_YN='N' AND POHD.APRV_STS IN ('R', 'W') THEN 'PD'                                                                                                                                                                          \n");
        sbSql.append("               WHEN PODT.GR_COMP_YN='N' AND POHD.APRV_STS = 'B'         THEN 'PD'                                                                                                                                                                          \n");
        sbSql.append("               WHEN PODT.GR_COMP_YN='Y' AND POHD.APRV_STS = 'B'         THEN 'GC'                                                                                                                                                                          \n");
        sbSql.append("               WHEN PODT.GR_COMP_YN='Y' AND POHD.APRV_STS IN ('C', 'K') THEN 'GC'                                                                                                                                                                          \n");
        sbSql.append("             END                                                                                                                                                                                                                                           \n");
        sbSql.append("       --ELSE NVL(PRDT.PR_PROG_STS, 'PC')                                                                                                                                                                                                                  \n");
        sbSql.append("          ELSE DECODE(PODT.GR_COMP_YN, 'Y', 'GC', NVL(PRDT.PR_PROG_STS,'PC'))                                                                                                                                                                              \n");
        sbSql.append("       END,'PC') AS LINE_STATUS  -- 라인 상태 코드                                                                                                                                                                                                         \n");
        sbSql.append(", NVL(SAL.SAL_PRICE,0)      AS SALE_PRICE -- 판매 단가                                                                                                                                                                                                     \n");
        sbSql.append("--                                                                                                                                                                                                                                                         \n");
        sbSql.append(", B.MAIN_UPJANG                                                                                                                                                                                                                                            \n");
        sbSql.append("  FROM EPROCUSR.ESPPOHD POHD   -- PO 헤더                                                                                                                                                                                                                  \n");
        sbSql.append("     , EPROCUSR.ESPPODT PODT   -- PO 상세(품목)                                                                                                                                                                                                            \n");
        sbSql.append("     , EPROCUSR.ESMMTGL MTGL   -- 자재마스터                                                                                                                                                                                                               \n");
        sbSql.append("     , EPROCUSR.ESPPODTSAL SAL -- 판매단가정보[통합영업]                                                                                                                                                                                                   \n");
        sbSql.append("     , EPROCUSR.ESPPRDT PRDT   -- PR 상세(품목)                                                                                                                                                                                                            \n");
        sbSql.append("     , (                                                                                                                                                                                                                                                   \n");
        sbSql.append("        SELECT /*+ NO_MERGE USE_HASH(B PDOT) LEADING(B) */                                                                                                                                                                                                 \n");
        sbSql.append("        B.MAIN_UPJANG,B.UPJANG,                                                                                                                                                                                                                            \n");
        sbSql.append("        PODT.ROWID AS PODT_ID                                                                                                                                                                                                                              \n");
        sbSql.append("        FROM                                                                                                                                                                                                                                               \n");
        sbSql.append("        EPROCUSR.ESPPODT PODT                                                                                                                                                                                                                              \n");
        sbSql.append("        , FMS_UPJANG_WITH B                                                                                                                                                                                                                                \n");
        sbSql.append("         WHERE PODT.GR_REQ_DATE BETWEEN TO_CHAR(ADD_MONTHS(SYSDATE,-1),'YYYYMMDD') AND '"+strDate+"'                                                                                                                                                                                                              \n");
        sbSql.append("         AND PODT.SHOP_CD = B.UPJANG                                                                                                                                                                                                                       \n");
        sbSql.append("         AND PODT.SYS_ID  = '100'                                                                                                                                                                                                                          \n");
        sbSql.append("         AND PODT.COMP_CD = 'HFC'                                                                                                                                                                                                                          \n");
        sbSql.append("         ORDER BY PODT.ROWID                                                                                                                                                                                                                               \n");
        sbSql.append("       ) B                                                                                                                                                                                                                                                 \n");
        sbSql.append(" WHERE PODT.SYS_ID  = POHD.SYS_ID (+)                                                                                                                                                                                                                      \n");
        sbSql.append("   AND PODT.COMP_CD = POHD.COMP_CD(+)                                                                                                                                                                                                                      \n");
        sbSql.append("   AND PODT.PO_NO   = POHD.PO_NO  (+)                                                                                                                                                                                                                      \n");
        sbSql.append("   AND PODT.SYS_ID  = SAL.SYS_ID(+)                                                                                                                                                                                                                        \n");
        sbSql.append("   AND PODT.COMP_CD = SAL.COMP_CD(+)                                                                                                                                                                                                                       \n");
        sbSql.append("   AND PODT.PO_NO   = SAL.PO_NO(+)                                                                                                                                                                                                                         \n");
        sbSql.append("   AND PODT.PO_LNO  = SAL.PO_LNO(+)                                                                                                                                                                                                                        \n");
        sbSql.append("   AND PODT.SYS_ID  = MTGL.SYS_ID                                                                                                                                                                                                                          \n");
        sbSql.append("   AND PODT.ITEM_CD = MTGL.ITEM_CD                                                                                                                                                                                                                         \n");
        sbSql.append("   AND PODT.PR_NO   = PRDT.PR_NO(+)                                                                                                                                                                                                                        \n");
        sbSql.append("   AND PODT.PR_LNO  = PRDT.PR_LNO(+)                                                                                                                                                                                                                       \n");
        sbSql.append("   AND PODT.SYS_ID  = PRDT.SYS_ID(+)                                                                                                                                                                                                                       \n");
        sbSql.append("   AND PODT.COMP_CD = PRDT.COMP_CD(+)                                                                                                                                                                                                                      \n");
        sbSql.append("   AND PODT.SHOP_TYP_CD <> '02'                                                                                                                                                                                                                            \n");
        sbSql.append("   --AND PODT.SYS_ID  = '100'                                                                                                                                                                                                                              \n");
        sbSql.append("  -- AND PODT.COMP_CD = 'HFC'                                                                                                                                                                                                                              \n");
        sbSql.append("   -- AND POHD.STS    <> 'D'                                                                                                                                                                                                                               \n");
        sbSql.append("   AND PODT.STS    <> 'D'                                                                                                                                                                                                                                  \n");
        sbSql.append("   --- 두번째 UNION ALL 조건                                                                                                                                                                                                                               \n");
        sbSql.append("   AND ((PRDT.STS    <> 'D'                                                                                                                                                                                                                                \n");
        sbSql.append("   AND PODT.REQ_SYS_CD = 'FR') OR                                                                                                                                                                                                                          \n");
        sbSql.append("   -- 세번째 UNION ALL 조건                                                                                                                                                                                                                                \n");
        sbSql.append("    (PODT.REQ_SYS_CD <> 'FR')                                                                                                                                                                                                                              \n");
        sbSql.append("   )                                                                                                                                                                                                                                                       \n");
        sbSql.append("   -- 조건                                                                                                                                                                                                                                                 \n");
        sbSql.append(" AND PODT.ROWID = B.PODT_ID                                                                                                                                                                                                                                \n");
        sbSql.append("    )                                                                                                                                                                                                                                                      \n");
        sbSql.append("  ,                                                                                                                                                                                                                                                        \n");
        sbSql.append("FMS_TRANSACTION_WITH AS                                                                                                                                                                                                                                    \n");
        sbSql.append("(                                                                                                                                                                                                                                                          \n");
        sbSql.append("SELECT /*+ INLINE */ A.MAIN_UPJANG,                                                                                                                                                                                                                        \n");
        sbSql.append("       A.TRANS_UPJANG AS UPJANG,                                                                                                                                                                                                                           \n");
        sbSql.append("       SUM(DECODE(SUBSTR(A.TRANS_TYPE,1,1),'I',1,-1) * ROUND(DECODE(A.TAX_CODE,'100',1.1,1) * ROUND(A.SALE_PRICE * A.TRANS_QTY) ) ) AS TR_AMT                                                                                                              \n");
        sbSql.append("FROM (                                                                                                                                                                                                                                                     \n");
        sbSql.append("       SELECT        A.TRANS_ID,                                                                                                                                                                                                                           \n");
        sbSql.append("               A.MG_DATE,                                                                                                                                                                                                                                  \n");
        sbSql.append("               A.SOURCE_TYPE,                                                                                                                                                                                                                              \n");
        sbSql.append("               A.TRANS_TYPE,                                                                                                                                                                                                                               \n");
        sbSql.append("               A.TRANS_QTY,                                                                                                                                                                                                                                \n");
        sbSql.append("               A.TRANS_UPJANG,                                                                                                                                                                                                                             \n");
        sbSql.append("               A.TAX_CODE,                                                                                                                                                                                                                                 \n");
        sbSql.append("               A.SALE_PRICE,                                                                                                                                                                                                                               \n");
        sbSql.append("               A.MAIN_UPJANG                                                                                                                                                                                                                               \n");
        sbSql.append("        FROM (                                                                                                                                                                                                                                             \n");
        sbSql.append("            SELECT /*+ LEADING(UP)  */                                                                                                                                                                                                                     \n");
        sbSql.append("                       DT.MG_NO AS TRANS_ID,/* 자재수불번호 */                                                                                                                                                                                             \n");
        sbSql.append("                       DT.MG_DATE AS MG_DATE,/* 수불일자*/                                                                                                                                                                                                 \n");
        sbSql.append("                           CASE WHEN SUBSTR(DT.MOVEMENT_TYP,0,2) = '25'                                                                                                                                                                                    \n");
        sbSql.append("                        THEN 'FO'                                                                                                                                                                                                                          \n");
        sbSql.append("                        WHEN DT.PROC_TYP_CD IS NULL                                                                                                                                                                                                        \n");
        sbSql.append("                            AND DT.IVT_INSP_NO IS NOT NULL                                                                                                                                                                                                 \n");
        sbSql.append("                        THEN '재고조정'                                                                                                                                                                                                                    \n");
        sbSql.append("                        WHEN DT.PROC_TYP_CD IS NULL                                                                                                                                                                                                        \n");
        sbSql.append("                            AND DT.IVT_INSP_NO IS NULL                                                                                                                                                                                                     \n");
        sbSql.append("                        THEN 'INV'                                                                                                                                                                                                                         \n");
        sbSql.append("                        ELSE 'PO'                                                                                                                                                                                                                          \n");
        sbSql.append("                        END                                                                                                                                                                                                                                \n");
        sbSql.append("                    AS SOURCE_TYPE,/* FO,PO,INV,재고조정 */                                                                                                                                                                                                \n");
        sbSql.append("                       DT.MOVEMENT_TYP AS MVT,                                                      /*이동유형 */                                                                                                                                          \n");
        sbSql.append("                           CASE WHEN SUBSTR(DT.MOVEMENT_TYP,0,1) = '3'                                                                                                                                                                                     \n");
        sbSql.append("                            AND DT.GR_QTY IS NULL                                                                                                                                                                                                          \n");
        sbSql.append("                        THEN 'O002'         /* 재고이동 - 이동출고   */                                                                                                                                                                                    \n");
        sbSql.append("                        WHEN SUBSTR(DT.MOVEMENT_TYP,0,1) = '3'                                                                                                                                                                                             \n");
        sbSql.append("                            AND DT.GR_QTY IS NOT NULL                                                                                                                                                                                                      \n");
        sbSql.append("                        THEN 'I002'      /*재고이동 - 이동입고  */                                                                                                                                                                                         \n");
        sbSql.append("                        WHEN DT.MOVEMENT_TYP = '251'                                                                                                                                                                                                       \n");
        sbSql.append("                            OR DT.MOVEMENT_TYP = '252'                                                                                                                                                                                                     \n");
        sbSql.append("                        THEN 'O001'      /* POS 매출 유형  */                                                                                                                                                                                              \n");
        sbSql.append("                        WHEN DT.MOVEMENT_TYP = '701'                                                                                                                                                                                                       \n");
        sbSql.append("                            OR DT.MOVEMENT_TYP = '702'                                                                                                                                                                                                     \n");
        sbSql.append("                        THEN 'O004'      /* 재고실사 */                                                                                                                                                                                                    \n");
        sbSql.append("                        ELSE 'I001'                                                                                                                                                                                                                        \n");
        sbSql.append("                        END                                                                                                                                                                                                                                \n");
        sbSql.append("                    AS TRANS_TYPE,                                                                                                                                                                                                                         \n");
        sbSql.append("                           CASE WHEN MOD(TO_NUMBER(DT.MOVEMENT_TYP),2) = 0                                                                                                                                                                                 \n");
        sbSql.append("                            AND DT.PROC_TYP_CD IS NOT NULL                                                                                                                                                                                                 \n");
        sbSql.append("                        THEN DECODE(                                                                                                                                                                                                                       \n");
        sbSql.append("                                DT.GR_QTY,                                                                                                                                                                                                                 \n");
        sbSql.append("                                NULL,                                                                                                                                                                                                                      \n");
        sbSql.append("                                DT.GI_PURC_QTY *-1,                                                                                                                                                                                                        \n");
        sbSql.append("                                DT.GR_PURC_QTY *-1                                                                                                                                                                                                         \n");
        sbSql.append("                            )                                                                                                                                                                                                                              \n");
        sbSql.append("                        WHEN MOD(TO_NUMBER(DT.MOVEMENT_TYP),2) = 1                                                                                                                                                                                         \n");
        sbSql.append("                            AND DT.PROC_TYP_CD IS NOT NULL                                                                                                                                                                                                 \n");
        sbSql.append("                        THEN DECODE(DT.GR_QTY,NULL,DT.GI_PURC_QTY,DT.GR_PURC_QTY)                                                                                                                                                                          \n");
        sbSql.append("                        WHEN MOD(TO_NUMBER(DT.MOVEMENT_TYP),2) = 0                                                                                                                                                                                         \n");
        sbSql.append("                            AND DT.PROC_TYP_CD IS NULL                                                                                                                                                                                                     \n");
        sbSql.append("                        THEN DECODE(                                                                                                                                                                                                                       \n");
        sbSql.append("                                DT.GR_QTY,                                                                                                                                                                                                                 \n");
        sbSql.append("                                NULL,                                                                                                                                                                                                                      \n");
        sbSql.append("                                DT.GI_QTY *-1,                                                                                                                                                                                                             \n");
        sbSql.append("                                DT.GR_QTY *-1                                                                                                                                                                                                              \n");
        sbSql.append("                            )                                                                                                                                                                                                                              \n");
        sbSql.append("                        WHEN MOD(TO_NUMBER(DT.MOVEMENT_TYP),2) = 1                                                                                                                                                                                         \n");
        sbSql.append("                            AND DT.PROC_TYP_CD IS NULL                                                                                                                                                                                                     \n");
        sbSql.append("                        THEN DECODE(DT.GR_QTY,NULL,DT.GI_QTY,DT.GR_QTY)                                                                                                                                                                                    \n");
        sbSql.append("                        END                                                                                                                                                                                                                                \n");
        sbSql.append("                    AS TRANS_QTY,      /* 수량 */                                                                                                                                                                                                          \n");
        sbSql.append("                       SL.SHOP_CD AS TRANS_UPJANG,/* 업장코드 */                                                                                                                                                                                           \n");
        sbSql.append("                       DECODE(MT.ACC_TAX_CD,'1','100','3','210','220') AS TAX_CODE,      /* 과면세 코드 */                                                                                                                                                 \n");
        sbSql.append("                       SL.SAL_PRICE AS SALE_PRICE,                        /* 외부판매단가 */                                                                                                                                                               \n");
        sbSql.append("                       SL.MAIN_UPJANG -- 201609 튜닝추가  메인 업장코드                                                                                                                                                                                    \n");
        sbSql.append("                FROM (   /* ESIMGDT 테이블과 인덱스간의 클러스터링팩터가 좋지 않아 ROWID로 정렬후 SCAN하기 위한 VIEW                                                                                                                                       \n");
        sbSql.append("                           ESIMGDT_PK 인덱스도 UNIQUE SCAN을 하게 되면 성능이 좋지 않아 FAST SCAN또는 RANGE SCAN 을 위한 HASH JOIN */                                                                                                                      \n");
        sbSql.append("                        SELECT /*+  NO_MERGE USE_NL(BB SL) USE_HASH(SL DT) INDEX_FFS(DT ESIMGDT_PK)  */                                                                                                                                                    \n");
        sbSql.append("                        SL.ROWID AS SL_ID,                                                                                                                                                                                                                 \n");
        sbSql.append("                               DT.ROWID AS DT_ID                                                                                                                                                                                                           \n");
        sbSql.append("                        FROM EPROCUSR.ESIMGDT DT,                                                                                                                                                                                                          \n");
        sbSql.append("                            EPROCUSR.ESISALP SL                                                                                                                                                                                                            \n");
        sbSql.append("                            INNER JOIN FMS_UPJANG_WITH BB ON SL.SHOP_CD = BB.UPJANG                                                                                                                                                                        \n");
        sbSql.append("                        WHERE DT.SYS_ID = SL.SYS_ID                                                                                                                                                                                                        \n");
        sbSql.append("                        AND DT.COMP_CD = SL.COMP_CD                                                                                                                                                                                                        \n");
        sbSql.append("                        AND DT.MG_NO = SL.MG_NO                                                                                                                                                                                                            \n");
        sbSql.append("                        AND SL.SYS_ID = '100'                                                                                                                                                                                                              \n");
        sbSql.append("                        AND SL.COMP_CD = 'HFC'                                                                                                                                                                                                             \n");
        sbSql.append("                        ORDER BY DT.ROWID                                                                                                                                                                                                                  \n");
        sbSql.append("                    ) UP,                                                                                                                                                                                                                                  \n");
        sbSql.append("                     EPROCUSR.ESIMGHD HD,                                         /* 수불헤더*/                                                                                                                                                            \n");
        sbSql.append("                     EPROCUSR.ESIMGDT DT,                                        /* 수불상세 */                                                                                                                                                            \n");
        sbSql.append("                     EPROCUSR.ESMMTGL MT,                                       /* 품목마스터 */                                                                                                                                                           \n");
        sbSql.append("                     ( -- ESISALP 테이블과 인덱스간의 클러스터링팩터가 좋지 않아 ROWID로 정렬후 SCAN까지한 VIEW                                                                                                                                            \n");
        sbSql.append("                        SELECT  /*+ NO_MERGE LEADING(SL) USE_NL(SLD) */                                                                                                                                                                                    \n");
        sbSql.append("                                SL.SL_ID AS SL_ID,                                                                                                                                                                                                         \n");
        sbSql.append("                               SLD.SHOP_CD,                                                                                                                                                                                                                \n");
        sbSql.append("                               SLD.SAL_PRICE,                                                                                                                                                                                                              \n");
        sbSql.append("                               SL.MAIN_UPJANG   -- GROUP 합계용 MAIN_UPJANG 데이터                                                                                                                                                                         \n");
        sbSql.append("                        FROM EPROCUSR.ESISALP SLD,                                                                                                                                                                                                         \n");
        sbSql.append("                             (                                                                                                                                                                                                                             \n");
        sbSql.append("                                SELECT /*+ NO_MERGE */ SL.ROWID AS SL_ID,                                                                                                                                                                                  \n");
        sbSql.append("                                       BB.MAIN_UPJANG                                                                                                                                                                                                      \n");
        sbSql.append("                                FROM EPROCUSR.ESISALP SL                                               /* 판매단가 */                                                                                                                                      \n");
        sbSql.append("                                    INNER JOIN FMS_UPJANG_WITH BB ON SL.SHOP_CD = BB.UPJANG                                                                                                                                                                \n");
        sbSql.append("                                ORDER BY SL.ROWID                                                                                                                                                                                                          \n");
        sbSql.append("                            ) SL                                                                                                                                                                                                                           \n");
        sbSql.append("                        WHERE SLD.ROWID = SL.SL_ID                                                                                                                                                                                                         \n");
        sbSql.append("                        ORDER BY SL.SL_ID                                                                                                                                                                                                                  \n");
        sbSql.append("                    ) SL                                                                                                                                                                                                                                   \n");
        sbSql.append("                WHERE UP.SL_ID = SL.SL_ID                                                                                                                                                                                                                  \n");
        sbSql.append("                AND UP.DT_ID = DT.ROWID                                                                                                                                                                                                                    \n");
        sbSql.append("                AND DT.SYS_ID = HD.SYS_ID                                                                                                                                                                                                                  \n");
        sbSql.append("                AND DT.COMP_CD = HD.COMP_CD                                                                                                                                                                                                                \n");
        sbSql.append("                AND DT.WH_CD = HD.WH_CD                                                                                                                                                                                                                    \n");
        sbSql.append("                AND DT.ITEM_CD = HD.ITEM_CD                                                                                                                                                                                                                \n");
        sbSql.append("                AND HD.SYS_ID = '100'                                                                                                                                                                                                                      \n");
        sbSql.append("                AND HD.COMP_CD = 'HFC'                                                                                                                                                                                                                     \n");
        sbSql.append("                AND HD.BU_CD = '2000'                                                                                                                                                                                                                      \n");
        sbSql.append("                AND DT.MOVEMENT_TYP NOT IN (                                                                                                                                                                                                               \n");
        sbSql.append("                        '561','562','998','999','901','902','801','802','111','112','211','212'                                                                                                                                                            \n");
        sbSql.append("                    )   /* 기초 ,기말 재고,배송입출고,직송 가상입출고  제외 */                                                                                                                                                                             \n");
        sbSql.append("                AND DT.STS <> 'D'                                                                                                                                                                                                                          \n");
        sbSql.append("                AND DT.SYS_ID = MT.SYS_ID                                                                                                                                                                                                                  \n");
        sbSql.append("                AND DT.ITEM_CD = MT.ITEM_CD                                                                                                                                                                                                                \n");
        sbSql.append("                AND DT.MG_DATE <= '"+strDate+"' -- 조건절 추가                                                                                                                                                                                                \n");
        sbSql.append("                ) A                                                                                                                                                                                                                                        \n");
        sbSql.append("                UNION ALL                                                                                                                                                                                                                                  \n");
        sbSql.append("                SELECT FB.TRANS_ID ,             /* 자재수불번호 : M+'0000000000' : 조정분 */                                                                                                                                                              \n");
        sbSql.append("                FB.TRANS_DATE AS MG_DATE,                                                                                                                                                                                                                  \n");
        sbSql.append("                FB.SOURCE_TYPE,                                                                                                                                                                                                                            \n");
        sbSql.append("                FB.TRANS_TYPE,                                                                                                                                                                                                                             \n");
        sbSql.append("                FB.TRANS_QTY,                                                                                                                                                                                                                              \n");
        sbSql.append("                TO_CHAR(FB.TRANS_UPJANG) AS TRANS_UPJANG,                                                                                                                                                                                                  \n");
        sbSql.append("                FB.TAX_CODE,                                                                                                                                                                                                                               \n");
        sbSql.append("                FB.SALE_PRICE,                                                                                                                                                                                                                             \n");
        sbSql.append("                BB.MAIN_UPJANG                                                                                                                                                                                                                             \n");
        sbSql.append("                FROM FMS_TRANSACTION FB INNER JOIN FMS_UPJANG_WITH BB                                                                                                                                                                                      \n");
        sbSql.append("                                    ON FB.TRANS_UPJANG = BB.UPJANG                                                                                                                                                                                         \n");
        sbSql.append("                                    WHERE FB.TRANS_DATE <= '"+strDate+"' -- MG_DATE <= 조건                                                                                                                                                                   \n");
        sbSql.append("            ) A                                                                                                                                                                                                                                            \n");
        sbSql.append("        LEFT JOIN (                                                                                                                                                                                                                                        \n");
        sbSql.append("                   SELECT                                                                                                                                                                                                                                  \n");
        sbSql.append("                      UPJANG                                                                                                                                                                                                                               \n");
        sbSql.append("                    ,  MAX(SALE_DATE) AS SALE_DATE                                                                                                                                                                                                         \n");
        sbSql.append("                   FROM   FMS_SALES                                                                                                                                                                                                                        \n");
        sbSql.append("                   WHERE  SALE_DATE <= '"+strDate+"'                                                                                                                                                                                                          \n");
        sbSql.append("                    AND     TRANS_YN = 'Y'                                                                                                                                                                                                                 \n");
        sbSql.append("                    GROUP BY UPJANG                                                                                                                                                                                                                        \n");
        sbSql.append("                   ) C ON A.TRANS_UPJANG = C.UPJANG -- A.TRANS_UPJANG = C.UPJANG                                                                                                                                                                           \n");
        sbSql.append("    WHERE    -- A.MG_DATE <= '"+strDate+"'                                                                                                                                                                                                                    \n");
        sbSql.append("     A.MG_DATE >= DECODE(C.SALE_DATE, NULL, GREATEST(TO_CHAR(ADD_MONTHS(TO_DATE('"+strDate+"', 'YYYYMMDD'), -1), 'YYYYMM') || '01', NVL(TO_CHAR(TO_DATE(C.SALE_DATE, 'YYYYMMDD')+1, 'YYYYMMDD'),' ')),  TO_CHAR(TO_DATE(C.SALE_DATE, 'YYYYMMDD')+1, 'YYYYMMDD')) \n");
        sbSql.append("     AND    (A.TRANS_TYPE = 'I001' OR (A.TRANS_TYPE LIKE '_002' AND A.SOURCE_TYPE = 'PO') )                                                                                                                                                                \n");
        sbSql.append("     GROUP BY                                                                                                                                                                                                                                              \n");
        sbSql.append("     A.MAIN_UPJANG,                                                                                                                                                                                                                                        \n");
        sbSql.append("     A.TRANS_UPJANG                                                                                                                                                                                                                                        \n");
        sbSql.append(")                                                                                                                                                                                                                                                          \n");
        sbSql.append(" SELECT  /*+ optimizer_features_enable('10.2.0.5') */                                                                                                                                                                                                      \n");
        sbSql.append("       A.MAIN_UPJANG, '1' AS BON_GB                                                                                                                                                                                                                        \n");
        sbSql.append("     , A.UPJANG                                                                                                                                                                                                                                            \n");
        sbSql.append("     , A.UPJANGNM_DISP                                                                                                                                                                                                                                     \n");
        sbSql.append("      ,(CASE WHEN NVL(A.CREDIT_END,'99999999') >= TO_CHAR(SYSDATE, 'YYYYMMDD') THEN NVL(A.CREDIT_AMOUNT,0) ELSE 0 END) AS AMT1                                                                                                                             \n");
        sbSql.append("      ,(CASE WHEN NVL(A.CREDIT_END,'99999999') >= TO_CHAR(SYSDATE, 'YYYYMMDD') THEN NVL(A.CREDIT_AMOUNT,0) ELSE 0 END) AS AMT1_0                                                                                                                           \n");
        sbSql.append("     , 0 AS AMT1_1                                                                                                                                                                                                                                         \n");
        sbSql.append("     , NVL(E.PO_AMT,0) + NVL(F.PR_AMT,0) AS AMT1_2                                                                                                                                                                                                         \n");
        sbSql.append("     , NVL(D.TR_AMT,0) AS AMT1_3                                                                                                                                                                                                                           \n");
        sbSql.append("  , NVL(C0.RMN_AMT,0)  AS AMT2_0                                                                                                                                                                                                                           \n");
        sbSql.append("  , NVL(C1.PRE_AMT,0)  AS AMT2_3                                                                                                                                                                                                                           \n");
        sbSql.append("     , 0 AS AMT2                                                                                                                                                                                                                                           \n");
        sbSql.append("     , 0 AS AMT2_1                                                                                                                                                                                                                                         \n");
        sbSql.append("     , CASE WHEN  '"+strDate+"' BETWEEN NVL(A.CREDIT_START,'00000000') AND NVL(A.CREDIT_END,'99999999')  THEN NVL(A.CREDIT_AMOUNT,0) ELSE 0 END                                                                                                               \n");
        sbSql.append("       - NVL(C0.RMN_AMT,0) + NVL(C1.PRE_AMT,0) - NVL(D.TR_AMT,0) - NVL(E.PO_AMT,0) - NVL(F.PR_AMT,0) AS AMT3                                                                                                                                               \n");
        sbSql.append("     , A.HEAD_CREDIT_YN AS TOT_YN                                                                                                                                                                                                                          \n");
        sbSql.append("     , DECODE(A.CREDIT_CONTROL_YN||A.CREDIT_TURN_CONTROL_YN||A.CREDIT_AMOUNT_CONTROL_YN                                                                                                                                                                    \n");
        sbSql.append("             ,'YYY','금액+회전일'                                                                                                                                                                                                                          \n");
        sbSql.append("             ,'YYN','회전일통제'                                                                                                                                                                                                                           \n");
        sbSql.append("             ,'YNY','금액통제','무통제') AS CTRL                                                                                                                                                                                                           \n");
        sbSql.append("     , A.CREDIT_TURN_DAYS                                                                                                                                                                                                                                  \n");
        sbSql.append("     , NVL(A.CREDIT_START,'00000000')||' ~ '||NVL(A.CREDIT_END,'99999999') AS PERIOD                                                                                                                                                                       \n");
        sbSql.append("     , 'Y' AS SUM_FLAG                                                                                                                                                                                                                                     \n");
        sbSql.append("      ,(CASE WHEN NVL(A.CREDIT_OVER_END,'99999999') >= TO_CHAR(SYSDATE, 'YYYYMMDD') THEN A.CREDIT_OVER_AMOUNT ELSE 0 END) AS CREDIT_OVER_AMOUNT                                                                                                            \n");
        sbSql.append("      ,(CASE WHEN NVL(A.CREDIT_OVER_END,'99999999') >= TO_CHAR(SYSDATE, 'YYYYMMDD') THEN TO_CHAR(TO_DATE(A.CREDIT_OVER_END,'YYYYMMDD'),'YYYY-MM-DD') ELSE '' END) AS CREDIT_OVER_END                                                                       \n");
        sbSql.append("  FROM FMS_UPJANG_WITH A                                                                                                                                                                                                                                   \n");
        sbSql.append("       LEFT JOIN                                                                                                                                                                                                                                           \n");
        sbSql.append("       --C0.외상잔액정보(AR)                                                                                                                                                                                                                               \n");
        sbSql.append("  (                                                                                                                                                                                                                                                        \n");
        sbSql.append("  SELECT                                                                                                                                                                                                                                                   \n");
        sbSql.append("    S.UPJANG                                                                                                                                                                                                                                               \n");
        sbSql.append("  , SUM(NVL(S.AR_AMT,0) - NVL(S.RECEIVE_AMT,0)) AS RMN_AMT                                                                                                                                                                                                 \n");
        sbSql.append("  FROM                                                                                                                                                                                                                                                     \n");
        sbSql.append("      (SELECT B.UPJANG                                                                                                                                                                                                                                     \n");
        sbSql.append("    , NVL(M.AR_AMT, 0) AS AR_AMT                                                                                                                                                                                                                           \n");
        sbSql.append("    , (SELECT NVL(SUM(D.RECEIVE_AMT),0) FROM SLA_AR_RECEIVE_DETAIL D WHERE D.RECD_STATUS  = 'L'                                                                                                                                                            \n");
        sbSql.append("                              AND D.RECEIVE_DATE <= '"+jDate+"'                                                                                                                                                                                             \n");
        sbSql.append("                              AND D.AR_NUM = M.AR_NUM) AS RECEIVE_AMT                                                                                                                                                                                      \n");
        sbSql.append("       FROM SLA_AR_MST M                                                                                                                                                                                                                                   \n");
        sbSql.append("            INNER JOIN  FMS_UPJANG_WITH B ON M.UPJANG_CD = B.UPJANG                                                                                                                                                                                        \n");
        sbSql.append("  WHERE M.SYS_CLASS IN ('13', '14')                                                                                                                                                                                                                        \n");
        sbSql.append("  AND    M.RECD_STATUS = 'L'                                                                                                                                                                                                                               \n");
        sbSql.append("  AND    M.OCCUR_DATE <= '"+jDate+"'                                                                                                                                                                                                                        \n");
        sbSql.append("        ) S                                                                                                                                                                                                                                                \n");
        sbSql.append("    GROUP BY S.UPJANG                                                                                                                                                                                                                                      \n");
        sbSql.append(" ) C0                                                                                                                                                                                                                                                      \n");
        sbSql.append("        ON A.UPJANG = C0.UPJANG                                                                                                                                                                                                                            \n");
        sbSql.append("       LEFT JOIN                                                                                                                                                                                                                                           \n");
        sbSql.append("       --C1.선수잔액정보                                                                                                                                                                                                                                   \n");
        sbSql.append("  (                                                                                                                                                                                                                                                        \n");
        sbSql.append("  SELECT                                                                                                                                                                                                                                                   \n");
        sbSql.append("    S.UPJANG                                                                                                                                                                                                                                               \n");
        sbSql.append("  , SUM(NVL(S.OCCUR_AMT,0) - NVL(S.APPLY_AMT,0)) AS PRE_AMT                                                                                                                                                                                                \n");
        sbSql.append("  FROM                                                                                                                                                                                                                                                     \n");
        sbSql.append("      (SELECT B.UPJANG                                                                                                                                                                                                                                     \n");
        sbSql.append("    , NVL(M.OCCUR_AMT, 0) AS OCCUR_AMT                                                                                                                                                                                                                     \n");
        sbSql.append("    , (SELECT NVL(SUM(D.APPLY_AMT),0) FROM SLA_ADVANCE_ALT_DETAIL D WHERE D.RECD_STATUS  = 'L'                                                                                                                                                             \n");
        sbSql.append("                              AND D.ALT_DATE <= '"+jDate+"'                                                                                                                                                                                                 \n");
        sbSql.append("                              AND D.ADVANCE_NUM = M.ADVANCE_NUM) AS APPLY_AMT                                                                                                                                                                              \n");
        sbSql.append("       FROM SLA_ADVANCE_MST M                                                                                                                                                                                                                              \n");
        sbSql.append("            INNER JOIN FMS_UPJANG_WITH B ON M.UPJANG_CD = B.UPJANG                                                                                                                                                                                         \n");
        sbSql.append("  WHERE M.SYS_CLASS IN ('13', '14')                                                                                                                                                                                                                        \n");
        sbSql.append("  AND    M.RECD_STATUS = 'L'                                                                                                                                                                                                                               \n");
        sbSql.append("  AND    M.OCCUR_DATE <= '"+jDate+"'                                                                                                                                                                                                                        \n");
        sbSql.append("        ) S                                                                                                                                                                                                                                                \n");
        sbSql.append("   GROUP BY S.UPJANG                                                                                                                                                                                                                                       \n");
        sbSql.append(" ) C1                                                                                                                                                                                                                                                      \n");
        sbSql.append("        ON A.UPJANG = C1.UPJANG                                                                                                                                                                                                                            \n");
        sbSql.append("       LEFT JOIN                                                                                                                                                                                                                                           \n");
        sbSql.append("       --D.당월 미매출마감된 검수금액                                                                                                                                                                                                                      \n");
        sbSql.append("      (SELECT X.UPJANG                                                                                                                                                                                                                                     \n");
        sbSql.append("    , SUM(X.TR_AMT) AS TR_AMT                                                                                                                                                                                                                              \n");
        sbSql.append("     /* D2. 식재매출집계(FMS_SALES)의 최종마감일자 이후에서 기준일자 까지 */                                                                                                                                                                               \n");
        sbSql.append("    FROM FMS_TRANSACTION_WITH X                                                                                                                                                                                                                            \n");
        sbSql.append(" GROUP BY X.UPJANG                                                                                                                                                                                                                                         \n");
        sbSql.append(" ) D                                                                                                                                                                                                                                                       \n");
        sbSql.append("        ON A.UPJANG = D.UPJANG                                                                                                                                                                                                                             \n");
        sbSql.append("       LEFT JOIN                                                                                                                                                                                                                                           \n");
        sbSql.append("       --E.당월 미검수 발주금액                                                                                                                                                                                                                            \n");
        sbSql.append("      (SELECT                                                                                                                                                                                                                                              \n");
        sbSql.append("              A.RC_UPJANG  as UPJANG                                                                                                                                                                                                                       \n");
        sbSql.append("            , SUM(ROUND(DECODE(A.TAX_CODE,'100',1.1,1) * ROUND((A.CENTER_DELI_QTY + A.DIRECT_DELI_QTY - A.DELIVERED_QTY - A.UNDELIVERED_QTY) * A.SALE_PRICE))) AS PO_AMT                                                                                   \n");
        sbSql.append("  FROM HLDC_PO_PO_WITH A                                                                                                                                                                                                                                   \n");
        sbSql.append("  WHERE   A.LINE_STATUS IN ('PW', 'PC', 'DL')                                                                                                                                                                                                              \n");
        sbSql.append("        GROUP BY A.RC_UPJANG) E                                                                                                                                                                                                                            \n");
        sbSql.append("        ON A.UPJANG = E.UPJANG                                                                                                                                                                                                                             \n");
        sbSql.append("       LEFT JOIN                                                                                                                                                                                                                                           \n");
        sbSql.append("       --F.당월 미발주 주문금액                                                                                                                                                                                                                            \n");
        sbSql.append("      (SELECT                                                                                                                                                                                                                                              \n");
        sbSql.append("              B.UPJANG                                                                                                                                                                                                                                     \n");
        sbSql.append("            , SUM(ROUND(DECODE(A.TAX_CODE,'100',1.1,1) * ROUND(A.PR_QTY * A.SALE_PRICE))) AS PR_AMT                                                                                                                                                        \n");
        sbSql.append("  FROM SO_PR A INNER JOIN FMS_UPJANG_WITH B                                                                                                                                                                                                                \n");
        sbSql.append("                   ON A.RC_UPJANG = B.UPJANG                                                                                                                                                                                                               \n");
        sbSql.append("  WHERE A.NEED_DATE <= '"+strDate+"'                                                                                                                                                                                                                          \n");
        sbSql.append("  AND    A.LINE_STATUS IN ('001')                                                                                                                                                                                                                          \n");
        sbSql.append("        GROUP BY B.UPJANG) F                                                                                                                                                                                                                               \n");
        sbSql.append("        ON A.UPJANG = F.UPJANG                                                                                                                                                                                                                             \n");
		
		pstmt = conn.prepareStatement(sbSql.toString());		
		rs = pstmt.executeQuery(); 
		ds_ListTmp = this.makeDataSet(rs, "ds_ListTmp");
		rs.close();
		pstmt.close();

		/**종료**/
		out_dl.add(ds_ListTmp);
		out_dl.add(ds_List);
		this.setResultMessage(0, "OK", out_vl);

	}
	catch(Exception ex)
	{
		//ex.printStackTrace();
		//jsp 로그남기기
		logger.debug(ex.getMessage(), ex);		
		this.setResultMessage(-1, ex.toString(),out_vl);
	}
	finally
	{
		if(rs != null) {
			try {
				rs.close();
			}catch(Exception e) {}
		}
		if(pstmt != null) {
			try {
				pstmt.close();
			}catch(Exception e) {}
		}
		if(conn != null) {
			try {
				conn.close();
			}catch(Exception e) {}
		}
		//jsp log 서비스 닫기 
		try {
			logger.endIndividualLog();
		} catch( Exception logE) {
			logE.printStackTrace();
		}		
	}

	proc_output(response,out,out_vl,out_dl);

%>
