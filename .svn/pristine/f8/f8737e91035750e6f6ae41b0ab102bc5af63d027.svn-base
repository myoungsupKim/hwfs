<?xml version="1.0" encoding="euc-kr"?>
<query dynamic="true">
	<type>select</type>
	<description><![CDATA[전망손익보고서]]></description>
	<reload>true</reload>
	<monitoring>true</monitoring>
	<result-count>1</result-count>
	<statement>
	
<isEqual col="CLOSE_TYPE" value="C05D">
<isEqual col="SALE_TYPE" value="S">
<isEqual col="DATA_CLASS" value="P"> 
/* 관리-실적-계획 */
 SELECT DISTINCT TM_CD
      ,TM_NM TM_NAME
      --2018.07.27 김명섭 CC코드 중복 방지
      --,UPJANG
      ,UPJANGNM UPJANG_NAME
      --2019.02.14 김명섭 업장명 신규계획일 경우 신규로 구분
      --,DECODE(NEW_GUBUN_NAME, '신규', 'N', 'O') NEW_GUBUN
      --,NEW_GUBUN_NAME
      ,(CASE WHEN UPJANGNM LIKE '%신규계획%' THEN 'N' ELSE DECODE(NEW_GUBUN_NAME, '신규', 'N', 'O') END) AS NEW_GUBUN
      ,(CASE WHEN UPJANGNM LIKE '%신규계획%' THEN '신규' ELSE NEW_GUBUN_NAME END) AS NEW_GUBUN_NAME
      ,CC_CD
      ,P_TYPE_A AS SIMU_SALE_AMT  -- 계획 매출액
      --재료비, 노무비, 경비 추가  요청자 : 유영진   20160318  처리자 :맹수영
      ,P_TYPE_B AS SIMU_COST_AMT  -- 계획 재료비
      ,P_TYPE_C AS SIMU_LABOR_AMT  -- 계획 노무비
      ,P_TYPE_D AS SIMU_EXP_AMT  -- 계획 경비
      ,(P_TYPE_A - (P_TYPE_B + P_TYPE_C + P_TYPE_D)) AS SIMU_SALE_PROFIT -- 계획 매출이익
      ,R_TYPE_A AS SALE_AMT -- 실적 매출액
      ,ROUND(R_TYPE_B) AS COST_AMT -- 실적 재료비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_B/R_TYPE_A*100),1) AS COST_RATE -- 실적 매출 비율
      ,R_TYPE_C AS LABOR_AMT -- 실적 노무비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_C/R_TYPE_A*100),1) AS LABOR_RATE -- 실적 노무비 비율
      ,R_TYPE_D AS EXP_AMT -- 실적 경비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_D/R_TYPE_A*100),1) AS EXP_RATE -- 실적 경비비율
      ,ROUND((R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))) AS SALE_PROFIT -- 실적 매출이익
      ,ROUND(DECODE(R_TYPE_A,0,0,(R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))/R_TYPE_A*100),1) AS SALE_PROFIT_RATE -- 매출이익 비율
      ,ROUND(DECODE(P_TYPE_A,0,0,R_TYPE_A/P_TYPE_A*100),1) AS SIMU_SALE_DIFF_RATE -- 실적 매출액(%)
      ,((P_TYPE_A - (P_TYPE_B + P_TYPE_C + P_TYPE_D)) - (R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))) AS SIMU_PROFIT_DIFF_AMT -- 매출 이익
      ,(SELECT CST_PLNKGVRN_CLASS_CD FROM SCC_CC WHERE CC_CD = T1.CC_CD) AS CC_GB
  FROM (
        SELECT TM_CD
              ,TM_NM
              ,UPJANG
              ,UPJANGNM
              ,NEW_GUBUN_NAME              
              ,MAX(DECODE(CC_CD, NULL, CC_CD, CC_CD)) CC_CD
              --MAX를 모두 sum으로 변경  20160519
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_A', P_MM_AMT, 0)) P_TYPE_A -- 계획 매출액
             -- ,MAX(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0)) P_TYPE_B -- 계획 재료비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_C', P_MM_AMT, 0)) P_TYPE_C -- 계획 노무비 
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_D', P_MM_AMT, 0)) P_TYPE_D -- 계획 경비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_A', R_MM_AMT, 0)) R_TYPE_A -- 실적 매출액
       
             --,MAX(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0) * NVL(R_MM_MR, 100) / 100 ) P_TYPE_B -- 관리계획 재료비        
             ,SUM(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0) * NVL(R_MM_MR, 100) / 100 ) +SUM(DECODE(ACCT_TYPE, 'TYPE_E', P_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_F', P_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_G', P_MM_AMT, 0)  ) P_TYPE_B
             -- , MAX(DECODE(ACCT_TYPE, 'TYPE_B', R_MM_AMT, 0)  * NVL(R_MM_MR, 100) / 100 ) R_TYPE_B -- 관리실적 재료비
  
             , SUM(DECODE(ACCT_TYPE, 'TYPE_B', R_MM_AMT, 0)  * NVL(R_MM_MR, 100) / 100 ) +SUM(DECODE(ACCT_TYPE, 'TYPE_E', R_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_F', R_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_G', R_MM_AMT, 0)  )R_TYPE_B
     
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_C', R_MM_AMT, 0)) R_TYPE_C -- 실적 노무비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_D', R_MM_AMT, 0)) R_TYPE_D -- 실적 경비
          FROM (
                 SELECT TM_CD
                       ,TM_NM
                       ,UPJANG
                       ,UPJANGNM
                       ,NEW_GUBUN_NAME
                       ,CC_CD
                       ,ACCT_TYPE
                       ,ROUND(SUM(P_MM_AMT) / 1000) AS P_MM_AMT
                       ,ROUND(SUM(R_MM_AMT) / 1000) AS R_MM_AMT
                      ,( SELECT  CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_MARGIN_RATE_01
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_MARGIN_RATE_02
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_MARGIN_RATE_03
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_MARGIN_RATE_04
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_MARGIN_RATE_05
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_MARGIN_RATE_06
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_MARGIN_RATE_07
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_MARGIN_RATE_08
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_MARGIN_RATE_09
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_MARGIN_RATE_10
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_MARGIN_RATE_11
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_MARGIN_RATE_12
                                 ELSE 0
                                 END
                            FROM MAP_MARGIN_RATE_MGMT
                           WHERE UPJANG = A.UPJANG
                             AND YY = SUBSTR(#YYMM#, 1, 4)
                             AND CLASS = 'R'
                       ) R_MM_MR -- 조회월 출하율
                   FROM (
                        SELECT V.TM_CD
                              ,V.TM_NAME AS TM_NM
                              ,V.UPJANG
                              ,A.CC_NM AS UPJANGNM
                              ,(CASE WHEN V.OPEN_YY = SUBSTRB(#YYMM#,1,4) THEN '신규' -- OPEN_YY가 현재년과 같으면 신규.
                                ELSE '기존'
                                 END    
                               ) AS NEW_GUBUN_NAME
                              ,A.CC_CD
                              ,( CASE WHEN SUBSTR(A.ACCT_CD, 1, 2) = '41'  THEN 'TYPE_A'
                                      WHEN A.ACCT_CD = '98001010'  THEN 'TYPE_A'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42203'  THEN 'TYPE_B'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '431' THEN 'TYPE_C'
                                      WHEN D.ACCTNM3 = '복리후생비(인건비성)' THEN 'TYPE_C' 
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' AND D.ACCTNM3 &lt;&gt; '복리후생비(인건비성)' THEN 'TYPE_D'
                                      --2018.01.16 김명섭 [SR201801_06318] 경비금액 내 내부원가 계정(98001510) 반영
                                      --WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002'  THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002' OR A.ACCT_CD = '98001510'  THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42202'  THEN 'TYPE_E'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42101'  THEN 'TYPE_F'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42201'  THEN 'TYPE_G'
                                  ELSE 'ETC'
                                   END
                               ) ACCT_TYPE
                              ,A.ACCT_CD
                               ,0 P_MM_AMT
                               ,( CASE WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '01' THEN A.MM_AMT_01  -- 조회 월
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '02' THEN A.MM_AMT_02
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '03' THEN A.MM_AMT_03
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '04' THEN A.MM_AMT_04
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '05' THEN A.MM_AMT_05
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '06' THEN A.MM_AMT_06
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '07' THEN A.MM_AMT_07
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '08' THEN A.MM_AMT_08
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '09' THEN A.MM_AMT_09
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '10' THEN A.MM_AMT_10
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '11' THEN A.MM_AMT_11
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '12' THEN A.MM_AMT_12
                                 ELSE 0
                                 END
                               ) R_MM_AMT -- 조회월 실적
                          FROM MAP_UPJANG_PL A -- SAP 실적
							                --2018.04.25 김명섭 사업계획관리 개선: 동일CC 데이터중복 개선
                              --,MAC_UPJANG_V V
                              ,(SELECT DISTINCT NVL(T2.ATTR01,T1.UPJANG) AS UPJANG, NVL(T2.CODE_NAME,T1.UPJANGNM) AS UPJANGNM,
                                       MU_CD,MU_NAME,SC_CD,SC_NAME,TM_CD,TM_NAME,PT_CD,PT_NAME,CC_CD,CC_NAME,OPEN_YY
                                  FROM MAC_UPJANG_V T1
                                LEFT OUTER JOIN SCC_COMMON_CODE T2
                                  ON T2.CODE = T1.CC_CD
                                 AND T2.GROUP_CODE = 'MAG20001S') V
                              --추가  
                              , MAS_ST_ACCOUNT D
                         WHERE 1 = 1
                           --2019.02.07 김명섭 팀/본부 조회 시 판관CC 제외
                           <isNull col="UPJANG">
                           --AND A.CC_CD NOT IN (SELECT CC_CD FROM SCC_CC WHERE CST_PLNKGVRN_CLASS_CD = 'SG')
                           </isNull>
                           AND A.CC_CD = V.CC_CD(+)
                           AND A.PL_CLASS = 'KS'
                           AND A.FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) -- 입력 년
                           <isNotNull col="MU_CD">
                           AND V.MU_CD = #MU_CD#
                           </isNotNull>
                            <isNotNull col="TM_CD">
                                <isNotEqual col="HOMEPLUS" value="1"> 
                                AND V.TM_CD LIKE #TM_CD# || '%'
                                </isNotEqual>
                            </isNotNull>
                            <isNotNull col="UPJANG">
                                <isNotEqual col="HOMEPLUS" value="1"> 
                                AND V.UPJANG = #UPJANG#
                                </isNotEqual>
                                <isEqual col="HOMEPLUS" value="1"> 
  						                  AND V.UPJANG    IN  (SELECT Z.CODE FROM SCC_COMMON_CODE Z WHERE Z.GROUP_CODE = 'UPJANG_GROUP' AND Z.USE_YN = 'Y' AND SET1 = #UPJANG#  )
  						                  </isEqual>
                            </isNotNull>
                           AND  A.ACCT_CD = D.ACCTCD

                       UNION ALL

                        SELECT V.TM_CD
                              ,V.TM_NAME AS TM_NM
                              ,V.UPJANG
                              ,V.CC_NAME AS UPJANGNM
                              ,(CASE WHEN V.OPEN_YY = SUBSTRB(#YYMM#,1,4) THEN '신규' -- OPEN_YY가 현재년과 같으면 신규.
                                ELSE '기존'
                                 END    
                               ) AS NEW_GUBUN_NAME
                              ,A.CC_CD
                              ,( CASE WHEN SUBSTR(A.ACCT_CD, 1, 2) = '41'  THEN 'TYPE_A'
                                      WHEN A.ACCT_CD = '98001010'  THEN 'TYPE_A'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42203'  THEN 'TYPE_B'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '431' THEN 'TYPE_C'
                                      WHEN D.ACCTNM3 = '복리후생비(인건비성)' THEN 'TYPE_C' 
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' AND D.ACCTNM3 &lt;&gt; '복리후생비(인건비성)' THEN 'TYPE_D'
                                      --2018.01.16 김명섭 [SR201801_06318] 경비금액 내 내부원가 계정(98001510) 반영
                                      --WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002'  THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002' OR A.ACCT_CD = '98001510'  THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42202'  THEN 'TYPE_E'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42101'  THEN 'TYPE_F'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42201'  THEN 'TYPE_G'
                                  ELSE 'ETC'
                                   END
                               ) ACCT_TYPE
                              ,A.ACCT_CD
                               ,( CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_AMT_01  -- 조회 월
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_AMT_02
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_AMT_03
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_AMT_04
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_AMT_05
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_AMT_06
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_AMT_07
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_AMT_08
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_AMT_09
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_AMT_10
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_AMT_11
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_AMT_12
                                  ELSE 0
                                  END
                               ) P_MM_AMT
                               ,0 R_MM_AMT -- 조회월 실적
                          FROM MAP_BPC_CONFIRM_PL_INFO A -- SAP 실적
							                --2018.04.25 김명섭 사업계획관리 개선: 동일CC 데이터중복 개선
                              --,MAC_UPJANG_V V
                              ,(SELECT DISTINCT NVL(T2.ATTR01,T1.UPJANG) AS UPJANG, NVL(T2.CODE_NAME,T1.UPJANGNM) AS UPJANGNM,
                                       MU_CD,MU_NAME,SC_CD,SC_NAME,TM_CD,TM_NAME,PT_CD,PT_NAME,CC_CD,CC_NAME,OPEN_YY
                                  FROM MAC_UPJANG_V T1
                                LEFT OUTER JOIN SCC_COMMON_CODE T2
                                  ON T2.CODE = T1.CC_CD
                                 AND T2.GROUP_CODE = 'MAG20001S') V
                              --추가  
                              , MAS_ST_ACCOUNT D
                         WHERE 1 = 1
                           --2019.02.07 김명섭 팀/본부 조회 시 판관CC 제외
                           <isNull col="UPJANG">
                           --AND A.CC_CD NOT IN (SELECT CC_CD FROM SCC_CC WHERE CST_PLNKGVRN_CLASS_CD = 'SG')
                           </isNull>
                           AND A.CC_CD = V.CC_CD(+)
                           AND A.PLAN_CLASS = 'AP'
                           AND A.PLAN_YEAR = SUBSTR(#YYMM#, 1, 4) -- 입력 년
                           AND A.VER_CD= (SELECT MAX(VER_CD)
                                            FROM MAP_BPC_CONFIRM_PL_INFO
                                           WHERE PLAN_CLASS = A.PLAN_CLASS
                                             AND PLAN_YEAR = A.PLAN_YEAR
                                             AND CC_CD = A.CC_CD)
                           <isNotNull col="MU_CD">
                           AND V.MU_CD = #MU_CD#
                           </isNotNull>
                            <isNotNull col="TM_CD">
                                <isNotEqual col="HOMEPLUS" value="1"> 
                                AND V.TM_CD LIKE #TM_CD# || '%'
                                </isNotEqual>
                            </isNotNull>
                            <isNotNull col="UPJANG">
                                <isNotEqual col="HOMEPLUS" value="1"> 
                                AND V.UPJANG = #UPJANG#
                                </isNotEqual>
                                <isEqual col="HOMEPLUS" value="1"> 
  						                  AND V.UPJANG    IN  (SELECT Z.CODE FROM SCC_COMMON_CODE Z WHERE Z.GROUP_CODE = 'UPJANG_GROUP' AND Z.USE_YN = 'Y' AND SET1 = #UPJANG#  )
  						                  </isEqual>
                            </isNotNull>
                           AND  A.ACCT_CD = D.ACCTCD

                       ) A
                                                 
                 GROUP BY TM_CD, TM_NM, UPJANG, UPJANGNM, NEW_GUBUN_NAME, CC_CD, ACCT_TYPE
                  
                 --ORDER BY CC_CD, ACCT_TYPE
         )
         GROUP BY TM_CD, TM_NM, UPJANG, UPJANGNM, NEW_GUBUN_NAME
       ) T1
 WHERE UPJANG NOT IN (SELECT TO_NUMBER(CODE) FROM SCC_COMMON_CODE WHERE GROUP_CODE = 'MA0048' AND USE_YN = 'Y')        
   --2019.12.13 김명섭 블로킹대상자 조회 제외 업장 체크
   AND NOT EXISTS (SELECT 'x'
                     FROM SCC_COMMON_CODE CCODE1, SCC_COMMON_CODE CCODE2
                    WHERE CCODE1.GROUP_CODE = 'EXLDOWN_BLOCKING'
                      AND CCODE1.CODE = #UUSER#
                      AND CCODE1.USE_YN = 'Y'
                      AND CCODE2.GROUP_CODE = 'UPJANG_BLOCKING'
                      AND CCODE2.CODE = T1.UPJANG
                      AND CCODE2.USE_YN = 'Y')
 ORDER BY NEW_GUBUN_NAME DESC, TM_NM, UPJANG_NAME
</isEqual>
<isEqual col="DATA_CLASS" value="E"> 
/* 관리-실적-추정 */
 SELECT DISTINCT TM_CD
      ,TM_NM TM_NAME
      --2018.07.27 김명섭 CC코드 중복 방지
      --,UPJANG
      ,UPJANGNM UPJANG_NAME
      --2019.02.14 김명섭 업장명 신규계획일 경우 신규로 구분
      --,DECODE(NEW_GUBUN_NAME, '신규', 'N', 'O') NEW_GUBUN
      --,NEW_GUBUN_NAME
      ,(CASE WHEN UPJANGNM LIKE '%신규계획%' THEN 'N' ELSE DECODE(NEW_GUBUN_NAME, '신규', 'N', 'O') END) AS NEW_GUBUN
      ,(CASE WHEN UPJANGNM LIKE '%신규계획%' THEN '신규' ELSE NEW_GUBUN_NAME END) AS NEW_GUBUN_NAME
      ,CC_CD
      ,P_TYPE_A AS SIMU_SALE_AMT  -- 계획 매출액
      --재료비, 노무비, 경비 추가  요청자 : 유영진   20160318  처리자 :맹수영
      ,P_TYPE_B AS SIMU_COST_AMT  -- 계획 재료비
      ,P_TYPE_C AS SIMU_LABOR_AMT  -- 계획 노무비
      ,P_TYPE_D AS SIMU_EXP_AMT  -- 계획 경비
      ,(P_TYPE_A - (P_TYPE_B + P_TYPE_C + P_TYPE_D)) AS SIMU_SALE_PROFIT -- 계획 매출이익
      ,R_TYPE_A AS SALE_AMT -- 실적 매출액
      ,ROUND(R_TYPE_B) AS COST_AMT -- 실적 재료비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_B/R_TYPE_A*100),1) AS COST_RATE -- 실적 매출 비율
      ,R_TYPE_C AS LABOR_AMT -- 실적 노무비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_C/R_TYPE_A*100),1) AS LABOR_RATE -- 실적 노무비 비율
      ,R_TYPE_D AS EXP_AMT -- 실적 경비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_D/R_TYPE_A*100),1) AS EXP_RATE -- 실적 경비비율
      ,ROUND((R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))) AS SALE_PROFIT -- 실적 매출이익
      ,ROUND(DECODE(R_TYPE_A,0,0,(R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))/R_TYPE_A*100),1) AS SALE_PROFIT_RATE -- 매출이익 비율
      ,ROUND(DECODE(P_TYPE_A,0,0,R_TYPE_A/P_TYPE_A*100),1) AS SIMU_SALE_DIFF_RATE -- 실적 매출액(%)
      ,((P_TYPE_A - (P_TYPE_B + P_TYPE_C + P_TYPE_D)) - (R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))) AS SIMU_PROFIT_DIFF_AMT -- 매출 이익
      ,(SELECT CST_PLNKGVRN_CLASS_CD FROM SCC_CC WHERE CC_CD = T1.CC_CD) AS CC_GB
  FROM (
        SELECT TM_CD
              ,TM_NM
              ,UPJANG
              ,UPJANGNM
              ,NEW_GUBUN_NAME              
              ,MAX(DECODE(CC_CD, NULL, CC_CD, CC_CD)) CC_CD
              --MAX를 모두 sum으로 변경  20160519
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_A', P_MM_AMT, 0)) P_TYPE_A -- 계획 매출액
             -- ,MAX(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0)) P_TYPE_B -- 계획 재료비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_C', P_MM_AMT, 0)) P_TYPE_C -- 계획 노무비 
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_D', P_MM_AMT, 0)) P_TYPE_D -- 계획 경비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_A', R_MM_AMT, 0)) R_TYPE_A -- 실적 매출액
       
             --,MAX(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0) * NVL(R_MM_MR, 100) / 100 ) P_TYPE_B -- 관리계획 재료비        
             ,SUM(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0) * NVL(R_MM_MR, 100) / 100 ) +SUM(DECODE(ACCT_TYPE, 'TYPE_E', P_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_F', P_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_G', P_MM_AMT, 0)  ) P_TYPE_B
             -- , MAX(DECODE(ACCT_TYPE, 'TYPE_B', R_MM_AMT, 0)  * NVL(R_MM_MR, 100) / 100 ) R_TYPE_B -- 관리실적 재료비
  
             , SUM(DECODE(ACCT_TYPE, 'TYPE_B', R_MM_AMT, 0)  * NVL(R_MM_MR, 100) / 100 ) +SUM(DECODE(ACCT_TYPE, 'TYPE_E', R_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_F', R_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_G', R_MM_AMT, 0)  )R_TYPE_B
     
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_C', R_MM_AMT, 0)) R_TYPE_C -- 실적 노무비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_D', R_MM_AMT, 0)) R_TYPE_D -- 실적 경비
          FROM (
                 SELECT TM_CD
                       ,TM_NM
                       ,UPJANG
                       ,UPJANGNM
                       ,NEW_GUBUN_NAME
                       ,CC_CD
                       ,ACCT_TYPE
                       ,ROUND(SUM(P_MM_AMT) / 1000) AS P_MM_AMT
                       ,ROUND(SUM(R_MM_AMT) / 1000) AS R_MM_AMT
                      ,( SELECT  CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_MARGIN_RATE_01
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_MARGIN_RATE_02
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_MARGIN_RATE_03
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_MARGIN_RATE_04
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_MARGIN_RATE_05
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_MARGIN_RATE_06
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_MARGIN_RATE_07
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_MARGIN_RATE_08
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_MARGIN_RATE_09
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_MARGIN_RATE_10
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_MARGIN_RATE_11
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_MARGIN_RATE_12
                                 ELSE 0
                                 END
                            FROM MAP_MARGIN_RATE_MGMT
                           WHERE UPJANG = A.UPJANG
                             AND YY = SUBSTR(#YYMM#, 1, 4)
                             AND CLASS = 'R'
                       ) R_MM_MR -- 조회월 출하율
                   FROM (
                        SELECT V.TM_CD
                              ,V.TM_NAME AS TM_NM
                              ,V.UPJANG
                              ,A.CC_NM AS UPJANGNM
                              ,(CASE WHEN V.OPEN_YY = SUBSTRB(#YYMM#,1,4) THEN '신규' -- OPEN_YY가 현재년과 같으면 신규.
                                ELSE '기존'
                                 END    
                               ) AS NEW_GUBUN_NAME
                              ,A.CC_CD
                              ,( CASE WHEN SUBSTR(A.ACCT_CD, 1, 2) = '41'  THEN 'TYPE_A'
                                      WHEN A.ACCT_CD = '98001010'  THEN 'TYPE_A'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42203'  THEN 'TYPE_B'
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진
                                   --   WHEN D.ACCTNM2  = '재료비'  THEN 'TYPE_B'
                                      
                                      
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '431' THEN 'TYPE_C'
                                      
                                      
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진                                      
                                      WHEN D.ACCTNM3 = '복리후생비(인건비성)' THEN 'TYPE_C' 
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' AND D.ACCTNM3 &lt;&gt; '복리후생비(인건비성)' THEN 'TYPE_D'
                                      --2018.01.16 김명섭 [SR201801_06318] 경비금액 내 내부원가 계정(98001510) 반영
                                      --WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002'  THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002' OR A.ACCT_CD = '98001510'  THEN 'TYPE_D'
                                      
                                   --   WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42202'  THEN 'TYPE_E'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42101'  THEN 'TYPE_F'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42201'  THEN 'TYPE_G'
                                  ELSE 'ETC'
                                   END
                               ) ACCT_TYPE
                              ,A.ACCT_CD
                               ,0 P_MM_AMT
                               ,( CASE WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '01' THEN A.MM_AMT_01  -- 조회 월
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '02' THEN A.MM_AMT_02
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '03' THEN A.MM_AMT_03
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '04' THEN A.MM_AMT_04
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '05' THEN A.MM_AMT_05
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '06' THEN A.MM_AMT_06
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '07' THEN A.MM_AMT_07
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '08' THEN A.MM_AMT_08
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '09' THEN A.MM_AMT_09
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '10' THEN A.MM_AMT_10
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '11' THEN A.MM_AMT_11
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '12' THEN A.MM_AMT_12
                                 ELSE 0
                                 END
                               ) R_MM_AMT -- 조회월 실적
                          FROM MAP_UPJANG_PL A -- SAP 실적
							                --2018.04.25 김명섭 사업계획관리 개선: 동일CC 데이터중복 개선
                              --,MAC_UPJANG_V V
                              ,(SELECT DISTINCT NVL(T2.ATTR01,T1.UPJANG) AS UPJANG, NVL(T2.CODE_NAME,T1.UPJANGNM) AS UPJANGNM,
                                       MU_CD,MU_NAME,SC_CD,SC_NAME,TM_CD,TM_NAME,PT_CD,PT_NAME,CC_CD,CC_NAME,OPEN_YY
                                  FROM MAC_UPJANG_V T1
                                LEFT OUTER JOIN SCC_COMMON_CODE T2
                                  ON T2.CODE = T1.CC_CD
                                 AND T2.GROUP_CODE = 'MAG20001S') V
                              --추가  
                              , MAS_ST_ACCOUNT D
                         WHERE 1 = 1
                           --2019.02.07 김명섭 팀/본부 조회 시 판관CC 제외
                           <isNull col="UPJANG">
                           --AND A.CC_CD NOT IN (SELECT CC_CD FROM SCC_CC WHERE CST_PLNKGVRN_CLASS_CD = 'SG')
                           </isNull>
                           AND A.CC_CD = V.CC_CD(+)
                           AND A.PL_CLASS = 'KS'
                                
                           AND A.FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) -- 입력 년
                           <isNotNull col="MU_CD">
                           AND V.MU_CD = #MU_CD#
                           </isNotNull>
		                            <isNotNull col="TM_CD">
		                                <isNotEqual col="HOMEPLUS" value="1"> 
		                                AND V.TM_CD LIKE #TM_CD# || '%'
		                                </isNotEqual>
		                            </isNotNull>
		                            <isNotNull col="UPJANG">
		                                <isNotEqual col="HOMEPLUS" value="1"> 
		                                AND V.UPJANG = #UPJANG#
		                                </isNotEqual>
		                                <isEqual col="HOMEPLUS" value="1"> 
 									                  AND V.UPJANG    IN  (SELECT Z.CODE FROM SCC_COMMON_CODE Z WHERE Z.GROUP_CODE = 'UPJANG_GROUP' AND Z.USE_YN = 'Y' AND SET1 = #UPJANG#  )
 									                  </isEqual>
		                            </isNotNull>
		                                                             --추가                           
                           AND  A.ACCT_CD = D.ACCTCD
                        
                        UNION ALL
                        
                        SELECT V.TM_CD
                              ,V.TM_NAME AS TM_NM
                              ,V.UPJANG
                              ,V.CC_NAME AS UPJANGNM
                              ,(CASE WHEN V.OPEN_YY = SUBSTRB(#YYMM#,1,4) THEN '신규' -- OPEN_YY가 현재년과 같으면 신규.
                                ELSE '기존'
                                 END    
                               ) AS NEW_GUBUN_NAME
                              ,A.CC_CD
                              ,( CASE WHEN SUBSTR(A.ACCT_CD, 1, 2) = '41'  THEN 'TYPE_A'
                                      WHEN A.ACCT_CD = '98001010'  THEN 'TYPE_A'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42203'  THEN 'TYPE_B'
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진
                                   --   WHEN D.ACCTNM2  = '재료비'  THEN 'TYPE_B'
                                      
                                      
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '431' THEN 'TYPE_C'
                                      
                                      
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진                                      
                                      WHEN D.ACCTNM3 = '복리후생비(인건비성)' THEN 'TYPE_C' 
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' AND D.ACCTNM3 &lt;&gt; '복리후생비(인건비성)' THEN 'TYPE_D'
                                      --2018.01.16 김명섭 [SR201801_06318] 경비금액 내 내부원가 계정(98001510) 반영
                                      --WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002'  THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002' OR A.ACCT_CD = '98001510'  THEN 'TYPE_D'
                                      
                                   --   WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42202'  THEN 'TYPE_E'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42101'  THEN 'TYPE_F'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42201'  THEN 'TYPE_G'
                                  ELSE 'ETC'
                                   END
                               ) ACCT_TYPE
                              ,A.ACCT_CD
                               ,( CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_AMT_01  -- 조회 월
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_AMT_02
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_AMT_03
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_AMT_04
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_AMT_05
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_AMT_06
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_AMT_07
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_AMT_08
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_AMT_09
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_AMT_10
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_AMT_11
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_AMT_12
                                  ELSE 0
                                  END
                               ) P_MM_AMT
                               ,0 R_MM_AMT -- 조회월 실적
                          FROM MAP_BPC_CONFIRM_PL_INFO A -- SAP 실적
							                --2018.04.25 김명섭 사업계획관리 개선: 동일CC 데이터중복 개선
                              --,MAC_UPJANG_V V
                              ,(SELECT DISTINCT NVL(T2.ATTR01,T1.UPJANG) AS UPJANG, NVL(T2.CODE_NAME,T1.UPJANGNM) AS UPJANGNM,
                                       MU_CD,MU_NAME,SC_CD,SC_NAME,TM_CD,TM_NAME,PT_CD,PT_NAME,CC_CD,CC_NAME,OPEN_YY
                                  FROM MAC_UPJANG_V T1
                                LEFT OUTER JOIN SCC_COMMON_CODE T2
                                  ON T2.CODE = T1.CC_CD
                                 AND T2.GROUP_CODE = 'MAG20001S') V
                              --추가  
                              , MAS_ST_ACCOUNT D
                         WHERE 1 = 1
                           --2019.02.07 김명섭 팀/본부 조회 시 판관CC 제외
                           <isNull col="UPJANG">
                           --AND A.CC_CD NOT IN (SELECT CC_CD FROM SCC_CC WHERE CST_PLNKGVRN_CLASS_CD = 'SG')
                           </isNull>
                           AND A.CC_CD = V.CC_CD(+)
                           AND A.PLAN_CLASS = 'MP'
                           AND A.PLAN_YEAR = SUBSTR(#YYMM#, 1, 4) -- 입력 년
                           AND A.VER_CD= (SELECT MAX(VER_CD)
                                            FROM MAP_BPC_CONFIRM_PL_INFO
                                           WHERE PLAN_CLASS = A.PLAN_CLASS
                                             AND PLAN_YEAR = A.PLAN_YEAR
                                             AND CC_CD = A.CC_CD)
                           <isNotNull col="MU_CD">
                           AND V.MU_CD = #MU_CD#
                           </isNotNull>
                            <isNotNull col="TM_CD">
                                <isNotEqual col="HOMEPLUS" value="1"> 
                                AND V.TM_CD LIKE #TM_CD# || '%'
                                </isNotEqual>
                            </isNotNull>
                            <isNotNull col="UPJANG">
                                <isNotEqual col="HOMEPLUS" value="1"> 
                                AND V.UPJANG = #UPJANG#
                                </isNotEqual>
                                <isEqual col="HOMEPLUS" value="1"> 
  						                  AND V.UPJANG    IN  (SELECT Z.CODE FROM SCC_COMMON_CODE Z WHERE Z.GROUP_CODE = 'UPJANG_GROUP' AND Z.USE_YN = 'Y' AND SET1 = #UPJANG#  )
  						                  </isEqual>
                            </isNotNull>
                           AND  A.ACCT_CD = D.ACCTCD
                        
                       ) A
                                                 
                 GROUP BY TM_CD, TM_NM, UPJANG, UPJANGNM, NEW_GUBUN_NAME, CC_CD, ACCT_TYPE
                  
                 --ORDER BY CC_CD, ACCT_TYPE
         )
         GROUP BY TM_CD, TM_NM, UPJANG, UPJANGNM, NEW_GUBUN_NAME
       ) T1
 WHERE UPJANG NOT IN (SELECT TO_NUMBER(CODE) FROM SCC_COMMON_CODE WHERE GROUP_CODE = 'MA0048' AND USE_YN = 'Y')        
   --2019.12.13 김명섭 블로킹대상자 조회 제외 업장 체크
   AND NOT EXISTS (SELECT 'x'
                     FROM SCC_COMMON_CODE CCODE1, SCC_COMMON_CODE CCODE2
                    WHERE CCODE1.GROUP_CODE = 'EXLDOWN_BLOCKING'
                      AND CCODE1.CODE = #UUSER#
                      AND CCODE1.USE_YN = 'Y'
                      AND CCODE2.GROUP_CODE = 'UPJANG_BLOCKING'
                      AND CCODE2.CODE = T1.UPJANG
                      AND CCODE2.USE_YN = 'Y')
 ORDER BY NEW_GUBUN_NAME DESC, TM_NM, UPJANG_NAME
</isEqual>
<isEqual col="DATA_CLASS" value="Y"> 
/* 관리-실적-전년 */
 SELECT DISTINCT TM_CD
      ,TM_NM TM_NAME
      --2018.07.27 김명섭 CC코드 중복 방지
      --,UPJANG
      ,UPJANGNM UPJANG_NAME
      --2019.02.14 김명섭 업장명 신규계획일 경우 신규로 구분
      --,DECODE(NEW_GUBUN_NAME, '신규', 'N', 'O') NEW_GUBUN
      --,NEW_GUBUN_NAME
      ,(CASE WHEN UPJANGNM LIKE '%신규계획%' THEN 'N' ELSE DECODE(NEW_GUBUN_NAME, '신규', 'N', 'O') END) AS NEW_GUBUN
      ,(CASE WHEN UPJANGNM LIKE '%신규계획%' THEN '신규' ELSE NEW_GUBUN_NAME END) AS NEW_GUBUN_NAME
      ,CC_CD
      ,P_TYPE_A AS SIMU_SALE_AMT  -- 계획 매출액
      --재료비, 노무비, 경비 추가  요청자 : 유영진   20160318  처리자 :맹수영
      ,P_TYPE_B AS SIMU_COST_AMT  -- 계획 재료비
      ,P_TYPE_C AS SIMU_LABOR_AMT  -- 계획 노무비
      ,P_TYPE_D AS SIMU_EXP_AMT  -- 계획 경비
      ,(P_TYPE_A - (P_TYPE_B + P_TYPE_C + P_TYPE_D)) AS SIMU_SALE_PROFIT -- 계획 매출이익
      ,R_TYPE_A AS SALE_AMT -- 실적 매출액
      ,ROUND(R_TYPE_B) AS COST_AMT -- 실적 재료비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_B/R_TYPE_A*100),1) AS COST_RATE -- 실적 매출 비율
      ,R_TYPE_C AS LABOR_AMT -- 실적 노무비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_C/R_TYPE_A*100),1) AS LABOR_RATE -- 실적 노무비 비율
      ,R_TYPE_D AS EXP_AMT -- 실적 경비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_D/R_TYPE_A*100),1) AS EXP_RATE -- 실적 경비비율
      ,ROUND((R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))) AS SALE_PROFIT -- 실적 매출이익
      ,ROUND(DECODE(R_TYPE_A,0,0,(R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))/R_TYPE_A*100),1) AS SALE_PROFIT_RATE -- 매출이익 비율
      ,ROUND(DECODE(P_TYPE_A,0,0,R_TYPE_A/P_TYPE_A*100),1) AS SIMU_SALE_DIFF_RATE -- 실적 매출액(%)
      ,((P_TYPE_A - (P_TYPE_B + P_TYPE_C + P_TYPE_D)) - (R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))) AS SIMU_PROFIT_DIFF_AMT -- 매출 이익
      ,(SELECT CST_PLNKGVRN_CLASS_CD FROM SCC_CC WHERE CC_CD = T1.CC_CD) AS CC_GB
  FROM (
        SELECT TM_CD
              ,TM_NM
              ,UPJANG
              ,UPJANGNM
              ,NEW_GUBUN_NAME              
              ,MAX(DECODE(CC_CD, NULL, CC_CD, CC_CD)) CC_CD
              --MAX를 모두 sum으로 변경  20160519
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_A', P_MM_AMT, 0)) P_TYPE_A -- 계획 매출액
             -- ,MAX(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0)) P_TYPE_B -- 계획 재료비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_C', P_MM_AMT, 0)) P_TYPE_C -- 계획 노무비 
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_D', P_MM_AMT, 0)) P_TYPE_D -- 계획 경비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_A', R_MM_AMT, 0)) R_TYPE_A -- 실적 매출액
       
             --,MAX(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0) * NVL(R_MM_MR, 100) / 100 ) P_TYPE_B -- 관리계획 재료비        
             ,SUM(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0) * NVL(R_MM_MR, 100) / 100 ) +SUM(DECODE(ACCT_TYPE, 'TYPE_E', P_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_F', P_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_G', P_MM_AMT, 0)  ) P_TYPE_B
             -- , MAX(DECODE(ACCT_TYPE, 'TYPE_B', R_MM_AMT, 0)  * NVL(R_MM_MR, 100) / 100 ) R_TYPE_B -- 관리실적 재료비
  
             /* 2018.02.07 김명섭 [] 조회조건 개선 */
             , SUM(DECODE(ACCT_TYPE, 'TYPE_B', R_MM_AMT, 0)  * NVL(R_MM_MR_2, 100) / 100 ) +SUM(DECODE(ACCT_TYPE, 'TYPE_E', R_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_F', R_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_G', R_MM_AMT, 0)  )R_TYPE_B
             /* 2018.02.07 김명섭 [] 조회조건 개선 */
     
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_C', R_MM_AMT, 0)) R_TYPE_C -- 실적 노무비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_D', R_MM_AMT, 0)) R_TYPE_D -- 실적 경비
          FROM (
                 SELECT TM_CD
                       ,TM_NM
                       ,UPJANG
                       ,UPJANGNM
                       ,NEW_GUBUN_NAME
                       ,CC_CD
                       ,ACCT_TYPE
                       ,ROUND(SUM(P_MM_AMT) / 1000) AS P_MM_AMT
                       ,ROUND(SUM(R_MM_AMT) / 1000) AS R_MM_AMT
                      ,( SELECT  CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_MARGIN_RATE_01
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_MARGIN_RATE_02
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_MARGIN_RATE_03
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_MARGIN_RATE_04
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_MARGIN_RATE_05
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_MARGIN_RATE_06
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_MARGIN_RATE_07
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_MARGIN_RATE_08
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_MARGIN_RATE_09
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_MARGIN_RATE_10
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_MARGIN_RATE_11
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_MARGIN_RATE_12
                                 ELSE 0
                                 END
                            FROM MAP_MARGIN_RATE_MGMT
                           WHERE UPJANG = A.UPJANG
                             AND YY = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY')
                             AND CLASS = 'R'
                       ) R_MM_MR
                      ,( SELECT  CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_MARGIN_RATE_01
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_MARGIN_RATE_02
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_MARGIN_RATE_03
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_MARGIN_RATE_04
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_MARGIN_RATE_05
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_MARGIN_RATE_06
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_MARGIN_RATE_07
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_MARGIN_RATE_08
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_MARGIN_RATE_09
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_MARGIN_RATE_10
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_MARGIN_RATE_11
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_MARGIN_RATE_12
                                 ELSE 0
                                 END
                            FROM MAP_MARGIN_RATE_MGMT
                           WHERE UPJANG = A.UPJANG
                             AND YY = SUBSTR(#YYMM#, 1, 4)
                             AND CLASS = 'R'
                       ) R_MM_MR_2
                   FROM (
                        SELECT V.TM_CD
                              ,V.TM_NAME AS TM_NM
                              ,V.UPJANG
                              ,A.CC_NM AS UPJANGNM
                              ,(CASE WHEN V.OPEN_YY = SUBSTRB(#YYMM#,1,4) THEN '신규' -- OPEN_YY가 현재년과 같으면 신규.
                                ELSE '기존'
                                 END    
                               ) AS NEW_GUBUN_NAME
                              ,A.CC_CD
                              ,( CASE WHEN SUBSTR(A.ACCT_CD, 1, 2) = '41'  THEN 'TYPE_A'
                                      WHEN A.ACCT_CD = '98001010'  THEN 'TYPE_A'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42203'  THEN 'TYPE_B'
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진
                                   --   WHEN D.ACCTNM2  = '재료비'  THEN 'TYPE_B'
                                      
                                      
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '431' THEN 'TYPE_C'
                                      
                                      
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진                                      
                                      WHEN D.ACCTNM3 = '복리후생비(인건비성)' THEN 'TYPE_C' 
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' AND D.ACCTNM3 &lt;&gt; '복리후생비(인건비성)' THEN 'TYPE_D'
                                      --2018.01.16 김명섭 [SR201801_06318] 경비금액 내 내부원가 계정(98001510) 반영
                                      --WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002'  THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002' OR A.ACCT_CD = '98001510'  THEN 'TYPE_D'
                                      
                                   --   WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42202'  THEN 'TYPE_E'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42101'  THEN 'TYPE_F'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42201'  THEN 'TYPE_G'
                                  ELSE 'ETC'
                                   END
                               ) ACCT_TYPE
                              ,A.ACCT_CD
                                ,( CASE WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '01' THEN A.MM_AMT_01  -- 조회 월
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '02' THEN A.MM_AMT_02
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '03' THEN A.MM_AMT_03
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '04' THEN A.MM_AMT_04
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '05' THEN A.MM_AMT_05
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '06' THEN A.MM_AMT_06
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '07' THEN A.MM_AMT_07
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '08' THEN A.MM_AMT_08
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '09' THEN A.MM_AMT_09
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '10' THEN A.MM_AMT_10
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '11' THEN A.MM_AMT_11
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '12' THEN A.MM_AMT_12
                                 ELSE 0
                                 END
                               ) P_MM_AMT -- 계획, 전년실적
                               ,( CASE WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '01' THEN A.MM_AMT_01  -- 조회 월
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '02' THEN A.MM_AMT_02
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '03' THEN A.MM_AMT_03
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '04' THEN A.MM_AMT_04
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '05' THEN A.MM_AMT_05
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '06' THEN A.MM_AMT_06
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '07' THEN A.MM_AMT_07
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '08' THEN A.MM_AMT_08
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '09' THEN A.MM_AMT_09
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '10' THEN A.MM_AMT_10
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '11' THEN A.MM_AMT_11
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '12' THEN A.MM_AMT_12
                                 ELSE 0
                                 END
                               ) R_MM_AMT -- 조회월 실적
                          FROM MAP_UPJANG_PL A -- SAP 실적
							                --2018.04.25 김명섭 사업계획관리 개선: 동일CC 데이터중복 개선
                              --,MAC_UPJANG_V V
                              ,(SELECT DISTINCT NVL(T2.ATTR01,T1.UPJANG) AS UPJANG, NVL(T2.CODE_NAME,T1.UPJANGNM) AS UPJANGNM,
                                       MU_CD,MU_NAME,SC_CD,SC_NAME,TM_CD,TM_NAME,PT_CD,PT_NAME,CC_CD,CC_NAME,OPEN_YY
                                  FROM MAC_UPJANG_V T1
                                LEFT OUTER JOIN SCC_COMMON_CODE T2
                                  ON T2.CODE = T1.CC_CD
                                 AND T2.GROUP_CODE = 'MAG20001S') V
                              --추가  
                              , MAS_ST_ACCOUNT D
                         WHERE 1 = 1
                           --2019.02.07 김명섭 팀/본부 조회 시 판관CC 제외
                           <isNull col="UPJANG">
                           --AND A.CC_CD NOT IN (SELECT CC_CD FROM SCC_CC WHERE CST_PLNKGVRN_CLASS_CD = 'SG')
                           </isNull>
                           AND A.CC_CD = V.CC_CD(+)
                           AND A.PL_CLASS = 'KS'
                                
                           AND A.FISCAL_YEAR IN (SUBSTR(#YYMM#, 1, 4), TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY')) -- 입력 년
                           <isNotNull col="MU_CD">
                           AND V.MU_CD = #MU_CD#
                           </isNotNull>
		                            <isNotNull col="TM_CD">
		                                <isNotEqual col="HOMEPLUS" value="1"> 
		                                AND V.TM_CD LIKE #TM_CD# || '%'
		                                </isNotEqual>
		                            </isNotNull>
		                            <isNotNull col="UPJANG">
		                                <isNotEqual col="HOMEPLUS" value="1"> 
		                                AND V.UPJANG = #UPJANG#
		                                </isNotEqual>
		                                <isEqual col="HOMEPLUS" value="1"> 
 									                  AND V.UPJANG    IN  (SELECT Z.CODE FROM SCC_COMMON_CODE Z WHERE Z.GROUP_CODE = 'UPJANG_GROUP' AND Z.USE_YN = 'Y' AND SET1 = #UPJANG#  )
 									                  </isEqual>
		                            </isNotNull>
		                                                             --추가                           
                           AND  A.ACCT_CD = D.ACCTCD
                       ) A
                                                 
                 GROUP BY TM_CD, TM_NM, UPJANG, UPJANGNM, NEW_GUBUN_NAME, CC_CD, ACCT_TYPE
                  
                 --ORDER BY CC_CD, ACCT_TYPE
         )
         GROUP BY TM_CD, TM_NM, UPJANG, UPJANGNM, NEW_GUBUN_NAME
       ) T1
 WHERE UPJANG NOT IN (SELECT TO_NUMBER(CODE) FROM SCC_COMMON_CODE WHERE GROUP_CODE = 'MA0048' AND USE_YN = 'Y')        
   --2019.12.13 김명섭 블로킹대상자 조회 제외 업장 체크
   AND NOT EXISTS (SELECT 'x'
                     FROM SCC_COMMON_CODE CCODE1, SCC_COMMON_CODE CCODE2
                    WHERE CCODE1.GROUP_CODE = 'EXLDOWN_BLOCKING'
                      AND CCODE1.CODE = #UUSER#
                      AND CCODE1.USE_YN = 'Y'
                      AND CCODE2.GROUP_CODE = 'UPJANG_BLOCKING'
                      AND CCODE2.CODE = T1.UPJANG
                      AND CCODE2.USE_YN = 'Y')
 ORDER BY NEW_GUBUN_NAME DESC, TM_NM, UPJANG_NAME
</isEqual>
<isEqual col="DATA_CLASS" value="M"> 
/* 관리-실적-전월 */
 SELECT DISTINCT TM_CD
      ,TM_NM TM_NAME
      --2018.07.27 김명섭 CC코드 중복 방지
      --,UPJANG
      ,UPJANGNM UPJANG_NAME
      --2019.02.14 김명섭 업장명 신규계획일 경우 신규로 구분
      --,DECODE(NEW_GUBUN_NAME, '신규', 'N', 'O') NEW_GUBUN
      --,NEW_GUBUN_NAME
      ,(CASE WHEN UPJANGNM LIKE '%신규계획%' THEN 'N' ELSE DECODE(NEW_GUBUN_NAME, '신규', 'N', 'O') END) AS NEW_GUBUN
      ,(CASE WHEN UPJANGNM LIKE '%신규계획%' THEN '신규' ELSE NEW_GUBUN_NAME END) AS NEW_GUBUN_NAME
      ,CC_CD
      ,P_TYPE_A AS SIMU_SALE_AMT  -- 계획 매출액
      --재료비, 노무비, 경비 추가  요청자 : 유영진   20160318  처리자 :맹수영
      ,P_TYPE_B AS SIMU_COST_AMT  -- 계획 재료비
      ,P_TYPE_C AS SIMU_LABOR_AMT  -- 계획 노무비
      ,P_TYPE_D AS SIMU_EXP_AMT  -- 계획 경비
      ,(P_TYPE_A - (P_TYPE_B + P_TYPE_C + P_TYPE_D)) AS SIMU_SALE_PROFIT -- 계획 매출이익
      ,R_TYPE_A AS SALE_AMT -- 실적 매출액
      ,ROUND(R_TYPE_B) AS COST_AMT -- 실적 재료비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_B/R_TYPE_A*100),1) AS COST_RATE -- 실적 매출 비율
      ,R_TYPE_C AS LABOR_AMT -- 실적 노무비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_C/R_TYPE_A*100),1) AS LABOR_RATE -- 실적 노무비 비율
      ,R_TYPE_D AS EXP_AMT -- 실적 경비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_D/R_TYPE_A*100),1) AS EXP_RATE -- 실적 경비비율
      ,ROUND((R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))) AS SALE_PROFIT -- 실적 매출이익
      ,ROUND(DECODE(R_TYPE_A,0,0,(R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))/R_TYPE_A*100),1) AS SALE_PROFIT_RATE -- 매출이익 비율
      ,ROUND(DECODE(P_TYPE_A,0,0,R_TYPE_A/P_TYPE_A*100),1) AS SIMU_SALE_DIFF_RATE -- 실적 매출액(%)
      ,((P_TYPE_A - (P_TYPE_B + P_TYPE_C + P_TYPE_D)) - (R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))) AS SIMU_PROFIT_DIFF_AMT -- 매출 이익
      ,(SELECT CST_PLNKGVRN_CLASS_CD FROM SCC_CC WHERE CC_CD = T1.CC_CD) AS CC_GB
  FROM (
        SELECT TM_CD
              ,TM_NM
              ,UPJANG
              ,UPJANGNM
              ,NEW_GUBUN_NAME              
              ,MAX(DECODE(CC_CD, NULL, CC_CD, CC_CD)) CC_CD
              --MAX를 모두 sum으로 변경  20160519
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_A', P_MM_AMT, 0)) P_TYPE_A -- 계획 매출액
             -- ,MAX(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0)) P_TYPE_B -- 계획 재료비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_C', P_MM_AMT, 0)) P_TYPE_C -- 계획 노무비 
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_D', P_MM_AMT, 0)) P_TYPE_D -- 계획 경비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_A', R_MM_AMT, 0)) R_TYPE_A -- 실적 매출액
       
             --,MAX(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0) * NVL(R_MM_MR, 100) / 100 ) P_TYPE_B -- 관리계획 재료비        
             ,SUM(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0) * NVL(R_MM_MR, 100) / 100 ) +SUM(DECODE(ACCT_TYPE, 'TYPE_E', P_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_F', P_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_G', P_MM_AMT, 0)  ) P_TYPE_B
             -- , MAX(DECODE(ACCT_TYPE, 'TYPE_B', R_MM_AMT, 0)  * NVL(R_MM_MR, 100) / 100 ) R_TYPE_B -- 관리실적 재료비
  
             /* 2018.02.07 김명섭 [] 조회조건 개선 */
             , SUM(DECODE(ACCT_TYPE, 'TYPE_B', R_MM_AMT, 0)  * NVL(R_MM_MR_2, 100) / 100 ) +SUM(DECODE(ACCT_TYPE, 'TYPE_E', R_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_F', R_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_G', R_MM_AMT, 0)  )R_TYPE_B
             /* 2018.02.07 김명섭 [] 조회조건 개선 */
     
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_C', R_MM_AMT, 0)) R_TYPE_C -- 실적 노무비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_D', R_MM_AMT, 0)) R_TYPE_D -- 실적 경비
          FROM (
                 SELECT TM_CD
                       ,TM_NM
                       ,UPJANG
                       ,UPJANGNM
                       ,NEW_GUBUN_NAME
                       ,CC_CD
                       ,ACCT_TYPE
                       ,ROUND(SUM(P_MM_AMT) / 1000) AS P_MM_AMT
                       ,ROUND(SUM(R_MM_AMT) / 1000) AS R_MM_AMT
                      ,( SELECT  CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_MARGIN_RATE_01
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_MARGIN_RATE_02
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_MARGIN_RATE_03
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_MARGIN_RATE_04
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_MARGIN_RATE_05
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_MARGIN_RATE_06
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_MARGIN_RATE_07
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_MARGIN_RATE_08
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_MARGIN_RATE_09
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_MARGIN_RATE_10
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_MARGIN_RATE_11
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_MARGIN_RATE_12
                                 ELSE 0
                                 END
                            FROM MAP_MARGIN_RATE_MGMT
                           WHERE UPJANG = A.UPJANG
                             AND YY = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY')
                             AND CLASS = 'R'
                       ) R_MM_MR
                      ,( SELECT  CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_MARGIN_RATE_01
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_MARGIN_RATE_02
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_MARGIN_RATE_03
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_MARGIN_RATE_04
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_MARGIN_RATE_05
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_MARGIN_RATE_06
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_MARGIN_RATE_07
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_MARGIN_RATE_08
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_MARGIN_RATE_09
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_MARGIN_RATE_10
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_MARGIN_RATE_11
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_MARGIN_RATE_12
                                 ELSE 0
                                 END
                            FROM MAP_MARGIN_RATE_MGMT
                           WHERE UPJANG = A.UPJANG
                             AND YY = SUBSTR(#YYMM#, 1, 4)
                             AND CLASS = 'R'
                       ) R_MM_MR_2
                   FROM (
                        SELECT V.TM_CD
                              ,V.TM_NAME AS TM_NM
                              ,V.UPJANG
                              ,A.CC_NM AS UPJANGNM
                              ,(CASE WHEN V.OPEN_YY = SUBSTRB(#YYMM#,1,4) THEN '신규' -- OPEN_YY가 현재년과 같으면 신규.
                                ELSE '기존'
                                 END    
                               ) AS NEW_GUBUN_NAME
                              ,A.CC_CD
                              ,( CASE WHEN SUBSTR(A.ACCT_CD, 1, 2) = '41'  THEN 'TYPE_A'
                                      WHEN A.ACCT_CD = '98001010'  THEN 'TYPE_A'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42203'  THEN 'TYPE_B'
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진
                                   --   WHEN D.ACCTNM2  = '재료비'  THEN 'TYPE_B'
                                      
                                      
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '431' THEN 'TYPE_C'
                                      
                                      
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진                                      
                                      WHEN D.ACCTNM3 = '복리후생비(인건비성)' THEN 'TYPE_C' 
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' AND D.ACCTNM3 &lt;&gt; '복리후생비(인건비성)' THEN 'TYPE_D'
                                      --2018.01.16 김명섭 [SR201801_06318] 경비금액 내 내부원가 계정(98001510) 반영
                                      --WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002'  THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002' OR A.ACCT_CD = '98001510'  THEN 'TYPE_D'
                                      
                                   --   WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42202'  THEN 'TYPE_E'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42101'  THEN 'TYPE_F'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42201'  THEN 'TYPE_G'
                                  ELSE 'ETC'
                                   END
                               ) ACCT_TYPE
                              ,A.ACCT_CD
                               ,( CASE WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '01' THEN A.MM_AMT_01  -- 조회 월
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '02' THEN A.MM_AMT_02
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '03' THEN A.MM_AMT_03
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '04' THEN A.MM_AMT_04
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '05' THEN A.MM_AMT_05
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '06' THEN A.MM_AMT_06
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '07' THEN A.MM_AMT_07
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '08' THEN A.MM_AMT_08
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '09' THEN A.MM_AMT_09
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '10' THEN A.MM_AMT_10
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '11' THEN A.MM_AMT_11
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '12' THEN A.MM_AMT_12
                                 ELSE 0
                                 END
                               ) P_MM_AMT -- 조회월 실적
                               ,( CASE WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '01' THEN A.MM_AMT_01  -- 조회 월
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '02' THEN A.MM_AMT_02
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '03' THEN A.MM_AMT_03
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '04' THEN A.MM_AMT_04
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '05' THEN A.MM_AMT_05
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '06' THEN A.MM_AMT_06
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '07' THEN A.MM_AMT_07
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '08' THEN A.MM_AMT_08
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '09' THEN A.MM_AMT_09
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '10' THEN A.MM_AMT_10
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '11' THEN A.MM_AMT_11
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '12' THEN A.MM_AMT_12
                                 ELSE 0
                                 END
                               ) R_MM_AMT -- 조회월 실적
                          FROM MAP_UPJANG_PL A -- SAP 실적
							                --2018.04.25 김명섭 사업계획관리 개선: 동일CC 데이터중복 개선
                              --,MAC_UPJANG_V V
                              ,(SELECT DISTINCT NVL(T2.ATTR01,T1.UPJANG) AS UPJANG, NVL(T2.CODE_NAME,T1.UPJANGNM) AS UPJANGNM,
                                       MU_CD,MU_NAME,SC_CD,SC_NAME,TM_CD,TM_NAME,PT_CD,PT_NAME,CC_CD,CC_NAME,OPEN_YY
                                  FROM MAC_UPJANG_V T1
                                LEFT OUTER JOIN SCC_COMMON_CODE T2
                                  ON T2.CODE = T1.CC_CD
                                 AND T2.GROUP_CODE = 'MAG20001S') V
                              --추가  
                              , MAS_ST_ACCOUNT D
                         WHERE 1 = 1
                           --2019.02.07 김명섭 팀/본부 조회 시 판관CC 제외
                           <isNull col="UPJANG">
                           --AND A.CC_CD NOT IN (SELECT CC_CD FROM SCC_CC WHERE CST_PLNKGVRN_CLASS_CD = 'SG')
                           </isNull>
                           AND A.CC_CD = V.CC_CD(+)
                           AND A.PL_CLASS = 'KS'
                                
                           AND A.FISCAL_YEAR IN (SUBSTR(#YYMM#, 1, 4), TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY')) -- 입력 년
                           <isNotNull col="MU_CD">
                           AND V.MU_CD = #MU_CD#
                           </isNotNull>
		                            <isNotNull col="TM_CD">
		                                <isNotEqual col="HOMEPLUS" value="1"> 
		                                AND V.TM_CD LIKE #TM_CD# || '%'
		                                </isNotEqual>
		                            </isNotNull>
		                            <isNotNull col="UPJANG">
		                                <isNotEqual col="HOMEPLUS" value="1"> 
		                                AND V.UPJANG = #UPJANG#
		                                </isNotEqual>
		                                <isEqual col="HOMEPLUS" value="1"> 
 									                  AND V.UPJANG    IN  (SELECT Z.CODE FROM SCC_COMMON_CODE Z WHERE Z.GROUP_CODE = 'UPJANG_GROUP' AND Z.USE_YN = 'Y' AND SET1 = #UPJANG#  )
 									                  </isEqual>
		                            </isNotNull>
		                                                             --추가                           
                           AND  A.ACCT_CD = D.ACCTCD
                       ) A
                                                 
                 GROUP BY TM_CD, TM_NM, UPJANG, UPJANGNM, NEW_GUBUN_NAME, CC_CD, ACCT_TYPE
                  
                 --ORDER BY CC_CD, ACCT_TYPE
         )
         GROUP BY TM_CD, TM_NM, UPJANG, UPJANGNM, NEW_GUBUN_NAME
       ) T1
 WHERE UPJANG NOT IN (SELECT TO_NUMBER(CODE) FROM SCC_COMMON_CODE WHERE GROUP_CODE = 'MA0048' AND USE_YN = 'Y')        
   --2019.12.13 김명섭 블로킹대상자 조회 제외 업장 체크
   AND NOT EXISTS (SELECT 'x'
                     FROM SCC_COMMON_CODE CCODE1, SCC_COMMON_CODE CCODE2
                    WHERE CCODE1.GROUP_CODE = 'EXLDOWN_BLOCKING'
                      AND CCODE1.CODE = #UUSER#
                      AND CCODE1.USE_YN = 'Y'
                      AND CCODE2.GROUP_CODE = 'UPJANG_BLOCKING'
                      AND CCODE2.CODE = T1.UPJANG
                      AND CCODE2.USE_YN = 'Y')
 ORDER BY NEW_GUBUN_NAME DESC, TM_NM, UPJANG_NAME
</isEqual>
</isEqual>
</isEqual>

<isEqual col="CLOSE_TYPE" value="C05C">
<isEqual col="SALE_TYPE" value="S">
<isEqual col="DATA_CLASS" value="P"> 
/* 재무-실적-계획 */
 SELECT DISTINCT TM_CD
      ,TM_NM TM_NAME
      --2018.07.27 김명섭 CC코드 중복 방지
      --,UPJANG
      ,UPJANGNM UPJANG_NAME
      --2019.02.14 김명섭 업장명 신규계획일 경우 신규로 구분
      --,DECODE(NEW_GUBUN_NAME, '신규', 'N', 'O') NEW_GUBUN
      --,NEW_GUBUN_NAME
      ,(CASE WHEN UPJANGNM LIKE '%신규계획%' THEN 'N' ELSE DECODE(NEW_GUBUN_NAME, '신규', 'N', 'O') END) AS NEW_GUBUN
      ,(CASE WHEN UPJANGNM LIKE '%신규계획%' THEN '신규' ELSE NEW_GUBUN_NAME END) AS NEW_GUBUN_NAME
      ,CC_CD
      ,P_TYPE_A AS SIMU_SALE_AMT  -- 계획 매출액
      --재료비, 노무비, 경비 추가  요청자 : 유영진   20160318  처리자 :맹수영
      ,P_TYPE_B AS SIMU_COST_AMT  -- 계획 재료비
      ,P_TYPE_C AS SIMU_LABOR_AMT  -- 계획 노무비
      ,P_TYPE_D AS SIMU_EXP_AMT  -- 계획 경비
      ,(P_TYPE_A - (P_TYPE_B + P_TYPE_C + P_TYPE_D)) AS SIMU_SALE_PROFIT -- 계획 매출이익
      ,R_TYPE_A AS SALE_AMT -- 실적 매출액
      ,ROUND(R_TYPE_B) AS COST_AMT -- 실적 재료비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_B/R_TYPE_A*100),1) AS COST_RATE -- 실적 매출 비율
      ,R_TYPE_C AS LABOR_AMT -- 실적 노무비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_C/R_TYPE_A*100),1) AS LABOR_RATE -- 실적 노무비 비율
      ,R_TYPE_D AS EXP_AMT -- 실적 경비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_D/R_TYPE_A*100),1) AS EXP_RATE -- 실적 경비비율
      ,ROUND((R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))) AS SALE_PROFIT -- 실적 매출이익
      ,ROUND(DECODE(R_TYPE_A,0,0,(R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))/R_TYPE_A*100),1) AS SALE_PROFIT_RATE -- 매출이익 비율
      ,ROUND(DECODE(P_TYPE_A,0,0,R_TYPE_A/P_TYPE_A*100),1) AS SIMU_SALE_DIFF_RATE -- 실적 매출액(%)
      ,((P_TYPE_A - (P_TYPE_B + P_TYPE_C + P_TYPE_D)) - (R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))) AS SIMU_PROFIT_DIFF_AMT -- 매출 이익
      ,(SELECT CST_PLNKGVRN_CLASS_CD FROM SCC_CC WHERE CC_CD = T1.CC_CD) AS CC_GB
  FROM (
        SELECT TM_CD
              ,TM_NM
              ,UPJANG
              ,UPJANGNM
              ,NEW_GUBUN_NAME              
              ,MAX(DECODE(CC_CD, NULL, CC_CD, CC_CD)) CC_CD
              --MAX를 모두 sum으로 변경  20160519
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_A', P_MM_AMT, 0)) P_TYPE_A -- 계획 매출액
             -- ,MAX(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0)) P_TYPE_B -- 계획 재료비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_C', P_MM_AMT, 0)) P_TYPE_C -- 계획 노무비 
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_D', P_MM_AMT, 0)) P_TYPE_D -- 계획 경비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_A', R_MM_AMT, 0)) R_TYPE_A -- 실적 매출액
               
              --,MAX(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0)) P_TYPE_B -- 계획 재료비
             ,SUM(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0)) +SUM(DECODE(ACCT_TYPE, 'TYPE_E', P_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_F', P_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_G', P_MM_AMT, 0)  ) P_TYPE_B
            --  ,MAX(DECODE(ACCT_TYPE, 'TYPE_B', R_MM_AMT, 0)) R_TYPE_B -- 재무실적 재료비
            ,SUM(DECODE(ACCT_TYPE, 'TYPE_B', R_MM_AMT, 0)) +SUM(DECODE(ACCT_TYPE, 'TYPE_E', R_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_F', R_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_G', R_MM_AMT, 0)  ) R_TYPE_B
     
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_C', R_MM_AMT, 0)) R_TYPE_C -- 실적 노무비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_D', R_MM_AMT, 0)) R_TYPE_D -- 실적 경비
          FROM (
                 SELECT TM_CD
                       ,TM_NM
                       ,UPJANG
                       ,UPJANGNM
                       ,NEW_GUBUN_NAME
                       ,CC_CD
                       ,ACCT_TYPE
                       ,ROUND(SUM(P_MM_AMT) / 1000) AS P_MM_AMT
                       ,ROUND(SUM(R_MM_AMT) / 1000) AS R_MM_AMT
                      ,( SELECT  CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_MARGIN_RATE_01
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_MARGIN_RATE_02
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_MARGIN_RATE_03
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_MARGIN_RATE_04
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_MARGIN_RATE_05
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_MARGIN_RATE_06
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_MARGIN_RATE_07
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_MARGIN_RATE_08
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_MARGIN_RATE_09
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_MARGIN_RATE_10
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_MARGIN_RATE_11
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_MARGIN_RATE_12
                                 ELSE 0
                                 END
                            FROM MAP_MARGIN_RATE_MGMT
                           WHERE UPJANG = A.UPJANG
                             AND YY = SUBSTR(#YYMM#, 1, 4)
                             AND CLASS = 'R'
                       ) R_MM_MR
                   FROM (
                        SELECT V.TM_CD
                              ,V.TM_NAME AS TM_NM
                              ,V.UPJANG
                              ,A.CC_NM AS UPJANGNM
                              ,(CASE WHEN V.OPEN_YY = SUBSTRB(#YYMM#,1,4) THEN '신규' -- OPEN_YY가 현재년과 같으면 신규.
                                ELSE '기존'
                                 END    
                               ) AS NEW_GUBUN_NAME
                              ,A.CC_CD
                              ,( CASE WHEN SUBSTR(A.ACCT_CD, 1, 2) = '41'  THEN 'TYPE_A'
                                      WHEN A.ACCT_CD = '98001010'  THEN 'TYPE_A'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42203'  THEN 'TYPE_B'
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진
                                   --   WHEN D.ACCTNM2  = '재료비'  THEN 'TYPE_B'
                                      
                                      
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '431' THEN 'TYPE_C'
                                      
                                      
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진                                      
                                      WHEN D.ACCTNM3 = '복리후생비(인건비성)' THEN 'TYPE_C' 
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' AND D.ACCTNM3 &lt;&gt; '복리후생비(인건비성)' THEN 'TYPE_D'
                                      --2018.01.16 김명섭 [SR201801_06318] 경비금액 내 내부원가 계정(98001510) 반영
                                      --WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002'  THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002' OR A.ACCT_CD = '98001510'  THEN 'TYPE_D'
                                      
                                   --   WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42202'  THEN 'TYPE_E'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42101'  THEN 'TYPE_F'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42201'  THEN 'TYPE_G'
                                  ELSE 'ETC'
                                   END
                               ) ACCT_TYPE
                              ,A.ACCT_CD
                               ,0 P_MM_AMT
                               ,( CASE WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '01' THEN A.MM_AMT_01  -- 조회 월
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '02' THEN A.MM_AMT_02
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '03' THEN A.MM_AMT_03
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '04' THEN A.MM_AMT_04
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '05' THEN A.MM_AMT_05
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '06' THEN A.MM_AMT_06
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '07' THEN A.MM_AMT_07
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '08' THEN A.MM_AMT_08
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '09' THEN A.MM_AMT_09
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '10' THEN A.MM_AMT_10
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '11' THEN A.MM_AMT_11
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '12' THEN A.MM_AMT_12
                                 ELSE 0
                                 END
                               ) R_MM_AMT -- 조회월 실적
                          FROM MAP_UPJANG_PL A -- SAP 실적
							                --2018.04.25 김명섭 사업계획관리 개선: 동일CC 데이터중복 개선
                              --,MAC_UPJANG_V V
                              ,(SELECT DISTINCT NVL(T2.ATTR01,T1.UPJANG) AS UPJANG, NVL(T2.CODE_NAME,T1.UPJANGNM) AS UPJANGNM,
                                       MU_CD,MU_NAME,SC_CD,SC_NAME,TM_CD,TM_NAME,PT_CD,PT_NAME,CC_CD,CC_NAME,OPEN_YY
                                  FROM MAC_UPJANG_V T1
                                LEFT OUTER JOIN SCC_COMMON_CODE T2
                                  ON T2.CODE = T1.CC_CD
                                 AND T2.GROUP_CODE = 'MAG20001S') V
                              --추가  
                              , MAS_ST_ACCOUNT D
                         WHERE 1 = 1
                           --2019.02.07 김명섭 팀/본부 조회 시 판관CC 제외
                           <isNull col="UPJANG">
                           --AND A.CC_CD NOT IN (SELECT CC_CD FROM SCC_CC WHERE CST_PLNKGVRN_CLASS_CD = 'SG')
                           </isNull>
                           AND A.CC_CD = V.CC_CD(+)
                           AND A.PL_CLASS = 'KS'
                                
                           AND A.FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) -- 입력 년
                           <isNotNull col="MU_CD">
                           AND V.MU_CD = #MU_CD#
                           </isNotNull>
		                            <isNotNull col="TM_CD">
		                                <isNotEqual col="HOMEPLUS" value="1"> 
		                                AND V.TM_CD LIKE #TM_CD# || '%'
		                                </isNotEqual>
		                            </isNotNull>
		                            <isNotNull col="UPJANG">
		                                <isNotEqual col="HOMEPLUS" value="1"> 
		                                AND V.UPJANG = #UPJANG#
		                                </isNotEqual>
		                                <isEqual col="HOMEPLUS" value="1"> 
 									     AND V.UPJANG    IN  (SELECT Z.CODE FROM SCC_COMMON_CODE Z WHERE Z.GROUP_CODE = 'UPJANG_GROUP' AND Z.USE_YN = 'Y' AND SET1 = #UPJANG#  )
 									    </isEqual>
		                            </isNotNull>
		                                                             --추가                           
                           AND  A.ACCT_CD = D.ACCTCD
                           
                        UNION ALL
                        
                        SELECT V.TM_CD
                              ,V.TM_NAME AS TM_NM
                              ,V.UPJANG
                              ,V.CC_NAME AS UPJANGNM
                              ,(CASE WHEN V.OPEN_YY = SUBSTRB(#YYMM#,1,4) THEN '신규' -- OPEN_YY가 현재년과 같으면 신규.
                                ELSE '기존'
                                 END    
                               ) AS NEW_GUBUN_NAME
                              ,A.CC_CD
                              ,( CASE WHEN SUBSTR(A.ACCT_CD, 1, 2) = '41'  THEN 'TYPE_A'
                                      WHEN A.ACCT_CD = '98001010'  THEN 'TYPE_A'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42203'  THEN 'TYPE_B'
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진
                                   --   WHEN D.ACCTNM2  = '재료비'  THEN 'TYPE_B'
                                      
                                      
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '431' THEN 'TYPE_C'
                                      
                                      
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진                                      
                                      WHEN D.ACCTNM3 = '복리후생비(인건비성)' THEN 'TYPE_C' 
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' AND D.ACCTNM3 &lt;&gt; '복리후생비(인건비성)' THEN 'TYPE_D'
                                      --2018.01.16 김명섭 [SR201801_06318] 경비금액 내 내부원가 계정(98001510) 반영
                                      --WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002'  THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002' OR A.ACCT_CD = '98001510'  THEN 'TYPE_D'
                                      
                                   --   WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42202'  THEN 'TYPE_E'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42101'  THEN 'TYPE_F'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42201'  THEN 'TYPE_G'
                                  ELSE 'ETC'
                                   END
                               ) ACCT_TYPE
                              ,A.ACCT_CD
                               ,( CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_AMT_01  -- 조회 월
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_AMT_02
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_AMT_03
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_AMT_04
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_AMT_05
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_AMT_06
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_AMT_07
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_AMT_08
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_AMT_09
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_AMT_10
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_AMT_11
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_AMT_12
                                  ELSE 0
                                  END
                               ) P_MM_AMT
                               ,0 R_MM_AMT -- 조회월 실적
                          FROM MAP_BPC_CONFIRM_PL_INFO A -- SAP 실적
							                --2018.04.25 김명섭 사업계획관리 개선: 동일CC 데이터중복 개선
                              --,MAC_UPJANG_V V
                              ,(SELECT DISTINCT NVL(T2.ATTR01,T1.UPJANG) AS UPJANG, NVL(T2.CODE_NAME,T1.UPJANGNM) AS UPJANGNM,
                                       MU_CD,MU_NAME,SC_CD,SC_NAME,TM_CD,TM_NAME,PT_CD,PT_NAME,CC_CD,CC_NAME,OPEN_YY
                                  FROM MAC_UPJANG_V T1
                                LEFT OUTER JOIN SCC_COMMON_CODE T2
                                  ON T2.CODE = T1.CC_CD
                                 AND T2.GROUP_CODE = 'MAG20001S') V
                              --추가  
                              , MAS_ST_ACCOUNT D
                         WHERE 1 = 1
                           --2019.02.07 김명섭 팀/본부 조회 시 판관CC 제외
                           <isNull col="UPJANG">
                           --AND A.CC_CD NOT IN (SELECT CC_CD FROM SCC_CC WHERE CST_PLNKGVRN_CLASS_CD = 'SG')
                           </isNull>
                           AND A.CC_CD = V.CC_CD(+)
                           AND A.PLAN_CLASS = 'AP'
                           AND A.PLAN_YEAR = SUBSTR(#YYMM#, 1, 4) -- 입력 년
                           AND A.VER_CD= (SELECT MAX(VER_CD)
                                            FROM MAP_BPC_CONFIRM_PL_INFO
                                           WHERE PLAN_CLASS = A.PLAN_CLASS
                                             AND PLAN_YEAR = A.PLAN_YEAR
                                             AND CC_CD = A.CC_CD)
                           <isNotNull col="MU_CD">
                           AND V.MU_CD = #MU_CD#
                           </isNotNull>
                            <isNotNull col="TM_CD">
                                <isNotEqual col="HOMEPLUS" value="1"> 
                                AND V.TM_CD LIKE #TM_CD# || '%'
                                </isNotEqual>
                            </isNotNull>
                            <isNotNull col="UPJANG">
                                <isNotEqual col="HOMEPLUS" value="1"> 
                                AND V.UPJANG = #UPJANG#
                                </isNotEqual>
                                <isEqual col="HOMEPLUS" value="1"> 
  						                  AND V.UPJANG    IN  (SELECT Z.CODE FROM SCC_COMMON_CODE Z WHERE Z.GROUP_CODE = 'UPJANG_GROUP' AND Z.USE_YN = 'Y' AND SET1 = #UPJANG#  )
  						                  </isEqual>
                            </isNotNull>
                           AND  A.ACCT_CD = D.ACCTCD
                                                   
                       ) A
                                                 
                 GROUP BY TM_CD, TM_NM, UPJANG, UPJANGNM, NEW_GUBUN_NAME, CC_CD, ACCT_TYPE
                  
                 --ORDER BY CC_CD, ACCT_TYPE
         )
         GROUP BY TM_CD, TM_NM, UPJANG, UPJANGNM, NEW_GUBUN_NAME
       ) T1
 WHERE UPJANG NOT IN (SELECT TO_NUMBER(CODE) FROM SCC_COMMON_CODE WHERE GROUP_CODE = 'MA0048' AND USE_YN = 'Y')        
   --2019.12.13 김명섭 블로킹대상자 조회 제외 업장 체크
   AND NOT EXISTS (SELECT 'x'
                     FROM SCC_COMMON_CODE CCODE1, SCC_COMMON_CODE CCODE2
                    WHERE CCODE1.GROUP_CODE = 'EXLDOWN_BLOCKING'
                      AND CCODE1.CODE = #UUSER#
                      AND CCODE1.USE_YN = 'Y'
                      AND CCODE2.GROUP_CODE = 'UPJANG_BLOCKING'
                      AND CCODE2.CODE = T1.UPJANG
                      AND CCODE2.USE_YN = 'Y')
 ORDER BY NEW_GUBUN_NAME DESC, TM_NM, UPJANG_NAME
</isEqual>
<isEqual col="DATA_CLASS" value="E"> 
/* 재무-실적-추정 */
 SELECT DISTINCT TM_CD
      ,TM_NM TM_NAME
      --2018.07.27 김명섭 CC코드 중복 방지
      --,UPJANG
      ,UPJANGNM UPJANG_NAME
      --2019.02.14 김명섭 업장명 신규계획일 경우 신규로 구분
      --,DECODE(NEW_GUBUN_NAME, '신규', 'N', 'O') NEW_GUBUN
      --,NEW_GUBUN_NAME
      ,(CASE WHEN UPJANGNM LIKE '%신규계획%' THEN 'N' ELSE DECODE(NEW_GUBUN_NAME, '신규', 'N', 'O') END) AS NEW_GUBUN
      ,(CASE WHEN UPJANGNM LIKE '%신규계획%' THEN '신규' ELSE NEW_GUBUN_NAME END) AS NEW_GUBUN_NAME
      ,CC_CD
      ,P_TYPE_A AS SIMU_SALE_AMT  -- 계획 매출액
      --재료비, 노무비, 경비 추가  요청자 : 유영진   20160318  처리자 :맹수영
      ,P_TYPE_B AS SIMU_COST_AMT  -- 계획 재료비
      ,P_TYPE_C AS SIMU_LABOR_AMT  -- 계획 노무비
      ,P_TYPE_D AS SIMU_EXP_AMT  -- 계획 경비
      ,(P_TYPE_A - (P_TYPE_B + P_TYPE_C + P_TYPE_D)) AS SIMU_SALE_PROFIT -- 계획 매출이익
      ,R_TYPE_A AS SALE_AMT -- 실적 매출액
      ,ROUND(R_TYPE_B) AS COST_AMT -- 실적 재료비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_B/R_TYPE_A*100),1) AS COST_RATE -- 실적 매출 비율
      ,R_TYPE_C AS LABOR_AMT -- 실적 노무비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_C/R_TYPE_A*100),1) AS LABOR_RATE -- 실적 노무비 비율
      ,R_TYPE_D AS EXP_AMT -- 실적 경비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_D/R_TYPE_A*100),1) AS EXP_RATE -- 실적 경비비율
      ,ROUND((R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))) AS SALE_PROFIT -- 실적 매출이익
      ,ROUND(DECODE(R_TYPE_A,0,0,(R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))/R_TYPE_A*100),1) AS SALE_PROFIT_RATE -- 매출이익 비율
      ,ROUND(DECODE(P_TYPE_A,0,0,R_TYPE_A/P_TYPE_A*100),1) AS SIMU_SALE_DIFF_RATE -- 실적 매출액(%)
      ,((P_TYPE_A - (P_TYPE_B + P_TYPE_C + P_TYPE_D)) - (R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))) AS SIMU_PROFIT_DIFF_AMT -- 매출 이익
      ,(SELECT CST_PLNKGVRN_CLASS_CD FROM SCC_CC WHERE CC_CD = T1.CC_CD) AS CC_GB
  FROM (
        SELECT TM_CD
              ,TM_NM
              ,UPJANG
              ,UPJANGNM
              ,NEW_GUBUN_NAME              
              ,MAX(DECODE(CC_CD, NULL, CC_CD, CC_CD)) CC_CD
              --MAX를 모두 sum으로 변경  20160519
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_A', P_MM_AMT, 0)) P_TYPE_A -- 계획 매출액
             -- ,MAX(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0)) P_TYPE_B -- 계획 재료비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_C', P_MM_AMT, 0)) P_TYPE_C -- 계획 노무비 
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_D', P_MM_AMT, 0)) P_TYPE_D -- 계획 경비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_A', R_MM_AMT, 0)) R_TYPE_A -- 실적 매출액
               
              --,MAX(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0)) P_TYPE_B -- 계획 재료비
             ,SUM(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0)) +SUM(DECODE(ACCT_TYPE, 'TYPE_E', P_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_F', P_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_G', P_MM_AMT, 0)  ) P_TYPE_B
            --  ,MAX(DECODE(ACCT_TYPE, 'TYPE_B', R_MM_AMT, 0)) R_TYPE_B -- 재무실적 재료비
            ,SUM(DECODE(ACCT_TYPE, 'TYPE_B', R_MM_AMT, 0)) +SUM(DECODE(ACCT_TYPE, 'TYPE_E', R_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_F', R_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_G', R_MM_AMT, 0)  ) R_TYPE_B
     
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_C', R_MM_AMT, 0)) R_TYPE_C -- 실적 노무비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_D', R_MM_AMT, 0)) R_TYPE_D -- 실적 경비
          FROM (
                 SELECT TM_CD
                       ,TM_NM
                       ,UPJANG
                       ,UPJANGNM
                       ,NEW_GUBUN_NAME
                       ,CC_CD
                       ,ACCT_TYPE
                       ,ROUND(SUM(P_MM_AMT) / 1000) AS P_MM_AMT
                       ,ROUND(SUM(R_MM_AMT) / 1000) AS R_MM_AMT
                      ,( SELECT  CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_MARGIN_RATE_01
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_MARGIN_RATE_02
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_MARGIN_RATE_03
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_MARGIN_RATE_04
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_MARGIN_RATE_05
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_MARGIN_RATE_06
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_MARGIN_RATE_07
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_MARGIN_RATE_08
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_MARGIN_RATE_09
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_MARGIN_RATE_10
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_MARGIN_RATE_11
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_MARGIN_RATE_12
                                 ELSE 0
                                 END
                            FROM MAP_MARGIN_RATE_MGMT
                           WHERE UPJANG = A.UPJANG
                             AND YY = SUBSTR(#YYMM#, 1, 4)
                             AND CLASS = 'R'
                       ) R_MM_MR
                   FROM (
                        SELECT V.TM_CD
                              ,V.TM_NAME AS TM_NM
                              ,V.UPJANG
                              ,A.CC_NM AS UPJANGNM
                              ,(CASE WHEN V.OPEN_YY = SUBSTRB(#YYMM#,1,4) THEN '신규' -- OPEN_YY가 현재년과 같으면 신규.
                                ELSE '기존'
                                 END    
                               ) AS NEW_GUBUN_NAME
                              ,A.CC_CD
                              ,( CASE WHEN SUBSTR(A.ACCT_CD, 1, 2) = '41'  THEN 'TYPE_A'
                                      WHEN A.ACCT_CD = '98001010'  THEN 'TYPE_A'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42203'  THEN 'TYPE_B'
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진
                                   --   WHEN D.ACCTNM2  = '재료비'  THEN 'TYPE_B'
                                      
                                      
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '431' THEN 'TYPE_C'
                                      
                                      
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진                                      
                                      WHEN D.ACCTNM3 = '복리후생비(인건비성)' THEN 'TYPE_C' 
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' AND D.ACCTNM3 &lt;&gt; '복리후생비(인건비성)' THEN 'TYPE_D'
                                      --2018.01.16 김명섭 [SR201801_06318] 경비금액 내 내부원가 계정(98001510) 반영
                                      --WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002'  THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002' OR A.ACCT_CD = '98001510'  THEN 'TYPE_D'
                                      
                                   --   WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42202'  THEN 'TYPE_E'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42101'  THEN 'TYPE_F'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42201'  THEN 'TYPE_G'
                                  ELSE 'ETC'
                                   END
                               ) ACCT_TYPE
                              ,A.ACCT_CD
                               ,0 P_MM_AMT
                               ,( CASE WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '01' THEN A.MM_AMT_01  -- 조회 월
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '02' THEN A.MM_AMT_02
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '03' THEN A.MM_AMT_03
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '04' THEN A.MM_AMT_04
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '05' THEN A.MM_AMT_05
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '06' THEN A.MM_AMT_06
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '07' THEN A.MM_AMT_07
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '08' THEN A.MM_AMT_08
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '09' THEN A.MM_AMT_09
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '10' THEN A.MM_AMT_10
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '11' THEN A.MM_AMT_11
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '12' THEN A.MM_AMT_12
                                 ELSE 0
                                 END
                               ) R_MM_AMT -- 조회월 실적
                          FROM MAP_UPJANG_PL A -- SAP 실적
							                --2018.04.25 김명섭 사업계획관리 개선: 동일CC 데이터중복 개선
                              --,MAC_UPJANG_V V
                              ,(SELECT DISTINCT NVL(T2.ATTR01,T1.UPJANG) AS UPJANG, NVL(T2.CODE_NAME,T1.UPJANGNM) AS UPJANGNM,
                                       MU_CD,MU_NAME,SC_CD,SC_NAME,TM_CD,TM_NAME,PT_CD,PT_NAME,CC_CD,CC_NAME,OPEN_YY
                                  FROM MAC_UPJANG_V T1
                                LEFT OUTER JOIN SCC_COMMON_CODE T2
                                  ON T2.CODE = T1.CC_CD
                                 AND T2.GROUP_CODE = 'MAG20001S') V
                              --추가  
                              , MAS_ST_ACCOUNT D
                         WHERE 1 = 1
                           --2019.02.07 김명섭 팀/본부 조회 시 판관CC 제외
                           <isNull col="UPJANG">
                           --AND A.CC_CD NOT IN (SELECT CC_CD FROM SCC_CC WHERE CST_PLNKGVRN_CLASS_CD = 'SG')
                           </isNull>
                           AND A.CC_CD = V.CC_CD(+)
                           AND A.PL_CLASS = 'KS'
                                
                           AND A.FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) -- 입력 년
                           <isNotNull col="MU_CD">
                           AND V.MU_CD = #MU_CD#
                           </isNotNull>
		                            <isNotNull col="TM_CD">
		                                <isNotEqual col="HOMEPLUS" value="1"> 
		                                AND V.TM_CD LIKE #TM_CD# || '%'
		                                </isNotEqual>
		                            </isNotNull>
		                            <isNotNull col="UPJANG">
		                                <isNotEqual col="HOMEPLUS" value="1"> 
		                                AND V.UPJANG = #UPJANG#
		                                </isNotEqual>
		                                <isEqual col="HOMEPLUS" value="1"> 
 									     AND V.UPJANG    IN  (SELECT Z.CODE FROM SCC_COMMON_CODE Z WHERE Z.GROUP_CODE = 'UPJANG_GROUP' AND Z.USE_YN = 'Y' AND SET1 = #UPJANG#  )
 									    </isEqual>
		                            </isNotNull>
		                                                             --추가                           
                           AND  A.ACCT_CD = D.ACCTCD
                           
                        UNION ALL
                        
                        SELECT V.TM_CD
                              ,V.TM_NAME AS TM_NM
                              ,V.UPJANG
                              ,V.CC_NAME AS UPJANGNM
                              ,(CASE WHEN V.OPEN_YY = SUBSTRB(#YYMM#,1,4) THEN '신규' -- OPEN_YY가 현재년과 같으면 신규.
                                ELSE '기존'
                                 END    
                               ) AS NEW_GUBUN_NAME
                              ,A.CC_CD
                              ,( CASE WHEN SUBSTR(A.ACCT_CD, 1, 2) = '41'  THEN 'TYPE_A'
                                      WHEN A.ACCT_CD = '98001010'  THEN 'TYPE_A'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42203'  THEN 'TYPE_B'
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진
                                   --   WHEN D.ACCTNM2  = '재료비'  THEN 'TYPE_B'
                                      
                                      
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '431' THEN 'TYPE_C'
                                      
                                      
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진                                      
                                      WHEN D.ACCTNM3 = '복리후생비(인건비성)' THEN 'TYPE_C' 
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' AND D.ACCTNM3 &lt;&gt; '복리후생비(인건비성)' THEN 'TYPE_D'
                                      --2018.01.16 김명섭 [SR201801_06318] 경비금액 내 내부원가 계정(98001510) 반영
                                      --WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002'  THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002' OR A.ACCT_CD = '98001510'  THEN 'TYPE_D'
                                      
                                   --   WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42202'  THEN 'TYPE_E'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42101'  THEN 'TYPE_F'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42201'  THEN 'TYPE_G'
                                  ELSE 'ETC'
                                   END
                               ) ACCT_TYPE
                              ,A.ACCT_CD
                               ,( CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_AMT_01  -- 조회 월
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_AMT_02
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_AMT_03
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_AMT_04
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_AMT_05
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_AMT_06
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_AMT_07
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_AMT_08
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_AMT_09
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_AMT_10
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_AMT_11
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_AMT_12
                                  ELSE 0
                                  END
                               ) P_MM_AMT
                               ,0 R_MM_AMT -- 조회월 실적
                          FROM MAP_BPC_CONFIRM_PL_INFO A -- SAP 실적
							                --2018.04.25 김명섭 사업계획관리 개선: 동일CC 데이터중복 개선
                              --,MAC_UPJANG_V V
                              ,(SELECT DISTINCT NVL(T2.ATTR01,T1.UPJANG) AS UPJANG, NVL(T2.CODE_NAME,T1.UPJANGNM) AS UPJANGNM,
                                       MU_CD,MU_NAME,SC_CD,SC_NAME,TM_CD,TM_NAME,PT_CD,PT_NAME,CC_CD,CC_NAME,OPEN_YY
                                  FROM MAC_UPJANG_V T1
                                LEFT OUTER JOIN SCC_COMMON_CODE T2
                                  ON T2.CODE = T1.CC_CD
                                 AND T2.GROUP_CODE = 'MAG20001S') V
                              --추가  
                              , MAS_ST_ACCOUNT D
                         WHERE 1 = 1
                           --2019.02.07 김명섭 팀/본부 조회 시 판관CC 제외
                           <isNull col="UPJANG">
                           --AND A.CC_CD NOT IN (SELECT CC_CD FROM SCC_CC WHERE CST_PLNKGVRN_CLASS_CD = 'SG')
                           </isNull>
                           AND A.CC_CD = V.CC_CD(+)
                           AND A.PLAN_CLASS = 'MP'
                           AND A.PLAN_YEAR = SUBSTR(#YYMM#, 1, 4) -- 입력 년
                           AND A.VER_CD= (SELECT MAX(VER_CD)
                                            FROM MAP_BPC_CONFIRM_PL_INFO
                                           WHERE PLAN_CLASS = A.PLAN_CLASS
                                             AND PLAN_YEAR = A.PLAN_YEAR
                                             AND CC_CD = A.CC_CD)
                           <isNotNull col="MU_CD">
                           AND V.MU_CD = #MU_CD#
                           </isNotNull>
                            <isNotNull col="TM_CD">
                                <isNotEqual col="HOMEPLUS" value="1"> 
                                AND V.TM_CD LIKE #TM_CD# || '%'
                                </isNotEqual>
                            </isNotNull>
                            <isNotNull col="UPJANG">
                                <isNotEqual col="HOMEPLUS" value="1"> 
                                AND V.UPJANG = #UPJANG#
                                </isNotEqual>
                                <isEqual col="HOMEPLUS" value="1"> 
  						                  AND V.UPJANG    IN  (SELECT Z.CODE FROM SCC_COMMON_CODE Z WHERE Z.GROUP_CODE = 'UPJANG_GROUP' AND Z.USE_YN = 'Y' AND SET1 = #UPJANG#  )
  						                  </isEqual>
                            </isNotNull>
                           AND  A.ACCT_CD = D.ACCTCD
                        
                       ) A
                                                 
                 GROUP BY TM_CD, TM_NM, UPJANG, UPJANGNM, NEW_GUBUN_NAME, CC_CD, ACCT_TYPE
                  
                 --ORDER BY CC_CD, ACCT_TYPE
         )
         GROUP BY TM_CD, TM_NM, UPJANG, UPJANGNM, NEW_GUBUN_NAME
       ) T1
 WHERE UPJANG NOT IN (SELECT TO_NUMBER(CODE) FROM SCC_COMMON_CODE WHERE GROUP_CODE = 'MA0048' AND USE_YN = 'Y')        
   --2019.12.13 김명섭 블로킹대상자 조회 제외 업장 체크
   AND NOT EXISTS (SELECT 'x'
                     FROM SCC_COMMON_CODE CCODE1, SCC_COMMON_CODE CCODE2
                    WHERE CCODE1.GROUP_CODE = 'EXLDOWN_BLOCKING'
                      AND CCODE1.CODE = #UUSER#
                      AND CCODE1.USE_YN = 'Y'
                      AND CCODE2.GROUP_CODE = 'UPJANG_BLOCKING'
                      AND CCODE2.CODE = T1.UPJANG
                      AND CCODE2.USE_YN = 'Y')
 ORDER BY NEW_GUBUN_NAME DESC, TM_NM, UPJANG_NAME
</isEqual>
<isEqual col="DATA_CLASS" value="Y"> 
/* 재무-실적-전년 */
 SELECT DISTINCT TM_CD
      ,TM_NM TM_NAME
      --2018.07.27 김명섭 CC코드 중복 방지
      --,UPJANG
      ,UPJANGNM UPJANG_NAME
      --2019.02.14 김명섭 업장명 신규계획일 경우 신규로 구분
      --,DECODE(NEW_GUBUN_NAME, '신규', 'N', 'O') NEW_GUBUN
      --,NEW_GUBUN_NAME
      ,(CASE WHEN UPJANGNM LIKE '%신규계획%' THEN 'N' ELSE DECODE(NEW_GUBUN_NAME, '신규', 'N', 'O') END) AS NEW_GUBUN
      ,(CASE WHEN UPJANGNM LIKE '%신규계획%' THEN '신규' ELSE NEW_GUBUN_NAME END) AS NEW_GUBUN_NAME
      ,CC_CD
      ,P_TYPE_A AS SIMU_SALE_AMT  -- 계획 매출액
      --재료비, 노무비, 경비 추가  요청자 : 유영진   20160318  처리자 :맹수영
      ,P_TYPE_B AS SIMU_COST_AMT  -- 계획 재료비
      ,P_TYPE_C AS SIMU_LABOR_AMT  -- 계획 노무비
      ,P_TYPE_D AS SIMU_EXP_AMT  -- 계획 경비
      ,(P_TYPE_A - (P_TYPE_B + P_TYPE_C + P_TYPE_D)) AS SIMU_SALE_PROFIT -- 계획 매출이익
      ,R_TYPE_A AS SALE_AMT -- 실적 매출액
      ,ROUND(R_TYPE_B) AS COST_AMT -- 실적 재료비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_B/R_TYPE_A*100),1) AS COST_RATE -- 실적 매출 비율
      ,R_TYPE_C AS LABOR_AMT -- 실적 노무비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_C/R_TYPE_A*100),1) AS LABOR_RATE -- 실적 노무비 비율
      ,R_TYPE_D AS EXP_AMT -- 실적 경비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_D/R_TYPE_A*100),1) AS EXP_RATE -- 실적 경비비율
      ,ROUND((R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))) AS SALE_PROFIT -- 실적 매출이익
      ,ROUND(DECODE(R_TYPE_A,0,0,(R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))/R_TYPE_A*100),1) AS SALE_PROFIT_RATE -- 매출이익 비율
      ,ROUND(DECODE(P_TYPE_A,0,0,R_TYPE_A/P_TYPE_A*100),1) AS SIMU_SALE_DIFF_RATE -- 실적 매출액(%)
      ,((P_TYPE_A - (P_TYPE_B + P_TYPE_C + P_TYPE_D)) - (R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))) AS SIMU_PROFIT_DIFF_AMT -- 매출 이익
      ,(SELECT CST_PLNKGVRN_CLASS_CD FROM SCC_CC WHERE CC_CD = T1.CC_CD) AS CC_GB
  FROM (
        SELECT TM_CD
              ,TM_NM
              ,UPJANG
              ,UPJANGNM
              ,NEW_GUBUN_NAME              
              ,MAX(DECODE(CC_CD, NULL, CC_CD, CC_CD)) CC_CD
              --MAX를 모두 sum으로 변경  20160519
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_A', P_MM_AMT, 0)) P_TYPE_A -- 계획 매출액
             -- ,MAX(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0)) P_TYPE_B -- 계획 재료비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_C', P_MM_AMT, 0)) P_TYPE_C -- 계획 노무비 
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_D', P_MM_AMT, 0)) P_TYPE_D -- 계획 경비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_A', R_MM_AMT, 0)) R_TYPE_A -- 실적 매출액
               
              --,MAX(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0)) P_TYPE_B -- 계획 재료비
             ,SUM(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0)) +SUM(DECODE(ACCT_TYPE, 'TYPE_E', P_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_F', P_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_G', P_MM_AMT, 0)  ) P_TYPE_B
            --  ,MAX(DECODE(ACCT_TYPE, 'TYPE_B', R_MM_AMT, 0)) R_TYPE_B -- 재무실적 재료비
            ,SUM(DECODE(ACCT_TYPE, 'TYPE_B', R_MM_AMT, 0)) +SUM(DECODE(ACCT_TYPE, 'TYPE_E', R_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_F', R_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_G', R_MM_AMT, 0)  ) R_TYPE_B
     
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_C', R_MM_AMT, 0)) R_TYPE_C -- 실적 노무비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_D', R_MM_AMT, 0)) R_TYPE_D -- 실적 경비
          FROM (
                 SELECT TM_CD
                       ,TM_NM
                       ,UPJANG
                       ,UPJANGNM
                       ,NEW_GUBUN_NAME
                       ,CC_CD
                       ,ACCT_TYPE
                       ,ROUND(SUM(P_MM_AMT) / 1000) AS P_MM_AMT
                       ,ROUND(SUM(R_MM_AMT) / 1000) AS R_MM_AMT
                      ,( SELECT  CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_MARGIN_RATE_01
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_MARGIN_RATE_02
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_MARGIN_RATE_03
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_MARGIN_RATE_04
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_MARGIN_RATE_05
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_MARGIN_RATE_06
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_MARGIN_RATE_07
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_MARGIN_RATE_08
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_MARGIN_RATE_09
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_MARGIN_RATE_10
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_MARGIN_RATE_11
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_MARGIN_RATE_12
                                 ELSE 0
                                 END
                            FROM MAP_MARGIN_RATE_MGMT
                           WHERE UPJANG = A.UPJANG
                             AND YY = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY')
                             AND CLASS = 'R'
                       ) R_MM_MR
                      ,( SELECT  CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_MARGIN_RATE_01
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_MARGIN_RATE_02
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_MARGIN_RATE_03
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_MARGIN_RATE_04
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_MARGIN_RATE_05
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_MARGIN_RATE_06
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_MARGIN_RATE_07
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_MARGIN_RATE_08
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_MARGIN_RATE_09
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_MARGIN_RATE_10
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_MARGIN_RATE_11
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_MARGIN_RATE_12
                                 ELSE 0
                                 END
                            FROM MAP_MARGIN_RATE_MGMT
                           WHERE UPJANG = A.UPJANG
                             AND YY = SUBSTR(#YYMM#, 1, 4)
                             AND CLASS = 'R'
                       ) R_MM_MR_2
                   FROM (
                        SELECT V.TM_CD
                              ,V.TM_NAME AS TM_NM
                              ,V.UPJANG
                              ,A.CC_NM AS UPJANGNM
                              ,(CASE WHEN V.OPEN_YY = SUBSTRB(#YYMM#,1,4) THEN '신규' -- OPEN_YY가 현재년과 같으면 신규.
                                ELSE '기존'
                                 END    
                               ) AS NEW_GUBUN_NAME
                              ,A.CC_CD
                              ,( CASE WHEN SUBSTR(A.ACCT_CD, 1, 2) = '41'  THEN 'TYPE_A'
                                      WHEN A.ACCT_CD = '98001010'  THEN 'TYPE_A'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42203'  THEN 'TYPE_B'
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진
                                   --   WHEN D.ACCTNM2  = '재료비'  THEN 'TYPE_B'
                                      
                                      
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '431' THEN 'TYPE_C'
                                      
                                      
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진                                      
                                      WHEN D.ACCTNM3 = '복리후생비(인건비성)' THEN 'TYPE_C' 
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' AND D.ACCTNM3 &lt;&gt; '복리후생비(인건비성)' THEN 'TYPE_D'
                                      --2018.01.16 김명섭 [SR201801_06318] 경비금액 내 내부원가 계정(98001510) 반영
                                      --WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002'  THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002' OR A.ACCT_CD = '98001510'  THEN 'TYPE_D'
                                      
                                   --   WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42202'  THEN 'TYPE_E'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42101'  THEN 'TYPE_F'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42201'  THEN 'TYPE_G'
                                  ELSE 'ETC'
                                   END
                               ) ACCT_TYPE
                              ,A.ACCT_CD
                                ,( CASE WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '01' THEN A.MM_AMT_01  -- 조회 월
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '02' THEN A.MM_AMT_02
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '03' THEN A.MM_AMT_03
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '04' THEN A.MM_AMT_04
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '05' THEN A.MM_AMT_05
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '06' THEN A.MM_AMT_06
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '07' THEN A.MM_AMT_07
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '08' THEN A.MM_AMT_08
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '09' THEN A.MM_AMT_09
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '10' THEN A.MM_AMT_10
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '11' THEN A.MM_AMT_11
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '12' THEN A.MM_AMT_12
                                 ELSE 0
                                 END
                               ) P_MM_AMT -- 계획, 전년실적
                               ,( CASE WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '01' THEN A.MM_AMT_01  -- 조회 월
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '02' THEN A.MM_AMT_02
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '03' THEN A.MM_AMT_03
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '04' THEN A.MM_AMT_04
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '05' THEN A.MM_AMT_05
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '06' THEN A.MM_AMT_06
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '07' THEN A.MM_AMT_07
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '08' THEN A.MM_AMT_08
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '09' THEN A.MM_AMT_09
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '10' THEN A.MM_AMT_10
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '11' THEN A.MM_AMT_11
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '12' THEN A.MM_AMT_12
                                 ELSE 0
                                 END
                               ) R_MM_AMT -- 조회월 실적
                          FROM MAP_UPJANG_PL A -- SAP 실적
							                --2018.04.25 김명섭 사업계획관리 개선: 동일CC 데이터중복 개선
                              --,MAC_UPJANG_V V
                              ,(SELECT DISTINCT NVL(T2.ATTR01,T1.UPJANG) AS UPJANG, NVL(T2.CODE_NAME,T1.UPJANGNM) AS UPJANGNM,
                                       MU_CD,MU_NAME,SC_CD,SC_NAME,TM_CD,TM_NAME,PT_CD,PT_NAME,CC_CD,CC_NAME,OPEN_YY
                                  FROM MAC_UPJANG_V T1
                                LEFT OUTER JOIN SCC_COMMON_CODE T2
                                  ON T2.CODE = T1.CC_CD
                                 AND T2.GROUP_CODE = 'MAG20001S') V
                              --추가  
                              , MAS_ST_ACCOUNT D
                         WHERE 1 = 1
                           --2019.02.07 김명섭 팀/본부 조회 시 판관CC 제외
                           <isNull col="UPJANG">
                           --AND A.CC_CD NOT IN (SELECT CC_CD FROM SCC_CC WHERE CST_PLNKGVRN_CLASS_CD = 'SG')
                           </isNull>
                           AND A.CC_CD = V.CC_CD(+)
                           AND A.PL_CLASS = 'KS'
                                
                           AND A.FISCAL_YEAR IN (SUBSTR(#YYMM#, 1, 4), TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY')) -- 입력 년
                           <isNotNull col="MU_CD">
                           AND V.MU_CD = #MU_CD#
                           </isNotNull>
		                            <isNotNull col="TM_CD">
		                                <isNotEqual col="HOMEPLUS" value="1"> 
		                                AND V.TM_CD LIKE #TM_CD# || '%'
		                                </isNotEqual>
		                            </isNotNull>
		                            <isNotNull col="UPJANG">
		                                <isNotEqual col="HOMEPLUS" value="1"> 
		                                AND V.UPJANG = #UPJANG#
		                                </isNotEqual>
		                                <isEqual col="HOMEPLUS" value="1"> 
 									     AND V.UPJANG    IN  (SELECT Z.CODE FROM SCC_COMMON_CODE Z WHERE Z.GROUP_CODE = 'UPJANG_GROUP' AND Z.USE_YN = 'Y' AND SET1 = #UPJANG#  )
 									    </isEqual>
		                            </isNotNull>
		                                                             --추가                           
                           AND  A.ACCT_CD = D.ACCTCD
                       ) A
                                                 
                 GROUP BY TM_CD, TM_NM, UPJANG, UPJANGNM, NEW_GUBUN_NAME, CC_CD, ACCT_TYPE
                  
                 --ORDER BY CC_CD, ACCT_TYPE
         )
         GROUP BY TM_CD, TM_NM, UPJANG, UPJANGNM, NEW_GUBUN_NAME
       ) T1
 WHERE UPJANG NOT IN (SELECT TO_NUMBER(CODE) FROM SCC_COMMON_CODE WHERE GROUP_CODE = 'MA0048' AND USE_YN = 'Y')        
   --2019.12.13 김명섭 블로킹대상자 조회 제외 업장 체크
   AND NOT EXISTS (SELECT 'x'
                     FROM SCC_COMMON_CODE CCODE1, SCC_COMMON_CODE CCODE2
                    WHERE CCODE1.GROUP_CODE = 'EXLDOWN_BLOCKING'
                      AND CCODE1.CODE = #UUSER#
                      AND CCODE1.USE_YN = 'Y'
                      AND CCODE2.GROUP_CODE = 'UPJANG_BLOCKING'
                      AND CCODE2.CODE = T1.UPJANG
                      AND CCODE2.USE_YN = 'Y')
 ORDER BY NEW_GUBUN_NAME DESC, TM_NM, UPJANG_NAME
</isEqual>
<isEqual col="DATA_CLASS" value="M"> 
/* 재무-실적-전월 */
 SELECT DISTINCT TM_CD
      ,TM_NM TM_NAME
      --2018.07.27 김명섭 CC코드 중복 방지
      --,UPJANG
      ,UPJANGNM UPJANG_NAME
      --2019.02.14 김명섭 업장명 신규계획일 경우 신규로 구분
      --,DECODE(NEW_GUBUN_NAME, '신규', 'N', 'O') NEW_GUBUN
      --,NEW_GUBUN_NAME
      ,(CASE WHEN UPJANGNM LIKE '%신규계획%' THEN 'N' ELSE DECODE(NEW_GUBUN_NAME, '신규', 'N', 'O') END) AS NEW_GUBUN
      ,(CASE WHEN UPJANGNM LIKE '%신규계획%' THEN '신규' ELSE NEW_GUBUN_NAME END) AS NEW_GUBUN_NAME
      ,CC_CD
      ,P_TYPE_A AS SIMU_SALE_AMT  -- 계획 매출액
      --재료비, 노무비, 경비 추가  요청자 : 유영진   20160318  처리자 :맹수영
      ,P_TYPE_B AS SIMU_COST_AMT  -- 계획 재료비
      ,P_TYPE_C AS SIMU_LABOR_AMT  -- 계획 노무비
      ,P_TYPE_D AS SIMU_EXP_AMT  -- 계획 경비
      ,(P_TYPE_A - (P_TYPE_B + P_TYPE_C + P_TYPE_D)) AS SIMU_SALE_PROFIT -- 계획 매출이익
      ,R_TYPE_A AS SALE_AMT -- 실적 매출액
      ,ROUND(R_TYPE_B) AS COST_AMT -- 실적 재료비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_B/R_TYPE_A*100),1) AS COST_RATE -- 실적 매출 비율
      ,R_TYPE_C AS LABOR_AMT -- 실적 노무비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_C/R_TYPE_A*100),1) AS LABOR_RATE -- 실적 노무비 비율
      ,R_TYPE_D AS EXP_AMT -- 실적 경비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_D/R_TYPE_A*100),1) AS EXP_RATE -- 실적 경비비율
      ,ROUND((R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))) AS SALE_PROFIT -- 실적 매출이익
      ,ROUND(DECODE(R_TYPE_A,0,0,(R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))/R_TYPE_A*100),1) AS SALE_PROFIT_RATE -- 매출이익 비율
      ,ROUND(DECODE(P_TYPE_A,0,0,R_TYPE_A/P_TYPE_A*100),1) AS SIMU_SALE_DIFF_RATE -- 실적 매출액(%)
      ,((P_TYPE_A - (P_TYPE_B + P_TYPE_C + P_TYPE_D)) - (R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))) AS SIMU_PROFIT_DIFF_AMT -- 매출 이익
      ,(SELECT CST_PLNKGVRN_CLASS_CD FROM SCC_CC WHERE CC_CD = T1.CC_CD) AS CC_GB
  FROM (
        SELECT TM_CD
              ,TM_NM
              ,UPJANG
              ,UPJANGNM
              ,NEW_GUBUN_NAME              
              ,MAX(DECODE(CC_CD, NULL, CC_CD, CC_CD)) CC_CD
              --MAX를 모두 sum으로 변경  20160519
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_A', P_MM_AMT, 0)) P_TYPE_A -- 계획 매출액
             -- ,MAX(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0)) P_TYPE_B -- 계획 재료비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_C', P_MM_AMT, 0)) P_TYPE_C -- 계획 노무비 
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_D', P_MM_AMT, 0)) P_TYPE_D -- 계획 경비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_A', R_MM_AMT, 0)) R_TYPE_A -- 실적 매출액
               
              --,MAX(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0)) P_TYPE_B -- 계획 재료비
             ,SUM(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0)) +SUM(DECODE(ACCT_TYPE, 'TYPE_E', P_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_F', P_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_G', P_MM_AMT, 0)  ) P_TYPE_B
            --  ,MAX(DECODE(ACCT_TYPE, 'TYPE_B', R_MM_AMT, 0)) R_TYPE_B -- 재무실적 재료비
            ,SUM(DECODE(ACCT_TYPE, 'TYPE_B', R_MM_AMT, 0)) +SUM(DECODE(ACCT_TYPE, 'TYPE_E', R_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_F', R_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_G', R_MM_AMT, 0)  ) R_TYPE_B
     
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_C', R_MM_AMT, 0)) R_TYPE_C -- 실적 노무비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_D', R_MM_AMT, 0)) R_TYPE_D -- 실적 경비
          FROM (
                 SELECT TM_CD
                       ,TM_NM
                       ,UPJANG
                       ,UPJANGNM
                       ,NEW_GUBUN_NAME
                       ,CC_CD
                       ,ACCT_TYPE
                       ,ROUND(SUM(P_MM_AMT) / 1000) AS P_MM_AMT
                       ,ROUND(SUM(R_MM_AMT) / 1000) AS R_MM_AMT
                      ,( SELECT  CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_MARGIN_RATE_01
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_MARGIN_RATE_02
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_MARGIN_RATE_03
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_MARGIN_RATE_04
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_MARGIN_RATE_05
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_MARGIN_RATE_06
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_MARGIN_RATE_07
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_MARGIN_RATE_08
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_MARGIN_RATE_09
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_MARGIN_RATE_10
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_MARGIN_RATE_11
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_MARGIN_RATE_12
                                 ELSE 0
                                 END
                            FROM MAP_MARGIN_RATE_MGMT
                           WHERE UPJANG = A.UPJANG
                             AND YY = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY')
                             AND CLASS = 'R'
                       ) R_MM_MR
                      ,( SELECT  CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_MARGIN_RATE_01
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_MARGIN_RATE_02
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_MARGIN_RATE_03
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_MARGIN_RATE_04
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_MARGIN_RATE_05
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_MARGIN_RATE_06
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_MARGIN_RATE_07
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_MARGIN_RATE_08
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_MARGIN_RATE_09
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_MARGIN_RATE_10
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_MARGIN_RATE_11
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_MARGIN_RATE_12
                                 ELSE 0
                                 END
                            FROM MAP_MARGIN_RATE_MGMT
                           WHERE UPJANG = A.UPJANG
                             AND YY = SUBSTR(#YYMM#, 1, 4)
                             AND CLASS = 'R'
                       ) R_MM_MR_2
                   FROM (
                        SELECT V.TM_CD
                              ,V.TM_NAME AS TM_NM
                              ,V.UPJANG
                              ,A.CC_NM AS UPJANGNM
                              ,(CASE WHEN V.OPEN_YY = SUBSTRB(#YYMM#,1,4) THEN '신규' -- OPEN_YY가 현재년과 같으면 신규.
                                ELSE '기존'
                                 END    
                               ) AS NEW_GUBUN_NAME
                              ,A.CC_CD
                              ,( CASE WHEN SUBSTR(A.ACCT_CD, 1, 2) = '41'  THEN 'TYPE_A'
                                      WHEN A.ACCT_CD = '98001010'  THEN 'TYPE_A'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42203'  THEN 'TYPE_B'
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진
                                   --   WHEN D.ACCTNM2  = '재료비'  THEN 'TYPE_B'
                                      
                                      
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '431' THEN 'TYPE_C'
                                      
                                      
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진                                      
                                      WHEN D.ACCTNM3 = '복리후생비(인건비성)' THEN 'TYPE_C' 
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' AND D.ACCTNM3 &lt;&gt; '복리후생비(인건비성)' THEN 'TYPE_D'
                                      --2018.01.16 김명섭 [SR201801_06318] 경비금액 내 내부원가 계정(98001510) 반영
                                      --WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002'  THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002' OR A.ACCT_CD = '98001510'  THEN 'TYPE_D'
                                      
                                   --   WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42202'  THEN 'TYPE_E'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42101'  THEN 'TYPE_F'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42201'  THEN 'TYPE_G'
                                  ELSE 'ETC'
                                   END
                               ) ACCT_TYPE
                              ,A.ACCT_CD
                               ,( CASE WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '01' THEN A.MM_AMT_01  -- 조회 월
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '02' THEN A.MM_AMT_02
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '03' THEN A.MM_AMT_03
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '04' THEN A.MM_AMT_04
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '05' THEN A.MM_AMT_05
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '06' THEN A.MM_AMT_06
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '07' THEN A.MM_AMT_07
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '08' THEN A.MM_AMT_08
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '09' THEN A.MM_AMT_09
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '10' THEN A.MM_AMT_10
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '11' THEN A.MM_AMT_11
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '12' THEN A.MM_AMT_12
                                 ELSE 0
                                 END
                               ) P_MM_AMT -- 조회월 실적
                               ,( CASE WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '01' THEN A.MM_AMT_01  -- 조회 월
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '02' THEN A.MM_AMT_02
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '03' THEN A.MM_AMT_03
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '04' THEN A.MM_AMT_04
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '05' THEN A.MM_AMT_05
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '06' THEN A.MM_AMT_06
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '07' THEN A.MM_AMT_07
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '08' THEN A.MM_AMT_08
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '09' THEN A.MM_AMT_09
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '10' THEN A.MM_AMT_10
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '11' THEN A.MM_AMT_11
                                      WHEN FISCAL_YEAR = SUBSTR(#YYMM#, 1, 4) AND SUBSTR(#YYMM#, 5, 2) = '12' THEN A.MM_AMT_12
                                 ELSE 0
                                 END
                               ) R_MM_AMT -- 조회월 실적
                          FROM MAP_UPJANG_PL A -- SAP 실적
							                --2018.04.25 김명섭 사업계획관리 개선: 동일CC 데이터중복 개선
                              --,MAC_UPJANG_V V
                              ,(SELECT DISTINCT NVL(T2.ATTR01,T1.UPJANG) AS UPJANG, NVL(T2.CODE_NAME,T1.UPJANGNM) AS UPJANGNM,
                                       MU_CD,MU_NAME,SC_CD,SC_NAME,TM_CD,TM_NAME,PT_CD,PT_NAME,CC_CD,CC_NAME,OPEN_YY
                                  FROM MAC_UPJANG_V T1
                                LEFT OUTER JOIN SCC_COMMON_CODE T2
                                  ON T2.CODE = T1.CC_CD
                                 AND T2.GROUP_CODE = 'MAG20001S') V
                              --추가  
                              , MAS_ST_ACCOUNT D
                         WHERE 1 = 1
                           --2019.02.07 김명섭 팀/본부 조회 시 판관CC 제외
                           <isNull col="UPJANG">
                           --AND A.CC_CD NOT IN (SELECT CC_CD FROM SCC_CC WHERE CST_PLNKGVRN_CLASS_CD = 'SG')
                           </isNull>
                           AND A.CC_CD = V.CC_CD(+)
                           AND A.PL_CLASS = 'KS'
                                
                           AND A.FISCAL_YEAR IN (SUBSTR(#YYMM#, 1, 4), TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY')) -- 입력 년
                           <isNotNull col="MU_CD">
                           AND V.MU_CD = #MU_CD#
                           </isNotNull>
		                            <isNotNull col="TM_CD">
		                                <isNotEqual col="HOMEPLUS" value="1"> 
		                                AND V.TM_CD LIKE #TM_CD# || '%'
		                                </isNotEqual>
		                            </isNotNull>
		                            <isNotNull col="UPJANG">
		                                <isNotEqual col="HOMEPLUS" value="1"> 
		                                AND V.UPJANG = #UPJANG#
		                                </isNotEqual>
		                                <isEqual col="HOMEPLUS" value="1"> 
 									     AND V.UPJANG    IN  (SELECT Z.CODE FROM SCC_COMMON_CODE Z WHERE Z.GROUP_CODE = 'UPJANG_GROUP' AND Z.USE_YN = 'Y' AND SET1 = #UPJANG#  )
 									    </isEqual>
		                            </isNotNull>
		                                                             --추가                           
                           AND  A.ACCT_CD = D.ACCTCD
                       ) A
                                                 
                 GROUP BY TM_CD, TM_NM, UPJANG, UPJANGNM, NEW_GUBUN_NAME, CC_CD, ACCT_TYPE
                  
                 --ORDER BY CC_CD, ACCT_TYPE
         )
         GROUP BY TM_CD, TM_NM, UPJANG, UPJANGNM, NEW_GUBUN_NAME
       ) T1
 WHERE UPJANG NOT IN (SELECT TO_NUMBER(CODE) FROM SCC_COMMON_CODE WHERE GROUP_CODE = 'MA0048' AND USE_YN = 'Y')        
   --2019.12.13 김명섭 블로킹대상자 조회 제외 업장 체크
   AND NOT EXISTS (SELECT 'x'
                     FROM SCC_COMMON_CODE CCODE1, SCC_COMMON_CODE CCODE2
                    WHERE CCODE1.GROUP_CODE = 'EXLDOWN_BLOCKING'
                      AND CCODE1.CODE = #UUSER#
                      AND CCODE1.USE_YN = 'Y'
                      AND CCODE2.GROUP_CODE = 'UPJANG_BLOCKING'
                      AND CCODE2.CODE = T1.UPJANG
                      AND CCODE2.USE_YN = 'Y')
 ORDER BY NEW_GUBUN_NAME DESC, TM_NM, UPJANG_NAME
</isEqual>
</isEqual>
</isEqual>

<isEqual col="CLOSE_TYPE" value="C05D">
<isEqual col="SALE_TYPE" value="E">
<isEqual col="DATA_CLASS" value="P"> 
/* 관리-추정-계획 */
 SELECT DISTINCT TM_CD
      ,TM_NM TM_NAME
      --2018.07.27 김명섭 CC코드 중복 방지
      --,UPJANG
      ,UPJANGNM UPJANG_NAME
      --2019.02.14 김명섭 업장명 신규계획일 경우 신규로 구분
      --,DECODE(NEW_GUBUN_NAME, '신규', 'N', 'O') NEW_GUBUN
      --,NEW_GUBUN_NAME
      ,(CASE WHEN UPJANGNM LIKE '%신규계획%' THEN 'N' ELSE DECODE(NEW_GUBUN_NAME, '신규', 'N', 'O') END) AS NEW_GUBUN
      ,(CASE WHEN UPJANGNM LIKE '%신규계획%' THEN '신규' ELSE NEW_GUBUN_NAME END) AS NEW_GUBUN_NAME
      ,CC_CD
      ,P_TYPE_A AS SIMU_SALE_AMT  -- 계획 매출액
      --재료비, 노무비, 경비 추가  요청자 : 유영진   20160318  처리자 :맹수영
      ,P_TYPE_B AS SIMU_COST_AMT  -- 계획 재료비
      ,P_TYPE_C AS SIMU_LABOR_AMT  -- 계획 노무비
      ,P_TYPE_D AS SIMU_EXP_AMT  -- 계획 경비
      ,(P_TYPE_A - (P_TYPE_B + P_TYPE_C + P_TYPE_D)) AS SIMU_SALE_PROFIT -- 계획 매출이익
      ,R_TYPE_A AS SALE_AMT -- 실적 매출액
      ,ROUND(R_TYPE_B) AS COST_AMT -- 실적 재료비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_B/R_TYPE_A*100),1) AS COST_RATE -- 실적 매출 비율
      ,R_TYPE_C AS LABOR_AMT -- 실적 노무비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_C/R_TYPE_A*100),1) AS LABOR_RATE -- 실적 노무비 비율
      ,R_TYPE_D AS EXP_AMT -- 실적 경비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_D/R_TYPE_A*100),1) AS EXP_RATE -- 실적 경비비율
      ,ROUND((R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))) AS SALE_PROFIT -- 실적 매출이익
      ,ROUND(DECODE(R_TYPE_A,0,0,(R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))/R_TYPE_A*100),1) AS SALE_PROFIT_RATE -- 매출이익 비율
      ,ROUND(DECODE(P_TYPE_A,0,0,R_TYPE_A/P_TYPE_A*100),1) AS SIMU_SALE_DIFF_RATE -- 실적 매출액(%)
      ,((P_TYPE_A - (P_TYPE_B + P_TYPE_C + P_TYPE_D)) - (R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))) AS SIMU_PROFIT_DIFF_AMT -- 매출 이익
      ,(SELECT CST_PLNKGVRN_CLASS_CD FROM SCC_CC WHERE CC_CD = T1.CC_CD) AS CC_GB
  FROM (
        SELECT TM_CD
              ,TM_NM
              ,UPJANG
              ,UPJANGNM
              ,NEW_GUBUN_NAME              
              ,MAX(DECODE(CC_CD, NULL, CC_CD, CC_CD)) CC_CD
              --MAX를 모두 sum으로 변경  20160519
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_A', P_MM_AMT, 0)) P_TYPE_A -- 계획 매출액
             -- ,MAX(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0)) P_TYPE_B -- 계획 재료비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_C', P_MM_AMT, 0)) P_TYPE_C -- 계획 노무비 
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_D', P_MM_AMT, 0)) P_TYPE_D -- 계획 경비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_A', R_MM_AMT, 0)) R_TYPE_A -- 실적 매출액
       
             --,MAX(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0) * NVL(R_MM_MR, 100) / 100 ) P_TYPE_B -- 관리계획 재료비        
             ,SUM(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0) * NVL(R_MM_MR, 100) / 100 ) +SUM(DECODE(ACCT_TYPE, 'TYPE_E', P_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_F', P_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_G', P_MM_AMT, 0)  ) P_TYPE_B
             -- , MAX(DECODE(ACCT_TYPE, 'TYPE_B', R_MM_AMT, 0)  * NVL(R_MM_MR, 100) / 100 ) R_TYPE_B -- 관리실적 재료비
  
             , SUM(DECODE(ACCT_TYPE, 'TYPE_B', R_MM_AMT, 0)  * NVL(R_MM_MR, 100) / 100 ) +SUM(DECODE(ACCT_TYPE, 'TYPE_E', R_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_F', R_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_G', R_MM_AMT, 0)  )R_TYPE_B
     
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_C', R_MM_AMT, 0)) R_TYPE_C -- 실적 노무비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_D', R_MM_AMT, 0)) R_TYPE_D -- 실적 경비
          FROM (
                 SELECT TM_CD
                       ,TM_NM
                       ,UPJANG
                       ,UPJANGNM
                       ,NEW_GUBUN_NAME
                       ,CC_CD
                       ,ACCT_TYPE
                       ,ROUND(SUM(P_MM_AMT) / 1000) AS P_MM_AMT
                       ,ROUND(SUM(R_MM_AMT) / 1000) AS R_MM_AMT
                      ,( SELECT  CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_MARGIN_RATE_01
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_MARGIN_RATE_02
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_MARGIN_RATE_03
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_MARGIN_RATE_04
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_MARGIN_RATE_05
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_MARGIN_RATE_06
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_MARGIN_RATE_07
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_MARGIN_RATE_08
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_MARGIN_RATE_09
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_MARGIN_RATE_10
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_MARGIN_RATE_11
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_MARGIN_RATE_12
                                 ELSE 0
                                 END
                            FROM MAP_MARGIN_RATE_MGMT
                           WHERE UPJANG = A.UPJANG
                             AND YY = SUBSTR(#YYMM#, 1, 4)
                             AND CLASS = 'R'
                       ) R_MM_MR
                   FROM (
                        SELECT V.TM_CD
                              ,V.TM_NAME AS TM_NM
                              ,V.UPJANG
                              ,V.CC_NAME AS UPJANGNM
                              ,(CASE WHEN V.OPEN_YY = SUBSTRB(#YYMM#,1,4) THEN '신규' -- OPEN_YY가 현재년과 같으면 신규.
                                ELSE '기존'
                                 END    
                               ) AS NEW_GUBUN_NAME
                              ,A.CC_CD
                              ,( CASE WHEN SUBSTR(A.ACCT_CD, 1, 2) = '41'  THEN 'TYPE_A'
                                      WHEN A.ACCT_CD = '98001010'  THEN 'TYPE_A'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42203'  THEN 'TYPE_B'
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진
                                   --   WHEN D.ACCTNM2  = '재료비'  THEN 'TYPE_B'
                                      
                                      
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '431' THEN 'TYPE_C'
                                      
                                      
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진                                      
                                      WHEN D.ACCTNM3 = '복리후생비(인건비성)' THEN 'TYPE_C' 
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' AND D.ACCTNM3 &lt;&gt; '복리후생비(인건비성)' THEN 'TYPE_D'
                                      --2018.01.16 김명섭 [SR201801_06318] 경비금액 내 내부원가 계정(98001510) 반영
                                      --WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002'  THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002' OR A.ACCT_CD = '98001510'  THEN 'TYPE_D'
                                      
                                   --   WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42202'  THEN 'TYPE_E'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42101'  THEN 'TYPE_F'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42201'  THEN 'TYPE_G'
                                  ELSE 'ETC'
                                   END
                               ) ACCT_TYPE
                              ,A.ACCT_CD
                               ,0 P_MM_AMT
                               ,( CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_AMT_01  -- 조회 월
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_AMT_02
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_AMT_03
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_AMT_04
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_AMT_05
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_AMT_06
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_AMT_07
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_AMT_08
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_AMT_09
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_AMT_10
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_AMT_11
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_AMT_12
                                  ELSE 0
                                  END
                               ) R_MM_AMT -- 조회월 실적
                          FROM MAP_BPC_CONFIRM_PL_INFO A
							                --2018.04.25 김명섭 사업계획관리 개선: 동일CC 데이터중복 개선
                              --,MAC_UPJANG_V V
                              ,(SELECT DISTINCT NVL(T2.ATTR01,T1.UPJANG) AS UPJANG, NVL(T2.CODE_NAME,T1.UPJANGNM) AS UPJANGNM,
                                       MU_CD,MU_NAME,SC_CD,SC_NAME,TM_CD,TM_NAME,PT_CD,PT_NAME,CC_CD,CC_NAME,OPEN_YY
                                  FROM MAC_UPJANG_V T1
                                LEFT OUTER JOIN SCC_COMMON_CODE T2
                                  ON T2.CODE = T1.CC_CD
                                 AND T2.GROUP_CODE = 'MAG20001S') V
                              --추가  
                              , MAS_ST_ACCOUNT D
                         WHERE 1 = 1
                           --2019.02.07 김명섭 팀/본부 조회 시 판관CC 제외
                           <isNull col="UPJANG">
                           --AND A.CC_CD NOT IN (SELECT CC_CD FROM SCC_CC WHERE CST_PLNKGVRN_CLASS_CD = 'SG')
                           </isNull>
                           AND A.CC_CD = V.CC_CD(+)
                           AND A.PLAN_CLASS = 'MP'
                                
                           AND A.PLAN_YEAR = SUBSTR(#YYMM#, 1, 4) -- 입력 년
                           AND A.VER_CD= (SELECT MAX(VER_CD)
                                            FROM MAP_BPC_CONFIRM_PL_INFO
                                           WHERE PLAN_CLASS = A.PLAN_CLASS
                                             AND PLAN_YEAR = A.PLAN_YEAR
                                             AND CC_CD = A.CC_CD)
                           <isNotNull col="MU_CD">
                           AND V.MU_CD = #MU_CD#
                           </isNotNull>
                            <isNotNull col="TM_CD">
                                <isNotEqual col="HOMEPLUS" value="1"> 
                                AND V.TM_CD LIKE #TM_CD# || '%'
                                </isNotEqual>
                            </isNotNull>
                            <isNotNull col="UPJANG">
                                <isNotEqual col="HOMEPLUS" value="1"> 
                                AND V.UPJANG = #UPJANG#
                                </isNotEqual>
                                <isEqual col="HOMEPLUS" value="1"> 
  						                  AND V.UPJANG    IN  (SELECT Z.CODE FROM SCC_COMMON_CODE Z WHERE Z.GROUP_CODE = 'UPJANG_GROUP' AND Z.USE_YN = 'Y' AND SET1 = #UPJANG#  )
  						                  </isEqual>
                            </isNotNull>
		                                                             --추가                           
                           AND  A.ACCT_CD = D.ACCTCD
                           
                        UNION ALL
                        
                        SELECT V.TM_CD
                              ,V.TM_NAME AS TM_NM
                              ,V.UPJANG
                              ,V.CC_NAME AS UPJANGNM
                              ,(CASE WHEN V.OPEN_YY = SUBSTRB(#YYMM#,1,4) THEN '신규' -- OPEN_YY가 현재년과 같으면 신규.
                                ELSE '기존'
                                 END    
                               ) AS NEW_GUBUN_NAME
                              ,A.CC_CD
                              ,( CASE WHEN SUBSTR(A.ACCT_CD, 1, 2) = '41'  THEN 'TYPE_A'
                                      WHEN A.ACCT_CD = '98001010'  THEN 'TYPE_A'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42203'  THEN 'TYPE_B'
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진
                                   --   WHEN D.ACCTNM2  = '재료비'  THEN 'TYPE_B'
                                      
                                      
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '431' THEN 'TYPE_C'
                                      
                                      
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진                                      
                                      WHEN D.ACCTNM3 = '복리후생비(인건비성)' THEN 'TYPE_C' 
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' AND D.ACCTNM3 &lt;&gt; '복리후생비(인건비성)' THEN 'TYPE_D'
                                      --2018.01.16 김명섭 [SR201801_06318] 경비금액 내 내부원가 계정(98001510) 반영
                                      --WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002'  THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002' OR A.ACCT_CD = '98001510'  THEN 'TYPE_D'
                                      
                                   --   WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42202'  THEN 'TYPE_E'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42101'  THEN 'TYPE_F'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42201'  THEN 'TYPE_G'
                                  ELSE 'ETC'
                                   END
                               ) ACCT_TYPE
                              ,A.ACCT_CD
                               ,( CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_AMT_01  -- 조회 월
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_AMT_02
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_AMT_03
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_AMT_04
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_AMT_05
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_AMT_06
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_AMT_07
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_AMT_08
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_AMT_09
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_AMT_10
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_AMT_11
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_AMT_12
                                  ELSE 0
                                  END
                               ) P_MM_AMT
                               ,0 R_MM_AMT -- 조회월 실적
                          FROM MAP_BPC_CONFIRM_PL_INFO A
							                --2018.04.25 김명섭 사업계획관리 개선: 동일CC 데이터중복 개선
                              --,MAC_UPJANG_V V
                              ,(SELECT DISTINCT NVL(T2.ATTR01,T1.UPJANG) AS UPJANG, NVL(T2.CODE_NAME,T1.UPJANGNM) AS UPJANGNM,
                                       MU_CD,MU_NAME,SC_CD,SC_NAME,TM_CD,TM_NAME,PT_CD,PT_NAME,CC_CD,CC_NAME,OPEN_YY
                                  FROM MAC_UPJANG_V T1
                                LEFT OUTER JOIN SCC_COMMON_CODE T2
                                  ON T2.CODE = T1.CC_CD
                                 AND T2.GROUP_CODE = 'MAG20001S') V
                              --추가  
                              , MAS_ST_ACCOUNT D
                         WHERE 1 = 1
                           --2019.02.07 김명섭 팀/본부 조회 시 판관CC 제외
                           <isNull col="UPJANG">
                           --AND A.CC_CD NOT IN (SELECT CC_CD FROM SCC_CC WHERE CST_PLNKGVRN_CLASS_CD = 'SG')
                           </isNull>
                           AND A.CC_CD = V.CC_CD(+)
                           AND A.PLAN_CLASS = 'AP'
                                
                           AND A.PLAN_YEAR = SUBSTR(#YYMM#, 1, 4) -- 입력 년
                           AND A.VER_CD= (SELECT MAX(VER_CD)
                                            FROM MAP_BPC_CONFIRM_PL_INFO
                                           WHERE PLAN_CLASS = A.PLAN_CLASS
                                             AND PLAN_YEAR = A.PLAN_YEAR
                                             AND CC_CD = A.CC_CD)
                           <isNotNull col="MU_CD">
                           AND V.MU_CD = #MU_CD#
                           </isNotNull>
                            <isNotNull col="TM_CD">
                                <isNotEqual col="HOMEPLUS" value="1"> 
                                AND V.TM_CD LIKE #TM_CD# || '%'
                                </isNotEqual>
                            </isNotNull>
                            <isNotNull col="UPJANG">
                                <isNotEqual col="HOMEPLUS" value="1"> 
                                AND V.UPJANG = #UPJANG#
                                </isNotEqual>
                                <isEqual col="HOMEPLUS" value="1"> 
  						                  AND V.UPJANG    IN  (SELECT Z.CODE FROM SCC_COMMON_CODE Z WHERE Z.GROUP_CODE = 'UPJANG_GROUP' AND Z.USE_YN = 'Y' AND SET1 = #UPJANG#  )
  						                  </isEqual>
                            </isNotNull>
		                                                             --추가                           
                           AND  A.ACCT_CD = D.ACCTCD
                        
                       ) A
                                                 
                 GROUP BY TM_CD, TM_NM, UPJANG, UPJANGNM, NEW_GUBUN_NAME, CC_CD, ACCT_TYPE
                  
                 --ORDER BY CC_CD, ACCT_TYPE
         )
         GROUP BY TM_CD, TM_NM, UPJANG, UPJANGNM, NEW_GUBUN_NAME
       ) T1
 WHERE UPJANG NOT IN (SELECT TO_NUMBER(CODE) FROM SCC_COMMON_CODE WHERE GROUP_CODE = 'MA0048' AND USE_YN = 'Y')        
   --2019.12.13 김명섭 블로킹대상자 조회 제외 업장 체크
   AND NOT EXISTS (SELECT 'x'
                     FROM SCC_COMMON_CODE CCODE1, SCC_COMMON_CODE CCODE2
                    WHERE CCODE1.GROUP_CODE = 'EXLDOWN_BLOCKING'
                      AND CCODE1.CODE = #UUSER#
                      AND CCODE1.USE_YN = 'Y'
                      AND CCODE2.GROUP_CODE = 'UPJANG_BLOCKING'
                      AND CCODE2.CODE = T1.UPJANG
                      AND CCODE2.USE_YN = 'Y')
 ORDER BY NEW_GUBUN_NAME DESC, TM_NM, UPJANG_NAME
</isEqual>
<isEqual col="DATA_CLASS" value="E"> 
/* 관리-추정-추정 */
 SELECT DISTINCT TM_CD
      ,TM_NM TM_NAME
      --2018.07.27 김명섭 CC코드 중복 방지
      --,UPJANG
      ,UPJANGNM UPJANG_NAME
      --2019.02.14 김명섭 업장명 신규계획일 경우 신규로 구분
      --,DECODE(NEW_GUBUN_NAME, '신규', 'N', 'O') NEW_GUBUN
      --,NEW_GUBUN_NAME
      ,(CASE WHEN UPJANGNM LIKE '%신규계획%' THEN 'N' ELSE DECODE(NEW_GUBUN_NAME, '신규', 'N', 'O') END) AS NEW_GUBUN
      ,(CASE WHEN UPJANGNM LIKE '%신규계획%' THEN '신규' ELSE NEW_GUBUN_NAME END) AS NEW_GUBUN_NAME
      ,CC_CD
      ,P_TYPE_A AS SIMU_SALE_AMT  -- 계획 매출액
      --재료비, 노무비, 경비 추가  요청자 : 유영진   20160318  처리자 :맹수영
      ,P_TYPE_B AS SIMU_COST_AMT  -- 계획 재료비
      ,P_TYPE_C AS SIMU_LABOR_AMT  -- 계획 노무비
      ,P_TYPE_D AS SIMU_EXP_AMT  -- 계획 경비
      ,(P_TYPE_A - (P_TYPE_B + P_TYPE_C + P_TYPE_D)) AS SIMU_SALE_PROFIT -- 계획 매출이익
      ,R_TYPE_A AS SALE_AMT -- 실적 매출액
      ,ROUND(R_TYPE_B) AS COST_AMT -- 실적 재료비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_B/R_TYPE_A*100),1) AS COST_RATE -- 실적 매출 비율
      ,R_TYPE_C AS LABOR_AMT -- 실적 노무비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_C/R_TYPE_A*100),1) AS LABOR_RATE -- 실적 노무비 비율
      ,R_TYPE_D AS EXP_AMT -- 실적 경비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_D/R_TYPE_A*100),1) AS EXP_RATE -- 실적 경비비율
      ,ROUND((R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))) AS SALE_PROFIT -- 실적 매출이익
      ,ROUND(DECODE(R_TYPE_A,0,0,(R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))/R_TYPE_A*100),1) AS SALE_PROFIT_RATE -- 매출이익 비율
      ,ROUND(DECODE(P_TYPE_A,0,0,R_TYPE_A/P_TYPE_A*100),1) AS SIMU_SALE_DIFF_RATE -- 실적 매출액(%)
      ,((P_TYPE_A - (P_TYPE_B + P_TYPE_C + P_TYPE_D)) - (R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))) AS SIMU_PROFIT_DIFF_AMT -- 매출 이익
      ,(SELECT CST_PLNKGVRN_CLASS_CD FROM SCC_CC WHERE CC_CD = T1.CC_CD) AS CC_GB
  FROM (
        SELECT TM_CD
              ,TM_NM
              ,UPJANG
              ,UPJANGNM
              ,NEW_GUBUN_NAME              
              ,MAX(DECODE(CC_CD, NULL, CC_CD, CC_CD)) CC_CD
              --MAX를 모두 sum으로 변경  20160519
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_A', P_MM_AMT, 0)) P_TYPE_A -- 계획 매출액
             -- ,MAX(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0)) P_TYPE_B -- 계획 재료비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_C', P_MM_AMT, 0)) P_TYPE_C -- 계획 노무비 
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_D', P_MM_AMT, 0)) P_TYPE_D -- 계획 경비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_A', R_MM_AMT, 0)) R_TYPE_A -- 실적 매출액
       
             --,MAX(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0) * NVL(R_MM_MR, 100) / 100 ) P_TYPE_B -- 관리계획 재료비        
             ,SUM(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0) * NVL(R_MM_MR, 100) / 100 ) +SUM(DECODE(ACCT_TYPE, 'TYPE_E', P_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_F', P_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_G', P_MM_AMT, 0)  ) P_TYPE_B
             -- , MAX(DECODE(ACCT_TYPE, 'TYPE_B', R_MM_AMT, 0)  * NVL(R_MM_MR, 100) / 100 ) R_TYPE_B -- 관리실적 재료비
  
             , SUM(DECODE(ACCT_TYPE, 'TYPE_B', R_MM_AMT, 0)  * NVL(R_MM_MR, 100) / 100 ) +SUM(DECODE(ACCT_TYPE, 'TYPE_E', R_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_F', R_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_G', R_MM_AMT, 0)  )R_TYPE_B
     
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_C', R_MM_AMT, 0)) R_TYPE_C -- 실적 노무비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_D', R_MM_AMT, 0)) R_TYPE_D -- 실적 경비
          FROM (
                 SELECT TM_CD
                       ,TM_NM
                       ,UPJANG
                       ,UPJANGNM
                       ,NEW_GUBUN_NAME
                       ,CC_CD
                       ,ACCT_TYPE
                       ,ROUND(SUM(P_MM_AMT) / 1000) AS P_MM_AMT
                       ,ROUND(SUM(R_MM_AMT) / 1000) AS R_MM_AMT
                      ,( SELECT  CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_MARGIN_RATE_01
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_MARGIN_RATE_02
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_MARGIN_RATE_03
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_MARGIN_RATE_04
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_MARGIN_RATE_05
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_MARGIN_RATE_06
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_MARGIN_RATE_07
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_MARGIN_RATE_08
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_MARGIN_RATE_09
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_MARGIN_RATE_10
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_MARGIN_RATE_11
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_MARGIN_RATE_12
                                 ELSE 0
                                 END
                            FROM MAP_MARGIN_RATE_MGMT
                           WHERE UPJANG = A.UPJANG
                             AND YY = SUBSTR(#YYMM#, 1, 4)
                             AND CLASS = 'R'
                       ) R_MM_MR
                   FROM (
                        SELECT V.TM_CD
                              ,V.TM_NAME AS TM_NM
                              ,V.UPJANG
                              ,V.CC_NAME AS UPJANGNM
                              ,(CASE WHEN V.OPEN_YY = SUBSTRB(#YYMM#,1,4) THEN '신규' -- OPEN_YY가 현재년과 같으면 신규.
                                ELSE '기존'
                                 END    
                               ) AS NEW_GUBUN_NAME
                              ,A.CC_CD
                              ,( CASE WHEN SUBSTR(A.ACCT_CD, 1, 2) = '41'  THEN 'TYPE_A'
                                      WHEN A.ACCT_CD = '98001010'  THEN 'TYPE_A'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42203'  THEN 'TYPE_B'
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진
                                   --   WHEN D.ACCTNM2  = '재료비'  THEN 'TYPE_B'
                                      
                                      
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '431' THEN 'TYPE_C'
                                      
                                      
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진                                      
                                      WHEN D.ACCTNM3 = '복리후생비(인건비성)' THEN 'TYPE_C' 
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' AND D.ACCTNM3 &lt;&gt; '복리후생비(인건비성)' THEN 'TYPE_D'
                                      --2018.01.16 김명섭 [SR201801_06318] 경비금액 내 내부원가 계정(98001510) 반영
                                      --WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002'  THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002' OR A.ACCT_CD = '98001510'  THEN 'TYPE_D'
                                      
                                   --   WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42202'  THEN 'TYPE_E'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42101'  THEN 'TYPE_F'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42201'  THEN 'TYPE_G'
                                  ELSE 'ETC'
                                   END
                               ) ACCT_TYPE
                              ,A.ACCT_CD
                               ,( CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_AMT_01  -- 조회 월
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_AMT_02
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_AMT_03
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_AMT_04
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_AMT_05
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_AMT_06
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_AMT_07
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_AMT_08
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_AMT_09
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_AMT_10
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_AMT_11
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_AMT_12
                                  ELSE 0
                                  END
                               ) P_MM_AMT
                               ,( CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_AMT_01  -- 조회 월
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_AMT_02
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_AMT_03
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_AMT_04
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_AMT_05
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_AMT_06
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_AMT_07
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_AMT_08
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_AMT_09
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_AMT_10
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_AMT_11
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_AMT_12
                                  ELSE 0
                                  END
                               ) R_MM_AMT -- 조회월 실적
                          FROM MAP_BPC_CONFIRM_PL_INFO A
							                --2018.04.25 김명섭 사업계획관리 개선: 동일CC 데이터중복 개선
                              --,MAC_UPJANG_V V
                              ,(SELECT DISTINCT NVL(T2.ATTR01,T1.UPJANG) AS UPJANG, NVL(T2.CODE_NAME,T1.UPJANGNM) AS UPJANGNM,
                                       MU_CD,MU_NAME,SC_CD,SC_NAME,TM_CD,TM_NAME,PT_CD,PT_NAME,CC_CD,CC_NAME,OPEN_YY
                                  FROM MAC_UPJANG_V T1
                                LEFT OUTER JOIN SCC_COMMON_CODE T2
                                  ON T2.CODE = T1.CC_CD
                                 AND T2.GROUP_CODE = 'MAG20001S') V
                              --추가  
                              , MAS_ST_ACCOUNT D
                         WHERE 1 = 1
                           --2019.02.07 김명섭 팀/본부 조회 시 판관CC 제외
                           <isNull col="UPJANG">
                           --AND A.CC_CD NOT IN (SELECT CC_CD FROM SCC_CC WHERE CST_PLNKGVRN_CLASS_CD = 'SG')
                           </isNull>
                           AND A.CC_CD = V.CC_CD(+)
                           AND A.PLAN_CLASS = 'MP'
                                
                           AND A.PLAN_YEAR = SUBSTR(#YYMM#, 1, 4) -- 입력 년
                           AND A.VER_CD= (SELECT MAX(VER_CD)
                                            FROM MAP_BPC_CONFIRM_PL_INFO
                                           WHERE PLAN_CLASS = A.PLAN_CLASS
                                             AND PLAN_YEAR = A.PLAN_YEAR
                                             AND CC_CD = A.CC_CD)
                           <isNotNull col="MU_CD">
                           AND V.MU_CD = #MU_CD#
                           </isNotNull>
		                            <isNotNull col="TM_CD">
		                                <isNotEqual col="HOMEPLUS" value="1"> 
		                                AND V.TM_CD LIKE #TM_CD# || '%'
		                                </isNotEqual>
		                            </isNotNull>
		                            <isNotNull col="UPJANG">
		                                <isNotEqual col="HOMEPLUS" value="1"> 
		                                AND V.UPJANG = #UPJANG#
		                                </isNotEqual>
		                                <isEqual col="HOMEPLUS" value="1"> 
 									                  AND V.UPJANG    IN  (SELECT Z.CODE FROM SCC_COMMON_CODE Z WHERE Z.GROUP_CODE = 'UPJANG_GROUP' AND Z.USE_YN = 'Y' AND SET1 = #UPJANG#  )
 									                  </isEqual>
		                            </isNotNull>
		                                                             --추가                           
                           AND  A.ACCT_CD = D.ACCTCD
                       ) A
                                                 
                 GROUP BY TM_CD, TM_NM, UPJANG, UPJANGNM, NEW_GUBUN_NAME, CC_CD, ACCT_TYPE
                  
                 --ORDER BY CC_CD, ACCT_TYPE
         )
         GROUP BY TM_CD, TM_NM, UPJANG, UPJANGNM, NEW_GUBUN_NAME
       ) T1
 WHERE UPJANG NOT IN (SELECT TO_NUMBER(CODE) FROM SCC_COMMON_CODE WHERE GROUP_CODE = 'MA0048' AND USE_YN = 'Y')        
   --2019.12.13 김명섭 블로킹대상자 조회 제외 업장 체크
   AND NOT EXISTS (SELECT 'x'
                     FROM SCC_COMMON_CODE CCODE1, SCC_COMMON_CODE CCODE2
                    WHERE CCODE1.GROUP_CODE = 'EXLDOWN_BLOCKING'
                      AND CCODE1.CODE = #UUSER#
                      AND CCODE1.USE_YN = 'Y'
                      AND CCODE2.GROUP_CODE = 'UPJANG_BLOCKING'
                      AND CCODE2.CODE = T1.UPJANG
                      AND CCODE2.USE_YN = 'Y')
 ORDER BY NEW_GUBUN_NAME DESC, TM_NM, UPJANG_NAME
</isEqual>
<isEqual col="DATA_CLASS" value="Y"> 
/* 관리-추정-전년 */
 SELECT DISTINCT TM_CD
      ,TM_NM TM_NAME
      --2018.07.27 김명섭 CC코드 중복 방지
      --,UPJANG
      ,UPJANGNM UPJANG_NAME
      --2019.02.14 김명섭 업장명 신규계획일 경우 신규로 구분
      --,DECODE(NEW_GUBUN_NAME, '신규', 'N', 'O') NEW_GUBUN
      --,NEW_GUBUN_NAME
      ,(CASE WHEN UPJANGNM LIKE '%신규계획%' THEN 'N' ELSE DECODE(NEW_GUBUN_NAME, '신규', 'N', 'O') END) AS NEW_GUBUN
      ,(CASE WHEN UPJANGNM LIKE '%신규계획%' THEN '신규' ELSE NEW_GUBUN_NAME END) AS NEW_GUBUN_NAME
      ,CC_CD
      ,P_TYPE_A AS SIMU_SALE_AMT  -- 계획 매출액
      --재료비, 노무비, 경비 추가  요청자 : 유영진   20160318  처리자 :맹수영
      ,P_TYPE_B AS SIMU_COST_AMT  -- 계획 재료비
      ,P_TYPE_C AS SIMU_LABOR_AMT  -- 계획 노무비
      ,P_TYPE_D AS SIMU_EXP_AMT  -- 계획 경비
      ,(P_TYPE_A - (P_TYPE_B + P_TYPE_C + P_TYPE_D)) AS SIMU_SALE_PROFIT -- 계획 매출이익
      ,R_TYPE_A AS SALE_AMT -- 실적 매출액
      ,ROUND(R_TYPE_B) AS COST_AMT -- 실적 재료비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_B/R_TYPE_A*100),1) AS COST_RATE -- 실적 매출 비율
      ,R_TYPE_C AS LABOR_AMT -- 실적 노무비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_C/R_TYPE_A*100),1) AS LABOR_RATE -- 실적 노무비 비율
      ,R_TYPE_D AS EXP_AMT -- 실적 경비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_D/R_TYPE_A*100),1) AS EXP_RATE -- 실적 경비비율
      ,ROUND((R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))) AS SALE_PROFIT -- 실적 매출이익
      ,ROUND(DECODE(R_TYPE_A,0,0,(R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))/R_TYPE_A*100),1) AS SALE_PROFIT_RATE -- 매출이익 비율
      ,ROUND(DECODE(P_TYPE_A,0,0,R_TYPE_A/P_TYPE_A*100),1) AS SIMU_SALE_DIFF_RATE -- 실적 매출액(%)
      ,((P_TYPE_A - (P_TYPE_B + P_TYPE_C + P_TYPE_D)) - (R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))) AS SIMU_PROFIT_DIFF_AMT -- 매출 이익
      ,(SELECT CST_PLNKGVRN_CLASS_CD FROM SCC_CC WHERE CC_CD = T1.CC_CD) AS CC_GB
  FROM (
        SELECT TM_CD
              ,TM_NM
              ,UPJANG
              ,UPJANGNM
              ,NEW_GUBUN_NAME              
              ,MAX(DECODE(CC_CD, NULL, CC_CD, CC_CD)) CC_CD
              --MAX를 모두 sum으로 변경  20160519
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_A', P_MM_AMT, 0)) P_TYPE_A -- 계획 매출액
             -- ,MAX(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0)) P_TYPE_B -- 계획 재료비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_C', P_MM_AMT, 0)) P_TYPE_C -- 계획 노무비 
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_D', P_MM_AMT, 0)) P_TYPE_D -- 계획 경비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_A', R_MM_AMT, 0)) R_TYPE_A -- 실적 매출액
       
             --,MAX(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0) * NVL(R_MM_MR, 100) / 100 ) P_TYPE_B -- 관리계획 재료비        
             ,SUM(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0) * NVL(R_MM_MR, 100) / 100 ) +SUM(DECODE(ACCT_TYPE, 'TYPE_E', P_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_F', P_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_G', P_MM_AMT, 0)  ) P_TYPE_B
             -- , MAX(DECODE(ACCT_TYPE, 'TYPE_B', R_MM_AMT, 0)  * NVL(R_MM_MR, 100) / 100 ) R_TYPE_B -- 관리실적 재료비
  
             /* 2018.02.07 김명섭 [] 조회조건 개선 */
             , SUM(DECODE(ACCT_TYPE, 'TYPE_B', R_MM_AMT, 0)  * NVL(R_MM_MR_2, 100) / 100 ) +SUM(DECODE(ACCT_TYPE, 'TYPE_E', R_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_F', R_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_G', R_MM_AMT, 0)  )R_TYPE_B
             /* 2018.02.07 김명섭 [] 조회조건 개선 */
     
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_C', R_MM_AMT, 0)) R_TYPE_C -- 실적 노무비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_D', R_MM_AMT, 0)) R_TYPE_D -- 실적 경비
          FROM (
                 SELECT TM_CD
                       ,TM_NM
                       ,UPJANG
                       ,UPJANGNM
                       ,NEW_GUBUN_NAME
                       ,CC_CD
                       ,ACCT_TYPE
                       ,ROUND(SUM(P_MM_AMT) / 1000) AS P_MM_AMT
                       ,ROUND(SUM(R_MM_AMT) / 1000) AS R_MM_AMT
                      ,( SELECT  CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_MARGIN_RATE_01
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_MARGIN_RATE_02
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_MARGIN_RATE_03
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_MARGIN_RATE_04
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_MARGIN_RATE_05
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_MARGIN_RATE_06
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_MARGIN_RATE_07
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_MARGIN_RATE_08
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_MARGIN_RATE_09
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_MARGIN_RATE_10
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_MARGIN_RATE_11
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_MARGIN_RATE_12
                                 ELSE 0
                                 END
                            FROM MAP_MARGIN_RATE_MGMT
                           WHERE UPJANG = A.UPJANG
                             AND YY = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY')
                             AND CLASS = 'R'
                       ) R_MM_MR
                      ,( SELECT  CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_MARGIN_RATE_01
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_MARGIN_RATE_02
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_MARGIN_RATE_03
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_MARGIN_RATE_04
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_MARGIN_RATE_05
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_MARGIN_RATE_06
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_MARGIN_RATE_07
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_MARGIN_RATE_08
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_MARGIN_RATE_09
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_MARGIN_RATE_10
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_MARGIN_RATE_11
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_MARGIN_RATE_12
                                 ELSE 0
                                 END
                            FROM MAP_MARGIN_RATE_MGMT
                           WHERE UPJANG = A.UPJANG
                             AND YY = SUBSTR(#YYMM#, 1, 4)
                             AND CLASS = 'R'
                       ) R_MM_MR_2
                   FROM (
                        SELECT V.TM_CD
                              ,V.TM_NAME AS TM_NM
                              ,V.UPJANG
                              ,A.CC_NM AS UPJANGNM
                              ,(CASE WHEN V.OPEN_YY = SUBSTRB(#YYMM#,1,4) THEN '신규' -- OPEN_YY가 현재년과 같으면 신규.
                                ELSE '기존'
                                 END    
                               ) AS NEW_GUBUN_NAME
                              ,A.CC_CD
                              ,( CASE WHEN SUBSTR(A.ACCT_CD, 1, 2) = '41'  THEN 'TYPE_A'
                                      WHEN A.ACCT_CD = '98001010'  THEN 'TYPE_A'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42203'  THEN 'TYPE_B'
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진
                                   --   WHEN D.ACCTNM2  = '재료비'  THEN 'TYPE_B'
                                      
                                      
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '431' THEN 'TYPE_C'
                                      
                                      
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진                                      
                                      WHEN D.ACCTNM3 = '복리후생비(인건비성)' THEN 'TYPE_C' 
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' AND D.ACCTNM3 &lt;&gt; '복리후생비(인건비성)' THEN 'TYPE_D'
                                      --2018.01.16 김명섭 [SR201801_06318] 경비금액 내 내부원가 계정(98001510) 반영
                                      --WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002'  THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002' OR A.ACCT_CD = '98001510'  THEN 'TYPE_D'
                                      
                                   --   WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42202'  THEN 'TYPE_E'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42101'  THEN 'TYPE_F'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42201'  THEN 'TYPE_G'
                                  ELSE 'ETC'
                                   END
                               ) ACCT_TYPE
                              ,A.ACCT_CD
                                ,( CASE WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '01' THEN A.MM_AMT_01  -- 조회 월
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '02' THEN A.MM_AMT_02
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '03' THEN A.MM_AMT_03
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '04' THEN A.MM_AMT_04
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '05' THEN A.MM_AMT_05
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '06' THEN A.MM_AMT_06
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '07' THEN A.MM_AMT_07
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '08' THEN A.MM_AMT_08
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '09' THEN A.MM_AMT_09
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '10' THEN A.MM_AMT_10
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '11' THEN A.MM_AMT_11
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '12' THEN A.MM_AMT_12
                                 ELSE 0
                                 END
                               ) P_MM_AMT -- 계획, 전년실적
                               ,0 R_MM_AMT
                          FROM MAP_UPJANG_PL A -- SAP 실적
							                --2018.04.25 김명섭 사업계획관리 개선: 동일CC 데이터중복 개선
                              --,MAC_UPJANG_V V
                              ,(SELECT DISTINCT NVL(T2.ATTR01,T1.UPJANG) AS UPJANG, NVL(T2.CODE_NAME,T1.UPJANGNM) AS UPJANGNM,
                                       MU_CD,MU_NAME,SC_CD,SC_NAME,TM_CD,TM_NAME,PT_CD,PT_NAME,CC_CD,CC_NAME,OPEN_YY
                                  FROM MAC_UPJANG_V T1
                                LEFT OUTER JOIN SCC_COMMON_CODE T2
                                  ON T2.CODE = T1.CC_CD
                                 AND T2.GROUP_CODE = 'MAG20001S') V
                              --추가  
                              , MAS_ST_ACCOUNT D
                         WHERE 1 = 1
                           --2019.02.07 김명섭 팀/본부 조회 시 판관CC 제외
                           <isNull col="UPJANG">
                           --AND A.CC_CD NOT IN (SELECT CC_CD FROM SCC_CC WHERE CST_PLNKGVRN_CLASS_CD = 'SG')
                           </isNull>
                           AND A.CC_CD = V.CC_CD(+)
                           AND A.PL_CLASS = 'KS'
                                
                           AND A.FISCAL_YEAR IN (SUBSTR(#YYMM#, 1, 4), TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY')) -- 입력 년
                           <isNotNull col="MU_CD">
                           AND V.MU_CD = #MU_CD#
                           </isNotNull>
		                            <isNotNull col="TM_CD">
		                                <isNotEqual col="HOMEPLUS" value="1"> 
		                                AND V.TM_CD LIKE #TM_CD# || '%'
		                                </isNotEqual>
		                            </isNotNull>
		                            <isNotNull col="UPJANG">
		                                <isNotEqual col="HOMEPLUS" value="1"> 
		                                AND V.UPJANG = #UPJANG#
		                                </isNotEqual>
		                                <isEqual col="HOMEPLUS" value="1"> 
 									                  AND V.UPJANG    IN  (SELECT Z.CODE FROM SCC_COMMON_CODE Z WHERE Z.GROUP_CODE = 'UPJANG_GROUP' AND Z.USE_YN = 'Y' AND SET1 = #UPJANG#  )
 									                  </isEqual>
		                            </isNotNull>
		                                                             --추가                           
                           AND  A.ACCT_CD = D.ACCTCD
                           
                        UNION ALL
                        
                        SELECT V.TM_CD
                              ,V.TM_NAME AS TM_NM
                              ,V.UPJANG
                              ,V.CC_NAME AS UPJANGNM
                              ,(CASE WHEN V.OPEN_YY = SUBSTRB(#YYMM#,1,4) THEN '신규' -- OPEN_YY가 현재년과 같으면 신규.
                                ELSE '기존'
                                 END    
                               ) AS NEW_GUBUN_NAME
                              ,A.CC_CD
                              ,( CASE WHEN SUBSTR(A.ACCT_CD, 1, 2) = '41'  THEN 'TYPE_A'
                                      WHEN A.ACCT_CD = '98001010'  THEN 'TYPE_A'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42203'  THEN 'TYPE_B'
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진
                                   --   WHEN D.ACCTNM2  = '재료비'  THEN 'TYPE_B'
                                      
                                      
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '431' THEN 'TYPE_C'
                                      
                                      
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진                                      
                                      WHEN D.ACCTNM3 = '복리후생비(인건비성)' THEN 'TYPE_C' 
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' AND D.ACCTNM3 &lt;&gt; '복리후생비(인건비성)' THEN 'TYPE_D'
                                      --2018.01.16 김명섭 [SR201801_06318] 경비금액 내 내부원가 계정(98001510) 반영
                                      --WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002'  THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002' OR A.ACCT_CD = '98001510'  THEN 'TYPE_D'
                                      
                                   --   WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42202'  THEN 'TYPE_E'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42101'  THEN 'TYPE_F'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42201'  THEN 'TYPE_G'
                                  ELSE 'ETC'
                                   END
                               ) ACCT_TYPE
                              ,A.ACCT_CD
                                ,0 P_MM_AMT -- 계획, 전년실적
                               ,( CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_AMT_01  -- 조회 월
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_AMT_02
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_AMT_03
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_AMT_04
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_AMT_05
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_AMT_06
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_AMT_07
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_AMT_08
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_AMT_09
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_AMT_10
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_AMT_11
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_AMT_12
                                  ELSE 0
                                  END
                               ) R_MM_AMT
                          FROM MAP_BPC_CONFIRM_PL_INFO A -- SAP 실적
							                --2018.04.25 김명섭 사업계획관리 개선: 동일CC 데이터중복 개선
                              --,MAC_UPJANG_V V
                              ,(SELECT DISTINCT NVL(T2.ATTR01,T1.UPJANG) AS UPJANG, NVL(T2.CODE_NAME,T1.UPJANGNM) AS UPJANGNM,
                                       MU_CD,MU_NAME,SC_CD,SC_NAME,TM_CD,TM_NAME,PT_CD,PT_NAME,CC_CD,CC_NAME,OPEN_YY
                                  FROM MAC_UPJANG_V T1
                                LEFT OUTER JOIN SCC_COMMON_CODE T2
                                  ON T2.CODE = T1.CC_CD
                                 AND T2.GROUP_CODE = 'MAG20001S') V
                              --추가  
                              , MAS_ST_ACCOUNT D
                         WHERE 1 = 1
                           --2019.02.07 김명섭 팀/본부 조회 시 판관CC 제외
                           <isNull col="UPJANG">
                           --AND A.CC_CD NOT IN (SELECT CC_CD FROM SCC_CC WHERE CST_PLNKGVRN_CLASS_CD = 'SG')
                           </isNull>
                           AND A.CC_CD = V.CC_CD(+)
                           AND A.PLAN_CLASS = 'MP'
                           AND A.PLAN_YEAR = SUBSTR(#YYMM#, 1, 4) -- 입력 년
                           AND A.VER_CD= (SELECT MAX(VER_CD)
                                            FROM MAP_BPC_CONFIRM_PL_INFO
                                           WHERE PLAN_CLASS = A.PLAN_CLASS
                                             AND PLAN_YEAR = A.PLAN_YEAR
                                             AND CC_CD = A.CC_CD)
                           <isNotNull col="MU_CD">
                           AND V.MU_CD = #MU_CD#
                           </isNotNull>
                            <isNotNull col="TM_CD">
                                <isNotEqual col="HOMEPLUS" value="1"> 
                                AND V.TM_CD LIKE #TM_CD# || '%'
                                </isNotEqual>
                            </isNotNull>
                            <isNotNull col="UPJANG">
                                <isNotEqual col="HOMEPLUS" value="1"> 
                                AND V.UPJANG = #UPJANG#
                                </isNotEqual>
                                <isEqual col="HOMEPLUS" value="1"> 
  						                  AND V.UPJANG    IN  (SELECT Z.CODE FROM SCC_COMMON_CODE Z WHERE Z.GROUP_CODE = 'UPJANG_GROUP' AND Z.USE_YN = 'Y' AND SET1 = #UPJANG#  )
  						                  </isEqual>
                            </isNotNull>
                           AND  A.ACCT_CD = D.ACCTCD
                        
                       ) A
                                                 
                 GROUP BY TM_CD, TM_NM, UPJANG, UPJANGNM, NEW_GUBUN_NAME, CC_CD, ACCT_TYPE
                  
                 --ORDER BY CC_CD, ACCT_TYPE
         )
         GROUP BY TM_CD, TM_NM, UPJANG, UPJANGNM, NEW_GUBUN_NAME
       ) T1
 WHERE UPJANG NOT IN (SELECT TO_NUMBER(CODE) FROM SCC_COMMON_CODE WHERE GROUP_CODE = 'MA0048' AND USE_YN = 'Y')        
   --2019.12.13 김명섭 블로킹대상자 조회 제외 업장 체크
   AND NOT EXISTS (SELECT 'x'
                     FROM SCC_COMMON_CODE CCODE1, SCC_COMMON_CODE CCODE2
                    WHERE CCODE1.GROUP_CODE = 'EXLDOWN_BLOCKING'
                      AND CCODE1.CODE = #UUSER#
                      AND CCODE1.USE_YN = 'Y'
                      AND CCODE2.GROUP_CODE = 'UPJANG_BLOCKING'
                      AND CCODE2.CODE = T1.UPJANG
                      AND CCODE2.USE_YN = 'Y')
 ORDER BY NEW_GUBUN_NAME DESC, TM_NM, UPJANG_NAME
</isEqual>
<isEqual col="DATA_CLASS" value="M"> 
/* 관리-추정-전월 */
 SELECT DISTINCT TM_CD
      ,TM_NM TM_NAME
      --2018.07.27 김명섭 CC코드 중복 방지
      --,UPJANG
      ,UPJANGNM UPJANG_NAME
      --2019.02.14 김명섭 업장명 신규계획일 경우 신규로 구분
      --,DECODE(NEW_GUBUN_NAME, '신규', 'N', 'O') NEW_GUBUN
      --,NEW_GUBUN_NAME
      ,(CASE WHEN UPJANGNM LIKE '%신규계획%' THEN 'N' ELSE DECODE(NEW_GUBUN_NAME, '신규', 'N', 'O') END) AS NEW_GUBUN
      ,(CASE WHEN UPJANGNM LIKE '%신규계획%' THEN '신규' ELSE NEW_GUBUN_NAME END) AS NEW_GUBUN_NAME
      ,CC_CD
      ,P_TYPE_A AS SIMU_SALE_AMT  -- 계획 매출액
      --재료비, 노무비, 경비 추가  요청자 : 유영진   20160318  처리자 :맹수영
      ,P_TYPE_B AS SIMU_COST_AMT  -- 계획 재료비
      ,P_TYPE_C AS SIMU_LABOR_AMT  -- 계획 노무비
      ,P_TYPE_D AS SIMU_EXP_AMT  -- 계획 경비
      ,(P_TYPE_A - (P_TYPE_B + P_TYPE_C + P_TYPE_D)) AS SIMU_SALE_PROFIT -- 계획 매출이익
      ,R_TYPE_A AS SALE_AMT -- 실적 매출액
      ,ROUND(R_TYPE_B) AS COST_AMT -- 실적 재료비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_B/R_TYPE_A*100),1) AS COST_RATE -- 실적 매출 비율
      ,R_TYPE_C AS LABOR_AMT -- 실적 노무비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_C/R_TYPE_A*100),1) AS LABOR_RATE -- 실적 노무비 비율
      ,R_TYPE_D AS EXP_AMT -- 실적 경비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_D/R_TYPE_A*100),1) AS EXP_RATE -- 실적 경비비율
      ,ROUND((R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))) AS SALE_PROFIT -- 실적 매출이익
      ,ROUND(DECODE(R_TYPE_A,0,0,(R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))/R_TYPE_A*100),1) AS SALE_PROFIT_RATE -- 매출이익 비율
      ,ROUND(DECODE(P_TYPE_A,0,0,R_TYPE_A/P_TYPE_A*100),1) AS SIMU_SALE_DIFF_RATE -- 실적 매출액(%)
      ,((P_TYPE_A - (P_TYPE_B + P_TYPE_C + P_TYPE_D)) - (R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))) AS SIMU_PROFIT_DIFF_AMT -- 매출 이익
      ,(SELECT CST_PLNKGVRN_CLASS_CD FROM SCC_CC WHERE CC_CD = T1.CC_CD) AS CC_GB
  FROM (
        SELECT TM_CD
              ,TM_NM
              ,UPJANG
              ,UPJANGNM
              ,NEW_GUBUN_NAME              
              ,MAX(DECODE(CC_CD, NULL, CC_CD, CC_CD)) CC_CD
              --MAX를 모두 sum으로 변경  20160519
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_A', P_MM_AMT, 0)) P_TYPE_A -- 계획 매출액
             -- ,MAX(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0)) P_TYPE_B -- 계획 재료비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_C', P_MM_AMT, 0)) P_TYPE_C -- 계획 노무비 
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_D', P_MM_AMT, 0)) P_TYPE_D -- 계획 경비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_A', R_MM_AMT, 0)) R_TYPE_A -- 실적 매출액
       
             --,MAX(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0) * NVL(R_MM_MR, 100) / 100 ) P_TYPE_B -- 관리계획 재료비        
             ,SUM(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0) * NVL(R_MM_MR, 100) / 100 ) +SUM(DECODE(ACCT_TYPE, 'TYPE_E', P_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_F', P_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_G', P_MM_AMT, 0)  ) P_TYPE_B
             -- , MAX(DECODE(ACCT_TYPE, 'TYPE_B', R_MM_AMT, 0)  * NVL(R_MM_MR, 100) / 100 ) R_TYPE_B -- 관리실적 재료비
  
             /* 2018.02.07 김명섭 [] 조회조건 개선 */
             , SUM(DECODE(ACCT_TYPE, 'TYPE_B', R_MM_AMT, 0)  * NVL(R_MM_MR_2, 100) / 100 ) +SUM(DECODE(ACCT_TYPE, 'TYPE_E', R_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_F', R_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_G', R_MM_AMT, 0)  )R_TYPE_B
             /* 2018.02.07 김명섭 [] 조회조건 개선 */
     
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_C', R_MM_AMT, 0)) R_TYPE_C -- 실적 노무비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_D', R_MM_AMT, 0)) R_TYPE_D -- 실적 경비
          FROM (
                 SELECT TM_CD
                       ,TM_NM
                       ,UPJANG
                       ,UPJANGNM
                       ,NEW_GUBUN_NAME
                       ,CC_CD
                       ,ACCT_TYPE
                       ,ROUND(SUM(P_MM_AMT) / 1000) AS P_MM_AMT
                       ,ROUND(SUM(R_MM_AMT) / 1000) AS R_MM_AMT
                      ,( SELECT  CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_MARGIN_RATE_01
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_MARGIN_RATE_02
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_MARGIN_RATE_03
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_MARGIN_RATE_04
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_MARGIN_RATE_05
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_MARGIN_RATE_06
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_MARGIN_RATE_07
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_MARGIN_RATE_08
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_MARGIN_RATE_09
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_MARGIN_RATE_10
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_MARGIN_RATE_11
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_MARGIN_RATE_12
                                 ELSE 0
                                 END
                            FROM MAP_MARGIN_RATE_MGMT
                           WHERE UPJANG = A.UPJANG
                             AND YY = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY')
                             AND CLASS = 'R'
                       ) R_MM_MR
                      ,( SELECT  CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_MARGIN_RATE_01
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_MARGIN_RATE_02
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_MARGIN_RATE_03
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_MARGIN_RATE_04
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_MARGIN_RATE_05
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_MARGIN_RATE_06
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_MARGIN_RATE_07
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_MARGIN_RATE_08
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_MARGIN_RATE_09
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_MARGIN_RATE_10
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_MARGIN_RATE_11
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_MARGIN_RATE_12
                                 ELSE 0
                                 END
                            FROM MAP_MARGIN_RATE_MGMT
                           WHERE UPJANG = A.UPJANG
                             AND YY = SUBSTR(#YYMM#, 1, 4)
                             AND CLASS = 'R'
                       ) R_MM_MR_2
                   FROM (
                        SELECT V.TM_CD
                              ,V.TM_NAME AS TM_NM
                              ,V.UPJANG
                              ,A.CC_NM AS UPJANGNM
                              ,(CASE WHEN V.OPEN_YY = SUBSTRB(#YYMM#,1,4) THEN '신규' -- OPEN_YY가 현재년과 같으면 신규.
                                ELSE '기존'
                                 END    
                               ) AS NEW_GUBUN_NAME
                              ,A.CC_CD
                              ,( CASE WHEN SUBSTR(A.ACCT_CD, 1, 2) = '41'  THEN 'TYPE_A'
                                      WHEN A.ACCT_CD = '98001010'  THEN 'TYPE_A'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42203'  THEN 'TYPE_B'
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진
                                   --   WHEN D.ACCTNM2  = '재료비'  THEN 'TYPE_B'
                                      
                                      
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '431' THEN 'TYPE_C'
                                      
                                      
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진                                      
                                      WHEN D.ACCTNM3 = '복리후생비(인건비성)' THEN 'TYPE_C' 
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' AND D.ACCTNM3 &lt;&gt; '복리후생비(인건비성)' THEN 'TYPE_D'
                                      --2018.01.16 김명섭 [SR201801_06318] 경비금액 내 내부원가 계정(98001510) 반영
                                      --WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002'  THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002' OR A.ACCT_CD = '98001510'  THEN 'TYPE_D'
                                      
                                   --   WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42202'  THEN 'TYPE_E'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42101'  THEN 'TYPE_F'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42201'  THEN 'TYPE_G'
                                  ELSE 'ETC'
                                   END
                               ) ACCT_TYPE
                              ,A.ACCT_CD
                               ,( CASE WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '01' THEN A.MM_AMT_01  -- 조회 월
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '02' THEN A.MM_AMT_02
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '03' THEN A.MM_AMT_03
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '04' THEN A.MM_AMT_04
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '05' THEN A.MM_AMT_05
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '06' THEN A.MM_AMT_06
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '07' THEN A.MM_AMT_07
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '08' THEN A.MM_AMT_08
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '09' THEN A.MM_AMT_09
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '10' THEN A.MM_AMT_10
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '11' THEN A.MM_AMT_11
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '12' THEN A.MM_AMT_12
                                 ELSE 0
                                 END
                               ) P_MM_AMT -- 조회월 실적
                               ,0 R_MM_AMT

                          FROM MAP_UPJANG_PL A -- SAP 실적
							                --2018.04.25 김명섭 사업계획관리 개선: 동일CC 데이터중복 개선
                              --,MAC_UPJANG_V V
                              ,(SELECT DISTINCT NVL(T2.ATTR01,T1.UPJANG) AS UPJANG, NVL(T2.CODE_NAME,T1.UPJANGNM) AS UPJANGNM,
                                       MU_CD,MU_NAME,SC_CD,SC_NAME,TM_CD,TM_NAME,PT_CD,PT_NAME,CC_CD,CC_NAME,OPEN_YY
                                  FROM MAC_UPJANG_V T1
                                LEFT OUTER JOIN SCC_COMMON_CODE T2
                                  ON T2.CODE = T1.CC_CD
                                 AND T2.GROUP_CODE = 'MAG20001S') V
                              --추가  
                              , MAS_ST_ACCOUNT D
                         WHERE 1 = 1
                           --2019.02.07 김명섭 팀/본부 조회 시 판관CC 제외
                           <isNull col="UPJANG">
                           --AND A.CC_CD NOT IN (SELECT CC_CD FROM SCC_CC WHERE CST_PLNKGVRN_CLASS_CD = 'SG')
                           </isNull>
                           AND A.CC_CD = V.CC_CD(+)
                           AND A.PL_CLASS = 'KS'
                                
                           AND A.FISCAL_YEAR IN (SUBSTR(#YYMM#, 1, 4), TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY')) -- 입력 년
                           <isNotNull col="MU_CD">
                           AND V.MU_CD = #MU_CD#
                           </isNotNull>
		                            <isNotNull col="TM_CD">
		                                <isNotEqual col="HOMEPLUS" value="1"> 
		                                AND V.TM_CD LIKE #TM_CD# || '%'
		                                </isNotEqual>
		                            </isNotNull>
		                            <isNotNull col="UPJANG">
		                                <isNotEqual col="HOMEPLUS" value="1"> 
		                                AND V.UPJANG = #UPJANG#
		                                </isNotEqual>
		                                <isEqual col="HOMEPLUS" value="1"> 
 									                  AND V.UPJANG    IN  (SELECT Z.CODE FROM SCC_COMMON_CODE Z WHERE Z.GROUP_CODE = 'UPJANG_GROUP' AND Z.USE_YN = 'Y' AND SET1 = #UPJANG#  )
 									                  </isEqual>
		                            </isNotNull>
		                                                             --추가                           
                           AND  A.ACCT_CD = D.ACCTCD
                           
                        UNION ALL
                        
                        SELECT V.TM_CD
                              ,V.TM_NAME AS TM_NM
                              ,V.UPJANG
                              ,V.CC_NAME AS UPJANGNM
                              ,(CASE WHEN V.OPEN_YY = SUBSTRB(#YYMM#,1,4) THEN '신규' -- OPEN_YY가 현재년과 같으면 신규.
                                ELSE '기존'
                                 END    
                               ) AS NEW_GUBUN_NAME
                              ,A.CC_CD
                              ,( CASE WHEN SUBSTR(A.ACCT_CD, 1, 2) = '41'  THEN 'TYPE_A'
                                      WHEN A.ACCT_CD = '98001010'  THEN 'TYPE_A'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42203'  THEN 'TYPE_B'
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진
                                   --   WHEN D.ACCTNM2  = '재료비'  THEN 'TYPE_B'
                                      
                                      
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '431' THEN 'TYPE_C'
                                      
                                      
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진                                      
                                      WHEN D.ACCTNM3 = '복리후생비(인건비성)' THEN 'TYPE_C' 
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' AND D.ACCTNM3 &lt;&gt; '복리후생비(인건비성)' THEN 'TYPE_D'
                                      --2018.01.16 김명섭 [SR201801_06318] 경비금액 내 내부원가 계정(98001510) 반영
                                      --WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002'  THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002' OR A.ACCT_CD = '98001510'  THEN 'TYPE_D'
                                      
                                   --   WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42202'  THEN 'TYPE_E'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42101'  THEN 'TYPE_F'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42201'  THEN 'TYPE_G'
                                  ELSE 'ETC'
                                   END
                               ) ACCT_TYPE
                              ,A.ACCT_CD
                               ,0 P_MM_AMT -- 조회월 실적
                               ,( CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_AMT_01  -- 조회 월
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_AMT_02
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_AMT_03
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_AMT_04
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_AMT_05
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_AMT_06
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_AMT_07
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_AMT_08
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_AMT_09
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_AMT_10
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_AMT_11
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_AMT_12
                                  ELSE 0
                                  END
                               ) R_MM_AMT
                          FROM MAP_BPC_CONFIRM_PL_INFO A -- SAP 실적
							                --2018.04.25 김명섭 사업계획관리 개선: 동일CC 데이터중복 개선
                              --,MAC_UPJANG_V V
                              ,(SELECT DISTINCT NVL(T2.ATTR01,T1.UPJANG) AS UPJANG, NVL(T2.CODE_NAME,T1.UPJANGNM) AS UPJANGNM,
                                       MU_CD,MU_NAME,SC_CD,SC_NAME,TM_CD,TM_NAME,PT_CD,PT_NAME,CC_CD,CC_NAME,OPEN_YY
                                  FROM MAC_UPJANG_V T1
                                LEFT OUTER JOIN SCC_COMMON_CODE T2
                                  ON T2.CODE = T1.CC_CD
                                 AND T2.GROUP_CODE = 'MAG20001S') V
                              --추가  
                              , MAS_ST_ACCOUNT D
                         WHERE 1 = 1
                           --2019.02.07 김명섭 팀/본부 조회 시 판관CC 제외
                           <isNull col="UPJANG">
                           --AND A.CC_CD NOT IN (SELECT CC_CD FROM SCC_CC WHERE CST_PLNKGVRN_CLASS_CD = 'SG')
                           </isNull>
                           AND A.CC_CD = V.CC_CD(+)
                           AND A.PLAN_CLASS = 'MP'
                           AND A.PLAN_YEAR = SUBSTR(#YYMM#, 1, 4) -- 입력 년
                           AND A.VER_CD= (SELECT MAX(VER_CD)
                                            FROM MAP_BPC_CONFIRM_PL_INFO
                                           WHERE PLAN_CLASS = A.PLAN_CLASS
                                             AND PLAN_YEAR = A.PLAN_YEAR
                                             AND CC_CD = A.CC_CD)
                           <isNotNull col="MU_CD">
                           AND V.MU_CD = #MU_CD#
                           </isNotNull>
                            <isNotNull col="TM_CD">
                                <isNotEqual col="HOMEPLUS" value="1"> 
                                AND V.TM_CD LIKE #TM_CD# || '%'
                                </isNotEqual>
                            </isNotNull>
                            <isNotNull col="UPJANG">
                                <isNotEqual col="HOMEPLUS" value="1"> 
                                AND V.UPJANG = #UPJANG#
                                </isNotEqual>
                                <isEqual col="HOMEPLUS" value="1"> 
  						                  AND V.UPJANG    IN  (SELECT Z.CODE FROM SCC_COMMON_CODE Z WHERE Z.GROUP_CODE = 'UPJANG_GROUP' AND Z.USE_YN = 'Y' AND SET1 = #UPJANG#  )
  						                  </isEqual>
                            </isNotNull>
                           AND  A.ACCT_CD = D.ACCTCD
                                                   
                       ) A
                                                 
                 GROUP BY TM_CD, TM_NM, UPJANG, UPJANGNM, NEW_GUBUN_NAME, CC_CD, ACCT_TYPE
                  
                 --ORDER BY CC_CD, ACCT_TYPE
         )
         GROUP BY TM_CD, TM_NM, UPJANG, UPJANGNM, NEW_GUBUN_NAME
       ) T1
 WHERE UPJANG NOT IN (SELECT TO_NUMBER(CODE) FROM SCC_COMMON_CODE WHERE GROUP_CODE = 'MA0048' AND USE_YN = 'Y')        
   --2019.12.13 김명섭 블로킹대상자 조회 제외 업장 체크
   AND NOT EXISTS (SELECT 'x'
                     FROM SCC_COMMON_CODE CCODE1, SCC_COMMON_CODE CCODE2
                    WHERE CCODE1.GROUP_CODE = 'EXLDOWN_BLOCKING'
                      AND CCODE1.CODE = #UUSER#
                      AND CCODE1.USE_YN = 'Y'
                      AND CCODE2.GROUP_CODE = 'UPJANG_BLOCKING'
                      AND CCODE2.CODE = T1.UPJANG
                      AND CCODE2.USE_YN = 'Y')
 ORDER BY NEW_GUBUN_NAME DESC, TM_NM, UPJANG_NAME
</isEqual>
</isEqual>
</isEqual>

<isEqual col="CLOSE_TYPE" value="C05C">
<isEqual col="SALE_TYPE" value="E">
<isEqual col="DATA_CLASS" value="P"> 
/* 재무-추정-계획 */
 SELECT DISTINCT TM_CD
      ,TM_NM TM_NAME
      --2018.07.27 김명섭 CC코드 중복 방지
      --,UPJANG
      ,UPJANGNM UPJANG_NAME
      --2019.02.14 김명섭 업장명 신규계획일 경우 신규로 구분
      --,DECODE(NEW_GUBUN_NAME, '신규', 'N', 'O') NEW_GUBUN
      --,NEW_GUBUN_NAME
      ,(CASE WHEN UPJANGNM LIKE '%신규계획%' THEN 'N' ELSE DECODE(NEW_GUBUN_NAME, '신규', 'N', 'O') END) AS NEW_GUBUN
      ,(CASE WHEN UPJANGNM LIKE '%신규계획%' THEN '신규' ELSE NEW_GUBUN_NAME END) AS NEW_GUBUN_NAME
      ,CC_CD
      ,P_TYPE_A AS SIMU_SALE_AMT  -- 계획 매출액
      --재료비, 노무비, 경비 추가  요청자 : 유영진   20160318  처리자 :맹수영
      ,P_TYPE_B AS SIMU_COST_AMT  -- 계획 재료비
      ,P_TYPE_C AS SIMU_LABOR_AMT  -- 계획 노무비
      ,P_TYPE_D AS SIMU_EXP_AMT  -- 계획 경비
      ,(P_TYPE_A - (P_TYPE_B + P_TYPE_C + P_TYPE_D)) AS SIMU_SALE_PROFIT -- 계획 매출이익
      ,R_TYPE_A AS SALE_AMT -- 실적 매출액
      ,ROUND(R_TYPE_B) AS COST_AMT -- 실적 재료비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_B/R_TYPE_A*100),1) AS COST_RATE -- 실적 매출 비율
      ,R_TYPE_C AS LABOR_AMT -- 실적 노무비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_C/R_TYPE_A*100),1) AS LABOR_RATE -- 실적 노무비 비율
      ,R_TYPE_D AS EXP_AMT -- 실적 경비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_D/R_TYPE_A*100),1) AS EXP_RATE -- 실적 경비비율
      ,ROUND((R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))) AS SALE_PROFIT -- 실적 매출이익
      ,ROUND(DECODE(R_TYPE_A,0,0,(R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))/R_TYPE_A*100),1) AS SALE_PROFIT_RATE -- 매출이익 비율
      ,ROUND(DECODE(P_TYPE_A,0,0,R_TYPE_A/P_TYPE_A*100),1) AS SIMU_SALE_DIFF_RATE -- 실적 매출액(%)
      ,((P_TYPE_A - (P_TYPE_B + P_TYPE_C + P_TYPE_D)) - (R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))) AS SIMU_PROFIT_DIFF_AMT -- 매출 이익
      ,(SELECT CST_PLNKGVRN_CLASS_CD FROM SCC_CC WHERE CC_CD = T1.CC_CD) AS CC_GB
  FROM (
        SELECT TM_CD
              ,TM_NM
              ,UPJANG
              ,UPJANGNM
              ,NEW_GUBUN_NAME              
              ,MAX(DECODE(CC_CD, NULL, CC_CD, CC_CD)) CC_CD
              --MAX를 모두 sum으로 변경  20160519
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_A', P_MM_AMT, 0)) P_TYPE_A -- 계획 매출액
             -- ,MAX(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0)) P_TYPE_B -- 계획 재료비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_C', P_MM_AMT, 0)) P_TYPE_C -- 계획 노무비 
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_D', P_MM_AMT, 0)) P_TYPE_D -- 계획 경비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_A', R_MM_AMT, 0)) R_TYPE_A -- 실적 매출액
               
              --,MAX(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0)) P_TYPE_B -- 계획 재료비
             ,SUM(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0)) +SUM(DECODE(ACCT_TYPE, 'TYPE_E', P_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_F', P_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_G', P_MM_AMT, 0)  ) P_TYPE_B
            --  ,MAX(DECODE(ACCT_TYPE, 'TYPE_B', R_MM_AMT, 0)) R_TYPE_B -- 재무실적 재료비
            ,SUM(DECODE(ACCT_TYPE, 'TYPE_B', R_MM_AMT, 0)) +SUM(DECODE(ACCT_TYPE, 'TYPE_E', R_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_F', R_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_G', R_MM_AMT, 0)  ) R_TYPE_B
     
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_C', R_MM_AMT, 0)) R_TYPE_C -- 실적 노무비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_D', R_MM_AMT, 0)) R_TYPE_D -- 실적 경비
          FROM (
                 SELECT TM_CD
                       ,TM_NM
                       ,UPJANG
                       ,UPJANGNM
                       ,NEW_GUBUN_NAME
                       ,CC_CD
                       ,ACCT_TYPE
                       ,ROUND(SUM(P_MM_AMT) / 1000) AS P_MM_AMT
                       ,ROUND(SUM(R_MM_AMT) / 1000) AS R_MM_AMT
                      ,( SELECT  CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_MARGIN_RATE_01
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_MARGIN_RATE_02
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_MARGIN_RATE_03
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_MARGIN_RATE_04
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_MARGIN_RATE_05
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_MARGIN_RATE_06
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_MARGIN_RATE_07
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_MARGIN_RATE_08
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_MARGIN_RATE_09
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_MARGIN_RATE_10
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_MARGIN_RATE_11
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_MARGIN_RATE_12
                                 ELSE 0
                                 END
                            FROM MAP_MARGIN_RATE_MGMT
                           WHERE UPJANG = A.UPJANG
                             AND YY = SUBSTR(#YYMM#, 1, 4)
                             AND CLASS = 'R'
                       ) R_MM_MR
                   FROM (
                        SELECT V.TM_CD
                              ,V.TM_NAME AS TM_NM
                              ,V.UPJANG
                              ,V.CC_NAME AS UPJANGNM
                              ,(CASE WHEN V.OPEN_YY = SUBSTRB(#YYMM#,1,4) THEN '신규' -- OPEN_YY가 현재년과 같으면 신규.
                                ELSE '기존'
                                 END    
                               ) AS NEW_GUBUN_NAME
                              ,A.CC_CD
                              ,( CASE WHEN SUBSTR(A.ACCT_CD, 1, 2) = '41'  THEN 'TYPE_A'
                                      WHEN A.ACCT_CD = '98001010'  THEN 'TYPE_A'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42203'  THEN 'TYPE_B'
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진
                                   --   WHEN D.ACCTNM2  = '재료비'  THEN 'TYPE_B'
                                      
                                      
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '431' THEN 'TYPE_C'
                                      
                                      
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진                                      
                                      WHEN D.ACCTNM3 = '복리후생비(인건비성)' THEN 'TYPE_C' 
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' AND D.ACCTNM3 &lt;&gt; '복리후생비(인건비성)' THEN 'TYPE_D'
                                      --2018.01.16 김명섭 [SR201801_06318] 경비금액 내 내부원가 계정(98001510) 반영
                                      --WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002'  THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002' OR A.ACCT_CD = '98001510'  THEN 'TYPE_D'
                                      
                                   --   WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42202'  THEN 'TYPE_E'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42101'  THEN 'TYPE_F'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42201'  THEN 'TYPE_G'
                                  ELSE 'ETC'
                                   END
                               ) ACCT_TYPE
                              ,A.ACCT_CD
                               ,0 P_MM_AMT
                               ,( CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_AMT_01  -- 조회 월
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_AMT_02
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_AMT_03
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_AMT_04
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_AMT_05
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_AMT_06
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_AMT_07
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_AMT_08
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_AMT_09
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_AMT_10
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_AMT_11
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_AMT_12
                                  ELSE 0
                                  END
                               ) R_MM_AMT -- 조회월 실적
                          FROM MAP_BPC_CONFIRM_PL_INFO A -- SAP 실적
							                --2018.04.25 김명섭 사업계획관리 개선: 동일CC 데이터중복 개선
                              --,MAC_UPJANG_V V
                              ,(SELECT DISTINCT NVL(T2.ATTR01,T1.UPJANG) AS UPJANG, NVL(T2.CODE_NAME,T1.UPJANGNM) AS UPJANGNM,
                                       MU_CD,MU_NAME,SC_CD,SC_NAME,TM_CD,TM_NAME,PT_CD,PT_NAME,CC_CD,CC_NAME,OPEN_YY
                                  FROM MAC_UPJANG_V T1
                                LEFT OUTER JOIN SCC_COMMON_CODE T2
                                  ON T2.CODE = T1.CC_CD
                                 AND T2.GROUP_CODE = 'MAG20001S') V
                              --추가  
                              , MAS_ST_ACCOUNT D
                         WHERE 1 = 1
                           --2019.02.07 김명섭 팀/본부 조회 시 판관CC 제외
                           <isNull col="UPJANG">
                           --AND A.CC_CD NOT IN (SELECT CC_CD FROM SCC_CC WHERE CST_PLNKGVRN_CLASS_CD = 'SG')
                           </isNull>
                           AND A.CC_CD = V.CC_CD(+)
                           AND A.PLAN_CLASS = 'MP'
                                
                           AND A.PLAN_YEAR = SUBSTR(#YYMM#, 1, 4) -- 입력 년
                           AND A.VER_CD= (SELECT MAX(VER_CD)
                                            FROM MAP_BPC_CONFIRM_PL_INFO
                                           WHERE PLAN_CLASS = A.PLAN_CLASS
                                             AND PLAN_YEAR = A.PLAN_YEAR
                                             AND CC_CD = A.CC_CD)
                           <isNotNull col="MU_CD">
                           AND V.MU_CD = #MU_CD#
                           </isNotNull>
		                            <isNotNull col="TM_CD">
		                                <isNotEqual col="HOMEPLUS" value="1"> 
		                                AND V.TM_CD LIKE #TM_CD# || '%'
		                                </isNotEqual>
		                            </isNotNull>
		                            <isNotNull col="UPJANG">
		                                <isNotEqual col="HOMEPLUS" value="1"> 
		                                AND V.UPJANG = #UPJANG#
		                                </isNotEqual>
		                                <isEqual col="HOMEPLUS" value="1"> 
 									     AND V.UPJANG    IN  (SELECT Z.CODE FROM SCC_COMMON_CODE Z WHERE Z.GROUP_CODE = 'UPJANG_GROUP' AND Z.USE_YN = 'Y' AND SET1 = #UPJANG#  )
 									    </isEqual>
		                            </isNotNull>
		                                                             --추가                           
                           AND  A.ACCT_CD = D.ACCTCD
                           
                        UNION ALL
                        
                        SELECT V.TM_CD
                              ,V.TM_NAME AS TM_NM
                              ,V.UPJANG
                              ,V.CC_NAME AS UPJANGNM
                              ,(CASE WHEN V.OPEN_YY = SUBSTRB(#YYMM#,1,4) THEN '신규' -- OPEN_YY가 현재년과 같으면 신규.
                                ELSE '기존'
                                 END    
                               ) AS NEW_GUBUN_NAME
                              ,A.CC_CD
                              ,( CASE WHEN SUBSTR(A.ACCT_CD, 1, 2) = '41'  THEN 'TYPE_A'
                                      WHEN A.ACCT_CD = '98001010'  THEN 'TYPE_A'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42203'  THEN 'TYPE_B'
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진
                                   --   WHEN D.ACCTNM2  = '재료비'  THEN 'TYPE_B'
                                      
                                      
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '431' THEN 'TYPE_C'
                                      
                                      
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진                                      
                                      WHEN D.ACCTNM3 = '복리후생비(인건비성)' THEN 'TYPE_C' 
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' AND D.ACCTNM3 &lt;&gt; '복리후생비(인건비성)' THEN 'TYPE_D'
                                      --2018.01.16 김명섭 [SR201801_06318] 경비금액 내 내부원가 계정(98001510) 반영
                                      --WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002'  THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002' OR A.ACCT_CD = '98001510'  THEN 'TYPE_D'
                                      
                                   --   WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42202'  THEN 'TYPE_E'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42101'  THEN 'TYPE_F'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42201'  THEN 'TYPE_G'
                                  ELSE 'ETC'
                                   END
                               ) ACCT_TYPE
                              ,A.ACCT_CD
                               ,( CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_AMT_01  -- 조회 월
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_AMT_02
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_AMT_03
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_AMT_04
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_AMT_05
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_AMT_06
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_AMT_07
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_AMT_08
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_AMT_09
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_AMT_10
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_AMT_11
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_AMT_12
                                  ELSE 0
                                  END
                               ) P_MM_AMT
                               ,0 R_MM_AMT -- 조회월 실적
                          FROM MAP_BPC_CONFIRM_PL_INFO A -- SAP 실적
							                --2018.04.25 김명섭 사업계획관리 개선: 동일CC 데이터중복 개선
                              --,MAC_UPJANG_V V
                              ,(SELECT DISTINCT NVL(T2.ATTR01,T1.UPJANG) AS UPJANG, NVL(T2.CODE_NAME,T1.UPJANGNM) AS UPJANGNM,
                                       MU_CD,MU_NAME,SC_CD,SC_NAME,TM_CD,TM_NAME,PT_CD,PT_NAME,CC_CD,CC_NAME,OPEN_YY
                                  FROM MAC_UPJANG_V T1
                                LEFT OUTER JOIN SCC_COMMON_CODE T2
                                  ON T2.CODE = T1.CC_CD
                                 AND T2.GROUP_CODE = 'MAG20001S') V
                              --추가  
                              , MAS_ST_ACCOUNT D
                         WHERE 1 = 1
                           --2019.02.07 김명섭 팀/본부 조회 시 판관CC 제외
                           <isNull col="UPJANG">
                           --AND A.CC_CD NOT IN (SELECT CC_CD FROM SCC_CC WHERE CST_PLNKGVRN_CLASS_CD = 'SG')
                           </isNull>
                           AND A.CC_CD = V.CC_CD(+)
                           AND A.PLAN_CLASS = 'AP'
                           AND A.PLAN_YEAR = SUBSTR(#YYMM#, 1, 4) -- 입력 년
                           AND A.VER_CD= (SELECT MAX(VER_CD)
                                            FROM MAP_BPC_CONFIRM_PL_INFO
                                           WHERE PLAN_CLASS = A.PLAN_CLASS
                                             AND PLAN_YEAR = A.PLAN_YEAR
                                             AND CC_CD = A.CC_CD)
                           <isNotNull col="MU_CD">
                           AND V.MU_CD = #MU_CD#
                           </isNotNull>
                            <isNotNull col="TM_CD">
                                <isNotEqual col="HOMEPLUS" value="1"> 
                                AND V.TM_CD LIKE #TM_CD# || '%'
                                </isNotEqual>
                            </isNotNull>
                            <isNotNull col="UPJANG">
                                <isNotEqual col="HOMEPLUS" value="1"> 
                                AND V.UPJANG = #UPJANG#
                                </isNotEqual>
                                <isEqual col="HOMEPLUS" value="1"> 
  						                  AND V.UPJANG    IN  (SELECT Z.CODE FROM SCC_COMMON_CODE Z WHERE Z.GROUP_CODE = 'UPJANG_GROUP' AND Z.USE_YN = 'Y' AND SET1 = #UPJANG#  )
  						                  </isEqual>
                            </isNotNull>
                           AND  A.ACCT_CD = D.ACCTCD
                        
                       ) A
                                                 
                 GROUP BY TM_CD, TM_NM, UPJANG, UPJANGNM, NEW_GUBUN_NAME, CC_CD, ACCT_TYPE
                  
                 --ORDER BY CC_CD, ACCT_TYPE
         )
         GROUP BY TM_CD, TM_NM, UPJANG, UPJANGNM, NEW_GUBUN_NAME
       ) T1
 WHERE UPJANG NOT IN (SELECT TO_NUMBER(CODE) FROM SCC_COMMON_CODE WHERE GROUP_CODE = 'MA0048' AND USE_YN = 'Y')        
   --2019.12.13 김명섭 블로킹대상자 조회 제외 업장 체크
   AND NOT EXISTS (SELECT 'x'
                     FROM SCC_COMMON_CODE CCODE1, SCC_COMMON_CODE CCODE2
                    WHERE CCODE1.GROUP_CODE = 'EXLDOWN_BLOCKING'
                      AND CCODE1.CODE = #UUSER#
                      AND CCODE1.USE_YN = 'Y'
                      AND CCODE2.GROUP_CODE = 'UPJANG_BLOCKING'
                      AND CCODE2.CODE = T1.UPJANG
                      AND CCODE2.USE_YN = 'Y')
 ORDER BY NEW_GUBUN_NAME DESC, TM_NM, UPJANG_NAME
</isEqual>
<isEqual col="DATA_CLASS" value="E"> 
/* 재무-추정-추정 */
 SELECT DISTINCT TM_CD
      ,TM_NM TM_NAME
      --2018.07.27 김명섭 CC코드 중복 방지
      --,UPJANG
      ,UPJANGNM UPJANG_NAME
      --2019.02.14 김명섭 업장명 신규계획일 경우 신규로 구분
      --,DECODE(NEW_GUBUN_NAME, '신규', 'N', 'O') NEW_GUBUN
      --,NEW_GUBUN_NAME
      ,(CASE WHEN UPJANGNM LIKE '%신규계획%' THEN 'N' ELSE DECODE(NEW_GUBUN_NAME, '신규', 'N', 'O') END) AS NEW_GUBUN
      ,(CASE WHEN UPJANGNM LIKE '%신규계획%' THEN '신규' ELSE NEW_GUBUN_NAME END) AS NEW_GUBUN_NAME
      ,CC_CD
      ,P_TYPE_A AS SIMU_SALE_AMT  -- 계획 매출액
      --재료비, 노무비, 경비 추가  요청자 : 유영진   20160318  처리자 :맹수영
      ,P_TYPE_B AS SIMU_COST_AMT  -- 계획 재료비
      ,P_TYPE_C AS SIMU_LABOR_AMT  -- 계획 노무비
      ,P_TYPE_D AS SIMU_EXP_AMT  -- 계획 경비
      ,(P_TYPE_A - (P_TYPE_B + P_TYPE_C + P_TYPE_D)) AS SIMU_SALE_PROFIT -- 계획 매출이익
      ,R_TYPE_A AS SALE_AMT -- 실적 매출액
      ,ROUND(R_TYPE_B) AS COST_AMT -- 실적 재료비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_B/R_TYPE_A*100),1) AS COST_RATE -- 실적 매출 비율
      ,R_TYPE_C AS LABOR_AMT -- 실적 노무비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_C/R_TYPE_A*100),1) AS LABOR_RATE -- 실적 노무비 비율
      ,R_TYPE_D AS EXP_AMT -- 실적 경비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_D/R_TYPE_A*100),1) AS EXP_RATE -- 실적 경비비율
      ,ROUND((R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))) AS SALE_PROFIT -- 실적 매출이익
      ,ROUND(DECODE(R_TYPE_A,0,0,(R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))/R_TYPE_A*100),1) AS SALE_PROFIT_RATE -- 매출이익 비율
      ,ROUND(DECODE(P_TYPE_A,0,0,R_TYPE_A/P_TYPE_A*100),1) AS SIMU_SALE_DIFF_RATE -- 실적 매출액(%)
      ,((P_TYPE_A - (P_TYPE_B + P_TYPE_C + P_TYPE_D)) - (R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))) AS SIMU_PROFIT_DIFF_AMT -- 매출 이익
      ,(SELECT CST_PLNKGVRN_CLASS_CD FROM SCC_CC WHERE CC_CD = T1.CC_CD) AS CC_GB
  FROM (
        SELECT TM_CD
              ,TM_NM
              ,UPJANG
              ,UPJANGNM
              ,NEW_GUBUN_NAME              
              ,MAX(DECODE(CC_CD, NULL, CC_CD, CC_CD)) CC_CD
              --MAX를 모두 sum으로 변경  20160519
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_A', P_MM_AMT, 0)) P_TYPE_A -- 계획 매출액
             -- ,MAX(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0)) P_TYPE_B -- 계획 재료비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_C', P_MM_AMT, 0)) P_TYPE_C -- 계획 노무비 
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_D', P_MM_AMT, 0)) P_TYPE_D -- 계획 경비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_A', R_MM_AMT, 0)) R_TYPE_A -- 실적 매출액
               
              --,MAX(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0)) P_TYPE_B -- 계획 재료비
             ,SUM(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0)) +SUM(DECODE(ACCT_TYPE, 'TYPE_E', P_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_F', P_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_G', P_MM_AMT, 0)  ) P_TYPE_B
            --  ,MAX(DECODE(ACCT_TYPE, 'TYPE_B', R_MM_AMT, 0)) R_TYPE_B -- 재무실적 재료비
            ,SUM(DECODE(ACCT_TYPE, 'TYPE_B', R_MM_AMT, 0)) +SUM(DECODE(ACCT_TYPE, 'TYPE_E', R_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_F', R_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_G', R_MM_AMT, 0)  ) R_TYPE_B
     
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_C', R_MM_AMT, 0)) R_TYPE_C -- 실적 노무비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_D', R_MM_AMT, 0)) R_TYPE_D -- 실적 경비
          FROM (
                 SELECT TM_CD
                       ,TM_NM
                       ,UPJANG
                       ,UPJANGNM
                       ,NEW_GUBUN_NAME
                       ,CC_CD
                       ,ACCT_TYPE
                       ,ROUND(SUM(P_MM_AMT) / 1000) AS P_MM_AMT
                       ,ROUND(SUM(R_MM_AMT) / 1000) AS R_MM_AMT
                      ,( SELECT  CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_MARGIN_RATE_01
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_MARGIN_RATE_02
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_MARGIN_RATE_03
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_MARGIN_RATE_04
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_MARGIN_RATE_05
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_MARGIN_RATE_06
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_MARGIN_RATE_07
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_MARGIN_RATE_08
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_MARGIN_RATE_09
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_MARGIN_RATE_10
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_MARGIN_RATE_11
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_MARGIN_RATE_12
                                 ELSE 0
                                 END
                            FROM MAP_MARGIN_RATE_MGMT
                           WHERE UPJANG = A.UPJANG
                             AND YY = SUBSTR(#YYMM#, 1, 4)
                             AND CLASS = 'R'
                       ) R_MM_MR
                   FROM (
                        SELECT V.TM_CD
                              ,V.TM_NAME AS TM_NM
                              ,V.UPJANG
                              ,V.CC_NAME AS UPJANGNM
                              ,(CASE WHEN V.OPEN_YY = SUBSTRB(#YYMM#,1,4) THEN '신규' -- OPEN_YY가 현재년과 같으면 신규.
                                ELSE '기존'
                                 END    
                               ) AS NEW_GUBUN_NAME
                              ,A.CC_CD
                              ,( CASE WHEN SUBSTR(A.ACCT_CD, 1, 2) = '41'  THEN 'TYPE_A'
                                      WHEN A.ACCT_CD = '98001010'  THEN 'TYPE_A'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42203'  THEN 'TYPE_B'
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진
                                   --   WHEN D.ACCTNM2  = '재료비'  THEN 'TYPE_B'
                                      
                                      
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '431' THEN 'TYPE_C'
                                      
                                      
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진                                      
                                      WHEN D.ACCTNM3 = '복리후생비(인건비성)' THEN 'TYPE_C' 
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' AND D.ACCTNM3 &lt;&gt; '복리후생비(인건비성)' THEN 'TYPE_D'
                                      --2018.01.16 김명섭 [SR201801_06318] 경비금액 내 내부원가 계정(98001510) 반영
                                      --WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002'  THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002' OR A.ACCT_CD = '98001510'  THEN 'TYPE_D'
                                      
                                   --   WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42202'  THEN 'TYPE_E'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42101'  THEN 'TYPE_F'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42201'  THEN 'TYPE_G'
                                  ELSE 'ETC'
                                   END
                               ) ACCT_TYPE
                              ,A.ACCT_CD
                               ,( CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_AMT_01  -- 조회 월
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_AMT_02
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_AMT_03
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_AMT_04
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_AMT_05
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_AMT_06
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_AMT_07
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_AMT_08
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_AMT_09
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_AMT_10
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_AMT_11
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_AMT_12
                                  ELSE 0
                                  END
                               ) P_MM_AMT
                               ,( CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_AMT_01  -- 조회 월
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_AMT_02
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_AMT_03
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_AMT_04
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_AMT_05
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_AMT_06
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_AMT_07
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_AMT_08
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_AMT_09
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_AMT_10
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_AMT_11
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_AMT_12
                                  ELSE 0
                                  END
                               ) R_MM_AMT -- 조회월 실적
                          FROM MAP_BPC_CONFIRM_PL_INFO A -- SAP 실적
							                --2018.04.25 김명섭 사업계획관리 개선: 동일CC 데이터중복 개선
                              --,MAC_UPJANG_V V
                              ,(SELECT DISTINCT NVL(T2.ATTR01,T1.UPJANG) AS UPJANG, NVL(T2.CODE_NAME,T1.UPJANGNM) AS UPJANGNM,
                                       MU_CD,MU_NAME,SC_CD,SC_NAME,TM_CD,TM_NAME,PT_CD,PT_NAME,CC_CD,CC_NAME,OPEN_YY
                                  FROM MAC_UPJANG_V T1
                                LEFT OUTER JOIN SCC_COMMON_CODE T2
                                  ON T2.CODE = T1.CC_CD
                                 AND T2.GROUP_CODE = 'MAG20001S') V
                              --추가  
                              , MAS_ST_ACCOUNT D
                         WHERE 1 = 1
                           --2019.02.07 김명섭 팀/본부 조회 시 판관CC 제외
                           <isNull col="UPJANG">
                           --AND A.CC_CD NOT IN (SELECT CC_CD FROM SCC_CC WHERE CST_PLNKGVRN_CLASS_CD = 'SG')
                           </isNull>
                           AND A.CC_CD = V.CC_CD(+)
                           AND A.PLAN_CLASS = 'MP'
                                
                           AND A.PLAN_YEAR = SUBSTR(#YYMM#, 1, 4) -- 입력 년
                           AND A.VER_CD= (SELECT MAX(VER_CD)
                                            FROM MAP_BPC_CONFIRM_PL_INFO
                                           WHERE PLAN_CLASS = A.PLAN_CLASS
                                             AND PLAN_YEAR = A.PLAN_YEAR
                                             AND CC_CD = A.CC_CD)
                           <isNotNull col="MU_CD">
                           AND V.MU_CD = #MU_CD#
                           </isNotNull>
		                            <isNotNull col="TM_CD">
		                                <isNotEqual col="HOMEPLUS" value="1"> 
		                                AND V.TM_CD LIKE #TM_CD# || '%'
		                                </isNotEqual>
		                            </isNotNull>
		                            <isNotNull col="UPJANG">
		                                <isNotEqual col="HOMEPLUS" value="1"> 
		                                AND V.UPJANG = #UPJANG#
		                                </isNotEqual>
		                                <isEqual col="HOMEPLUS" value="1"> 
 									     AND V.UPJANG    IN  (SELECT Z.CODE FROM SCC_COMMON_CODE Z WHERE Z.GROUP_CODE = 'UPJANG_GROUP' AND Z.USE_YN = 'Y' AND SET1 = #UPJANG#  )
 									    </isEqual>
		                            </isNotNull>
		                                                             --추가                           
                           AND  A.ACCT_CD = D.ACCTCD
                       ) A
                                                 
                 GROUP BY TM_CD, TM_NM, UPJANG, UPJANGNM, NEW_GUBUN_NAME, CC_CD, ACCT_TYPE
                  
                 --ORDER BY CC_CD, ACCT_TYPE
         )
         GROUP BY TM_CD, TM_NM, UPJANG, UPJANGNM, NEW_GUBUN_NAME
       ) T1
 WHERE UPJANG NOT IN (SELECT TO_NUMBER(CODE) FROM SCC_COMMON_CODE WHERE GROUP_CODE = 'MA0048' AND USE_YN = 'Y')        
   --2019.12.13 김명섭 블로킹대상자 조회 제외 업장 체크
   AND NOT EXISTS (SELECT 'x'
                     FROM SCC_COMMON_CODE CCODE1, SCC_COMMON_CODE CCODE2
                    WHERE CCODE1.GROUP_CODE = 'EXLDOWN_BLOCKING'
                      AND CCODE1.CODE = #UUSER#
                      AND CCODE1.USE_YN = 'Y'
                      AND CCODE2.GROUP_CODE = 'UPJANG_BLOCKING'
                      AND CCODE2.CODE = T1.UPJANG
                      AND CCODE2.USE_YN = 'Y')
 ORDER BY NEW_GUBUN_NAME DESC, TM_NM, UPJANG_NAME
</isEqual>
<isEqual col="DATA_CLASS" value="Y"> 
/* 재무-추정-전년 */
 SELECT DISTINCT TM_CD
      ,TM_NM TM_NAME
      --2018.07.27 김명섭 CC코드 중복 방지
      --,UPJANG
      ,UPJANGNM UPJANG_NAME
      --2019.02.14 김명섭 업장명 신규계획일 경우 신규로 구분
      --,DECODE(NEW_GUBUN_NAME, '신규', 'N', 'O') NEW_GUBUN
      --,NEW_GUBUN_NAME
      ,(CASE WHEN UPJANGNM LIKE '%신규계획%' THEN 'N' ELSE DECODE(NEW_GUBUN_NAME, '신규', 'N', 'O') END) AS NEW_GUBUN
      ,(CASE WHEN UPJANGNM LIKE '%신규계획%' THEN '신규' ELSE NEW_GUBUN_NAME END) AS NEW_GUBUN_NAME
      ,CC_CD
      ,P_TYPE_A AS SIMU_SALE_AMT  -- 계획 매출액
      --재료비, 노무비, 경비 추가  요청자 : 유영진   20160318  처리자 :맹수영
      ,P_TYPE_B AS SIMU_COST_AMT  -- 계획 재료비
      ,P_TYPE_C AS SIMU_LABOR_AMT  -- 계획 노무비
      ,P_TYPE_D AS SIMU_EXP_AMT  -- 계획 경비
      ,(P_TYPE_A - (P_TYPE_B + P_TYPE_C + P_TYPE_D)) AS SIMU_SALE_PROFIT -- 계획 매출이익
      ,R_TYPE_A AS SALE_AMT -- 실적 매출액
      ,ROUND(R_TYPE_B) AS COST_AMT -- 실적 재료비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_B/R_TYPE_A*100),1) AS COST_RATE -- 실적 매출 비율
      ,R_TYPE_C AS LABOR_AMT -- 실적 노무비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_C/R_TYPE_A*100),1) AS LABOR_RATE -- 실적 노무비 비율
      ,R_TYPE_D AS EXP_AMT -- 실적 경비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_D/R_TYPE_A*100),1) AS EXP_RATE -- 실적 경비비율
      ,ROUND((R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))) AS SALE_PROFIT -- 실적 매출이익
      ,ROUND(DECODE(R_TYPE_A,0,0,(R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))/R_TYPE_A*100),1) AS SALE_PROFIT_RATE -- 매출이익 비율
      ,ROUND(DECODE(P_TYPE_A,0,0,R_TYPE_A/P_TYPE_A*100),1) AS SIMU_SALE_DIFF_RATE -- 실적 매출액(%)
      ,((P_TYPE_A - (P_TYPE_B + P_TYPE_C + P_TYPE_D)) - (R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))) AS SIMU_PROFIT_DIFF_AMT -- 매출 이익
      ,(SELECT CST_PLNKGVRN_CLASS_CD FROM SCC_CC WHERE CC_CD = T1.CC_CD) AS CC_GB
  FROM (
        SELECT TM_CD
              ,TM_NM
              ,UPJANG
              ,UPJANGNM
              ,NEW_GUBUN_NAME              
              ,MAX(DECODE(CC_CD, NULL, CC_CD, CC_CD)) CC_CD
              --MAX를 모두 sum으로 변경  20160519
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_A', P_MM_AMT, 0)) P_TYPE_A -- 계획 매출액
             -- ,MAX(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0)) P_TYPE_B -- 계획 재료비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_C', P_MM_AMT, 0)) P_TYPE_C -- 계획 노무비 
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_D', P_MM_AMT, 0)) P_TYPE_D -- 계획 경비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_A', R_MM_AMT, 0)) R_TYPE_A -- 실적 매출액
               
              --,MAX(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0)) P_TYPE_B -- 계획 재료비
             ,SUM(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0)) +SUM(DECODE(ACCT_TYPE, 'TYPE_E', P_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_F', P_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_G', P_MM_AMT, 0)  ) P_TYPE_B
            --  ,MAX(DECODE(ACCT_TYPE, 'TYPE_B', R_MM_AMT, 0)) R_TYPE_B -- 재무실적 재료비
            ,SUM(DECODE(ACCT_TYPE, 'TYPE_B', R_MM_AMT, 0)) +SUM(DECODE(ACCT_TYPE, 'TYPE_E', R_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_F', R_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_G', R_MM_AMT, 0)  ) R_TYPE_B
     
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_C', R_MM_AMT, 0)) R_TYPE_C -- 실적 노무비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_D', R_MM_AMT, 0)) R_TYPE_D -- 실적 경비
          FROM (
                 SELECT TM_CD
                       ,TM_NM
                       ,UPJANG
                       ,UPJANGNM
                       ,NEW_GUBUN_NAME
                       ,CC_CD
                       ,ACCT_TYPE
                       ,ROUND(SUM(P_MM_AMT) / 1000) AS P_MM_AMT
                       ,ROUND(SUM(R_MM_AMT) / 1000) AS R_MM_AMT
                      ,( SELECT  CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_MARGIN_RATE_01
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_MARGIN_RATE_02
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_MARGIN_RATE_03
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_MARGIN_RATE_04
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_MARGIN_RATE_05
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_MARGIN_RATE_06
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_MARGIN_RATE_07
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_MARGIN_RATE_08
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_MARGIN_RATE_09
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_MARGIN_RATE_10
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_MARGIN_RATE_11
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_MARGIN_RATE_12
                                 ELSE 0
                                 END
                            FROM MAP_MARGIN_RATE_MGMT
                           WHERE UPJANG = A.UPJANG
                             AND YY = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY')
                             AND CLASS = 'R'
                       ) R_MM_MR
                      ,( SELECT  CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_MARGIN_RATE_01
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_MARGIN_RATE_02
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_MARGIN_RATE_03
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_MARGIN_RATE_04
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_MARGIN_RATE_05
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_MARGIN_RATE_06
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_MARGIN_RATE_07
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_MARGIN_RATE_08
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_MARGIN_RATE_09
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_MARGIN_RATE_10
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_MARGIN_RATE_11
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_MARGIN_RATE_12
                                 ELSE 0
                                 END
                            FROM MAP_MARGIN_RATE_MGMT
                           WHERE UPJANG = A.UPJANG
                             AND YY = SUBSTR(#YYMM#, 1, 4)
                             AND CLASS = 'R'
                       ) R_MM_MR_2
                   FROM (
                        SELECT V.TM_CD
                              ,V.TM_NAME AS TM_NM
                              ,V.UPJANG
                              ,A.CC_NM AS UPJANGNM
                              ,(CASE WHEN V.OPEN_YY = SUBSTRB(#YYMM#,1,4) THEN '신규' -- OPEN_YY가 현재년과 같으면 신규.
                                ELSE '기존'
                                 END    
                               ) AS NEW_GUBUN_NAME
                              ,A.CC_CD
                              ,( CASE WHEN SUBSTR(A.ACCT_CD, 1, 2) = '41'  THEN 'TYPE_A'
                                      WHEN A.ACCT_CD = '98001010'  THEN 'TYPE_A'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42203'  THEN 'TYPE_B'
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진
                                   --   WHEN D.ACCTNM2  = '재료비'  THEN 'TYPE_B'
                                      
                                      
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '431' THEN 'TYPE_C'
                                      
                                      
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진                                      
                                      WHEN D.ACCTNM3 = '복리후생비(인건비성)' THEN 'TYPE_C' 
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' AND D.ACCTNM3 &lt;&gt; '복리후생비(인건비성)' THEN 'TYPE_D'
                                      --2018.01.16 김명섭 [SR201801_06318] 경비금액 내 내부원가 계정(98001510) 반영
                                      --WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002'  THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002' OR A.ACCT_CD = '98001510'  THEN 'TYPE_D'
                                      
                                   --   WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42202'  THEN 'TYPE_E'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42101'  THEN 'TYPE_F'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42201'  THEN 'TYPE_G'
                                  ELSE 'ETC'
                                   END
                               ) ACCT_TYPE
                              ,A.ACCT_CD
                                ,( CASE WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '01' THEN A.MM_AMT_01  -- 조회 월
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '02' THEN A.MM_AMT_02
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '03' THEN A.MM_AMT_03
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '04' THEN A.MM_AMT_04
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '05' THEN A.MM_AMT_05
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '06' THEN A.MM_AMT_06
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '07' THEN A.MM_AMT_07
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '08' THEN A.MM_AMT_08
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '09' THEN A.MM_AMT_09
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '10' THEN A.MM_AMT_10
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '11' THEN A.MM_AMT_11
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY') AND SUBSTR(#YYMM#, 5, 2) = '12' THEN A.MM_AMT_12
                                 ELSE 0
                                 END
                               ) P_MM_AMT -- 계획, 전년실적
                               ,0 R_MM_AMT
                          FROM MAP_UPJANG_PL A -- SAP 실적
							                --2018.04.25 김명섭 사업계획관리 개선: 동일CC 데이터중복 개선
                              --,MAC_UPJANG_V V
                              ,(SELECT DISTINCT NVL(T2.ATTR01,T1.UPJANG) AS UPJANG, NVL(T2.CODE_NAME,T1.UPJANGNM) AS UPJANGNM,
                                       MU_CD,MU_NAME,SC_CD,SC_NAME,TM_CD,TM_NAME,PT_CD,PT_NAME,CC_CD,CC_NAME,OPEN_YY
                                  FROM MAC_UPJANG_V T1
                                LEFT OUTER JOIN SCC_COMMON_CODE T2
                                  ON T2.CODE = T1.CC_CD
                                 AND T2.GROUP_CODE = 'MAG20001S') V
                              --추가  
                              , MAS_ST_ACCOUNT D
                         WHERE 1 = 1
                           --2019.02.07 김명섭 팀/본부 조회 시 판관CC 제외
                           <isNull col="UPJANG">
                           --AND A.CC_CD NOT IN (SELECT CC_CD FROM SCC_CC WHERE CST_PLNKGVRN_CLASS_CD = 'SG')
                           </isNull>
                           AND A.CC_CD = V.CC_CD(+)
                           AND A.PL_CLASS = 'KS'
                                
                           AND A.FISCAL_YEAR IN (SUBSTR(#YYMM#, 1, 4), TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-12),'YYYY')) -- 입력 년
                           <isNotNull col="MU_CD">
                           AND V.MU_CD = #MU_CD#
                           </isNotNull>
		                            <isNotNull col="TM_CD">
		                                <isNotEqual col="HOMEPLUS" value="1"> 
		                                AND V.TM_CD LIKE #TM_CD# || '%'
		                                </isNotEqual>
		                            </isNotNull>
		                            <isNotNull col="UPJANG">
		                                <isNotEqual col="HOMEPLUS" value="1"> 
		                                AND V.UPJANG = #UPJANG#
		                                </isNotEqual>
		                                <isEqual col="HOMEPLUS" value="1"> 
 									     AND V.UPJANG    IN  (SELECT Z.CODE FROM SCC_COMMON_CODE Z WHERE Z.GROUP_CODE = 'UPJANG_GROUP' AND Z.USE_YN = 'Y' AND SET1 = #UPJANG#  )
 									    </isEqual>
		                            </isNotNull>
		                                                             --추가                           
                           AND  A.ACCT_CD = D.ACCTCD
                           
                        UNION ALL
                        
                        SELECT V.TM_CD
                              ,V.TM_NAME AS TM_NM
                              ,V.UPJANG
                              ,V.CC_NAME AS UPJANGNM
                              ,(CASE WHEN V.OPEN_YY = SUBSTRB(#YYMM#,1,4) THEN '신규' -- OPEN_YY가 현재년과 같으면 신규.
                                ELSE '기존'
                                 END    
                               ) AS NEW_GUBUN_NAME
                              ,A.CC_CD
                              ,( CASE WHEN SUBSTR(A.ACCT_CD, 1, 2) = '41'  THEN 'TYPE_A'
                                      WHEN A.ACCT_CD = '98001010'  THEN 'TYPE_A'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42203'  THEN 'TYPE_B'
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진
                                   --   WHEN D.ACCTNM2  = '재료비'  THEN 'TYPE_B'
                                      
                                      
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '431' THEN 'TYPE_C'
                                      
                                      
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진                                      
                                      WHEN D.ACCTNM3 = '복리후생비(인건비성)' THEN 'TYPE_C' 
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' AND D.ACCTNM3 &lt;&gt; '복리후생비(인건비성)' THEN 'TYPE_D'
                                      --2018.01.16 김명섭 [SR201801_06318] 경비금액 내 내부원가 계정(98001510) 반영
                                      --WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002'  THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002' OR A.ACCT_CD = '98001510'  THEN 'TYPE_D'
                                      
                                   --   WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42202'  THEN 'TYPE_E'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42101'  THEN 'TYPE_F'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42201'  THEN 'TYPE_G'
                                  ELSE 'ETC'
                                   END
                               ) ACCT_TYPE
                              ,A.ACCT_CD
                                ,0 P_MM_AMT -- 계획, 전년실적
                               ,( CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_AMT_01  -- 조회 월
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_AMT_02
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_AMT_03
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_AMT_04
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_AMT_05
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_AMT_06
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_AMT_07
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_AMT_08
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_AMT_09
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_AMT_10
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_AMT_11
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_AMT_12
                                  ELSE 0
                                  END
                               ) R_MM_AMT
                          FROM MAP_BPC_CONFIRM_PL_INFO A -- SAP 실적
							                --2018.04.25 김명섭 사업계획관리 개선: 동일CC 데이터중복 개선
                              --,MAC_UPJANG_V V
                              ,(SELECT DISTINCT NVL(T2.ATTR01,T1.UPJANG) AS UPJANG, NVL(T2.CODE_NAME,T1.UPJANGNM) AS UPJANGNM,
                                       MU_CD,MU_NAME,SC_CD,SC_NAME,TM_CD,TM_NAME,PT_CD,PT_NAME,CC_CD,CC_NAME,OPEN_YY
                                  FROM MAC_UPJANG_V T1
                                LEFT OUTER JOIN SCC_COMMON_CODE T2
                                  ON T2.CODE = T1.CC_CD
                                 AND T2.GROUP_CODE = 'MAG20001S') V
                              --추가  
                              , MAS_ST_ACCOUNT D
                         WHERE 1 = 1
                           --2019.02.07 김명섭 팀/본부 조회 시 판관CC 제외
                           <isNull col="UPJANG">
                           --AND A.CC_CD NOT IN (SELECT CC_CD FROM SCC_CC WHERE CST_PLNKGVRN_CLASS_CD = 'SG')
                           </isNull>
                           AND A.CC_CD = V.CC_CD(+)
                           AND A.PLAN_CLASS = 'MP'
                           AND A.PLAN_YEAR = SUBSTR(#YYMM#, 1, 4) -- 입력 년
                           AND A.VER_CD= (SELECT MAX(VER_CD)
                                            FROM MAP_BPC_CONFIRM_PL_INFO
                                           WHERE PLAN_CLASS = A.PLAN_CLASS
                                             AND PLAN_YEAR = A.PLAN_YEAR
                                             AND CC_CD = A.CC_CD)
                           <isNotNull col="MU_CD">
                           AND V.MU_CD = #MU_CD#
                           </isNotNull>
                            <isNotNull col="TM_CD">
                                <isNotEqual col="HOMEPLUS" value="1"> 
                                AND V.TM_CD LIKE #TM_CD# || '%'
                                </isNotEqual>
                            </isNotNull>
                            <isNotNull col="UPJANG">
                                <isNotEqual col="HOMEPLUS" value="1"> 
                                AND V.UPJANG = #UPJANG#
                                </isNotEqual>
                                <isEqual col="HOMEPLUS" value="1"> 
  						                  AND V.UPJANG    IN  (SELECT Z.CODE FROM SCC_COMMON_CODE Z WHERE Z.GROUP_CODE = 'UPJANG_GROUP' AND Z.USE_YN = 'Y' AND SET1 = #UPJANG#  )
  						                  </isEqual>
                            </isNotNull>
                           AND  A.ACCT_CD = D.ACCTCD
                        
                       ) A
                                                 
                 GROUP BY TM_CD, TM_NM, UPJANG, UPJANGNM, NEW_GUBUN_NAME, CC_CD, ACCT_TYPE
                  
                 --ORDER BY CC_CD, ACCT_TYPE
         )
         GROUP BY TM_CD, TM_NM, UPJANG, UPJANGNM, NEW_GUBUN_NAME
       ) T1
 WHERE UPJANG NOT IN (SELECT TO_NUMBER(CODE) FROM SCC_COMMON_CODE WHERE GROUP_CODE = 'MA0048' AND USE_YN = 'Y')        
   --2019.12.13 김명섭 블로킹대상자 조회 제외 업장 체크
   AND NOT EXISTS (SELECT 'x'
                     FROM SCC_COMMON_CODE CCODE1, SCC_COMMON_CODE CCODE2
                    WHERE CCODE1.GROUP_CODE = 'EXLDOWN_BLOCKING'
                      AND CCODE1.CODE = #UUSER#
                      AND CCODE1.USE_YN = 'Y'
                      AND CCODE2.GROUP_CODE = 'UPJANG_BLOCKING'
                      AND CCODE2.CODE = T1.UPJANG
                      AND CCODE2.USE_YN = 'Y')
 ORDER BY NEW_GUBUN_NAME DESC, TM_NM, UPJANG_NAME
</isEqual>
<isEqual col="DATA_CLASS" value="M"> 
/* 재무-추정-전월 */
 SELECT DISTINCT TM_CD
      ,TM_NM TM_NAME
      --2018.07.27 김명섭 CC코드 중복 방지
      --,UPJANG
      ,UPJANGNM UPJANG_NAME
      --2019.02.14 김명섭 업장명 신규계획일 경우 신규로 구분
      --,DECODE(NEW_GUBUN_NAME, '신규', 'N', 'O') NEW_GUBUN
      --,NEW_GUBUN_NAME
      ,(CASE WHEN UPJANGNM LIKE '%신규계획%' THEN 'N' ELSE DECODE(NEW_GUBUN_NAME, '신규', 'N', 'O') END) AS NEW_GUBUN
      ,(CASE WHEN UPJANGNM LIKE '%신규계획%' THEN '신규' ELSE NEW_GUBUN_NAME END) AS NEW_GUBUN_NAME
      ,CC_CD
      ,P_TYPE_A AS SIMU_SALE_AMT  -- 계획 매출액
      --재료비, 노무비, 경비 추가  요청자 : 유영진   20160318  처리자 :맹수영
      ,P_TYPE_B AS SIMU_COST_AMT  -- 계획 재료비
      ,P_TYPE_C AS SIMU_LABOR_AMT  -- 계획 노무비
      ,P_TYPE_D AS SIMU_EXP_AMT  -- 계획 경비
      ,(P_TYPE_A - (P_TYPE_B + P_TYPE_C + P_TYPE_D)) AS SIMU_SALE_PROFIT -- 계획 매출이익
      ,R_TYPE_A AS SALE_AMT -- 실적 매출액
      ,ROUND(R_TYPE_B) AS COST_AMT -- 실적 재료비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_B/R_TYPE_A*100),1) AS COST_RATE -- 실적 매출 비율
      ,R_TYPE_C AS LABOR_AMT -- 실적 노무비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_C/R_TYPE_A*100),1) AS LABOR_RATE -- 실적 노무비 비율
      ,R_TYPE_D AS EXP_AMT -- 실적 경비
      ,ROUND(DECODE(R_TYPE_A,0,0,R_TYPE_D/R_TYPE_A*100),1) AS EXP_RATE -- 실적 경비비율
      ,ROUND((R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))) AS SALE_PROFIT -- 실적 매출이익
      ,ROUND(DECODE(R_TYPE_A,0,0,(R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))/R_TYPE_A*100),1) AS SALE_PROFIT_RATE -- 매출이익 비율
      ,ROUND(DECODE(P_TYPE_A,0,0,R_TYPE_A/P_TYPE_A*100),1) AS SIMU_SALE_DIFF_RATE -- 실적 매출액(%)
      ,((P_TYPE_A - (P_TYPE_B + P_TYPE_C + P_TYPE_D)) - (R_TYPE_A - (R_TYPE_B + R_TYPE_C + R_TYPE_D))) AS SIMU_PROFIT_DIFF_AMT -- 매출 이익
      ,(SELECT CST_PLNKGVRN_CLASS_CD FROM SCC_CC WHERE CC_CD = T1.CC_CD) AS CC_GB
  FROM (
        SELECT TM_CD
              ,TM_NM
              ,UPJANG
              ,UPJANGNM
              ,NEW_GUBUN_NAME              
              ,MAX(DECODE(CC_CD, NULL, CC_CD, CC_CD)) CC_CD
              --MAX를 모두 sum으로 변경  20160519
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_A', P_MM_AMT, 0)) P_TYPE_A -- 계획 매출액
             -- ,MAX(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0)) P_TYPE_B -- 계획 재료비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_C', P_MM_AMT, 0)) P_TYPE_C -- 계획 노무비 
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_D', P_MM_AMT, 0)) P_TYPE_D -- 계획 경비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_A', R_MM_AMT, 0)) R_TYPE_A -- 실적 매출액
               
              --,MAX(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0)) P_TYPE_B -- 계획 재료비
             ,SUM(DECODE(ACCT_TYPE, 'TYPE_B', P_MM_AMT, 0)) +SUM(DECODE(ACCT_TYPE, 'TYPE_E', P_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_F', P_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_G', P_MM_AMT, 0)  ) P_TYPE_B
            --  ,MAX(DECODE(ACCT_TYPE, 'TYPE_B', R_MM_AMT, 0)) R_TYPE_B -- 재무실적 재료비
            ,SUM(DECODE(ACCT_TYPE, 'TYPE_B', R_MM_AMT, 0)) +SUM(DECODE(ACCT_TYPE, 'TYPE_E', R_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_F', R_MM_AMT, 0)  ) + SUM(DECODE(ACCT_TYPE, 'TYPE_G', R_MM_AMT, 0)  ) R_TYPE_B
     
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_C', R_MM_AMT, 0)) R_TYPE_C -- 실적 노무비
              ,SUM(DECODE(ACCT_TYPE, 'TYPE_D', R_MM_AMT, 0)) R_TYPE_D -- 실적 경비
          FROM (
                 SELECT TM_CD
                       ,TM_NM
                       ,UPJANG
                       ,UPJANGNM
                       ,NEW_GUBUN_NAME
                       ,CC_CD
                       ,ACCT_TYPE
                       ,ROUND(SUM(P_MM_AMT) / 1000) AS P_MM_AMT
                       ,ROUND(SUM(R_MM_AMT) / 1000) AS R_MM_AMT
                      ,( SELECT  CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_MARGIN_RATE_01
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_MARGIN_RATE_02
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_MARGIN_RATE_03
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_MARGIN_RATE_04
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_MARGIN_RATE_05
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_MARGIN_RATE_06
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_MARGIN_RATE_07
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_MARGIN_RATE_08
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_MARGIN_RATE_09
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_MARGIN_RATE_10
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_MARGIN_RATE_11
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_MARGIN_RATE_12
                                 ELSE 0
                                 END
                            FROM MAP_MARGIN_RATE_MGMT
                           WHERE UPJANG = A.UPJANG
                             AND YY = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY')
                             AND CLASS = 'R'
                       ) R_MM_MR
                      ,( SELECT  CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_MARGIN_RATE_01
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_MARGIN_RATE_02
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_MARGIN_RATE_03
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_MARGIN_RATE_04
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_MARGIN_RATE_05
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_MARGIN_RATE_06
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_MARGIN_RATE_07
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_MARGIN_RATE_08
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_MARGIN_RATE_09
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_MARGIN_RATE_10
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_MARGIN_RATE_11
                                      WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_MARGIN_RATE_12
                                 ELSE 0
                                 END
                            FROM MAP_MARGIN_RATE_MGMT
                           WHERE UPJANG = A.UPJANG
                             AND YY = SUBSTR(#YYMM#, 1, 4)
                             AND CLASS = 'R'
                       ) R_MM_MR_2
                   FROM (
                        SELECT V.TM_CD
                              ,V.TM_NAME AS TM_NM
                              ,V.UPJANG
                              ,A.CC_NM AS UPJANGNM
                              ,(CASE WHEN V.OPEN_YY = SUBSTRB(#YYMM#,1,4) THEN '신규' -- OPEN_YY가 현재년과 같으면 신규.
                                ELSE '기존'
                                 END    
                               ) AS NEW_GUBUN_NAME
                              ,A.CC_CD
                              ,( CASE WHEN SUBSTR(A.ACCT_CD, 1, 2) = '41'  THEN 'TYPE_A'
                                      WHEN A.ACCT_CD = '98001010'  THEN 'TYPE_A'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42203'  THEN 'TYPE_B'
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진
                                   --   WHEN D.ACCTNM2  = '재료비'  THEN 'TYPE_B'
                                      
                                      
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '431' THEN 'TYPE_C'
                                      
                                      
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진                                      
                                      WHEN D.ACCTNM3 = '복리후생비(인건비성)' THEN 'TYPE_C' 
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' AND D.ACCTNM3 &lt;&gt; '복리후생비(인건비성)' THEN 'TYPE_D'
                                      --2018.01.16 김명섭 [SR201801_06318] 경비금액 내 내부원가 계정(98001510) 반영
                                      --WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002'  THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002' OR A.ACCT_CD = '98001510'  THEN 'TYPE_D'
                                      
                                   --   WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42202'  THEN 'TYPE_E'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42101'  THEN 'TYPE_F'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42201'  THEN 'TYPE_G'
                                  ELSE 'ETC'
                                   END
                               ) ACCT_TYPE
                              ,A.ACCT_CD
                               ,( CASE WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '01' THEN A.MM_AMT_01  -- 조회 월
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '02' THEN A.MM_AMT_02
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '03' THEN A.MM_AMT_03
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '04' THEN A.MM_AMT_04
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '05' THEN A.MM_AMT_05
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '06' THEN A.MM_AMT_06
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '07' THEN A.MM_AMT_07
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '08' THEN A.MM_AMT_08
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '09' THEN A.MM_AMT_09
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '10' THEN A.MM_AMT_10
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '11' THEN A.MM_AMT_11
                                      WHEN FISCAL_YEAR = TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY') AND TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'MM') = '12' THEN A.MM_AMT_12
                                 ELSE 0
                                 END
                               ) P_MM_AMT -- 조회월 실적
                               ,0 R_MM_AMT
                          FROM MAP_UPJANG_PL A -- SAP 실적
							                --2018.04.25 김명섭 사업계획관리 개선: 동일CC 데이터중복 개선
                              --,MAC_UPJANG_V V
                              ,(SELECT DISTINCT NVL(T2.ATTR01,T1.UPJANG) AS UPJANG, NVL(T2.CODE_NAME,T1.UPJANGNM) AS UPJANGNM,
                                       MU_CD,MU_NAME,SC_CD,SC_NAME,TM_CD,TM_NAME,PT_CD,PT_NAME,CC_CD,CC_NAME,OPEN_YY
                                  FROM MAC_UPJANG_V T1
                                LEFT OUTER JOIN SCC_COMMON_CODE T2
                                  ON T2.CODE = T1.CC_CD
                                 AND T2.GROUP_CODE = 'MAG20001S') V
                              --추가  
                              , MAS_ST_ACCOUNT D
                         WHERE 1 = 1
                           --2019.02.07 김명섭 팀/본부 조회 시 판관CC 제외
                           <isNull col="UPJANG">
                           --AND A.CC_CD NOT IN (SELECT CC_CD FROM SCC_CC WHERE CST_PLNKGVRN_CLASS_CD = 'SG')
                           </isNull>
                           AND A.CC_CD = V.CC_CD(+)
                           AND A.PL_CLASS = 'KS'
                                
                           AND A.FISCAL_YEAR IN (SUBSTR(#YYMM#, 1, 4), TO_CHAR(ADD_MONTHS(TO_DATE(#YYMM#,'YYYYMM'),-1),'YYYY')) -- 입력 년
                           <isNotNull col="MU_CD">
                           AND V.MU_CD = #MU_CD#
                           </isNotNull>
		                            <isNotNull col="TM_CD">
		                                <isNotEqual col="HOMEPLUS" value="1"> 
		                                AND V.TM_CD LIKE #TM_CD# || '%'
		                                </isNotEqual>
		                            </isNotNull>
		                            <isNotNull col="UPJANG">
		                                <isNotEqual col="HOMEPLUS" value="1"> 
		                                AND V.UPJANG = #UPJANG#
		                                </isNotEqual>
		                                <isEqual col="HOMEPLUS" value="1"> 
 									     AND V.UPJANG    IN  (SELECT Z.CODE FROM SCC_COMMON_CODE Z WHERE Z.GROUP_CODE = 'UPJANG_GROUP' AND Z.USE_YN = 'Y' AND SET1 = #UPJANG#  )
 									    </isEqual>
		                            </isNotNull>
		                                                             --추가                           
                           AND  A.ACCT_CD = D.ACCTCD
                           
                        UNION ALL
                        
                        SELECT V.TM_CD
                              ,V.TM_NAME AS TM_NM
                              ,V.UPJANG
                              ,V.CC_NAME AS UPJANGNM
                              ,(CASE WHEN V.OPEN_YY = SUBSTRB(#YYMM#,1,4) THEN '신규' -- OPEN_YY가 현재년과 같으면 신규.
                                ELSE '기존'
                                 END    
                               ) AS NEW_GUBUN_NAME
                              ,A.CC_CD
                              ,( CASE WHEN SUBSTR(A.ACCT_CD, 1, 2) = '41'  THEN 'TYPE_A'
                                      WHEN A.ACCT_CD = '98001010'  THEN 'TYPE_A'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42203'  THEN 'TYPE_B'
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진
                                   --   WHEN D.ACCTNM2  = '재료비'  THEN 'TYPE_B'
                                      
                                      
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '431' THEN 'TYPE_C'
                                      
                                      
                                      --손익양식 변경에 따른 변경 20160314 맹수영 요청자:유영진                                      
                                      WHEN D.ACCTNM3 = '복리후생비(인건비성)' THEN 'TYPE_C' 
                                      WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' AND D.ACCTNM3 &lt;&gt; '복리후생비(인건비성)' THEN 'TYPE_D'
                                      --2018.01.16 김명섭 [SR201801_06318] 경비금액 내 내부원가 계정(98001510) 반영
                                      --WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002'  THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '98002' OR A.ACCT_CD = '98001510'  THEN 'TYPE_D'
                                      
                                   --   WHEN SUBSTR(A.ACCT_CD, 1, 3) = '432' THEN 'TYPE_D'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42202'  THEN 'TYPE_E'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42101'  THEN 'TYPE_F'
                                      WHEN SUBSTR(A.ACCT_CD, 1, 5) = '42201'  THEN 'TYPE_G'
                                  ELSE 'ETC'
                                   END
                               ) ACCT_TYPE
                              ,A.ACCT_CD
                               ,0 P_MM_AMT -- 조회월 실적
                               ,( CASE WHEN SUBSTR(#YYMM#, 5, 2) = '01' THEN MM_AMT_01  -- 조회 월
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '02' THEN MM_AMT_02
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '03' THEN MM_AMT_03
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '04' THEN MM_AMT_04
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '05' THEN MM_AMT_05
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '06' THEN MM_AMT_06
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '07' THEN MM_AMT_07
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '08' THEN MM_AMT_08
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '09' THEN MM_AMT_09
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '10' THEN MM_AMT_10
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '11' THEN MM_AMT_11
                                       WHEN SUBSTR(#YYMM#, 5, 2) = '12' THEN MM_AMT_12
                                  ELSE 0
                                  END
                               ) R_MM_AMT
                          FROM MAP_BPC_CONFIRM_PL_INFO A -- SAP 실적
							                --2018.04.25 김명섭 사업계획관리 개선: 동일CC 데이터중복 개선
                              --,MAC_UPJANG_V V
                              ,(SELECT DISTINCT NVL(T2.ATTR01,T1.UPJANG) AS UPJANG, NVL(T2.CODE_NAME,T1.UPJANGNM) AS UPJANGNM,
                                       MU_CD,MU_NAME,SC_CD,SC_NAME,TM_CD,TM_NAME,PT_CD,PT_NAME,CC_CD,CC_NAME,OPEN_YY
                                  FROM MAC_UPJANG_V T1
                                LEFT OUTER JOIN SCC_COMMON_CODE T2
                                  ON T2.CODE = T1.CC_CD
                                 AND T2.GROUP_CODE = 'MAG20001S') V
                              --추가  
                              , MAS_ST_ACCOUNT D
                         WHERE 1 = 1
                           --2019.02.07 김명섭 팀/본부 조회 시 판관CC 제외
                           <isNull col="UPJANG">
                           --AND A.CC_CD NOT IN (SELECT CC_CD FROM SCC_CC WHERE CST_PLNKGVRN_CLASS_CD = 'SG')
                           </isNull>
                           AND A.CC_CD = V.CC_CD(+)
                           AND A.PLAN_CLASS = 'MP'
                           AND A.PLAN_YEAR = SUBSTR(#YYMM#, 1, 4) -- 입력 년
                           AND A.VER_CD= (SELECT MAX(VER_CD)
                                            FROM MAP_BPC_CONFIRM_PL_INFO
                                           WHERE PLAN_CLASS = A.PLAN_CLASS
                                             AND PLAN_YEAR = A.PLAN_YEAR
                                             AND CC_CD = A.CC_CD)
                           <isNotNull col="MU_CD">
                           AND V.MU_CD = #MU_CD#
                           </isNotNull>
                            <isNotNull col="TM_CD">
                                <isNotEqual col="HOMEPLUS" value="1"> 
                                AND V.TM_CD LIKE #TM_CD# || '%'
                                </isNotEqual>
                            </isNotNull>
                            <isNotNull col="UPJANG">
                                <isNotEqual col="HOMEPLUS" value="1"> 
                                AND V.UPJANG = #UPJANG#
                                </isNotEqual>
                                <isEqual col="HOMEPLUS" value="1"> 
  						                  AND V.UPJANG    IN  (SELECT Z.CODE FROM SCC_COMMON_CODE Z WHERE Z.GROUP_CODE = 'UPJANG_GROUP' AND Z.USE_YN = 'Y' AND SET1 = #UPJANG#  )
  						                  </isEqual>
                            </isNotNull>
                           AND  A.ACCT_CD = D.ACCTCD
                        
                       ) A
                                                 
                 GROUP BY TM_CD, TM_NM, UPJANG, UPJANGNM, NEW_GUBUN_NAME, CC_CD, ACCT_TYPE
                  
                 --ORDER BY CC_CD, ACCT_TYPE
         )
         GROUP BY TM_CD, TM_NM, UPJANG, UPJANGNM, NEW_GUBUN_NAME
       ) T1
 WHERE UPJANG NOT IN (SELECT TO_NUMBER(CODE) FROM SCC_COMMON_CODE WHERE GROUP_CODE = 'MA0048' AND USE_YN = 'Y')        
   --2019.12.13 김명섭 블로킹대상자 조회 제외 업장 체크
   AND NOT EXISTS (SELECT 'x'
                     FROM SCC_COMMON_CODE CCODE1, SCC_COMMON_CODE CCODE2
                    WHERE CCODE1.GROUP_CODE = 'EXLDOWN_BLOCKING'
                      AND CCODE1.CODE = #UUSER#
                      AND CCODE1.USE_YN = 'Y'
                      AND CCODE2.GROUP_CODE = 'UPJANG_BLOCKING'
                      AND CCODE2.CODE = T1.UPJANG
                      AND CCODE2.USE_YN = 'Y')
 ORDER BY NEW_GUBUN_NAME DESC, TM_NM, UPJANG_NAME
</isEqual>
</isEqual>
</isEqual>

	</statement>
	<input default-name="ds_in">
	   <col name="YYMM" size="6" type="VARCHAR" description="" />
	   <col name="DATA_CLASS" size="1" type="VARCHAR" description="" />
	   <col name="MU_CD" size="10" type="VARCHAR" description="부서" /> 
	   <col name="TM_CD" size="10" type="VARCHAR" description="팀" />
	   <col name="UPJANG" size="10" type="VARCHAR" description="업장" />
	   <col name="SUB_JOB_CD" size="10" type="VARCHAR" description="" /> 
	   <col name="LOC_CD" size="10" type="VARCHAR" description="" />
	   <col name="NEW_GUBUN" size="10" type="VARCHAR" description="" /> 
	   <col name="CLOSE_TYPE" size="10" type="VARCHAR" description="" /> 
	   <col name="SALE_TYPE" size="10" type="VARCHAR" description="" /> 
	   <col name="UUSER" size="255" type="VARCHAR" description="" />
	</input>
	<output default-name="ds_out">
	   <col name="TM_CD" size="3" type="VARCHAR" description="" />
	   <col name="TM_NAME" size="100" type="VARCHAR" description="" />
	   <col name="UPJANG" size="6" type="VARCHAR" description="" />
	   <col name="UPJANG_NAME" size="100" type="VARCHAR" description="" />
	   <col name="NEW_GUBUN" size="10" type="VARCHAR" description="" />
	   <col name="NEW_GUBUN_NAME" size="10" type="VARCHAR" description="" />
	   <col name="SIMU_SALE_AMT" size="22" type="NUMERIC" description="" /> 
	   <col name="SIMU_SALE_PROFIT" size="22" type="NUMERIC" description="" />
	   <col name="SALE_AMT" size="22" type="NUMERIC" description="" />
	   <col name="COST_AMT" size="22" type="NUMERIC" description="" />
	   <col name="COST_RATE" size="22" type="NUMERIC" description="" />
	   <col name="LABOR_AMT" size="22" type="NUMERIC" description="" />
	   <col name="LABOR_RATE" size="22" type="NUMERIC" description="" />
	   <col name="EXP_AMT" size="22" type="NUMERIC" description="" />
	   <col name="EXP_RATE" size="22" type="NUMERIC" description="" />
	   <col name="SALE_PROFIT" size="22" type="NUMERIC" description="" />
	   <col name="SALE_PROFIT_RATE" size="22" type="NUMERIC" description="" />
	   <col name="SIMU_SALE_DIFF_RATE" size="22" type="NUMERIC" description="" />
	   <col name="SIMU_PROFIT_DIFF_AMT" size="22" type="NUMERIC" description="" />
	 </output>
</query>