<?xml version="1.0" encoding="UTF-8"?>
<hqml xmlns="http://hone.hanwha.co.kr/schema/hqml"
	name="sc.app.mainDAO">
	<desc>FC POS 마스터 외부 인터페이스 HQML</desc>









	<statement name="selectTest"><![CDATA[SELECT '1' AS CHECK_NUM
  FROM DUAL]]></statement>
	<statement name="logInsert"><![CDATA[INSERT INTO APP_INTERFACE_LOG(
INSDT,
TXID,
TXDIV,
TXHEADER,
TXDATA,
TXRESULT)
VALUES(
TO_CHAR(SYSDATE,'YYYY-MM-DD HH24:MI:SS'),
<#if txId?has_content >:txId,<#else>null,</#if> 
<#if txDiv?has_content >:txDiv,<#else>null,</#if> 
<#if tHeader?has_content >:tHeader,<#else>null,</#if> 
<#if tData?has_content >:tData,<#else>null,</#if> 
<#if tResult?has_content >:tResult<#else>null</#if> 
)]]></statement>
	<statement name="selectUpjang"><![CDATA[
SELECT T1.UPJANG AS UPJANG_CD,
       (SELECT NM_KOR FROM SCC_USERINFO WHERE SABUN = T3.PART_SALES_SABUN) AS SALES_NM, --담당영업사원
       SC_CRYPTO_FUN('DEC',T3.PART_SALES_TEL_NO_ENC) AS SALES_TELNO, --담당영업사원전화번호
       (SELECT NM_KOR FROM SCC_USERINFO WHERE SABUN = T3.CS_SABUN) AS CS_NM, --CS사원
       SC_CRYPTO_FUN('DEC',T3.CS_TEL_NO_ENC) AS CS_TELNO, --CS전화번호
       (SELECT BANKNM FROM HLDC_ST_BANK WHERE BANKCD = T3.BANK_CD) BANK_NM,
       SC_CRYPTO_FUN('DEC',T3.ACNTCD_ENC) AS VACCT_NO,--가상계좌
       T3.BANK_DRNM,--예금주
       (SELECT CENTER_CODE FROM HLDC_PO_UPJANG_CENTER WHERE UPJANG = T2.AP_UNITPRICE_UPJANG) AS CENTER_CODE,
       (SELECT B.OPER_ORG_SN_PURC
          FROM HLDC_PO_UPJANG_CENTER A, HLDC_PO_CENTER B
         WHERE A.UPJANG = T2.AP_UNITPRICE_UPJANG
           AND A.CENTER_CODE = B.CENTER_CODE) AS OPER_ORG_SN_PURC,
       T2.AP_UNITPRICE_UPJANG,
       T3.OTCUST_PRICE_UPJANG,
       T3.D_DAYS,
       T3.D_TIMES,
       T3.D_OVER_DAYS,
       T3.QTY_CONTROL_YN,
       /* 추가구매승인여부 조회*/
       (SELECT 'Y' FROM FSA_PR_CHECK WHERE UPJANG = T1.UPJANG AND TO_CHAR(SYSDATE,'YYYYMMDD') BETWEEN START_DATE AND END_DATE AND APRV_YN = 'Y' AND ROWNUM <= 1) AS APPROVE_YN,
       /* 추가구매예외업장 조회*/
       (SELECT 'Y' FROM SCC_COMMON_CODE WHERE GROUP_CODE = 'FS0125' AND CODE = :upjangCd AND USE_YN = 'Y' AND ROWNUM <= 1) AS APPROVE_EXCEPT_YN,
       V.TEAM_MST_SABUN,
       (SELECT NM_KOR FROM HLDC_HR_PERSONAL WHERE SABUN = V.TEAM_MST_SABUN) TEAM_MST_SABUNNM,
       (CASE WHEN T3.DEPT_ID IN (SELECT CC_CD FROM HLDC_SC_DEPT_V WHERE BU_CD = '2000' AND MU_CD = '2004' AND TM_CD LIKE 'CI%') THEN 'B' --브랜드사업장
             WHEN T3.DEPT_ID IN (SELECT CC_CD FROM HLDC_SC_DEPT_V WHERE BU_CD = '2000' AND MU_CD = '2004' AND DEPT_ID IN (SELECT CODE FROM SCC_COMMON_CODE WHERE GROUP_CODE = 'BRAND_UPJANG_POP_ETC')) THEN 'M' --마트사업장
        ELSE '' END) AS ATTR01 --추가속성
  FROM (SELECT :upjangCd AS UPJANG
          FROM DUAL) T1,
       ST_UPJANG     T2,
       FMS_UPJANG    T3,
       SCO_UPJANG_MST V
 WHERE T1.UPJANG = T2.UPJANG(+)
   AND T1.UPJANG = T3.UPJANG(+)
   AND T1.UPJANG = V.UPJANG(+)]]></statement>
	<statement name="selectSubinv"><![CDATA[SELECT T1.SUBINV_CODE
     , T1.SUBINV_NAME
     , T1.D_DAYS
     , T1.D_TIMES
     , T2.STOCK_YN, T2.CONSUM_YN, T2.TAX_CODE, T2.SUBINV_CLASS
  FROM HLDC_PO_SUBINVENTORY T1, FMS_SUBINVENTORY T2, FMS_UPJANG T3
 WHERE T2.SUBINV_CODE = T1.SUBINV_CODE
   AND T2.SUBINV_CODE LIKE 'S1%'
   AND T2.UPJANG = :upjangCd
   AND T1.USE_YN = 'Y' 
   AND T2.USE_YN = 'Y'
   AND T2.UPJANG = T3.UPJANG
UNION ALL
SELECT A.SUBINV_CODE
     , A.SUBINV_NAME||' '||REPLACE(B.UPJANGNM,'단체급식 ') SUBINV_NAME
     , A.D_DAYS
     , A.D_TIMES
     , '' AS STOCK_YN
     , '' AS CONSUM_YN
     , '' AS TAX_CODE
     , '' AS SUBINV_CLASS
  FROM HLDC_PO_SUBINVENTORY A
     , ST_UPJANG B
 WHERE A.UPJANG = B.UPJANG
   AND A.USE_YN = 'Y'
   AND WH_CLS_CD = 'C0'
   AND B.UPJANG = :upjangCd
 ORDER BY 1]]></statement>
	<statement name="selectCtrlday"><![CDATA[
SELECT T1.CTRL_DATE
  FROM (
SELECT CTRL_DATE
  FROM FMP_ORD_CTRL_DAYS T1
 WHERE UPJANG = :upjangCd
   AND USE_YN = 'Y'
UNION
SELECT CTRL_DATE
  FROM FMP_ORD_CTRL_DAYS
 WHERE UPJANG = -1
   AND USE_YN = 'Y') T1, (SELECT NVL(MAX(D_OVER_DAYS),0) AS D_OVER_DAYS FROM FMS_UPJANG WHERE UPJANG = :upjangCd) T2
 WHERE 1=1
   AND T1.CTRL_DATE BETWEEN TO_CHAR(SYSDATE,'YYYYMMDD') AND TO_CHAR(SYSDATE+T2.D_OVER_DAYS,'YYYYMMDD')
ORDER BY 1]]></statement>
	<statement name="selectFsCtrlday"><![CDATA[
(SELECT NEED_DATE AS CTRL_DATE
  FROM FSP_HOLIDAY_UPJANG
WHERE NEED_DATE >= TO_CHAR(SYSDATE, 'YYYYMMDD')
GROUP BY NEED_DATE
MINUS
 SELECT NEED_DATE AS CTRL_DATE
 FROM FSP_HOLIDAY_UPJANG
 WHERE NEED_DATE >= TO_CHAR(SYSDATE, 'YYYYMMDD')
 AND UPJANG = :upjangCd)
UNION
SELECT TO_CHAR(SYSDATE + (LEVEL-1), 'YYYYMMDD') AS CTRL_DATE
  FROM HLDC_PO_TYPE_FS
 WHERE PO_TYPE = :poType
CONNECT BY LEVEL <= D_DAYS + (SELECT CASE WHEN TO_CHAR(SYSDATE,'HH24') >= D_TIMES THEN '1' ELSE '0' END FROM DUAL)
ORDER BY 1]]></statement>
	<statement name="selectCtrlord"><![CDATA[SELECT A.CTRL_TYPE||A.ITEM_TYPE AS CHK_TYPE, A.CTRL_TYPE, A.ITEM_TYPE
     , A.MON, A.TUE, A.WED, A.THU, A.FRI, A.SAT, A.SUN
  FROM FMP_ORD_CTRL A
 WHERE A.UPJANG = :upjangCd
   AND A.USE_YN = 'Y']]></statement>
	<statement name="selectOprate"><![CDATA[SELECT ITEM_CODE,
       ITEM_TYPE,
       SDATE,
       EDATE,
       OP_RATE,
       OP_PRICE,
       CEIL_VAL
  FROM FMU_OP_RATE
 WHERE UPJANG = :upjangCd
   AND :needDate BETWEEN SDATE AND EDATE
   AND USE_YN = 'Y'
   AND ITEM_TYPE IN ('M','C')]]></statement>
	<statement name="selectEvent"><![CDATA[SELECT A.EVENT_ID, A.EVENT_PRICE, A.APPLY_ED AS EVENT_ED, A.ITEM_CODE
      FROM (
            SELECT C.EVENT_ID
                 , C.EVENT_PRICE
                 , C.ITEM_CODE
                 , A.APPLY_ED
                 , ROW_NUMBER() OVER(partition by ITEM_CODE ORDER BY C.EVENT_PRICE ASC, A.APPLY_SD ASC, A.EVENT_ID ASC) AS RN
              FROM FMS_EVENT_MST         A  -- 행사관리(브랜드유통사업장)
                 , FMS_EVENT_UPJANG_MST  B  -- 행사관리 업장정보
                 , FMS_EVENT_ITEM_MST    C  -- 행사상품관리
                 , FMS_UPJANG            U1 --매출처업장관리
             WHERE A.EVENT_ID             = B.EVENT_ID
               AND A.EVENT_ID             = C.EVENT_ID
               AND B.UPJANG_CD            = U1.UPJANG
               AND :needDate           BETWEEN A.APPLY_SD -- 행사 행사적용일자
                                        AND A.APPLY_ED
               AND :needDate           BETWEEN B.APPLY_SD -- 업장 행사적용일자
                                        AND B.APPLY_ED
               AND A.USE_YN               = 'Y'         --이벤트 사용여부
               AND A.EVENT_STATUS         = 'N'         --이벤트 상태 ( N:정상 / H:보류 / C:취소 / E:오류 .. )
               AND B.USE_YN               = 'Y'         --업장 사용여부
               AND C.USE_YN               = 'Y'         --행사상품  사용여부
               AND U1.UPJANG              = :upjangCd    --업장
           ) A
     WHERE RN = 1]]></statement>
	<statement name="selectItemClass"><![CDATA[SELECT A.CLASS_CODE, A.CLASS_NAME, A.CLASS_TYPE
  FROM HLDC_PO_ITEM_CLASS_HLDC_V A
 WHERE 1=1
   AND A.USE_YN = 'Y'
   AND A.CLASS_CODE LIKE 'F%'
   AND A.CLASS_TYPE IN ('M', 'S', 'D') ORDER BY A.CLASS_TYPE, A.CLASS_CODE]]></statement>
	<statement name="selectOrdlimit"><![CDATA[SELECT ITEM_CODE
  FROM FMP_ORD_LIMIT
 WHERE UPJANG = :upjangCd
   AND :needDate BETWEEN SDATE AND EDATE
   AND USE_YN = 'Y']]></statement>
	<statement name="selectOrdSchdule"><![CDATA[/* 수발주 입고요일 제한 */
SELECT T2.CENTER_CODE,
       T2.UPJANG,
       T2.ITEM_CODE,
       T2.CUSTCD
  FROM (SELECT T1.UPJANG, T2.CENTER_CODE
          FROM ST_UPJANG T1, HLDC_PO_UPJANG_CENTER T2
         WHERE T1.UPJANG = :upjangCd
           AND T1.AP_UNITPRICE_UPJANG = T2.UPJANG) T1,
       FMP_ORDER_SCHEDULE T2
 WHERE T1.CENTER_CODE = T2.CENTER_CODE
   AND T1.UPJANG = T2.UPJANG
   AND T2.USE_YN = 'Y'
   AND DECODE(TO_CHAR(TO_DATE( :needDate ,'YYYYMMDD'),'D'),
       1,SUN,2,MON,3,TUE,4,WED,5,THU,6,FRI,7,SAT) = 'Y']]></statement>
	<statement name="selectLoan"><![CDATA[SELECT NVL(T4.CREDIT_AMOUNT,0) AS CREDIT_AMOUNT, /* 기본여신금액  */
       NVL(T4.CREDIT_OVER_AMOUNT,0) AS CREDIT_OVER_AMOUNT, /* 임시여신금액  */
       NVL(T4.CREDIT_RMN_AMT,0) AS CREDIT_RMN_AMT,
       NVL(T4.CREDIT_AMOUNT,0) - NVL(T4.CREDIT_RMN_AMT,0) AS BOND_AMT,
       NVL(T4.CREDIT_AMOUNT_CONTROL_YN,'N') AS CREDIT_CTRL_YN,
       NVL(T4.CREDIT_AVAIL_AMT,0) AS CREDIT_AVAIL_AMT, /* 실주문가능금액 */
       NVL(T4.CREDIT_TURN_CONTROL_YN,'N') AS CREDIT_TURN_CONTROL_YN, /* 'Y'이면 여신회전일통제, 'N'이면 '통제안함' */
       T4.LAST_TURN_CNT,
       T4.CREDIT_TURN_DAYS_TOT, /* 'Y'이면 여신회전일통제, 'N'이면 '통제안함' */
       T4.L_BILL_DATE_DISP /* 최장 미입금된 외상매출발생일 */
  FROM TABLE(FT_UPJANG_CREDIT_LIMIT(:upjangCd, :needDate)) T4]]></statement>
	<statement name="selectSubinv2"><![CDATA[SELECT GREATEST(NVL(T1.D_DAYS,0),NVL(T3.D_DAYS,0))
     + DECODE(NVL(T1.D_DAYS,0)+NVL(T3.D_DAYS,0),0,0,DECODE(T4.UPJ_CNT,0,NVL(T5.ALL_D,0),NVL(T4.UPJ_D,0))) AS D_DAYS
     , TO_CHAR(TO_DATE(TRIM(TO_CHAR(DECODE(SIGN(NVL(T1.D_DAYS,0)-NVL(T3.D_DAYS,0)),1,NVL(TO_NUMBER(T1.D_TIMES),0),0,LEAST(NVL(TO_NUMBER(T1.D_TIMES),0),NVL(TO_NUMBER(T3.D_TIMES),0)),NVL(TO_NUMBER(T3.D_TIMES),0)),'0000')),'HH24MI'),'HH24MI') AS D_TIMES
     , DECODE(GREATEST(NVL(T1.D_DAYS,0),NVL(T3.D_DAYS,0))+DECODE(NVL(T1.D_DAYS,0)+NVL(T3.D_DAYS,0),0,0,DECODE(T4.UPJ_CNT,0,NVL(T5.ALL_D,0),NVL(T4.UPJ_D,0))),0,'-','D-'||TO_CHAR(GREATEST(NVL(T1.D_DAYS,0),NVL(T3.D_DAYS,0))+DECODE(NVL(T1.D_DAYS,0)+NVL(T3.D_DAYS,0),0,0,DECODE(T4.UPJ_CNT,0,NVL(T5.ALL_D,0),NVL(T4.UPJ_D,0)))))
       ||' '||DECODE(GREATEST(NVL(T1.D_DAYS,0),NVL(T3.D_DAYS,0))+DECODE(NVL(T1.D_DAYS,0)+NVL(T3.D_DAYS,0),0,0,DECODE(T4.UPJ_CNT,0,NVL(T5.ALL_D,0),NVL(T4.UPJ_D,0))),0,'-',TO_CHAR(TO_DATE(TRIM(TO_CHAR(DECODE(SIGN(NVL(T1.D_DAYS,0)-NVL(T3.D_DAYS,0)),1,NVL(TO_NUMBER(T1.D_TIMES),0),0,LEAST(NVL(TO_NUMBER(T1.D_TIMES),0),NVL(TO_NUMBER(T3.D_TIMES),0)),NVL(TO_NUMBER(T3.D_TIMES),0)),'0000')),'HH24MI'),'HH24:MI')) AS DAYS
     , T6.SUBINV_AMT,T6.PO_AMT,T6.CONTROL_AMT,T6.CONTROL_YN,T6.NON_CTRL_AMT,T6.CHK_SAVE
  FROM HLDC_PO_SUBINVENTORY T1, FMS_SUBINVENTORY T2, FMS_UPJANG T3
     ,(SELECT COUNT(*) AS UPJ_CNT
            , SUM(DECODE(USE_YN,'Y',1,0)) AS UPJ_D
         FROM FMS_EXC_DAYS
        WHERE UPJANG = :upjangCd
          AND EXC_DATE BETWEEN TO_CHAR(SYSDATE,'YYYYMMDD') AND NVL(:needDate,TO_CHAR(SYSDATE,'YYYYMMDD'))) T4
     ,(SELECT COUNT(*) AS ALL_CNT
            , SUM(DECODE(USE_YN,'Y',1,0)) AS ALL_D
         FROM FMS_EXC_DAYS
        WHERE UPJANG = -1
          AND EXC_DATE BETWEEN TO_CHAR(SYSDATE,'YYYYMMDD') AND NVL(:needDate,TO_CHAR(SYSDATE,'YYYYMMDD'))) T5
     ,(SELECT * FROM TABLE(APP_SMLL_ORD_CTRL_FUN(:upjangCd, :needDate))) T6
 WHERE T2.SUBINV_CODE = T1.SUBINV_CODE
   AND T2.SUBINV_CODE = :subinvCd
   AND T2.UPJANG = :upjangCd
   AND T1.USE_YN = 'Y' 
   AND T2.USE_YN = 'Y'
   AND T2.UPJANG = T3.UPJANG
   AND T2.UPJANG = T6.UPJANG(+)
   AND T2.SUBINV_CODE = T6.SUBINV_CODE(+)]]></statement>
</hqml>
