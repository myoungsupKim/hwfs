<?xml version="1.0" encoding="utf-8"?>
<FDL version="1.4">
  <TypeDefinition url="../../../default_typedef.xml"/>
  <Form id="FMP00160E" onkeydown="fn_FormKeyDown" onload="form_onload" titletext="주요상품 발주" position="absolute 0 0 996 593" scrollbars="none" onactivate="FMP00160E_onactivate">
    <Layouts>
      <Layout>
        <Static id="Static00" class="sta_WFDA_Labelbg" position="absolute 0 112 981 139" anchor="left top right"/>
        <Static id="Static49" class="sta_WFDA_Labelbg" position="absolute 78 86 981 113" anchor="left top right"/>
        <Static id="Static08" class="sta_WFSA_Labelbg" position="absolute 0 30 981 71" anchor="left top right"/>
        <Static id="Static28" text="최종 발주정보" position="absolute 164 86 260 113" class="sta_WFDA_Label01"/>
        <Edit autoselect="true" enable="false" id="ed_Credit" taborder="6" tabstop="false" visible="false" position="absolute 531 89 646 110" style="align:right; :disabled {color:red;}" inputtype="number"/>
        <Combo codecolumn="SUBINV_CODE" datacolumn="SUBINV_NAME" displayrowcount="10" id="cbo_Subinv" imemode="native" innerdataset="ds_Subinv" onitemchanged="cbo_Subinv_OnChanged" type="filter" taborder="3" position="absolute 351 40 511 61"/>
        <Static id="Static23" text="최종발주일" position="absolute 0 86 82 113" class="sta_WFDA_Label01"/>
        <Static id="st_Credit" text="발주가능금액" visible="false" position="absolute 439 86 529 113" class="sta_WFDA_Label01"/>
        <Static id="st_Days" text="발주 마감 : D-0 00시" position="absolute 761 44 933 59" class="sta_WF_DiscPoint"/>
        <Button id="btn_Upjang" onclick="fn_edBtn_OnClick" taborder="2" tabstop="false" text="" position="absolute 220 40 241 61" class="btn_WF_popSearch" image=""/>
        <Edit autoselect="true" id="ed_Upjang" imemode="native" onkeydown="fn_edBtn_OnKeyDown" readonly="true" taborder="1" position="absolute 71 40 221 61"/>
        <Static id="st_Upjang" text="사업장" userdata="strQuery_FMUpjang" position="absolute 15 40 63 61" class="sta_WFSA_label"/>
        <Static id="Static6" text="식당(창고)" position="absolute 271 40 350 61" class="sta_WFSA_label"/>
        <Static id="Static8" text="입고예정일" position="absolute 541 40 616 61" class="sta_WFSA_label"/>
        <MaskEdit id="me_NeedDate" mask="####-##-##" oneditclick="g_Date_OnFocus" onsetfocus="g_Date_OnFocus" taborder="4" type="string" position="absolute 621 40 702 61" class="msk_WF_Cal" onkeydown="me_NeedDate_onkeydown" ontextchanged="me_NeedDate_ontextchanged" onkillfocus="me_NeedDate_onkillfocus" canchange="me_NeedDate_canchange"/>
        <Button id="btn_NeedDate" onclick="g_CalButton_OnClick" taborder="5" tabstop="false" text="" userdata="me_NeedDate" position="absolute 700 40 721 61" class="btn_WF_cal" image=""/>
        <MaskEdit enable="false" id="me_Pdate" mask="####-##-##" oneditclick="g_Date_OnFocus" onsetfocus="g_Date_OnFocus" onkillfocus="g_Date_OnKillFocus" taborder="7" tabstop="false" type="string" position="absolute 84 89 162 110" class="msk_WF_Cal"/>
        <Edit autoselect="true" enable="false" id="ed_Pcnt" imemode="native" taborder="8" tabstop="false" position="absolute 262 89 333 110" style="align:right;"/>
        <Edit autoselect="true" enable="false" id="ed_Pamt" imemode="native" taborder="9" tabstop="false" position="absolute 334 89 437 110" style="align:right;"/>
        <Button id="btn_Copy" onclick="btn_Item_OnClick" taborder="11" tabstop="false" text="지난발주 복사" userdata="1" visible="false" position="absolute 674 115 774 136" class="btn_WF_Custom" image="" anchor="top right"/>
        <Button id="btn_Item" onclick="btn_Item_OnClick" taborder="10" tabstop="false" text="발  주" userdata="0" position="absolute 878 115 978 136" class="btn_WF_Custom" image="" anchor="top right"/>
        <TextArea id="ta_Sql" readonly="true" taborder="14" tabstop="false" visible="false" position="absolute 316 0 430 40"/>
        <Static id="Static5" text="주요상품 발주" position="absolute 0 152 450 170" class="sta_WF_Title01"/>
        <Static id="Sta_Green" text="보조금 잔액" visible="false" position="absolute 0 112 82 139" class="sta_WFDA_Label01"/>
        <Edit autoselect="true" enable="false" id="ed_Green" imemode="native" taborder="19" tabstop="false" visible="false" position="absolute 84 115 200 136" style="align:right;"/>
        <Button id="btn_RcpConf" onclick="btn_RcpConf_OnClick" taborder="32" tabstop="false" text="실시간 입금확인" userdata="1" visible="false" position="absolute 776 115 876 136" class="btn_WF_Custom" image="" anchor="top right"/>
        <Static id="st_Bond" text="채권잔액" visible="false" position="absolute 648 86 727 113" class="sta_WFDA_Label01"/>
        <Edit autoselect="true" enable="false" id="ed_Bond" imemode="native" taborder="34" tabstop="false" visible="false" position="absolute 729 89 839 110" style="align:right; :disabled {background:#ffffffff;color:red;}" readonly="false"/>
        <Div id="div_cmnBtn" anchor="left top right" taborder="35" url="cmn::CmnBtn.xfdl" text="Div0" scrollbars="none" position="absolute 0 0 981 30"/>
        <Static id="Static06" text="w15" class="Guide01_AreaRed" visible="false" position="absolute 981 0 996 593" anchor="top right"/>
        <Static id="Static07" text="w15" class="Guide01_AreaRed" visible="false" position="absolute 0 40 15 61"/>
        <Static id="Static04" text="h10" class="Guide01_AreaRed" visible="false" position="absolute 0 30 949 40"/>
        <Static id="Static05" text="h10" class="Guide01_AreaRed" visible="false" position="absolute 0 61 949 71"/>
        <Static id="Static11" text="글자간격기준 w10" class="Guide01_AreaRed" visible="false" position="absolute 61 40 71 61"/>
        <Static id="Static09" text="w30" class="Guide01_AreaRed" visible="false" position="absolute 241 40 271 61"/>
        <Static id="Static60" text="h15" class="Guide01_AreaRed" visible="false" position="absolute 40 71 490 86" anchor="left top"/>
        <Static id="Static01" text="h13" class="Guide01_AreaRed" visible="false" position="absolute 0 139 450 152" anchor="left top"/>
        <Static id="Static59" text="글자기준간격 h05" class="Guide01_AreaRed" visible="false" position="absolute 0 165 450 170" anchor="left top"/>
        <Static id="Static02" text="h15" class="Guide01_AreaRed" visible="false" position="absolute 0 578 981 593" anchor="left bottom"/>
        <Static id="Static03" text="글자간격기준 w10" class="Guide01_AreaRed" visible="false" position="absolute 341 40 351 61"/>
        <Static id="Static10" text="w30" class="Guide01_AreaRed" visible="false" position="absolute 511 40 541 61"/>
        <Static id="Static12" text="글자간격기준 w10" class="Guide01_AreaRed" visible="false" position="absolute 611 40 621 61"/>
        <Grid id="gd_list" taborder="37" useinputpanel="false" position="absolute 0 170 981 578" binddataset="ds_List" oncellclick="gd_list_OnCellClick" onheadclick="gd_list_OnHeadClick" onselectchanged="gd_list_OnCellPosChanged" autoenter="select" cellmovingtype="col" cellsizingtype="both" autofittype="col" anchor="all" autofitminwidth="981">
          <Formats>
            <Format id="Default">
              <Columns>
                <Column size="28"/>
                <Column size="87"/>
                <Column size="140"/>
                <Column size="100"/>
                <Column size="0"/>
                <Column size="40"/>
                <Column size="70"/>
                <Column size="80"/>
                <Column size="60"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="60"/>
                <Column size="50"/>
                <Column size="70"/>
                <Column size="100"/>
                <Column size="120"/>
                <Column size="100"/>
                <Column size="80"/>
              </Columns>
              <Rows>
                <Row size="26" band="head"/>
                <Row size="20"/>
                <Row size="22" band="summ"/>
              </Rows>
              <Band id="head">
                <Cell displaytype="text" class="head_Excel"/>
                <Cell col="1" displaytype="text" text="상품코드"/>
                <Cell col="2" displaytype="text" text="상품명"/>
                <Cell col="3" displaytype="text" text="규격"/>
                <Cell col="4" displaytype="text" text="원산지"/>
                <Cell col="5" displaytype="text" text="단위"/>
                <Cell col="6" text="보관유형"/>
                <Cell col="7" displaytype="text" text="판매단가"/>
                <Cell col="8" displaytype="text" text="수량"/>
                <Cell col="9" displaytype="text" text="금액"/>
                <Cell col="10" displaytype="text" text="부가세"/>
                <Cell col="11" displaytype="text" text="합계"/>
                <Cell col="12" displaytype="text" text="발주상태"/>
                <Cell col="13" displaytype="text" text="마감"/>
                <Cell col="14" text="마감일"/>
                <Cell col="15" displaytype="text" text="주문번호"/>
                <Cell col="16" displaytype="text" text="비고"/>
                <Cell col="17" text="발주시간"/>
                <Cell col="18" text="등록자"/>
              </Band>
              <Band id="body">
                <Cell celltype="head" displaytype="text" style="align:right;backgroundimage:EXPR(expr_GetRowTypeImg(currow));" expr="expr:currow + 1"/>
                <Cell col="1" displaytype="text" style="align:center;background:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;white&quot;));background2:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;white&quot;));" text="bind:ITEM_CODE"/>
                <Cell col="2" displaytype="text" style="align:left;background:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;white&quot;));background2:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;white&quot;));" text="bind:ITEM_NAME"/>
                <Cell col="3" displaytype="text" style="align:left;background:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;white&quot;));background2:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;white&quot;));" text="bind:ITEM_SIZE"/>
                <Cell col="4" displaytype="text" style="align:left;background:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;white&quot;));background2:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;white&quot;));" text="bind:ORIGIN_TYPE"/>
                <Cell col="5" displaytype="text" style="align:center;background:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;white&quot;));background2:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;white&quot;));" text="bind:PO_UOM"/>
                <Cell col="6" style="background:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;white&quot;));background2:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;white&quot;));" text="bind:KEEPING_TYPE"/>
                <Cell col="7" displaytype="number" style="background:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;white&quot;));background2:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;white&quot;));" text="bind:OP_PRICE" mask="#,##0"/>
                <Cell col="8" displaytype="number" edittype="expr:setEditExpr(iif(CLS_STATUS=='마감',&quot;none&quot;,&quot;number&quot;))" editfilter="expr:setfilterExpr(iif(CLS_STATUS=='마감',&quot;none&quot;,&quot;number&quot;))" style="background:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;lightyellow&quot;));background2:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;lightyellow&quot;));color:EXPR(iif(PR_QTY==0,&quot;red&quot;,&quot;default&quot;));" text="bind:PR_QTY" mask="#,##0.0" editautoselect="true"/>
                <Cell col="9" displaytype="number" style="background:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;white&quot;));background2:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;white&quot;));" text="bind:OP_AMOUNT" mask="#,##0"/>
                <Cell col="10" displaytype="number" style="background:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;white&quot;));background2:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;white&quot;));" expr="expr:Math.round(iif(TAX_CODE==&quot;100&quot;,0.1,0)* OP_AMOUNT)" mask="#,##0"/>
                <Cell col="11" displaytype="number" style="background:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;white&quot;));background2:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;white&quot;));" expr="expr:Math.round(iif(TAX_CODE==&quot;100&quot;,1.1,1)* OP_AMOUNT)" mask="#,##0"/>
                <Cell col="12" displaytype="text" style="align:center;background:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;white&quot;));background2:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;white&quot;));" text="bind:PO_LINE_STATUS"/>
                <Cell col="13" displaytype="text" style="align:center;background:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;white&quot;));background2:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;white&quot;));" text="bind:CLS_STATUS"/>
                <Cell col="14" style="background:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;white&quot;));background2:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;white&quot;));" text="bind:D_DAY_DISP"/>
                <Cell col="15" displaytype="text" edittype="none" style="align:center;background:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;lightyellow&quot;));background2:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;lightyellow&quot;));" text="bind:PR_NUM" editimemode="native" editautoselect="true"/>
                <Cell col="16" displaytype="text" edittype="expr:setEditExpr(iif(CLS_STATUS=='마감',&quot;none&quot;,&quot;normal&quot;))" editfilter="expr:setfilterExpr(iif(CLS_STATUS=='마감',&quot;none&quot;,&quot;normal&quot;))" style="align:left;background:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;lightyellow&quot;));background2:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;lightyellow&quot;));color:EXPR(iif(LINE_STATUS=='005',&quot;red&quot;,&quot;default&quot;));" text="bind:PR_REMARK" editimemode="native" editautoselect="true"/>
                <Cell col="17" style="background:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;lightyellow&quot;));background2:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;lightyellow&quot;));" text="bind:APPROVE_TIME"/>
                <Cell col="18" style="background:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;lightyellow&quot;));background2:EXPR(iif(CLS_STATUS==&quot;마감&quot;,&quot;thistle&quot;,&quot;lightyellow&quot;));" text="bind:CREATE_BY"/>
              </Band>
              <Band id="summary">
                <Cell displaytype="text" style="align:left;"/>
                <Cell col="1" displaytype="text" style="align:center;" text="합  계"/>
                <Cell col="2" displaytype="text" style="align:left;"/>
                <Cell col="3" displaytype="text" style="align:left;"/>
                <Cell col="4" displaytype="text" style="align:left;"/>
                <Cell col="5" displaytype="text" style="align:left;"/>
                <Cell col="6"/>
                <Cell col="7" displaytype="text" style="align:left;"/>
                <Cell col="8" displaytype="number" style="align: ;" expr="expr:getSum(&quot;PR_QTY&quot;)" mask="#,##0.0"/>
                <Cell col="9" displaytype="number" style="align: ;" expr="expr:getSum(&quot;OP_AMOUNT&quot;)" mask="#,##0"/>
                <Cell col="10" displaytype="number" style="align: ;" expr="expr:getCaseSum(&quot;TAX_CODE=='100'&quot;,&quot;Math.round(OP_AMOUNT/10)&quot;)" mask="#,##0"/>
                <Cell col="11" displaytype="number" style="align: ;" expr="expr:getSum(&quot;Math.round(iif(TAX_CODE=='100',1.1,1)* OP_AMOUNT)&quot;)" mask="#,##0"/>
                <Cell col="12" displaytype="text" style="align:left;"/>
                <Cell col="13" displaytype="text" style="align:left;"/>
                <Cell col="14"/>
                <Cell col="15" displaytype="text" style="align:left;"/>
                <Cell col="16" displaytype="text" style="align:left;"/>
                <Cell col="17"/>
                <Cell col="18"/>
              </Band>
            </Format>
          </Formats>
        </Grid>
        <Div id="dv_RcpConf" taborder="36" tabstop="false" text="Div0" scrollbars="none" visible="false" position="absolute 1000 196 1136 360" class="div_WFGRD_graybg" style="background:#ffffffff;border:2 solid #515d6fff ;">
          <Layouts>
            <Layout>
              <Button id="btn_RcpRun" taborder="7" text="입금확인" onclick="dv_MultiUpj_btn_Hidden_OnClick" class="btn_WF_Custom" position="absolute 4 80 128 101" anchor="default"/>
              <Static id="Static1" text="입금확인일자" class="sta_WFDA_Label01" position="absolute 4 6 127 30" anchor="default"/>
              <MaskEdit id="me_RcpDateF" taborder="8" readonly="true" type="string" mask="####-##-##" onsetfocus="g_Date_OnFocus" oneditclick="g_Date_OnFocus" enable="false" position="absolute 5 32 105 53" anchor="default" class="msk_WF_Cal"/>
              <Button id="btn_RcpDateF" taborder="9" tabstop="false" onclick="g_CalButton_OnClick" class="btn_WF_cal" enable="false" position="absolute 84 32 105 53" userdata="dv_RcpConf.me_RcpDateF" anchor="default"/>
              <MaskEdit id="me_RcpDateT" taborder="10" readonly="true" type="string" mask="####-##-##" onsetfocus="g_Date_OnFocus" oneditclick="g_Date_OnFocus" ontextchanged="dv_RcpConf_me_RcpDateT_OnChanged" position="absolute 17 55 117 76" anchor="default" class="msk_WF_Cal"/>
              <Button id="btn_RcpDateT" taborder="11" tabstop="false" onclick="g_CalButton_OnClick" class="btn_WF_cal" position="absolute 96 55 117 76" userdata="dv_RcpConf.me_RcpDateT" anchor="default"/>
              <Static id="Static0" text="~" position="absolute 5 59 13 72" anchor="default"/>
              <Static id="Static02" text="※ 은행 전산 구조상 최대 10분 지연 될수 있습니다." position="absolute 11 100 131 160" anchor="default"/>
            </Layout>
          </Layouts>
        </Div>
        <Static id="st_Week" text="(월)" position="absolute 726 41 754 62" style="font:Gulim,9,bold;"/>
        <Edit id="ed_CreditAvail" taborder="38" tabstop="false" inputtype="number" autoselect="true" enable="true" visible="false" position="absolute 850 89 965 110" style="align:right; :disabled {color:red;}"/>
        <Static id="stc_ctrlAmt" text="( 전체창고 발주금액 : $amt$ )" visible="false" position="absolute 955 41 1208 62" style="font:Gulim,9, bold;"/>
      </Layout>
    </Layouts>
    <Objects>
      <Dataset id="ds_Subinv">
        <ColumnInfo>
          <Column id="SUBINV_CODE" size="8" type="STRING"/>
          <Column id="SUBINV_NAME_DISP" size="100" type="STRING"/>
          <Column id="CONSUM_YN" size="1" type="STRING"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_Cond">
        <ColumnInfo>
          <Column id="NEED_DATE" size="8" type="STRING"/>
          <Column id="UPJANG" size="22" type="INT"/>
          <Column id="SUBINV_CODE" size="8" type="STRING"/>
          <Column id="QTY_CONTROL_YN" size="1" type="STRING"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_Days">
        <ColumnInfo>
          <Column id="D_DAYS" size="22" type="INT"/>
          <Column id="D_TIMES" size="4" type="STRING"/>
          <Column id="DAYS" size="50" type="STRING"/>
          <Column id="D_OVER_DAYS" size="22" type="INT"/>
          <Column id="QTY_CONTROL_YN" size="1" type="STRING"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_List" cancolumnchange="ds_List_CanColumnChange" oncolumnchanged="ds_List_OnColumnChanged">
        <ColumnInfo>
          <Column id="CENTER_CODE" size="22" type="INT"/>
          <Column id="CENTER_FLAG" size="1" type="STRING"/>
          <Column id="CLS_STATUS" size="50" type="STRING"/>
          <Column id="CUSTCD" size="22" type="INT"/>
          <Column id="INVAT_FLAG" size="1" type="STRING"/>
          <Column id="ITEM_CODE" size="50" type="STRING"/>
          <Column id="ITEM_NAME" size="200" type="STRING"/>
          <Column id="ITEM_SIZE" size="100" type="STRING"/>
          <Column id="LINE_STATUS" size="50" type="STRING"/>
          <Column id="MARGIN_PRICE" size="22" type="BIGDECIMAL"/>
          <Column id="MIN_ORD_QTY" size="22" type="BIGDECIMAL"/>
          <Column id="MAX_ORD_QTY" size="22" type="BIGDECIMAL"/>
          <Column id="MULTIPLIER_QTY" size="22" type="BIGDECIMAL"/>
          <Column id="NEED_DATE" size="8" type="STRING"/>
          <Column id="OTCUSTCD" size="50" type="STRING"/>
          <Column id="OUTVAT_FLAG" size="1" type="STRING"/>
          <Column id="PO_UOM" size="10" type="STRING"/>
          <Column id="POINT_FLAG" size="1" type="STRING"/>
          <Column id="PR_ID" size="22" type="BIGDECIMAL"/>
          <Column id="PR_NUM" size="50" type="STRING"/>
          <Column id="PR_QTY" size="22" type="BIGDECIMAL"/>
          <Column id="PR_REMARK" size="300" type="STRING"/>
          <Column id="PR_UPJANG" size="22" type="INT"/>
          <Column id="RC_UPJANG" size="22" type="INT"/>
          <Column id="SALE_AMOUNT" size="22" type="BIGDECIMAL"/>
          <Column id="SALE_PRICE" size="22" type="BIGDECIMAL"/>
          <Column id="SUBINV_CODE" size="8" type="STRING"/>
          <Column id="TAX_CODE" size="3" type="STRING"/>
          <Column id="UNIT_PRICE" size="22" type="BIGDECIMAL"/>
          <Column id="OP_PRICE" size="22" type="BIGDECIMAL"/>
          <Column id="OP_AMOUNT" size="22" type="BIGDECIMAL"/>
          <Column id="D_DAYS" size="4" type="BIGDECIMAL"/>
          <Column id="D_TIMES" size="4" type="BIGDECIMAL"/>
          <Column id="IMAGE_PATH" size="200" type="STRING"/>
          <Column id="OP_AMOUNT_OLD" size="22" type="BIGDECIMAL"/>
          <Column id="APPLY_SD" type="STRING" size="256"/>
          <Column id="VD_SN" type="STRING" size="256"/>
          <Column id="MOBILE_GUBUN" type="STRING" size="256"/>
          <Column id="ORIGIN_TYPE" type="STRING" size="256"/>
          <Column id="MAX_SO_QTY" type="STRING" size="256"/>
          <Column id="UPJANG_GRP" type="STRING" size="256"/>
          <Column id="PO_LINE_STATUS" type="STRING" size="256"/>
          <Column id="OP_RATE" type="STRING" size="256"/>
          <Column id="APPROVE_TIME" type="STRING" size="256"/>
          <Column id="CREATE_BY" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_OrdCtrl">
        <ColumnInfo>
          <Column id="CTRL_TYPE" size="50" type="STRING"/>
          <Column id="FRI" size="1" type="STRING"/>
          <Column id="ITEM_TYPE" size="50" type="STRING"/>
          <Column id="MON" size="1" type="STRING"/>
          <Column id="SAT" size="1" type="STRING"/>
          <Column id="SUN" size="1" type="STRING"/>
          <Column id="THU" size="1" type="STRING"/>
          <Column id="TUE" size="1" type="STRING"/>
          <Column id="WED" size="1" type="STRING"/>
          <Column id="CHK_TYPE" size="100" type="STRING"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_CrdInfo">
        <ColumnInfo>
          <Column id="CREDIT_AMOUNT" size="22" prop="default" type="BIGDECIMAL"/>
          <Column id="CREDIT_AMOUNT_CONTROL_YN" size="1" prop="default" type="STRING"/>
          <Column id="CREDIT_AMOUNT_TOT" size="22" prop="default" type="BIGDECIMAL"/>
          <Column id="CREDIT_AVAIL_AMT" size="22" prop="default" type="BIGDECIMAL"/>
          <Column id="CREDIT_EXT_AMOUNT" size="22" prop="default" type="BIGDECIMAL"/>
          <Column id="CREDIT_EXT_DAYS" size="22" prop="default" type="BIGDECIMAL"/>
          <Column id="CREDIT_OVER_AMOUNT" size="22" prop="default" type="BIGDECIMAL"/>
          <Column id="CREDIT_RMN_AMT" size="22" prop="default" type="BIGDECIMAL"/>
          <Column id="CREDIT_TURN_CONTROL_YN" size="1" prop="default" type="STRING"/>
          <Column id="CREDIT_TURN_DAYS" size="22" prop="default" type="BIGDECIMAL"/>
          <Column id="CREDIT_TURN_DAYS_TOT" size="22" prop="default" type="BIGDECIMAL"/>
          <Column id="L_BILL_DATE" size="8" prop="default" type="STRING"/>
          <Column id="L_BILL_DATE_DISP" size="50" prop="default" type="STRING"/>
          <Column id="LAST_TURN_CNT" size="22" prop="default" type="BIGDECIMAL"/>
          <Column id="PO_AMT" size="22" prop="default" type="BIGDECIMAL"/>
          <Column id="PR_AMT" size="22" prop="default" type="BIGDECIMAL"/>
          <Column id="RMN_AMT" size="22" prop="default" type="BIGDECIMAL"/>
          <Column id="TR_AMT" size="22" prop="default" type="BIGDECIMAL"/>
          <Column id="BOND_AMT" size="22" prop="default" type="BIGDECIMAL"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_Subinv_0">
        <ColumnInfo>
          <Column id="SUBINV_CODE" size="8" type="STRING"/>
          <Column id="SUBINV_NAME_DISP" size="100" type="STRING"/>
          <Column id="CONSUM_YN" size="1" type="STRING"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_Green">
        <ColumnInfo>
          <Column id="BALANCE_AMT" size="22" type="BIGDECIMAL"/>
          <Column id="GREEN_AMT" size="200" type="STRING"/>
          <Column id="USE_YN" size="2" type="STRING"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_Green_Proc">
        <ColumnInfo>
          <Column id="UPJANG" size="256" type="BIGDECIMAL"/>
          <Column id="NEED_DATE" size="256" type="STRING"/>
          <Column id="CUSER" size="256" type="STRING"/>
          <Column id="OUT_RTN_MESSAGE" size="256" type="STRING"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_save_out" firefirstcount="0" firenextcount="0" useclientlayout="false" updatecontrol="true" enableevent="true" loadkeymode="keep" loadfiltermode="keep" reversesubsum="false"/>
      <Dataset id="ds_common" firefirstcount="0" firenextcount="0" useclientlayout="false" updatecontrol="true" enableevent="true" loadkeymode="keep" loadfiltermode="keep" reversesubsum="false">
        <ColumnInfo>
          <Column id="code" type="STRING" size="256"/>
          <Column id="codename" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_hidden" cancolumnchange="ds_List_CanColumnChange" oncolumnchanged="ds_List_OnColumnChanged">
        <ColumnInfo>
          <Column id="SABUN" type="STRING" size="256"/>
          <Column id="HIDDEN_YN" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_ctrlList" firefirstcount="0" firenextcount="0" useclientlayout="false" updatecontrol="true" enableevent="true" loadkeymode="keep" loadfiltermode="keep" reversesubsum="false">
        <ColumnInfo>
          <Column id="rcUpjang" type="STRING" size="255"/>
          <Column id="subinvCode" type="STRING" size="255"/>
          <Column id="subinvAmt" type="BIGDECIMAL" size="255"/>
          <Column id="poAmt" type="BIGDECIMAL" size="255"/>
          <Column id="controlAmt" type="BIGDECIMAL" size="255"/>
          <Column id="controlYn" type="STRING" size="255"/>
          <Column id="nonCtrlAmt" type="BIGDECIMAL" size="255"/>
          <Column id="chkSave" type="STRING" size="255"/>
        </ColumnInfo>
      </Dataset>
    </Objects>
    <Script type="xscript4.0"><![CDATA[include "U_lib::lib_conversionCom.xjs";
/*
 ******************************************************************************************
 * 시스템구분   : 식재영업/발주관리/주요상품 발주
 * 프로그램명   : FMP00160E.XML
 * 기      능   : 주요상품 발주
 * 작  성  자   : 박은규
 * 작성  일자   : 2008-01-07
 * ----------------------------------------------------------------------------------------
 * HISTORY    :
 *				2017.02.24	kihoon	[CH201702_00698] 주요상품발주 추가 정보 표기
 ******************************************************************************************
*/
//=========================================================================================
// [ PART 1 ]
// Form에서 Include 할 내용을 정의
//
//=========================================================================================
//@@컨버터에서 주석처리 #include "lib::sc_comon.js"				// 시스템 공통
//@@컨버터에서 주석처리 #include "LIB::lib_comm_0001.js"		//JAVA 코딩시
//@@컨버터에서 주석처리 #include "LIB::tit_comm_0001.js"		// X-Framework Lib
//@@컨버터에서 주석처리 #include "lib::sc_sql_common.js"		// 공통팝업
//@@컨버터에서 주석처리 #include "lib::fm_common.js"			// FM공통
//=========================================================================================
// [ PART 2 ]
// Form에서 사용될 전역변수를 선언
//
//=========================================================================================
var fa_Sql;
var fa_DocSrc = '07 FM(주요)';
// [속도개선 Project 시작] 2017. 7. 19. 최범주 발주버튼 클릭 시 주요상품검색 팝업 저장버튼 권한처리
var fv_sHiddenYn = "N";
// [속도개선 Project   끝] 2017. 7. 19. 최범주

//최초등록시 주문번호 채번,이후에는같은번호 
var fn_gubunNewOrOld = "NEW";
var fn_maxPrNum = "";
var fn_maxApproveNum = "";
var fn_maxBefApproveNum = "";
var fn_dsListCnt = 0;
var pre_need_date_temp = "";   //2017.10.13 김호석 추가 입고일자 변경 전으로 되돌림
//var fa_weekendTimeCheck = "N"; // 주말 발주 통제 여부
//var fa_startTime; // 통제시작시간
//var fa_endTime; // 통제종료시간
//=========================================================================================
// [ PART 3 ]
// Form Loading 시 작업 정의
//
//=========================================================================================
function form_onload(obj:Form, e:LoadEventInfo)
{
	gfn_formOnLoad(obj, false);

	//초기화
	fsp_init(this);
	v_ds_check = "ds_List";
	
	//사용자관리화면에서 [여신/공급업체] 항목의 값을 들고와서 
	//발주가능금액, 채권잔액, 실시간입금확인을 컨트롤 함 - (김진희 2014.02.19)
	if (g_Simple_Po_Yn == "Y") 
	{
		//발주가능금액 컨트롤
		st_Credit.visible = true;
		ed_Credit.visible = true;
		//채권잔액 컨트롤
		st_Bond.visible = true;
		ed_Bond.visible = true;
		//실시간입금확인 컨트롤
		btn_RcpConf.visible = true;

		//공급업체 컬럼 컨트롤
		//tab_list.tab1.gd_list.setFormatColProperty(11, "size", 80);
	}	
	else 
	{
		//발주가능금액 컨트롤
		st_Credit.visible = false;
		ed_Credit.visible = false;
		//채권잔액 컨트롤
		st_Bond.visible = false;
		ed_Bond.visible = false;
		//실시간입금확인 컨트롤
		btn_RcpConf.visible = false;

		//공급업체 컬럼 컨트롤
		//tab_list.tab1.gd_list.setFormatColProperty(11, "size", 0);
	}

	//기본적으로 사업장은 채권잔액 공개않함. - 이혜은(20130422)
	if(application.g_UserKind == "사업장")
	{
		st_Bond.visible = false;
		ed_Bond.visible = false;
	}
	
	//실시간 입금확인
	var nX = btn_RcpConf.position.left;
	var nY = btn_RcpConf.position.bottom + 1
	dv_RcpConf.move(nX, nY);
		
	dv_RcpConf.me_RcpDateT.value = fn_CurrDateWeek();
	dv_RcpConf.me_RcpDateF.value = gfn_addDate(fn_CurrDateWeek(),-1);

	ed_Upjang.userdata = application.g_Upjang;
	ed_Upjang.value     = application.g_UpjangNm;
	me_NeedDate.value  = gfn_addDate(fn_CurrDateWeek(),1); //addDate(today(),1);
	//날자 셋팅 후 일자도 변경
	st_Week.text = "(" + ffn_DayToWeek(me_NeedDate.value) + ")";
	if (st_Week.text == "(토)")
		st_Week.style.color = "blue";
	else if (st_Week.text == "(일)")
		st_Week.style.color = "red";
	else
		st_Week.style.color = "black";
	//공휴일색변경	
	if(gfn_length(fn_isHoliday(me_NeedDate.value))>0)
	{
		st_Week.style.color = "red";
	}

	//초기화
	fn_ResetData();
	
	// FICS 발주제한요일, 시간 설정 조회
	//fn_getWeekendTime();
	
	//Init 조회 서비스(속도 개선 async 통신으로 변경)
    fn_InitService();
	
	if (ed_Upjang.enable) ed_Upjang.setFocus();
}

function fn_InitService()
{
	////////// 1. 창고 조회
	ds_Subinv.clearData();
	var actionName, cmdName, inData, outData, otherArg, callBackFnc, trId;
	trId  = "searchSubinv";
	outData		= "ds_Subinv=ds_List";
	otherArg	= "UPJANG=" + wrapQuote(ed_Upjang.userdata);
	callBackFnc = "fn_CallbakInitService";
	
	fsp_clear(this); 
	fsp_addSearch(this, "fm/fmz:FMZ_PO_SUBINV_S001");
	fsp_callService(this, actionName, cmdName, inData, outData, otherArg, callBackFnc, "", "", "", trId);
}

function fn_CallbakInitService(errCode, errMsg, svcId)
{	
	if (errCode == 0)
	{
	    
	    switch(svcId)
		{
			case "searchSubinv":
				
				//기본창고지정
	            if (ds_Subinv.rowcount > 0) cbo_Subinv.index = 0;
	            
	            ////////// 2. 디데이 조회
				ds_Days.clearData();
				var actionName, cmdName, inData, outData, otherArg, callBackFnc, trId;
				trId  = "searchDays";
				outData		= "ds_Days=ds_List";
				otherArg	= "UPJANG=" + wrapQuote(ed_Upjang.userdata) + " SUBINV_CODE=" + wrapQuote(cbo_Subinv.value) + " NEED_DATE=" + wrapQuote(me_NeedDate.value);
				callBackFnc = "fn_CallbakInitService";
				fsp_clear(this); 
				fsp_addSearch(this, "fm/fmz:FMZ_GETDAYS_S001");
				fsp_callService(this, actionName, cmdName, inData, outData, otherArg, callBackFnc, "", "", "", trId);
				
				////////// 3. 주문통제 조회
				ds_OrdCtrl.clearData();
				var actionName, cmdName, inData, outData, otherArg, callBackFnc, trId;
				trId  = "searchOrdCtrl";
				outData		= "ds_OrdCtrl=ds_List";
				otherArg	= "UPJANG=" + wrapQuote(ed_Upjang.userdata);
				callBackFnc = "fn_CallbakInitService";
				fsp_clear(this); 
				fsp_addSearch(this, "fm/fmz:FMZ_ORD_CTRL_S001");
				fsp_callService(this, actionName, cmdName, inData, outData, otherArg, callBackFnc, "", "", "", trId);
				
				////////// 4. 사업장이 여신관리하는지 여부 조회
// [속도개선 Project 시작] 2017. 8. 21. 최범주 여신정보조회 함수 대체
				if ( !fn_GetCredit() ) return; // 여신정보 조회

				//자동조회
				fn_search();
// 				var dsObjin, dsObjot;
// 				create("Dataset", "ds_Dummyin");
// 				create("Dataset", "ds_Dummyot");
// 				dsObjin = eval("ds_Dummyin");
// 				dsObjin.addColumn("UPJANG", "INT", 22);
// 				dsObjin.addColumn("NEED_DATE", "STRING", 8);
// 				dsObjot = eval("ds_Dummyot");
// 				dsObjot.addColumn("CRD_YN", "STRING", 1);
// 				ds_Dummyin.clearData();
// 				ds_Dummyot.clearData();
// 				ds_Dummyin.addRow();
// 				ds_Dummyin.setColumn(0, "UPJANG",         ed_Upjang.userdata);
// 				ds_Dummyin.setColumn(0, "NEED_DATE",      me_NeedDate.value);
// 				var actionName, cmdName, inData, outData, otherArg, callBackFnc, trId;
// 				trId  = "searchCreditChk";
// 				inData		= "ds_Cond=ds_Dummyin";
// 				outData		= "ds_Dummyot=ds_List";
// 				fsp_clear(this); 
// 				fsp_addSearch(this, "fm/fmz:FMZ_CREDIT_CHKYN_S001");
// 				fsp_callService(this, actionName, cmdName, inData, outData, otherArg, callBackFnc, "", "", "", trId);
// [속도개선 Project   끝] 2017. 8. 21. 최범주
				break;
				
			case "searchDays":
				
				//디데이 표시
				if (ds_Days.rowcount > 0) {
					st_Days.text = "▶ 발주 마감 : " + ds_Days.getColumn(0,"DAYS");
				} else {
					g_Message("EE","발주마감정보를 확인할 수 없습니다.!" + "\n\n" + "관리자에게 문의하세요.");
				}
	            
				break;	
				
// [속도개선 Project 시작] 2017. 8. 21. 최범주 여신정보조회 함수 대체
// 			case "searchCreditChk":
// 				
// 				if (ds_Dummyot.rowcount > 0) {
// 					
// 					////////// 5. 여신정보 조회
// 					ds_Cond.clearData();
// 					ds_CrdInfo.clearData();
// 					ds_Cond.addRow();
// 					ds_Cond.setColumn(0, "UPJANG",         ed_Upjang.userdata);
// 					ds_Cond.setColumn(0, "NEED_DATE",      me_NeedDate.value);
// 					var strSvcID, strURL, strInDatasets, strOutDatasets, strArgument, strCallbackFunc, trId;
// 					strSvcID = "searchCreditInfo";
// 					strURL   = "U_svc::" + "fm/fmz/FMZ_CREDIT_INFO_T001.jsp";
// 					strInDatasets  = "ds_Cond=ds_Cond";
// 					strOutDatasets = "ds_CrdInfo=ds_List";
// 					strArgument  = "g_Upjang=" + wrapQuote(g_Upjang);
// 					strArgument += " g_EmpNo=" + wrapQuote(g_EmpNo);
// 					strCallbackFunc = "fn_CallbakInitService";
// 					jsp_transaction(this, strSvcID, strURL, strInDatasets, strOutDatasets, strArgument, strCallbackFunc, "", "", "");
// 					
// 				} else {
// 					//여신정보 초기화
// 					ds_CrdInfo.clearData();
// 					ed_Credit.value = "무 제 한";
// 					return;
// 				}
// 				
// 				//ds임시생성 해제
// 				Destroy("ds_Dummyin");
// 				Destroy("ds_Dummyot");
// 				
// 				break;
// [속도개선 Project   끝] 2017. 8. 21. 최범주
						
// [속도개선 Project 시작] 2017. 8. 21. 최범주 여신정보조회 함수 대체
// 			case "searchCreditInfo":
// 				
// 				//여신 표시
// 				if (ds_CrdInfo.rowcount > 0) 
// 				{
// 					alert(ds_CrdInfo.getColumn(0,"CREDIT_AMOUNT_CONTROL_YN"));
// 					if (ds_CrdInfo.getColumn(0,"CREDIT_AMOUNT_CONTROL_YN") != "Y")
// 					{
// 						//주문가능액
// 						ed_Credit.value = gfn_numFormat(gfn_trim(ds_CrdInfo.getColumn(0,"CREDIT_RMN_AMT")));
// 						//실주문가능액 - 임시여신을 합해줘야함
// 						ed_CreditAvail.value = gfn_numFormat(gfn_trim(ds_CrdInfo.getColumn(0,"CREDIT_AVAIL_AMT")));
// 						//채권금액
// 						ed_Bond.value = gfn_numFormat(gfn_trim(ds_CrdInfo.getColumn(0,"BOND_AMT")));
// 					}	
// 					else
// 						ed_Credit.value = "무 제 한";
// 				}
// 				else
// 				{
// 					g_Message("EE","업장여신정보를 확인할 수 없습니다.!" + "\n\n" + "관리자에게 문의하세요.");
// 					return;
// 				}
// 				
// 				//최종 발주정보
// 				//fn_GetLastOrd();
// 				
// 				//자동조회
// 				fn_search();
// 				
// 				break;	
// [속도개선 Project   끝] 2017. 8. 21. 최범주
		
// [속도개선 Project 시작] 2017. 7. 19. 최범주 발주버튼 클릭 시 주요상품검색 팝업 저장버튼 권한처리
			// 주요상품검색 팝업 저장버튼 권한조회
            case "searchBtnAuthInfo":
				if ( ds_hidden.getRowCount() > 0 ) {
					fv_sHiddenYn = ds_hidden.getColumn(0, "HIDDEN_YN");
				}
            break;
// [속도개선 Project   끝] 2017. 7. 19. 최범주

			default:
				break;
		}
	    
	} else {
		g_Message("EE",fn_AlertMsg("002"));
	}
}


//=========================================================================================
// [ PART 4 ]
// Main Process Event 정의(조회,입력,삭제,저장,인쇄,도움말,form닫기)
//
//=========================================================================================
/*------------------------------------------------------------(60)
	1. Function ID : fn_Search()
	2. 개       요 : 업무프로세스에 따른 조회작업
	3. 기       능 : 검색조건에 해당하는 정보를 조회
	4. 인 수 설 명 : 
*/
function fn_search()
{
	//필수항목 
	if (fn_ChkManNull()) return;
	
	//입고통제일 체크 
	if (fn_NeedDateCheck()) 
	{
	    g_Message("EE","해당일자는 입고통제일 입니다.");
	    ds_List.clearData();
		return;
	}
		
	//2017.10.13 김호석 추가 입고일자 변경 전으로 되돌림
	pre_need_date_temp = me_NeedDate.value;
		
	//최종발주정보
	fn_GetLastOrd();
	// 초기화
	ds_Cond.clearData();
	ds_List.clearData();
	ds_Cond.addRow();
	ds_Cond.setColumn(0, "SUBINV_CODE",    cbo_Subinv.value);
	ds_Cond.setColumn(0, "NEED_DATE",      me_NeedDate.value);
	ds_Cond.setColumn(0, "QTY_CONTROL_YN", ds_Days.getColumn(0,"QTY_CONTROL_YN"));
	
	// 조회
	var actionName, cmdName, inData, outData, otherArg, callBackFnc;
	
	// 파라미터셋팅
    inData		= "ds_Cond=ds_Cond";
    outData		= "ds_List=ds_List";
    callBackFnc	= "fn_CallBack_Search";
	otherArg    = "DocSrc=" + wrapQuote(fa_DocSrc);
	
	//action 정보 초기화 
	fsp_clear(this); 
    // 서버에서 조회할 정보 추가 
	fsp_addSearch(this, "fm/fmp:FMP00160E_S002");
	// 서버 호출 
	SetWaitCursor(true);
	setCapture();
	//
	http.Sync = true;
    fsp_callService(this, actionName, cmdName, inData, outData, otherArg, callBackFnc);		// 서비스 호출 
	http.Sync = false;
	//
	releaseCapture();
	SetWaitCursor(false);
	
    //if (ed_Green.Visible == 'true');
    //{
		//보조금 금액 재 계산 프로시져 호출     
		//fn_Create_Green_Amt();
		
		//보조금 사용 후 잔액 조회
		//fn_Green_Amt();    
    //}  	
}

function fn_NeedDateCheck()
{
	//ds임시생성
	var dsObjin, dsObjot;
		
	create("Dataset", "ds_Dummyin");
	create("Dataset", "ds_Dummyot");
	
	dsObjin = eval("ds_Dummyin");
	dsObjin.addColumn("UPJANG", "INT", 22);
	dsObjin.addColumn("NEED_DATE", "STRING", 8);
	dsObjot = eval("ds_Dummyot");
	dsObjot.addColumn("CNT", "INT", 22);
	
	/*-------------*/
	http.Sync = true;
	/*-------------*/
	// 초기화
	ds_Dummyin.clearData();
	ds_Dummyot.clearData();
	ds_Dummyin.addRow();
	ds_Dummyin.setColumn(0, "UPJANG",         ed_Upjang.userdata);
	ds_Dummyin.setColumn(0, "NEED_DATE",      me_NeedDate.value);

	// 조회
	var actionName, cmdName, inData, outData, otherArg, callBackFnc;
	// 파라미터셋팅
    inData		= "ds_Cond=ds_Dummyin";
    outData		= "ds_Dummyot=ds_List";
	//action 정보 초기화 
	fsp_clear(this); 
    // 서버에서 조회할 정보 추가 
	fsp_addSearch(this, "fm/fmz:FMZ_ORD_CTRL_S002");
	// 서버 호출 
    fsp_callService(this, actionName, cmdName, inData, outData, otherArg, callBackFnc);
	/*-------------*/
	http.Sync = false;
	/*-------------*/

	var bYn = (ds_Dummyot.getColumn(0, "CNT") > 0);

	//ds임시생성 해제
	Destroy("ds_Dummyin");
	Destroy("ds_Dummyot");
	
	return bYn;
}

/*------------------------------------------------------------
	1. Function ID : fn_Insert()
	2. 개       요 : 업무프로세스에 따른 입력작업
	3. 기       능 : 입력버튼 입력 시 처리되는 작업
	4. 인 수 설 명 : 
*/
function fn_insert()
{
}

/*------------------------------------------------------------
	1. Function ID : fn_Delete()
	2. 개       요 : 업무프로세스에 따른 입력작업
	3. 기       능 : 입력버튼 입력 시 처리되는 작업
	4. 인 수 설 명 : 
*/
function fn_delete()
{
	if (ds_List.rowcount < 1)
	{
		g_Message("EE", fn_AlertMsg("006"));
		return;
	}
	if (ds_List.rowposition < 0 || ds_List.getSelect(ds_List.rowposition) == false)
	{
		g_Message("EE", "삭제할 상품을 선택하세요.");
		return;
	}
	//if (ds_List.GetColumn(ds_List.row,"LINE_STATUS") <> "004")
	if (ds_List.getColumn(ds_List.rowposition,"CLS_STATUS") == "마감")
	{
		g_Message("EE", "해당상품은 마감이 완료되어 삭제가 불가합니다.");
		return;
	}
	if (! g_Confirm("01", '선택하신 주문상품을 삭제하시겠습니까?!')) return;

	if (GetRowType(ds_List,ds_List.rowposition)== 'insert')
	{
		ds_List.deleteRow(ds_List.rowposition);
		return;
	}
	
	//실제 Table자료 삭제 시 Table에서 즉시 삭제처리
	//필수항목 
	if (fn_ChkManNull()) return;
	//
	var strSvcID, strURL, strInDatasets, strOutDatasets, strArgument, strCallbackFunc;
	// 경로 설정
	strSvcID = "FMP00160E_T003";
	strURL   = "U_svc::" + "fm/fmp/FMP00160E_T003.jsp";
	// 데이터셋 설정U
	strInDatasets  = "";
	strOutDatasets = "";
	// 파라메터 설정
	strArgument  = "g_Upjang=" + wrapQuote(g_Upjang);
	strArgument += " g_EmpNo=" + wrapQuote(g_EmpNo);
	strArgument += " sDocSrc=" + wrapQuote(fa_DocSrc);
	strArgument += " sPrID=" + wrapQuote(ds_List.getColumn(ds_List.rowposition,"PR_ID"));
	strArgument += " sOtcustCD=" + wrapQuote(ds_List.getColumn(ds_List.rowposition,"OTCUSTCD"));
	strArgument += " sMenuFlag=" + wrapQuote("N");
	strArgument += " sUpjang=" + wrapQuote(ds_List.getColumn(ds_List.rowposition,"RC_UPJANG"));
	strArgument += " sMenuCD=" + wrapQuote(ds_List.getColumn(ds_List.rowposition,"NEED_DATE") + "-" + ds_List.getColumn(ds_List.rowposition,"SUBINV_CODE"));
	strArgument += " sItemCode=" + wrapQuote(ds_List.getColumn(ds_List.rowposition,"ITEM_CODE"));
	strArgument += " sPrNum=" + wrapQuote(gfn_trim(ds_List.getColumn(ds_List.rowposition,"PR_NUM")));
	strArgument += " sPrUpjang=" + wrapQuote(ed_Upjang.userdata);
	strArgument += " sPrSabun=" + wrapQuote(g_EmpNo);
// [속도개선 Project 시작] 2017. 8. 4. 최범주 여신금액 집계 프로시저 추가
    strArgument += " sSubinv=" + wrapQuote(cbo_Subinv.value);     // 식당(창고)
    strArgument += " sNeedDate=" + wrapQuote(me_NeedDate.value);  // 입고예정일
	strArgument += " scrnId=" + wrapQuote("FMP00160E");           // 화면ID
	strArgument += " scrnName=" + wrapQuote("주요상품발주");      // 화면명
// [속도개선 Project   끝] 2017. 8. 4. 최범주
	// 콜백함수 지정
	strCallbackFunc = "fn_CallBack_Delete";
	// 서버 호출 
	//Transaction(strSvcID, strURL, strInDatasets, strOutDatasets, strArgument, strCallbackFunc);
	jsp_transaction(this, strSvcID, strURL, strInDatasets, strOutDatasets, strArgument, strCallbackFunc, false, false, true);
}

/*------------------------------------------------------------
	1. Function ID : fn_Save()
	2. 개       요 : 업무프로세스에 따른 입력작업
	3. 기       능 : 입력버튼 입력 시 처리되는 작업
	4. 인 수 설 명 : 
*/
function fn_save()
{
	/*시스템 통제 시간 체크 - 특정일자에 사용을 할 수 없게 한다.*/
	mfn_GetSystemWorkCheck("PO");
	if (ds_common.getColumn(0, 0) == "Y")
	{
		g_Message("EE", "시스템 변경 작업중이라 현 화면을 사용할 수 없습니다. \n사용불가시간(" + ds_common.getColumn(0, 1) + " ~ " + ds_common.getColumn(0, 2) + ") ");
		return false; 
	}
	
	// 최초등록시 주문번호 채번,이후에는같은번호 
	// 조회건수가 1건이라도 있을경우
	ds_List.filter("OTCUSTCD=='0000'");
	
	if (fn_dsListCnt > 0)
	{
		for (i=0; i<fn_dsListCnt; i++)
		{
			fn_gubunNewOrOld = "OLD";	
			
			if(!gfn_isNull(ds_List.getColumn(i, "PR_NUM")))
			{
				fn_maxPrNum = ds_List.getColumn(i, "PR_NUM");
			}
			
			if(!gfn_isNull(ds_List.getColumn(i, "APPROVE_NUM")))
			{
				fn_maxApproveNum = ds_List.getColumn(i, "APPROVE_NUM");	
			}			
		}
	}
	else
	{
		fn_maxPrNum = "";
		fn_maxApproveNum = "";
		fn_gubunNewOrOld = "NEW";
	}
	
	ds_List.filter("");
	
	//저장 버튼 누른 후 팝업 상태에서 마감시간 이후 저장 체크를 위한 변경
	//[HISTORY] : 수정일 > 2009/01/19
	//            수정자 > 노규완
	//            수정 내용 > 저장 Confirm 팝업 메시지를 제일 먼저 띄어 줌.	
	
	// 저장 전 사용자 메세지 전달
	if (! g_Confirm("", "주문내역을 저장하시겠습니까?"))
	{
		return;
	}
	
	//수량 영 점검
	var nRow;
	nRow = ds_List.findRowExpr("PR_QTY==0");
	if (nRow >= 0)
	{
		if (! g_Confirm("02", "발주량이 0인 상품이 있습니다.\n\n그대로 저장하시겠습니까?!"))
		{
			ds_List.rowposition = nRow;
			gd_list.setFocus();
			gd_list.setCellPos(ffn_Get_HeaderTitleColIdx(gd_list,"수량"));
			return;
		}
	}	
	//현재시간 초기화. 
	//발주가능, 데이타체크에서 현재시간을 통해 계산하기때문에
	//fn_SetTimer(); -->AS-IS 동일 오류
	//필수항목 
	if (fn_ChkManNull()) return;
	//발주가능 체크
	if (! fn_OrdChk()) return;
	// 데이타체크
	var sRtn = fn_ChkData();
	if (sRtn != null)
	{
		g_Message("EE", sRtn);
		return;
	}
	
/*
   	// action 정보 초기화 
    tit_clearActionInfo(this);
	// 초기화
	ds_Cond.ClearData();
	ds_Cond.AddRow();
	ds_Cond.SetColumn(0, "SUBINV_CODE",    cbo_Subinv.Value);
	ds_Cond.SetColumn(0, "NEED_DATE",      me_NeedDate.Value);
    // 서비스셋팅
    var actionName, cmdName, inData, outData, otherArg, callBackFnc;
    var singleSql, insertSql, updateSql, deleteSql, saveFlagColumn, keySqlName, keyIncrement, callbackSql;
    inData		= "ds_IUD=ds_List:U ds_Cond=ds_Cond";
    outData		= "ds_List=ds_List";
    callBackFnc	= "fn_CallBack_Save";
	// 파라미터셋팅
    insertSql	= "fm/fmp:FMP00160E_I001";
    updateSql	= "fm/fmp:FMP00160E_U001";
    deleteSql	= "fm/fmp:FMP00160E_D001";
//    keySqlName	= "fm/fmz:FMZ_PR_NUM_S002";
//    keyIncrement= 0;
    callbackSql	= "fm/fmp:FMP00160E_S002";
	// 서버에서 작업할 정보 추가
	tit_addSearchActionInfo(this, "fm/fmz:FMZ_PR_NUM_S002", true);
	tit_addSaveActionInfo(this, insertSql, updateSql, deleteSql, saveFlagColumn, keySqlName, keyIncrement, callbackSql);
	// 서버 호출 
	tit_callService(this, actionName, cmdName, inData, outData, otherArg, callBackFnc);		// 서비스 호출 
*/
	var strSvcID, strURL, strInDatasets, strOutDatasets, strArgument, strCallbackFunc;
	
	// 경로 설정
	strSvcID = "FMP00160E_T001";
	strURL   = "U_svc::" + "fm/fmp/FMP00160E_T001.jsp";
	// 데이터셋 설정U
	strInDatasets  = "ds_IUD=ds_List:U";
	strOutDatasets = "";
	// 파라메터 설정
	strArgument  = "sSubinv=" + wrapQuote(cbo_Subinv.value);
	strArgument += " sNeedDate=" + wrapQuote(me_NeedDate.value);
	strArgument += " g_Upjang=" + wrapQuote(g_Upjang);
	strArgument += " g_EmpNo=" + wrapQuote(g_EmpNo);
	strArgument += " sDocSrc=" + wrapQuote(fa_DocSrc);
	strArgument += " sPrUpjang=" + wrapQuote(ed_Upjang.userdata);
	strArgument += " sPrSabun=" + wrapQuote(g_EmpNo);
	
	// 신규일경우 기존대로 새로운 주문번호 생성:NEW , 동일업장, 창고 및 입고일자에 주문건수가 있을경우 상품추가시  주문번호를 새로 생성하지 않는다:OLD
	strArgument += " sGubunNewOrOld=" + wrapQuote(fn_gubunNewOrOld);
	strArgument += " sMaxPrNum=" + wrapQuote(fn_maxPrNum);
	strArgument += " sMaxApproveNum=" + wrapQuote(fn_maxApproveNum);	
// [속도개선 Project 시작] 2017. 8. 4. 최범주 여신금액 집계 프로시저 추가
	strArgument += " scrnId=" + wrapQuote("FMP00160E");       // 화면ID
	strArgument += " scrnName=" + wrapQuote("주요상품발주");  // 화면명
// [속도개선 Project   끝] 2017. 8. 4. 최범주
	
	// 콜백함수 지정
	strCallbackFunc = "fn_CallBack_Save";

	//바이너리 통신 설정
	//http.Compress = true;
	//http.CompressMethod = "ZLIB";
	//http.XmlFormat = false;
	//바이너리 통신 설정	

	// 서버 호출 
	//Transaction(strSvcID, strURL, strInDatasets, strOutDatasets, strArgument, strCallbackFunc);
	jsp_transaction(this, strSvcID, strURL, strInDatasets, strOutDatasets, strArgument, strCallbackFunc, false, false, true);
}

function fn_Save2()
{
	// 최초등록시 주문번호 채번,이후에는같은번호 
	// 조회건수가 1건이라도 있을경우
	if (fn_dsListCnt > 0)
	{
		for (i=0; i<fn_dsListCnt; i++)
		{
			fn_gubunNewOrOld = "OLD";	
			
			if(!gfn_isNull(ds_List.getColumn(i, "PR_NUM")))
			{
				fn_maxPrNum = ds_List.getColumn(i, "PR_NUM");
			}
			
			if(!gfn_isNull(ds_List.getColumn(i, "APPROVE_NUM")))
			{
				fn_maxApproveNum = ds_List.getColumn(i, "APPROVE_NUM");	
			}			
		}
	}
	else
	{
		fn_maxPrNum = "";
		fn_maxApproveNum = "";
		fn_gubunNewOrOld = "NEW";
	}
	
	//저장 버튼 누른 후 팝업 상태에서 마감시간 이후 저장 체크를 위한 변경
	//[HISTORY] : 수정일 > 2009/01/19
	//            수정자 > 노규완
	//            수정 내-용 > 저장 Confirm 팝업 메시지를 제일 먼저 띄어 줌.	
	//수량 영 점검

	//현재시간 초기화. 
	//발주가능, 데이타체크에서 현재시간을 통해 계산하기때문에
	//fn_SetTimer();-->AS-IS 동일 오류
	//필수항목 
	if (fn_ChkManNull()) return;
	//발주가능 체크
	if (! fn_OrdChk()) return;
	// 데이타체크
	var sRtn = fn_ChkData();
	if (sRtn != null)
	{
		g_Message("EE", sRtn);
		return;
	}
	var strSvcID, strURL, strInDatasets, strOutDatasets, strArgument, strCallbackFunc;
	
	// 경로 설정
	strSvcID = "FMP00160E_T001";
	strURL   = "U_svc::" + "fm/fmp/FMP00160E_T001.jsp";
	// 데이터셋 설정U
	strInDatasets  = "ds_IUD=ds_List:U";
	strOutDatasets = "ds_save_out=ds_save_out";
	
	// 파라메터 설정
	strArgument  = "sSubinv=" + wrapQuote(cbo_Subinv.value);
	strArgument += " sNeedDate=" + wrapQuote(me_NeedDate.value);
	strArgument += " g_Upjang=" + wrapQuote(g_Upjang);
	strArgument += " g_EmpNo=" + wrapQuote(g_EmpNo);
	strArgument += " sDocSrc=" + wrapQuote(fa_DocSrc);
	strArgument += " sPrUpjang=" + wrapQuote(ed_Upjang.userdata);
	strArgument += " sPrSabun=" + wrapQuote(g_EmpNo);
	
	// 신규일경우 기존대로 새로운 주문번호 생성:NEW , 동일업장, 창고 및 입고일자에 주문건수가 있을경우 상품추가시  주문번호를 새로 생성하지 않는다:OLD
	strArgument += " sGubunNewOrOld=" + wrapQuote(fn_gubunNewOrOld);
	strArgument += " sMaxPrNum=" + wrapQuote(fn_maxPrNum);
	strArgument += " sMaxApproveNum=" + wrapQuote(fn_maxApproveNum);	
// [속도개선 Project 시작] 2017. 8. 4. 최범주 여신금액 집계 프로시저 추가
	strArgument += " scrnId=" + wrapQuote("FMP00160E");       // 화면ID
	strArgument += " scrnName=" + wrapQuote("주요상품발주");  // 화면명
// [속도개선 Project   끝] 2017. 8. 4. 최범주
	
	// 콜백함수 지정
	strCallbackFunc = "fn_CallBack_Save";

	//바이너리 통신 설정
	//http.Compress = true;
	//http.CompressMethod = "ZLIB";
	//http.XmlFormat = false;
	//바이너리 통신 설정	

	// 서버 호출 
	//Transaction(strSvcID, strURL, strInDatasets, strOutDatasets, strArgument, strCallbackFunc);
	jsp_transaction(this, strSvcID, strURL, strInDatasets, strOutDatasets, strArgument, strCallbackFunc, false, false, true);
}

/*------------------------------------------------------------
	1. Function ID : fn_Print()
	2. 개       요 : 업무프로세스에 따른 입력작업
	3. 기       능 : 입력버튼 입력 시 처리되는 작업
	4. 인 수 설 명 : 
*/
function fn_print()
{
	//gd_listE.ExportExcelEx("단가표");
}

/*------------------------------------------------------------
	1. Function ID : fn_Close()
	2. 개       요 : 업무프로세스에 따른 입력작업
	3. 기       능 : 입력버튼 입력 시 처리되는 작업
	4. 인 수 설 명 : 
*/
function fn_Close()
{
	This.close();
}

/*------------------------------------------------------------
	1. Function ID : fn_Help()
	2. 개       요 : 업무프로세스에 따른 입력작업
	3. 기       능 : 입력버튼 입력 시 처리되는 작업
	4. 인 수 설 명 : 
*/
function fn_help()
{
}

//=========================================================================================
// [ PART 5 ]
// Detail Process Event 정의 ( User Define function )
//
//=========================================================================================
/*------------------------------------------------------------
	1. Function ID : fn_AlertMsg(cd)
	2. 개       요 : 메세지 처리
	3. 기       능 : 화면에 나타나는 메시지 코드및 텍스트 리턴
	4. 인 수 설 명 : cd : 원하는 메시지 코드
*/
function fn_AlertMsg(cd)
{
	var v_Msg="";
	switch(cd)
	{
		case "000":
			v_Msg= "이(가) 저장되었습니다.";
			break;
		case "001":
			v_Msg= "버튼이 정의 되어 있지않습니다.";
			break;
		case "002":
			v_Msg="서비스 오류:시스템 관리자에게 문의하십시오";
			break;
		case "003":
			v_Msg="필수항목은 반드시 선택하시기 바랍니다.";
			break;	
		case "004":
			v_Msg="작업대상 본사를 선택하세요.";
			break;
		case "005":
			v_Msg="을(를) 입력하세요";
			break;
		case "006":
			v_Msg="삭제할 데이터가 없습니다.";
			break;
		case "007":
			v_Msg="변경된 데이터가 없습니다.";
			break;
		case "008":
			v_Msg="시스템ID가 없습니다.";
			break;			
/*			
		case "":
			v_Msg="";
			break;
*/			
		default:
			break;			
	}
	return v_Msg;
}

//콜백
function fn_CallBack_Search(errCode, errMsg)
{
	if (errCode == 0)
	{
		if (ds_List.rowcount > 0)
			gd_list.setFocus();
		else
		{
			g_Message("EE","주문등록한 상품이 없습니다.");
			//me_NeedDate.setFocus();
		}
		
		//최초등록시 주문번호 채번,이후에는같은번호 
		ds_List.filter("OTCUSTCD=='0000'");
		fn_dsListCnt = 0;
		fn_dsListCnt = ds_List.rowcount;
		ds_List.filter("");
		
		fn_getOrderCtrlList();
		
	}
	else
		g_Message("EE",fn_AlertMsg("002"));
}

//function fn_CallBack_Delete(SvcID, errCode, errMsg)
function fn_CallBack_Delete(errCode, errMsg)
{
ta_Sql.value = fa_Sql;
	if (errCode == 0)
	{
		//PR_ID를 (-)으로 설정하여 저장 시 다시 삭제하는 일이 없도록 한다.
		ds_List.setColumn(ds_List.rowposition,"PR_ID","-1");
		ds_List.deleteRow(ds_List.rowposition);
		//삭제자료만 존재한다면 데이타셑의 row type을 초기화 하여 삭제상태를 초기화 한다.
		if (ds_List.getCaseCount("rowtype='insert'||rowtype='update'") <= 0) ds_List.applyChange();
		
		//최초등록시 주문번호 채번,이후에는같은번호 
		ds_List.filter("OTCUSTCD=='0000'");
		if (ds_List.rowcount == 0)
		{
			fn_dsListCnt = 0;
		}
		else
		{
			fn_dsListCnt = ds_List.rowcount;
		}
		ds_List.filter("");
		
		fn_getOrderCtrlList();
		
// [속도개선 Project 시작] 2017. 8. 21. 최범주 여신정보조회 함수 대체
		if ( !fn_GetCredit() ) return; // 여신정보 조회
// [속도개선 Project   끝] 2017. 8. 21. 최범주
	}
	else
		g_Message("EE",fn_AlertMsg("002"));
}

//function fn_CallBack_Save(SvcID, errCode, errMsg)
function fn_CallBack_Save(errCode, errMsg)
{
	if (errCode == 0)
	{
// [속도개선 Project 시작] 2017. 8. 21. 최범주 여신정보조회 함수 대체
		if ( !fn_GetCredit() ) return; // 여신정보 조회
// [속도개선 Project   끝] 2017. 8. 21. 최범주
		fn_search();
		g_Message("02","주문자료" + fn_AlertMsg("000"));
	} else {
		if(ds_save_out.rowcount >0){
			// 자재유효성체크에서 걸린 리스트
			var sRet = gfn_dialog("", "U_FMP::FMP00030P.xfdl", "", "", "", "", "", "", "", "", "", false);
			return;
		}
		g_Message("EE",fn_AlertMsg("002"));
	}
		
}

function fn_ChkManNull()
{
	if (ffn_ChkNull(ed_Upjang.userdata))
	{
		g_Message("EE", "사업장" + fn_AlertMsg("005"));
		if (ed_Upjang.enable) ed_Upjang.setFocus();
		return true;
	}
	if (ffn_ChkNull(cbo_Subinv.value))
	{
		g_Message("EE", "식당을 선택하세요.");
		if (cbo_Subinv.enable) cbo_Subinv.setFocus();
		return true;
	}
	if ( ffn_ChkNull(me_NeedDate.value) || (gfn_length(me_NeedDate.value)< 8) )
	{
		g_Message("EE", "입고예정일을 정확하게 입력하세요.");
		me_NeedDate.setFocus();
		return true;
	}
	//
	return false;
}

function fn_ChkData()
{
	//변경여부 확인
	if ( (! gfn_dsIsUpdated(ds_List)) )
	{
		return fn_AlertMsg("007");
	}
// [속도개선 Project 시작] 2017. 8. 21. 최범주 여신정보조회 함수 대체
	if ( !fn_GetCredit() ) return; // 여신정보 조회
// [속도개선 Project   끝] 2017. 8. 21. 최범주
	//여신한도초과여부
	//if (ed_Credit.Text != "무 제 한")
	if (ds_CrdInfo.rowcount > 0)
	{
		//여신금액
		if (ds_CrdInfo.getColumn(0,"CREDIT_AMOUNT_CONTROL_YN") == "Y")
		{
			var nAmt = 0;
			
			/*주요상품의 경우 팝업창에서 여신을 체크 하므로 아래의 여신체크는 뺀다. 주석풀면 여신 오류남*/
			/*
			for (i=0; i<ds_List.rowcount; i++)
				nAmt += Math.round((ds_List.getColumn(i,"OP_AMOUNT") - ds_List.getColumn(i,"OP_AMOUNT_OLD")) * iif(ds_List.getColumn(i,"TAX_CODE")=="100",1.1,1));
			
			if (nAmt > toNumber(ds_CrdInfo.getColumn(0,"CREDIT_AVAIL_AMT")))
			{
				return "주문가능한 여신한도를 초과하여 주문이 불가합니다.";
			}
			*/
			
			for (i=0; i<ds_List.rowcount; i++) {
				nAmt += Math.round(( toNumber(ds_List.getColumn(i,"OP_PRICE")) * toNumber(ds_List.getColumn(i,"PR_QTY"))  - toNumber(ds_List.getColumn(i,"OP_AMOUNT_OLD"))) * iif(ds_List.getColumn(i,"TAX_CODE")=="100",1.1,1));
			}
				
			if ( nAmt > toNumber(ds_CrdInfo.getColumn(0,"CREDIT_AVAIL_AMT")) )
			{
				return "주문가능한 여신한도를 초과하여 주문이 불가합니다.";
			}
			
		}
		//여신회전일
		if (ds_CrdInfo.getColumn(0,"CREDIT_TURN_CONTROL_YN") == "Y")
		{
			if (toNumber(ds_CrdInfo.getColumn(0,"LAST_TURN_CNT")) >= 0)
			{
				if (toNumber(ds_CrdInfo.getColumn(0,"LAST_TURN_CNT")) > toNumber(ds_CrdInfo.getColumn(0,"CREDIT_TURN_DAYS_TOT")))
				{
					return ds_CrdInfo.getColumn(0,"L_BILL_DATE_DISP") + "에 매출채권이 존재하여 주문이 불가합니다.";
				}
			}
		}
	}
	//상품별 디데이 체크
	for (i=0; i<ds_List.rowcount; i++)
	{
		//수량 0인건 어차피 지울꺼니 패스...
		if ( gfn_numFormat(ds_List.getColumn(i,"PR_QTY"),1)== "0" ) continue;
		//기존자료이거나 무통제면 패스...
		if ( gfn_numFormat(ds_List.getColumn(i,"D_DAYS"))== "0" ) continue;
		//디데이체크
		if ( ds_List.getRowType(i) == Dataset.ROWTYPE_INSERT || ds_List.getRowType(i) == Dataset.ROWTYPE_UPDATE )
		{
		
			if ( gfn_addDate(gds_currdate.getColumn(0,"YMD"),ds_List.getColumn(i,"D_DAYS"))> me_NeedDate.value )
			{
				ds_List.rowposition = i;
				return ("[" + ds_List.getColumn(i,"ITEM_NAME") + "]상품은 주문일자(D-" + ds_List.getColumn(i,"D_DAYS") + ")를 초과하여 주문이 불가합니다.");
			}
			else if ( gfn_addDate(gds_currdate.getColumn(0,"YMD"),ds_List.getColumn(i,"D_DAYS"))== me_NeedDate.value )
			{
				//디타임체크
				if ( gfn_subStr(gds_currdate.getColumn(0, "YMD_TM"),8,4)> ds_List.getColumn(i,"D_TIMES") )
				{
					ds_List.rowposition = i;
					return ("[" + ds_List.getColumn(i,"ITEM_NAME") + "]상품은 주문시간(" + gfn_right("0"+ds_List.getColumn(i,"D_TIMES"),4)+ ")을 초과하여 주문이 불가합니다.");
				}
			}
		}	
        //-----------------------------------------------------------------------------------
		//--- 체크로직 추가 
		//    수정일    : 2010/10/28 BY 노규완
		//    수정내용  : 상품 수량 입력 시 기존에는 라인별로 최대발주량 체크 하였으나,
		//                추가 상품으로 동일 상품을 등록 한 다음 최대 발주량만 넘지 않으면 
		//                추가로 상품이 저장 되는 문제가 발생하여, 입고 예정일 기준으로 
		//                동일 상품의 총 합계를 체크 하여 최대 발주량을 넘는지 체크 한다.
		//-----------------------------------------------------------------------------------
		if ((ds_List.getColumn(i,"MAX_ORD_QTY") > 0) && ( ds_List.getCaseSum("ITEM_CODE=='"+ds_List.getColumn(i,"ITEM_CODE")+"'","PR_QTY") > ds_List.getColumn(i,"MAX_ORD_QTY")))
		{
			ds_List.rowposition = i;
			return ("[" + ds_List.getColumn(i,"ITEM_NAME") + "] 상품이 최대 발주량" + ds_List.getColumn(i,"MAX_ORD_QTY") + ")를 초과하여 주문이 불가합니다.");
		}		
	}
	//저장 시 수량이 0 이거나 NULL 인 자재 삭제 처리
	for (i=ds_List.rowcount-1; i>=0; i--)
	{
		//if ( gfn_numFormat(ds_List.getColumn(i,"PR_QTY"),1)== "0" ) ds_List.deleteRow(i);
		if( ds_List.getColumn(i, "PR_QTY") == 0 || gfn_length(gfn_trim(ds_List.getColumn(i, "PR_QTY"))) == 0 ) {
			ds_List.deleteRow(i);
		}
	}
}

function fn_FormKeyDown(obj:Form, e:KeyEventInfo)
{
	gfn_formKeyDown(obj, e); //(obj,e.fromreferenceobject,e.keycode,e.shiftKey,e.ctrlKey,e.altKey,-1,-1);
	//입고예정일에서 엔터시 조회
	if ( (e.keycode == 13) && (e.fromreferenceobject == me_NeedDate) ) fn_search();
}	

function fn_edBtn_OnClick(obj:Button, e:ClickEventInfo)
{
	var sAddWhere = "";
	
	switch(obj.name)
	{
		case "btn_Upjang":
			sAddWhere = " AND A.USE_YN = 'Y'";
			//본사인 경우 해당 사업장 조회
			if (application.g_UserKind == '본사')
				sAddWhere += " AND A.MAIN_UPJANG = " + application.g_Main_Upjang;
			//사업장인 경우 관리업장만 조회
			else if (application.g_UserKind == '사업장')
				sAddWhere += " AND ( A.UPJANG = " + application.g_Upjang + " OR EXISTS (SELECT 1 FROM FMS_USER_UPJANG B WHERE B.USE_YN = 'Y' AND B.UPJANG = A.UPJANG AND B.SABUN = '" + application.g_EmpNo + "') )";

			break;

		default:
			break;
	}
	//fm공통 팝업클릭 호출
	if (ffn_btn_OnClick(obj, sAddWhere)) fn_Trigger_edBtn(eval("ed_" + gfn_subStr(obj.name, 4)));
}

function fn_edBtn_OnKeyDown(obj:Edit, e:KeyEventInfo)
{
	var sOnBoard = "";
	
	if (ffn_ed_OnKeyDown(obj,e.keycode)) fn_Trigger_edBtn(obj);
	if (e.keycode == 46) fn_Trigger_edBtn(eval(sOnBoard + "ed_" + gfn_subStr(obj.name, 3)));
}

function fn_Trigger_edBtn(obj)
{
	switch(obj)
	{
		case ed_Upjang:
			//초기화
			fn_ResetData();
			if (! ffn_ChkNull(obj.userdata))
			{
				//창고세팅
				fn_SetSubinv();
				//디데이
				fn_GetDays();
// [속도개선 Project 시작] 2017. 8. 21. 최범주 여신정보조회 함수 대체				
				if ( !fn_GetCredit() ) return; // 여신정보 조회
// [속도개선 Project   끝] 2017. 8. 21. 최범주
				//최종 발주정보
				//fn_GetLastOrd();
				//자동조회
				fn_search();
			}

			break;
			
		default:

			break;
	}
}

function fn_ResetData()
{
	ds_Subinv.clearData();
	st_Days.text = "▶ 발주 마감 : - -";
	ed_Credit.value = "";
	me_Pdate.value = "";
	ed_Pcnt.value = "";
	ed_Pamt.value = "";
	ed_Bond.value = "";
	cbo_Subinv.value = "";
	ds_List.clearData();
	
	me_NeedDate.value  = gfn_addDate(gds_currdate.getColumn(0, "YMD"),1);
	
}

function fn_SetSubinv()
{
	/*-------------*/
	http.Sync = true;
	/*-------------*/
	// 초기화
	ds_Subinv.clearData();
	// 조회
	var actionName, cmdName, inData, outData, otherArg, callBackFnc;
	// 파라미터셋팅
    outData		= "ds_Subinv=ds_List";
    otherArg	= "UPJANG=" + wrapQuote(ed_Upjang.userdata);
	//action 정보 초기화 
	fsp_clear(this); 
    // 서버에서 조회할 정보 추가 
	fsp_addSearch(this, "fm/fmz:FMZ_PO_SUBINV_S001");
	// 서버 호출 
    fsp_callService(this, actionName, cmdName, inData, outData, otherArg, callBackFnc);
	/*-------------*/
	http.Sync = false;
	/*-------------*/
	//기본창고지정
	if (ds_Subinv.rowcount > 0) cbo_Subinv.index = 0;
}

function fn_GetDays()
{
	// 초기화(디데이)
	ds_Days.clearData();
	// 조회
	var actionName, cmdName, inData, outData, otherArg, callBackFnc;
	// 파라미터셋팅
    outData		= "ds_Days=ds_List";
    otherArg	= "UPJANG=" + wrapQuote(ed_Upjang.userdata) + " SUBINV_CODE=" + wrapQuote(cbo_Subinv.value) + " NEED_DATE=" + wrapQuote(me_NeedDate.value);
	//action 정보 초기화 
	fsp_clear(this); 
    // 서버에서 조회할 정보 추가 
	fsp_addSearch(this, "fm/fmz:FMZ_GETDAYS_S001");
	// 서버 호출 
	http.Sync = true;
    fsp_callService(this, actionName, cmdName, inData, outData, otherArg, callBackFnc);
	http.Sync = false;
	//디데이 표시
	if (ds_Days.rowcount > 0)
		st_Days.text = "▶ 발주 마감 : " + ds_Days.getColumn(0,"DAYS");
	else
	{
		g_Message("EE","발주마감정보를 확인할 수 없습니다.!" + "\n\n" + "관리자에게 문의하세요.");
		//close();
	}
	
	// 초기화(주문통제)
	ds_OrdCtrl.clearData();
	// 조회
	var actionName, cmdName, inData, outData, otherArg, callBackFnc;
	// 파라미터셋팅
    outData		= "ds_OrdCtrl=ds_List";
    otherArg	= "UPJANG=" + wrapQuote(ed_Upjang.userdata);
	//action 정보 초기화 
	fsp_clear(this); 
    // 서버에서 조회할 정보 추가 
	fsp_addSearch(this, "fm/fmz:FMZ_ORD_CTRL_S001");
	// 서버 호출 
	http.Sync = true;
    fsp_callService(this, actionName, cmdName, inData, outData, otherArg, callBackFnc);
	http.Sync = false;
}

// [속도개선 Project 시작] 2017. 8. 21. 최범주 여신정보조회 함수 대체
/*----------------------------------------------------------------------------------------------
 * 설명      : 여신정보 조회
 *---------------------------------------------------------------------------------------------*/
function fn_GetCredit() {
	var rtnValue = false;
	
	////////////////////////////////////////////////////////////////////////////////////////////////////////
	// 초기화
	////////////////////////////////////////////////////////////////////////////////////////////////////////
	ds_Cond.clearData();
	ds_CrdInfo.clearData();

	////////////////////////////////////////////////////////////////////////////////////////////////////////
	// 여신정보 조회 조건 셋팅
	////////////////////////////////////////////////////////////////////////////////////////////////////////
	var iRow = ds_Cond.addRow();
	ds_Cond.setColumn(iRow, "UPJANG", ed_Upjang.userdata);    // 업장코드
	ds_Cond.setColumn(iRow, "NEED_DATE", me_NeedDate.value);  // 입고예정일
	
	////////////////////////////////////////////////////////////////////////////////////////////////////////
	// 서버단 호출
	////////////////////////////////////////////////////////////////////////////////////////////////////////
	var svcID, svcUrl, inData, outData, otherArg, callBackFnc, isErrorNotCall, isNotShow, isSync;
	svcID          = "FMZ_CREDIT_INFO_T003";                         // 서비스 ID
	svcUrl         = "U_svc::" + "fm/fmz/FMZ_CREDIT_INFO_T003.jsp";  // 서비스 URL
	inData         = "ds_Cond=ds_Cond";                              // 서버로 전송할 DataSet 객체 Str
	outData        = "ds_CrdInfo=ds_CrdInfo";                        // 서버로부터 전송 받을  DataSet 객체 String
	otherArg       = "";                                             // 서버로 전송할 기타 Argument 정보 String
	callBackFnc    = "";                                             // 서버에서 처리가 완료된 후 Callback 받을 Function 명
	isErrorNotCall = false;                                          // 에러 발생 시 Callback 함수 호출 여부
	isNotShow      = false;                                          // 처리중입니다. 메시지 창 보여줄지 여부 설정하기
	isSync         = true;                                           // 동기식으로 설정할지 여부
	jsp_transaction(this, svcID, svcUrl, inData, outData, otherArg, callBackFnc, isErrorNotCall, isNotShow, isSync);

	////////////////////////////////////////////////////////////////////////////////////////////////////////
	// 여신정보 셋팅
	////////////////////////////////////////////////////////////////////////////////////////////////////////
	ta_Sql.value = fa_Sql;
	
	if ( ds_CrdInfo.getRowCount() == 0 ) {
		g_Message("EE", "업장여신정보를 확인할 수 없습니다.\n\n관리자에게 문의하십시오.");
		
	} else {
		rtnValue = true;
		
		// 여신금액통제일 경우
		if ( ds_CrdInfo.getColumn(0,"CREDIT_AMOUNT_CONTROL_YN") == "Y" ) {
			ed_Credit.value      = gfn_numFormat(ds_CrdInfo.getColumn(0,"CREDIT_RMN_AMT"));    // 가용여신
			ed_CreditAvail.value = gfn_numFormat(ds_CrdInfo.getColumn(0,"CREDIT_AVAIL_AMT"));  // 실주문가능금액
			ed_Bond.value        = gfn_numFormat(ds_CrdInfo.getColumn(0,"BOND_AMT"));          // 채권잔액
		} else {
			ed_Credit.value      = "무 제 한";
			ed_CreditAvail.value = "";
			ed_Bond.value        = "";
		}
	}
	
	return rtnValue;
}
// [속도개선 Project   끝] 2017. 8. 21. 최범주

// [속도개선 Project 시작] 2017. 8. 21. 최범주 여신정보조회 함수 대체
// function fn_GetCrdYn()
// {
// 	//ds임시생성
// 	var dsObjin, dsObjot;
// 		
// 	create("Dataset", "ds_Dummyin");
// 	create("Dataset", "ds_Dummyot");
// 	
// 	dsObjin = eval("ds_Dummyin");
// 	dsObjin.addColumn("UPJANG", "INT", 22);
// 	dsObjin.addColumn("NEED_DATE", "STRING", 8);
// 	dsObjot = eval("ds_Dummyot");
// 	dsObjot.addColumn("CRD_YN", "STRING", 1);
// 	
// 	/*-------------*/
// 	http.Sync = true;
// 	/*-------------*/
// 	// 초기화
// 	ds_Dummyin.clearData();
// 	ds_Dummyot.clearData();
// 	ds_Dummyin.addRow();
// 	ds_Dummyin.setColumn(0, "UPJANG",         ed_Upjang.userdata);
// 	ds_Dummyin.setColumn(0, "NEED_DATE",      me_NeedDate.value);
// 	// 조회
// 	var actionName, cmdName, inData, outData, otherArg, callBackFnc;
// 	// 파라미터셋팅
//     inData		= "ds_Cond=ds_Dummyin";
//     outData		= "ds_Dummyot=ds_List";
// 	//action 정보 초기화 
// 	fsp_clear(this); 
//     // 서버에서 조회할 정보 추가 
// 	fsp_addSearch(this, "fm/fmz:FMZ_CREDIT_CHKYN_S001");
// 	// 서버 호출 
//     fsp_callService(this, actionName, cmdName, inData, outData, otherArg, callBackFnc);
// 	/*-------------*/
// 	http.Sync = false;
// 	/*-------------*/
// 
// 	var bYn = (ds_Dummyot.rowcount > 0);
// 
// 	//ds임시생성 해제
// 	Destroy("ds_Dummyin");
// 	Destroy("ds_Dummyot");
// 
// 	return  bYn;
// }
// [속도개선 Project   끝] 2017. 8. 21. 최범주

function fn_GetLastOrd()
{
	//ds임시생성
	var dsObjin, dsObjot;
		
	create("Dataset", "ds_Dummyin");
	create("Dataset", "ds_Dummyot");
	
	dsObjin = eval("ds_Dummyin");
	dsObjin.addColumn("SUBINV_CODE", "STRING", 8);
	dsObjin.addColumn("NEED_DATE", "STRING", 8);
	dsObjin.addColumn("DOCU_SOURCE", "STRING", 50);
	dsObjot = eval("ds_Dummyot");
	dsObjot.addColumn("NEED_DATE", "STRING", 8);
	dsObjot.addColumn("CNT", "DECIMAL", 22);
	dsObjot.addColumn("AMT", "DECIMAL", 22);
	
	/*-------------*/
	http.Sync = true;
	/*-------------*/
	// 초기화
	dsObjin.clearData();
	dsObjot.clearData();
	dsObjin.addRow();
	dsObjin.setColumn(0, "SUBINV_CODE",    cbo_Subinv.value);
	dsObjin.setColumn(0, "NEED_DATE",      me_NeedDate.value);
	dsObjin.setColumn(0, "DOCU_SOURCE",    fa_DocSrc);
	
	// 조회
	var actionName, cmdName, inData, outData, otherArg, callBackFnc;
	
	// 파라미터셋팅
    inData		= "ds_Cond=ds_Dummyin";
    outData		= "ds_Dummyot=ds_List";

	//action 정보 초기화 
	fsp_clear(this); 
    // 서버에서 조회할 정보 추가 
	fsp_addSearch(this, "fm/fmp:FMP00160E_S001");
	// 서버 호출 
    fsp_callService(this, actionName, cmdName, inData, outData, otherArg, callBackFnc);		// 서비스 호출 
	/*-------------*/
	http.Sync = false;
	/*-------------*/

	//최근 발주 표시
	if (ds_Dummyot.rowcount > 0)
	{
		me_Pdate.value = ds_Dummyot.getColumn(ds_Dummyot.rowcount-1,"NEED_DATE");
		ed_Pcnt.value = '총 (' + gfn_numFormat(ds_Dummyot.getColumn(ds_Dummyot.rowcount-1,"CNT"))+ ') 건';
		ed_Pamt.value = gfn_numFormat(ds_Dummyot.getColumn(ds_Dummyot.rowcount-1,"AMT"))+ ' 원';
	}
	else
	{
		me_Pdate.value = "";
		ed_Pcnt.value = "";
		ed_Pamt.value = "";
	}

	//ds임시생성 해제
	Destroy("ds_Dummyin");
	Destroy("ds_Dummyot");
}

function fn_OrdChk(sMode)
{
	fn_GetDays();
	fn_CurrDateWeek();

	//입고통제일 체크 
	if (fn_NeedDateCheck()) 
	{
	    g_Message("EE","해당일자는 입고통제일 입니다.");
	    ds_List.clearData();
		return false;
	}

	//발주통제일자
	if (toNumber(ds_Days.getColumn(0,"D_OVER_DAYS")) > 0)
	{
		if (me_NeedDate.value > gfn_addDate(gds_currdate.getColumn(0, "YMD"),toNumber(ds_Days.getColumn(0,"D_OVER_DAYS"))))
		{
			g_Message("EE", ds_Days.getColumn(0,"D_OVER_DAYS") + "일을 초과하여 입고예정일을 지정할 수 없습니다.");
			return false;
		}
	}
	//발주제한일자
	if (toNumber(ds_Days.getColumn(0,"D_DAYS")) > 0)
	{
		if (me_NeedDate.value < gfn_addDate(gds_currdate.getColumn(0, "YMD"),toNumber(ds_Days.getColumn(0,"D_DAYS"))))
		{
			g_Message("EE", "발주마감은 " + ds_Days.getColumn(0,"DAYS") + "입니다.");
			return false;
		}
		if (me_NeedDate.value == gfn_addDate(gds_currdate.getColumn(0, "YMD"),toNumber(ds_Days.getColumn(0,"D_DAYS"))))
		{
			if (gfn_subStr(gds_currdate.getColumn(0, "YMD_TM"),8,6)> ds_Days.getColumn(0,"D_TIMES"))
			{
				g_Message("EE", "발주마감은 " + ds_Days.getColumn(0,"DAYS") + "입니다.");
				return false;
			}
		}
	}
	//창고가 식재 또는 소모품 전용창고인 경우 주문통제 점검
	if (! ffn_ChkNull(ds_Subinv.getColumn(ds_Subinv.rowposition,"CONSUM_YN")))
	{
		//주문통제(주문일자)
		var nRow;
		nRow = ds_OrdCtrl.findRowExpr("CTRL_TYPE=='주문'&&ITEM_TYPE==decode('" + ds_Subinv.getColumn(ds_Subinv.rowposition,"CONSUM_YN") + "','Y','소모품','식자재')");
		if (nRow >= 0)
		{
			if (ds_OrdCtrl.getColumn(nRow,ToUpper(gds_currdate.getColumn(0, "WEEK_ENG"))) == "Y")
			{
				g_Message("EE", gds_currdate.getColumn(0, "WEEK_KOR") + "요일은 주문불가 요일입니다.");
				return false;
			}
		}
		//주문통제(입고일자)
		nRow = ds_OrdCtrl.findRowExpr("CTRL_TYPE=='입고'&&ITEM_TYPE==decode('" + ds_Subinv.getColumn(ds_Subinv.rowposition,"CONSUM_YN") + "','Y','소모품','식자재')");
		if (nRow >= 0)
		{
			if (ds_OrdCtrl.getColumn(nRow,ToUpper(ffn_DayToWeek(me_NeedDate.value,"1"))) == "Y")
			{
				g_Message("EE", ffn_DayToWeek(me_NeedDate.value) + "요일은 입고불가 요일입니다." + "\n\n" + "입고예정일을 변경하세요.");
				return false;
			}
		}
	}else{
		//주문통제(입고일자)
		nRow = ds_OrdCtrl.findRowExpr("CTRL_TYPE=='입고'&&ITEM_TYPE=='공통'");
		if (nRow >= 0)
		{
			if (ds_OrdCtrl.getColumn(nRow,ToUpper(ffn_DayToWeek(me_NeedDate.value,"1"))) == "Y")
			{
				g_Message("EE", ffn_DayToWeek(me_NeedDate.value) + "요일은 입고불가 요일입니다." + "\n\n" + "입고예정일을 변경하세요.");
				return false;
			}
		}
	}
	
	if ( sMode != "open" ) {
		var ctrlOrder = fn_checkOrderCtrl();
		if ( !gfn_isNull(ctrlOrder) ) {
			g_Message("EE", ctrlOrder);
			return false;
		}
	}
	//
	return true;
}
//=========================================================================================
// [ PART 6 ]
// component Event 정의 ( User Define function )
// --> component Event의 기요,기능,동작 등 상세내용은 MiPlatform 메뉴얼을 참조하시기 바랍니다.
//=========================================================================================
function gd_list_OnHeadClick(obj:Grid, e:GridClickEventInfo)
{
	gfn_gridSort(obj, e); //(eval(obj.binddataset), obj, e.cell);
}

function cbo_Subinv_OnChanged(obj:Combo, e:ItemChangeEventInfo)
{
	//초기화
	me_Pdate.value = "";
	ed_Pcnt.value = "";
	ed_Pamt.value = "";
	ds_List.clearData();
	//최종 발주정보
	//fn_GetLastOrd();
	//데이타셑 위치변경
	ds_Subinv.rowposition = e.postindex;
	//디데이
	fn_GetDays();
	//자동조회
	fn_search();
}

function me_NeedDate_OnChanged(obj:MaskEdit, e:TextChangedEventInfo)
{
	g_Date_OnKillFocus(obj);
	
	//초기화
//	me_Pdate.Value = "";
//	ed_Pcnt.Text = "";
//	ed_Pamt.Text = "";
	ds_List.clearData();
	//최종 발주정보
//	fn_GetLastOrd();
	//디데이
	fn_GetDays();
}

function ds_List_CanColumnChange(obj:Dataset, e:DSColChangeEventInfo)
{
	//수량체크
	if (e.columnid == "PR_QTY")
	{
		//(-)발주여부
		if ( toNumber(e.newvalue) < 0 )
		{
			g_Message("EE","(-)발주는 불가합니다.");
			return false;
		}
		//수량통제 안하는 업장의 경우 이하 패스...
		//if (ds_Days.GetColumn(0,"QTY_CONTROL_YN") = "N") return;
		//
		//수량통제 안하는 업장의 경우 소숫점발주가 Y이면 무조건 최소발주량/발주승수량을 무조건 0.1로 세팅하여 조회
		if ( toNumber(e.newvalue) > 0 )
		{
			//최소발주량 체크
			if ( (toNumber(obj.getColumn(e.row,"MIN_ORD_QTY")) > 0) && (toNumber(obj.getColumn(e.row,"MIN_ORD_QTY")) > toNumber(e.newvalue)) )
			{
				g_Message("EE","해당 상품은 최소발주량이 " + obj.getColumn(e.row,"MIN_ORD_QTY") + "입니다.");
				return false;
			}
			//최대발주량 체크
			if ( (toNumber(obj.getColumn(e.row,"MAX_ORD_QTY")) > 0) && (toNumber(obj.getColumn(e.row,"MAX_ORD_QTY")) < toNumber(e.newvalue)) )
			{
				g_Message("EE","해당 상품은 최대발주량이 " + obj.getColumn(e.row,"MAX_ORD_QTY") + "입니다.");
				return false;
			}
			//소숫점발주여부
			if ( (obj.getColumn(e.row,"POINT_FLAG") != "Y") && (Math.ceil(toNumber(e.newvalue)) != toNumber(e.newvalue)) )
			{
				g_Message("EE","해당 상품은 소숫점발주가 불가합니다.");
				return false;
			}
			//발주승수량
			if ( (toNumber(obj.getColumn(e.row,"MULTIPLIER_QTY")) > 0) && ((Math.round(toNumber(e.newvalue) * 1000) % Math.round(toNumber(obj.getColumn(e.row,"MULTIPLIER_QTY")) * 1000)) <> 0) )
			{
				g_Message("EE","해당 상품은 발주승수량이 " + obj.getColumn(e.row,"MULTIPLIER_QTY") + "입니다.");
				return false;
			}
		}
		
		//3개월치 최대발주량 초과시 알람
		if ( toNumber(e.newvalue) >  toNumber(obj.getColumn(e.row,"MAX_SO_QTY")) )
		{
			g_Message("EE","해당 상품은 최근 3개월 최대발주량 " + obj.getColumn(e.row,"MAX_SO_QTY") + " 을 초과 하였습니다. ");
		}
	}
	return true;
}

function ds_List_OnColumnChanged(obj:Dataset, e:DSColChangeEventInfo)
{
	//금액계산
	if (e.columnid == "PR_QTY")
	{
		var nAmt = Math.round(toNumber(obj.getColumn(e.row,"SALE_PRICE")) * toNumber(e.newvalue));
		obj.setColumn(e.row, "SALE_AMOUNT", nAmt);
		nAmt = Math.round(toNumber(obj.getColumn(e.row,"OP_PRICE")) * toNumber(e.newvalue));
		obj.setColumn(e.row, "OP_AMOUNT", nAmt);
	}
}

function btn_Item_OnClick(obj:Button, e:ClickEventInfo)
{
	/*시스템 통제 시간 체크 - 특정일자에 사용을 할 수 없게 한다.*/
	mfn_GetSystemWorkCheck("PO");
	if (ds_common.getColumn(0, 0) == "Y")
	{
		g_Message("EE", "시스템 변경 작업중이라 현 화면을 사용할 수 없습니다. \n사용불가시간(" + ds_common.getColumn(0, 1) + " ~ " + ds_common.getColumn(0, 2) + ") ");
		return false; 
	}	
	
	//필수항목 
	if (fn_ChkManNull()) return;
	//발주가능 체크
	if (! fn_OrdChk("open"))
	{
		btn_NeedDate.setFocus();
		return;
	}
	
	// FICS 발주제한요일, 시간 설정 조회
    //fn_getWeekendTime();
	
	//
// [속도개선 Project 시작] 2017. 7. 19. 최범주 발주버튼 클릭 시 주요상품검색 팝업 저장버튼 권한처리
	fn_getBtnAuthInfo();  // 주요상품검색 팝업 저장버튼 권한조회
	
	var sParam = {  fa_Upjang:ed_Upjang.userdata
	              , fa_SubinvCode:cbo_Subinv.value
	              , fa_NeedDate:me_NeedDate.value
	              , fa_Consum:ds_Subinv.getColumn(ds_Subinv.rowposition,"CONSUM_YN")
	              , fa_Qty_Ctl:ds_Days.getColumn(0,"QTY_CONTROL_YN")
	              , fa_TabIdx:obj.userdata
	              , fa_PopupGubun:'FMP00161P'
	              , fa_sHiddenYn:fv_sHiddenYn
	              , fa_CtrlAmt: { text : stc_ctrlAmt.text
									, visible : stc_ctrlAmt.visible
									, color : stc_ctrlAmt.style.color }
	             };
// [속도개선 Project   끝] 2017. 7. 19. 최범주
	//gfn_dialog("", "U_FMP::FMP00161P.xfdl",sParam);
	gfn_dialog("", "U_FMP::FMP00161P.xfdl",sParam, -1, -1, null, -1, -1, false, null, null, true);
	
	fn_Save2();
}

function gd_list_OnCellClick(obj:Grid, e:GridClickEventInfo)
{
	//2010/03/23 수량 입력 클릭 시 공백 처리 == by Noh Kyu Wan ==
	if (e.cell == 8)
	{
	    if (ds_List.getColumn(e.row,"PR_QTY") <> 0)
	    {}
	    else	    
		ds_List.setColumn(e.row,"PR_QTY","");		
	}	
	
	if (eval(obj.binddataset).rowcount < 1) return;
	if (e.row < 0) return;
	if (e.cell <> 1) return;
	
	//상품이미지
/*
	if (object(obj.BindDataset).GetColumn(nRow, "OTCUSTCD") = "0000")
		gfn_dialog("", "U_SCC::SCC91000P.xml","fa_Image="+quote(gfmsImgPathH + object(obj.BindDataset).GetColumn(nRow, "IMAGE_PATH")));
	else
		gfn_dialog("", "U_SCC::SCC91000P.xml","fa_Image="+quote(gfmsImgPathO + object(obj.BindDataset).GetColumn(nRow, "IMAGE_PATH")));
*/
	
	/******************* 구매 자재팝업으로 변경
	var strParam = {};
	strParam["fa_CenterCode"] = eval(obj.binddataset).getColumn(e.row, "CENTER_CODE");
	strParam["fa_Custcd"] = eval(obj.binddataset).getColumn(e.row, "CUSTCD");
	strParam["fa_ItemCode"] = eval(obj.binddataset).getColumn(e.row, "ITEM_CODE");
	if (gfn_length(eval(obj.binddataset).getColumn(e.row, "IMAGE_PATH"))<= 0) {
		strParam["fa_Image"] = '';
	} else {
		if (eval(obj.binddataset).getColumn(e.row, "OTCUSTCD") == "0000")
			strParam["fa_Image"] = gfmsImgPathH + eval(obj.binddataset).getColumn(e.row, "IMAGE_PATH");
		else
			strParam["fa_Image"] = gfmsImgPathO + eval(obj.binddataset).getColumn(e.row, "IMAGE_PATH");
	}
	strParam["fa_ItemPrice"] = eval(obj.binddataset).getColumn(e.row, "OP_PRICE");
	gfn_dialog("", "U_FMP::FMP00010P.xfdl", strParam);
	********************/
	
	
	var arrParam = new Array();
	
	arrParam[0] = eval(obj.binddataset).getColumn(e.row, "ITEM_CODE");
	
	var rtnVal = gfn_dialog("FMP00010P"			// dialogId
				   , "U_FMP::FMP00010P.xfdl"		// Url
				   , {fv_Contents:arrParam}					// 배열
				   , null, null, null, null, null, false, true, -1);
				   
	//자재상세팝업 호출 : 두번째 파라미터는 아이템코드 
	//SCSysIf.eprocPopup(SCSysIf.EPROC_ITEM_POPUP, eval(obj.binddataset).getColumn(e.row, "ITEM_CODE"));
}

function gd_list_OnCellPosChanged(obj:Grid, e:GridSelectEventInfo)
{
	//2010/03/23 수량 입력 클릭 시 공백 처리 == by Noh Kyu Wan ==
	if (e.cell == 7)
	{
	    if (ds_List.getColumn(e.row,"PR_QTY") <> 0)
	    {}
	    else	    
		ds_List.setColumn(e.row,"PR_QTY","");		
	}
}

//*************************************************************
// 2010-08-05  보조금 관련 추가 ( 사업장 보조금 관리 유무조회)
//*************************************************************
function fn_Green_Upjang()
{
	/*-------------*/
	http.Sync = true;
	/*-------------*/
	// 조회
	var actionName, cmdName, inData, outData, otherArg, callBackFnc;
	// 파라미터셋팅
    outData		= "ds_Green=ds_Green";
    otherArg	= "UPJANG=" + wrapQuote(ed_Upjang.userdata);	
	//action 정보 초기화 
	fsp_clear(this); 
    // 서버에서 조회할 정보 추가 
	fsp_addSearch(this, "sc/scc:SCC_GREEN_USER");
	// 서버 호출 
    fsp_callService(this, actionName, cmdName, inData, outData, otherArg, callBackFnc);
	/*-------------*/
	http.Sync = false;
	/*-------------*/	
	
	//*********************************************************************
	//	me_Pdate   Width : 160  --> 80
	//	Static28  : Width : 95  , Left : 268     --> Left : 190
	//	ed_Pcnt : Width 110 , Left : 365  -->   Width 90  , Left :  287
	//	ed_Pamt : Width : 224 , Left : 477   -> Width : 130 , Left : 378	
	//*********************************************************************
	if (ds_Green.getColumn(0,"USE_YN") == 'Y')
	{
		me_Pdate.position.width = 80;                      //최종발주일자 edit 사이즈 변경
		Static28.position.left = 190;                       //최종발주정보 Static 위치 변경
		ed_Pcnt.position.width = 90;  ed_Pcnt.position.left = 287;   //최종발주 카운터 사이즈 및 위치 변경
		ed_Pamt.position.width = 130; ed_Pamt.position.left = 378;   //최종발주 금액 사이즈 및 위치 변경
		Sta_Green.visible = true;                  //보조금 잔액 Static 화면 보이기
		ed_Green.visible = true;				   //보조금 잔액 금액 표시 화면 보이기.
	}
}
//*************************************************************
// 2010-08-05  보조금 관련 추가 ( 사업장 보조금 잔액 조회)
//*************************************************************
function fn_Green_Amt()
{
	/*-------------*/
	http.Sync = true;
	/*-------------*/
	// 조회
	var actionName, cmdName, inData, outData, otherArg, callBackFnc;
	// 파라미터셋팅
    outData		= "ds_Green=ds_Green";
    otherArg	= "UPJANG=" + wrapQuote(ed_Upjang.userdata);
	otherArg	+=" NEED_DATE="+ wrapQuote(gfn_trim(me_NeedDate.value));        	
	//action 정보 초기화 
	fsp_clear(this); 
    // 서버에서 조회할 정보 추가 
	fsp_addSearch(this, "sc/scc:SCC_GREEN_AMT");
	// 서버 호출 
    fsp_callService(this, actionName, cmdName, inData, outData, otherArg, callBackFnc);
	/*-------------*/
	http.Sync = false;
	/*-------------*/	

	ed_Green.value = gfn_numFormat(ds_Green.getColumn(0,"BALANCE_AMT"))+ " 원";	

}

//*****************************************************************************
// 2010-08-05  보조금 관련 추가 (로그인 사업장 보조금 재 생성 프로시져 호출)
//*****************************************************************************
function  fn_Create_Green_Amt()
{
	var t_timeout;
	// action 정보 초기화
	fsp_clear(this);	

	// 데이타체크
	ds_Green_Proc.clearData();	
	ds_Green_Proc.addRow();				

	ds_Green_Proc.setColumn(0,"UPJANG",ed_Upjang.userdata);				
	ds_Green_Proc.setColumn(0,"NEED_DATE",me_NeedDate.value);
	ds_Green_Proc.setColumn(0,"CUSER", g_EmpNo);		

	http.Sync = true;			

	t_timeout = application.httptimeout;
	application.httptimeout=2000; //1800초 

	setCapture();

	fsp_addSingle(this, "sc/scc:SCC_GREEN_PROC");
	fsp_callService(this, "", "", "ds_Green_Proc=ds_Green_Proc:A", "",  "", "");

	application.httptimeout=t_timeout; //60초

	http.Sync = false;
}

function btn_RcpConf_OnClick(obj:Button, e:ClickEventInfo)
{
	dv_RcpConf.visible = (! dv_RcpConf.visible);
}

function dv_RcpConf_me_RcpDateT_OnChanged(obj:MaskEdit, e:TextChangedEventInfo)
{
	dv_RcpConf.me_RcpDateF.value = gfn_addDate(e.posttext,-1);
}

function dv_MultiUpj_btn_Hidden_OnClick(obj:Button, e:ClickEventInfo)
{
	if (ffn_ChkNull(ed_Upjang.userdata))
	{
		g_Message("EE", "사업장을 선택하세요!");
		return;
	}
	if (ffn_ChkNull(dv_RcpConf.me_RcpDateF.value))
	{
		g_Message("EE", "입금확인일자를 지정하세요!");
		return;
	}
	if (ffn_ChkNull(dv_RcpConf.me_RcpDateT.value))
	{
		g_Message("EE", "입금확인일자를 지정하세요!");
		return;
	}
	/*
	//ds임시생성
	var dsObjin;
	create("Dataset", "ds_Dummyin");
	dsObjin = eval("ds_Dummyin");
	dsObjin.addColumn("RCP_DATEF", "STRING", 8);
	dsObjin.addColumn("RCP_DATET", "STRING", 8);
	dsObjin.addColumn("UPJANG", "STRING", 6);
	// 초기화
	ds_Dummyin.clearData();
	ds_Dummyin.addRow();
	ds_Dummyin.setColumn(0, "RCP_DATEF",  dv_RcpConf.me_RcpDateF.value);
	ds_Dummyin.setColumn(0, "RCP_DATET",  dv_RcpConf.me_RcpDateT.value);
	ds_Dummyin.setColumn(0, "UPJANG",    ed_Upjang.userdata);
	// 트랜잭션 호출
	var strSvcID, strURL, strInDatasets, strOutDatasets, strArgument, strCallbackFunc;
	// 경로 설정
	strSvcID = "FMZ_CREDIT_INFO_T002";
	strURL   = "U_svc::" + "fm/fmz/FMZ_CREDIT_INFO_T002.jsp";
	// 데이터셋 설정
	strInDatasets  = "ds_Cond=ds_Dummyin";
	//jsp_transaction(this, strSvcID, strURL, strInDatasets, strOutDatasets, strArgument, strCallbackFunc, false, false, true);
ta_Sql.value = fa_Sql;
	//ds임시생성 해제
	Destroy("ds_Dummyin");
	*/
	//과거에는 아이리스 인터페이스 프로시져를 통해 입금 여부를 실시간으로 가져왔으나
	//지금은 SAP와 연동되어서 바로 받아오기 때문에 그냥 여신을 다시 한번 재조회 하면 됨.
	
// [속도개선 Project 시작] 2017. 8. 21. 최범주 여신정보조회 함수 대체
	if ( !fn_GetCredit() ) return; // 여신정보 조회
// [속도개선 Project   끝] 2017. 8. 21. 최범주
	dv_RcpConf.visible = false;
	g_Message("01","실시간 입금확인이 완료되었습니다.");
}

function me_NeedDate_ontextchanged(obj:MaskEdit,  e:TextChangedEventInfo)
{
	
}

function me_NeedDate_OnChanged(obj:MaskEdit, e:TextChangedEventInfo)
{
	// 그리드초기화
	ds_List.clearData();
	
	fn_SetTimer();
	//발주가능 체크
	if (! fn_OrdChk())
	{
		btn_NeedDate.setFocus();
		return;
	}
	
	//자동조회
	
	fn_search();
}


function fn_SetTimer()
{
	fn_CurrDateWeek();
	
	// FICS 발주제한요일, 시간 설정 	
	//fn_setWeekendTime();
		
	var sChkDate, sDay, sTime;
	if ( gfn_subStr(gds_currdate.getColumn(0, "YMD_TM"),8,4)>= gfn_trim(ds_Days.getColumn(0,"D_TIMES")) )
	{
		sChkDate = gfn_addDate(me_NeedDate.value, (-1 * (toNumber(gfn_trim(ds_Days.getColumn(0,"D_DAYS"))) + 1)));	
		sTime = G_fn_GapTime("1", gfn_subStr(gds_currdate.getColumn(0, "YMD_TM"),8,4), toNumber(gfn_trim(ds_Days.getColumn(0,"D_TIMES"))), "");	
	}
	else
	{
		sChkDate = gfn_addDate(me_NeedDate.value, (-1 * toNumber(gfn_trim(ds_Days.getColumn(0,"D_DAYS")))));
		sTime = G_fn_GapTime("0", gfn_subStr(gds_currdate.getColumn(0, "YMD_TM"),8,4), gfn_trim(ds_Days.getColumn(0,"D_TIMES")), "");
	}
	
	if (parseInt(gds_currdate.getColumn(0, "YMD")) <= parseInt(sChkDate))
		sDay = G_fn_CalcDay(gds_currdate.getColumn(0, "YMD"), sChkDate);		
	else
		sDay = G_fn_CalcDay(sChkDate, gds_currdate.getColumn(0, "YMD")) * (-1);		
		
	if ((toNumber(sDay) >= 0) && (toNumber(sDay) < 10)) sDay = "0" + sDay;	
	//st_Timer.text = "마감시간 : " + sDay + "일 " + gfn_left(sTime,2)+ "시간 " + gfn_right(sTime,2)+ "분 전";
	
	st_Week.text = "(" + ffn_DayToWeek(me_NeedDate.value) + ")";
	if (st_Week.text == "(토)")
		st_Week.style.color = "blue";
	else if (st_Week.text == "(일)")
		st_Week.style.color = "red";
	else
		st_Week.style.color = "black";
		
	//fa_sDay = sDay;	
	//if (toNumber(sDay) < 0) fn_CLS_STATUS_Setting(); 	
	
}
/*
// FICS 발주제한요일, 시간 설정 조회
function fn_getWeekendTime()
{
	fn_CurrDateWeek();
	
	// 조회
	var actionName, cmdName, inData, outData, otherArg, callBackFnc;
	// 파라미터셋팅
    outData		= "ds_WeekendTime=ds_List";
    callBackFnc = "callBackWeekendTime"
    //action 정보 초기화 
	fsp_clear(this); 
    // 서버에서 조회할 정보 추가 
	//fsp_addSearch(this, "fm/fmz:FMZ_GET_WEEKENDTIME_S001");
	fsp_addSearch(this, "fm/fmz:FMZ_GET_WEEKENDTIME_S001");
	
	// 서버 호출 
    fsp_callService(this, actionName, cmdName, inData, outData, otherArg, callBackFnc);
}

function callBackWeekendTime(errCode, errMsg)
{
	if (errCode == 0)
	{
	    fn_setWeekendTime();
	} else {
		g_Message("EE",fn_AlertMsg("002"));
	}
}

// FICS 발주제한요일, 시간 설정에 따른 화면 제어 	
function fn_setWeekendTime()
{
	var sCurWeekCd = gds_currdate.getColumn(0, "WEEK_CD");
	var sCurTm = gfn_subStr(gds_currdate.getColumn(0, "YMD_TM"),8,4);
	var nRow = ds_WeekendTime.findRow("CODE", sCurWeekCd);
	
	if ( nRow > -1 ) {
		
		fa_startTime = ds_WeekendTime.getColumn(nRow, "SET2");
		fa_endTime = ds_WeekendTime.getColumn(nRow, "SET3");
		
		if ( sCurTm >= fa_startTime && sCurTm <= fa_endTime ) {
			
			// 발주 통제 함
			fa_weekendTimeCheck = "Y"; 
			g_Message("EE", "발주통제 시간입니다. 해당화면을 닫습니다.");
			fn_close();
			
		} else {
		    // 발주 통제 안함
			fa_weekendTimeCheck = "N"; 
		}
		
		//trace("fn_setWeekendTime 주요상품발주: "+fa_weekendTimeCheck);
	}
}

function FMP00160E_ontimer(obj:Form, e:TimerEventInfo)
{
	//if (e.timerid == 555) fn_SetTimer();
}

function FMP00160E_ondeactivate(obj:Form, e:ActivateEventInfo)
{
	//타이머 종료...(타이머 발생으로 쿼리 수행하여 결과값 가져오면 화면이 앞으로 올라온다.
	killTimer(555);
}

*/

function FMP00160E_onactivate(obj:Form, e:ActivateEventInfo)
{
	//화면 액트브시 타이머 재설정
	fn_SetTimer();
	//setTimer(555,30000); //일단 30초 세팅
}


function fn_isHoliday(sDate)
{
	var i;
	var aHolidays;
	
	aHolidays = gfn_getHolidays(parseInt(gfn_today().substr(0,4), 10));

	for( i = 0 ; i < aHolidays.length ; i++ )
	{
		if( aHolidays[i].substr(0,8) == sDate )
			return aHolidays[i].substr(8);
	}

	return "";	
}

/*
       <달력 포커스 및 조회 총정리>     2015.12.19 박용대

1. 숫자 입력 후 탭이동 : me_NeedDate_canchange -> me_NeedDate_onkillfocus
                           (fn_search())            (fn_search()) 
                           (색적용)

2. 숫자 입력 후 엔터   : me_NeedDate_onkeydown -> me_NeedDate_onkillfocus
						   (색적용)      			(fn_search()) 

3. 달력컴포넌트를 사용 : me_NeedDate_canchange
						   (fn_search())
						   (색적용)
						   
※ 구조상 탭이동은 조회가 두번 겹칠수 밖에 없음. 2,3번의 케이스가 훨신 많기 때문에 1번은 무시함
※ mi->xplatform으로 바뀌면서 onchanged 이벤트가 canchange 이벤트로 바뀌면서 obj를 제대로 못가져옴. 강제셋팅
*/

function me_NeedDate_onkeydown(obj:MaskEdit, e:KeyEventInfo)
{
	if (e.keycode == 13) 
	{
		//trace("me_NeedDate_onkeydown");
		g_Date_OnKillFocus(obj); 
	
		//초기화
		//	me_Pdate.Value = "";
		//	ed_Pcnt.Text = "";
		//	ed_Pamt.Text = "";
		ds_List.clearData();
		//최종 발주정보
		//fn_GetLastOrd();
		//디데이
		fn_GetDays();
		//날짜변경
		st_Week.text = "(" + ffn_DayToWeek(me_NeedDate.value) + ")";
		
		//날짜색변경
		if (st_Week.text == "(토)")
			st_Week.style.color = "blue";
		else if (st_Week.text == "(일)")
			st_Week.style.color = "red";
		else
			st_Week.style.color = "black";
		//공휴일색변경	
		if(gfn_length(fn_isHoliday(me_NeedDate.value))>0)
		{
			st_Week.style.color = "red";
		}
	}
}


function me_NeedDate_onkillfocus(obj:MaskEdit, e:KillFocusEventInfo)
{
	//trace("me_NeedDate_onkillfocus");
	//변경되면 포커스를 잃고 글로벌 함수 실행(여기서 글자수를 체크하여 제대로 된 데이터 넘김)
	g_Date_OnKillFocus(obj);
	
	//변경된 사항이 있는지 확인
	if(gfn_dsIsUpdated(ds_List)==true)
	{
		g_Message("EE","변경된 내역이 있습니다. 저장해 주십시요");
		me_NeedDate.value = pre_need_date;	//변경전의 날짜를 되돌림
		return;
	}else{
		fn_search();
	}
}


function me_NeedDate_canchange(obj:MaskEdit,  e:ChangeEventInfo)
{
	//trace("me_NeedDate_canchange");
	
	//날짜변경
	st_Week.text = "(" + ffn_DayToWeek(me_NeedDate.value) + ")";
	//날짜색변경

	if (st_Week.text == "(토)")
		st_Week.style.color = "blue";
	else if (st_Week.text == "(일)")
		st_Week.style.color = "red";
	else
		st_Week.style.color = "black";
	//공휴일색변경	
	if(gfn_length(fn_isHoliday(me_NeedDate.value))>0)
	{
		st_Week.style.color = "red";
	}

	
	//변경되면 포커스를 잃고 글로벌 함수 실행(여기서 글자수를 체크하여 제대로 된 데이터 넘김)
	g_Date_OnKillFocus(me_NeedDate);
		
	//변경된 사항이 있는지 확인
	if(gfn_dsIsUpdated(ds_List)==true)
	{
		//g_Message("EE","변경된 내역이 있습니다. 저장해 주십시요");
		var retValue = gfn_confirm("confirm.before.search");	// 검색을 진행하면 변경된 데이터가 사라집니다. 계속 진행 하시겠습니까?
 		if (retValue == true) {	
			fn_search();
			return true;
 		} else {
			//2017.10.13 김호석 추가 입고일자 변경 전으로 되돌림
			me_NeedDate.value = pre_need_date_temp;	//변경전의 날짜를 되돌림
			//날짜변경
			st_Week.text = "(" + ffn_DayToWeek(me_NeedDate.value) + ")";
			//날짜색변경

			if (st_Week.text == "(토)")
				st_Week.style.color = "blue";
			else if (st_Week.text == "(일)")
				st_Week.style.color = "red";
			else
				st_Week.style.color = "black";
			//공휴일색변경	
			if(gfn_length(fn_isHoliday(me_NeedDate.value))>0)
			{
				st_Week.style.color = "red";
			}
			return false;
		}
		//날짜변경
		st_Week.text = "(" + ffn_DayToWeek(me_NeedDate.value) + ")";
		//날짜색변경

		if (st_Week.text == "(토)")
			st_Week.style.color = "blue";
		else if (st_Week.text == "(일)")
			st_Week.style.color = "red";
		else
			st_Week.style.color = "black";
		//공휴일색변경	
		if(gfn_length(fn_isHoliday(me_NeedDate.value))>0)
		{
			st_Week.style.color = "red";
		}
		me_NeedDate.value = pre_need_date_temp;	//변경전의 날짜를 되돌림
		return false;
	}else{
		fn_search();
		return true;
	}

}

// [속도개선 Project 시작] 2017. 7. 19. 최범주 발주버튼 클릭 시 주요상품검색 팝업 저장버튼 권한처리
/************************************************************************************************
 * 사용자 FUNCTION 영역 (필수)
 ************************************************************************************************/
/*----------------------------------------------------------------------------------------------
 * 설명      : 주요상품검색 팝업 저장버튼 권한조회
 *---------------------------------------------------------------------------------------------*/
 function fn_getBtnAuthInfo()
 {
	///////////////////////////////////////////////////////////////////////////////////////
	// 데이터셋 초기화
	ds_hidden.clearData();
	
	///////////////////////////////////////////////////////////////////////////////////////
	// 서버단 호출
	var actionName;
	var cmdName;
	var inData;
	var outData     = "ds_hidden=ds_hidden";
	var otherArg    = "SABUN=" + wrapQuote(g_EmpNo);
	var callBackFnc = "fn_CallbakInitService";
	var isSync      = true;
	var trId        = "searchBtnAuthInfo";
	
	fsp_clear(this);
	fsp_addSearch(this, "fm/fmp:FMP00160E_S003");
	fsp_callService(this, actionName, cmdName, inData, outData, otherArg, callBackFnc, "", "", isSync, trId);
}
// [속도개선 Project   끝] 2017. 7. 19. 최범주


function fn_getOrderCtrlList() {
	
	var strSvcID    = "searchCtrlList";
	var strURL      = "fm/fms/smallOrderCtrlMgnt/selectCtrlList.xdo";
	var strInDs     = "";
	var strOutDs    = "ds_ctrlList=ds_ctrlList";
	var strArg      = "upjang=" + ed_Upjang.userdata;
		strArg		+= " needDate=" + me_NeedDate.value;
		strArg		+= " uKey=" + gfn_encProc(g_Upjang+gfn_today());
	var strCallback = "fn_callBack";
	var bAsync      = true;
	
	gfn_transaction(this, strSvcID, strURL, strInDs, strOutDs, strArg, strCallback, bAsync);
}

function fn_callBack(strSvcID, nErrorCode, strErrorMsg) {
	if ( nErrorCode < 0 ) {
		return;
	}
	
	switch ( strSvcID ) {
		case "searchCtrlList" :
			stc_ctrlAmt.visible = false;
			if ( ds_ctrlList.rowcount != 0 && ds_ctrlList.getCaseCount("controlYn == 'Y'") > 0 ) {
				stc_ctrlAmt.text = "( 전체창고 발주금액 : " + gfn_numFormat(ds_ctrlList.getSum("subinvAmt")) + "원 )";
				 
				switch ( ds_ctrlList.lookup("subinvCode", cbo_Subinv.value, "chkSave") ) {
					case "Y" :
						stc_ctrlAmt.style.color = "#444444ff";
						stc_ctrlAmt.visible = true;
						break;
						
					case "N" :
						stc_ctrlAmt.style.color = "red";
						stc_ctrlAmt.visible = true;
						break;
						
					default : 
						stc_ctrlAmt.visible = false;
						break;
					
				}
				
				var rtnAmt = fn_getOrderStatus();	
				if ( rtnAmt.ctrlAmt > rtnAmt.poAmt ) {
					//st_ctrlAmt.text = " 발주가능금액 " + gfn_numFormat(rtnAmt.ctrlAmt - rtnAmt.poAmt) + "원 부족";
					//st_ctrlAmt.visible = true;
				}
			}
			break;
		
		default :
			break;
	}
}


function fn_checkOrderCtrl() {

	// 통제 창고인 경우
	//gd_list.updateToDataset();
	if ( ds_ctrlList.lookup("subinvCode", cbo_Subinv.value, "controlYn") == "Y" ) {
		var bMix = true;
		//if ( ds_List.rowcount == ds_List.getCaseCount("D_DAYS == '1' && PR_QTY >= 0") ) {
		if ( ds_List.getCaseCount("PR_QTY > 0") == ds_List.getCaseCount("D_DAYS == '1' && PR_QTY > 0") ) {
			bMix = false;
		} else {
			bMix = true;
		}
		
		//trace(ds_List.getCaseCount("PR_QTY > 0") +"=="+ ds_List.getCaseCount("D_DAYS == '1' && PR_QTY >= 0"));
		var rtnAmt = fn_getOrderStatus("recheck");
		
		if ( (ds_List.getCaseCount("D_DAYS == '1' && PR_QTY > 0") > 0) && (rtnAmt.ctrlAmt > rtnAmt.poAmt) ) {
		
			var  strMsg = "최소발주금액[" + gfn_numFormat(ds_ctrlList.lookup("subinvCode", cbo_Subinv.value, "controlAmt")) + "]원보다";
				 strMsg += " [" + gfn_numFormat(rtnAmt.ctrlAmt - rtnAmt.poAmt) + "]원 부족합니다.\r\n\r\n";
			
			if ( !bMix ) {
				strMsg += "발주금액을 확인하시기 바랍니다.";
				
			} else {
				strMsg += "D-2상품은 금액과 상관없이 주문가능하나, D-1상품은 저장할 수 없습니다.";
				
				/*
				strMsg += "D-2상품은 금액과 상관없이 주문가능하며,\r\n\D-1상품은 삭제됩니다.\r\n\D-2상품만 주문하시겠습니까?";
				
				if ( g_Confirm("01", strMsg) ) {
					for ( var z=ds_List.rowcount; z>=0; z-- ) {
						if ( (ds_List.getRowType(z) == Dataset.ROWTYPE_INSERT) && ds_List.getColumn(z, "D_DAYS") == "1" ) {
							ds_List.deleteRow(z);
						}
					}
				} else {
					return;
				}
				*/
			}
	
			//g_Message("EE", strMsg);
			return strMsg;
			/*
			if ( g_EmpNo.substr(0,2) <> "CS" && g_EmpNo.substr(0,2) <> "FM" ) {
				// 내부지원 skip
			} else {	// 고객
				return;
			}
			*/
		}
	}
	
	return "";
}

function fn_getOrderStatus(pSource) {
	
	switch ( ds_ctrlList.lookup("subinvCode", cbo_Subinv.value, "chkSave") ) {
		case "Y" :
			if ( pSource != "recheck" ) {
				return {'poAmt': 0, 'ctrlAmt' : -1};
			}
			break;
			
		case "N" :
				//return {'poAmt': 0, 'ctrlAmt' : -1};
			break;
			
		default : 
			break;
			
	}
	
	var poAmt = toNumber(ds_List.getCaseSum("PR_QTY > 0 && TAX_CODE == '100'", "OP_AMOUNT")) * 1.1
				+ toNumber(ds_List.getCaseSum("PR_QTY > 0 && TAX_CODE != '100'", "OP_AMOUNT")) * 1
				//+ toNumber(ds_ctrlList.getSum("subinvAmt"))
				+ toNumber(ds_ctrlList.getCaseSum("subinvCode != '" + cbo_Subinv.value + "'", "subinvAmt" ))
				//+ toNumber(ds_ctrlList.lookup("subinvCode", cbo_Subinv.value, "nonCtrlAmt"));
	var ctrlAmt = toNumber(ds_ctrlList.lookup("subinvCode", cbo_Subinv.value, "controlAmt"));
	
	return {'poAmt': Math.round(poAmt), 'ctrlAmt' : ctrlAmt};
}]]></Script>
  </Form>
</FDL>
