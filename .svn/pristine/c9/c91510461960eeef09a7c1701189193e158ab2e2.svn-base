<?xml version="1.0" encoding="utf-8"?>
<FDL version="1.4">
  <TypeDefinition url="../../../default_typedef.xml"/>
  <Form id="FSM00330R" onkeydown="form_OnKeyDown" onload="form_onload" titletext="식단표조회" position="absolute 0 0 1252 725" scrollbars="none">
    <Layouts>
      <Layout>
        <Static id="Static08" class="sta_WFSA_Labelbg" position="absolute 0 30 1237 71" anchor="left top right"/>
        <Edit autoselect="true" id="ed_UPJANG_NM" ontextchanged="ed_UPJANG_NM_OnChanged" onkeydown="ed_UPJANG_NM_OnKeyDown" readonly="true" taborder="1" tooltiptext="사업장" position="absolute 72 40 192 61" oneditclick="ed_UPJANG_NM_oneditclick"/>
        <Combo codecolumn="HALL_CD" datacolumn="HALL_NAME" id="cbo_upjang_hall" index="0" innerdataset="ds_upjang_hall" onitemchanged="cbo_upjang_hall_OnChanged" taborder="3" tooltiptext="식당명" position="absolute 297 40 409 61"/>
        <Static id="st10" text="사업장" position="absolute 16 41 78 62" class="sta_WFSA_label" onclick="st10_onclick"/>
        <Static id="Static1" text="식당명" position="absolute 243 41 305 62" class="sta_WFSA_label"/>
        <Static id="Static2" text="제공일" position="absolute 717 41 779 62" class="sta_WFSA_label"/>
        <Static id="Static0" text="코너" position="absolute 579 41 641 62" class="sta_WFSA_label"/>
        <Combo codecolumn="CORNER" datacolumn="CORNER_NAME" id="cbo_upjang_hall_corner" index="0" innerdataset="ds_upjang_hall_corner" taborder="5" tooltiptext="코너" position="absolute 620 40 687 61"/>
        <Button id="btn_UPJANG" onclick="btn_UPJANG_OnClick" taborder="2" tabstop="false" text="" position="absolute 191 40 213 61" class="btn_WF_popSearch" image=""/>
        <CheckBox id="chk_SHOW_CAL" onclick="chk_SHOW_CAL_OnClick" taborder="10" tabstop="false" text="열량표시" value="false" position="absolute 1016 40 1125 61"/>
        <Combo codecolumn="MEAL" datacolumn="MEAL_NAME" id="cbo_upjang_hall_meal" index="0" innerdataset="ds_upjang_hall_meal" onitemchanged="cbo_upjang_hall_meal_OnChanged" taborder="4" position="absolute 480 40 548 61"/>
        <Static id="Static6" text="끼니" position="absolute 439 41 501 62" class="sta_WFSA_label" onclick="Static6_onclick"/>
        <Grid selecttype="multiarea" autoenter="select" scrollbars="alwayshorz" binddataset="ds_list_pivot" cellmovingtype="col" cellsizingtype="both" readonly="false" enable="true" id="grd_list_Pivot" useinputpanel="false" taborder="12" tabstop="true" usecontextmenu="true" useselcolor="true" visible="true" wheelscrollrow="1" position="absolute 0 84 1237 710" anchor="all" onheadclick="grd_list_Pivot_onheadclick">
          <Formats>
            <Format id="Default">
              <Columns>
                <Column band="left" size="71"/>
                <Column size="105"/>
              </Columns>
              <Rows>
                <Row size="22" band="head"/>
                <Row size="14"/>
              </Rows>
              <Band id="head">
                <Cell col="0" displaytype="text" class="head_Excel"/>
                <Cell col="1" displaytype="text" expr="expr:gfn_subStr(MENU_DATE,6,2)+ &quot;일&quot;+&quot;(&quot;+MENU_DAYS+&quot;)&quot;"/>
              </Band>
              <Band id="body">
                <Cell col="0" displaytype="text" expr="expr:MEAL_NAME+CORNER_NAME" suppress="1" style="align:center;"/>
                <Cell col="1" text="bind:RECIPE_NAME" displaytype="text" edittype="normal" style="align:left;"/>
              </Band>
            </Format>
            <Format id="B">
              <Columns>
                <Column band="left" size="71"/>
                <Column size="105"/>
                <Column size="50"/>
              </Columns>
              <Rows>
                <Row size="22" band="head"/>
                <Row size="14"/>
              </Rows>
              <Band id="head">
                <Cell col="0" displaytype="text" class="head_Excel"/>
                <Cell col="1" displaytype="text" expr="expr:gfn_subStr(MENU_DATE,6,2)+ &quot;일&quot;"/>
                <Cell col="2" text="Kcal"/>
              </Band>
              <Band id="body">
                <Cell col="0" displaytype="text" expr="expr:MEAL_NAME+CORNER_NAME" suppress="1" style="align:center;"/>
                <Cell col="1" text="bind:RECIPE_NAME" displaytype="text" subsumtext="*열량합계" style="align:expr:iif(getRowLevel(currow)==1,'right');background:EXPR(iif(getRowLevel(currow)==1,'#FEFCC0',-1));"/>
                <Cell col="2" text="bind:RECIPE_CAL" displaytype="number" style="background:EXPR(iif(getRowLevel(currow)==1,'#FEFCC0',-1));align:left;"/>
              </Band>
            </Format>
          </Formats>
        </Grid>
        <MaskEdit id="cal_START_DATE" mask="####-##-##" oneditclick="g_Date_OnFocus" onsetfocus="g_Date_OnFocus" onkillfocus="g_Date_OnKillFocus" taborder="6" type="string" userdata="btn_START_DATE" position="absolute 771 40 850 61"/>
        <Button id="btn_START_DATE" onclick="g_CalButton_OnClick" taborder="7" tabstop="false" userdata="cal_START_DATE" position="absolute 849 40 871 61" class="btn_WF_cal" text="" image=""/>
        <Static id="Static8" text="~" position="absolute 874 40 883 61"/>
        <MaskEdit id="cal_END_DATE" mask="####-##-##" oneditclick="g_Date_OnFocus" onsetfocus="g_Date_OnFocus" onkillfocus="g_Date_OnKillFocus" taborder="8" type="string" userdata="btn_END_DATE" position="absolute 886 40 965 61"/>
        <Button id="btn_END_DATE" onclick="g_CalButton_OnClick" taborder="9" tabstop="false" userdata="cal_END_DATE" position="absolute 964 40 986 61" class="btn_WF_cal" text="" image=""/>
        <Div id="div_cmnBtn" anchor="left top right" taborder="13" url="cmn::CmnBtn.xfdl" text="Div00" scrollbars="none" position="absolute 0 0 1237 30"/>
        <Static id="Static15" text="h06" onclick="Static03_onclick" class="Guide01_AreaRed" visible="false" position="absolute 0 71 144 84" anchor="top right"/>
        <Static id="Static16" text="h06" onclick="Static03_onclick" class="Guide01_AreaRed" visible="false" position="absolute 1093 71 1237 77" anchor="top right"/>
        <Static id="Static19" text="h05" class="Guide01_AreaRed" visible="false" position="absolute 1093 97 1237 102" anchor="top right"/>
        <Static id="Static23" text="W15" visible="false" position="absolute 1 40 16 61" style="background:#ff000055;align:center middle;" onclick="Static23_onclick"/>
        <Static id="Static18" text="글자간격기준 w10" class="Guide01_AreaRed" visible="false" position="absolute 62 40 72 61"/>
        <Static id="Static20" text="w30" class="Guide01_AreaRed" visible="false" position="absolute 213 40 243 61"/>
        <Static id="Static21" text="W10" visible="false" position="absolute 0 30 1237 40" style="background:#ff000055;align:center middle;"/>
        <Static id="Static05" text="W10" visible="false" position="absolute 0 61 1237 71" style="background:#ff000055;align:center middle;"/>
        <Static id="Static24" text="글자간격기준 w10" class="Guide01_AreaRed" visible="false" position="absolute 287 40 297 61"/>
        <Static id="Static25" text="w30" class="Guide01_AreaRed" visible="false" position="absolute 409 40 439 61"/>
        <Static id="Static26" text="글자간격기준 w10" class="Guide01_AreaRed" visible="false" position="absolute 470 40 480 61"/>
        <Static id="Static27" text="w30" class="Guide01_AreaRed" visible="false" position="absolute 548 40 578 61"/>
        <Static id="Static28" text="글자간격기준 w10" class="Guide01_AreaRed" visible="false" position="absolute 610 40 620 61"/>
        <Static id="Static17" text="w15" onclick="Static06_onclick" class="Guide01_AreaRed" visible="false" position="absolute 1237 0 1252 710" anchor="top right"/>
        <Static id="Static71" text="h15" onclick="Static71_onclick" class="Guide01_AreaRed" visible="false" position="absolute 0 710 1252 725" anchor="left bottom"/>
        <Static id="Static03" text="w30" class="Guide01_AreaRed" visible="false" position="absolute 687 40 717 61"/>
        <Static id="Static04" text="글자간격기준 w10" class="Guide01_AreaRed" visible="false" position="absolute 761 40 771 61" onclick="Static04_onclick"/>
        <Static id="Static07" text="w30" class="Guide01_AreaRed" visible="false" position="absolute 986 40 1016 61"/>
        <Grid id="Grid00" taborder="14" useinputpanel="false" position="absolute 397 752 667 932" visible="false">
          <Formats>
            <Format id="Default">
              <Columns>
                <Column size="71" band="left"/>
                <Column size="120"/>
                <Column size="60"/>
                <Column size="120"/>
                <Column size="60"/>
                <Column size="120"/>
                <Column size="60"/>
                <Column size="120"/>
                <Column size="60"/>
                <Column size="120"/>
                <Column size="60"/>
                <Column size="120"/>
                <Column size="60"/>
                <Column size="120"/>
                <Column size="60"/>
              </Columns>
              <Rows>
                <Row size="26" band="head"/>
                <Row size="24"/>
              </Rows>
              <Band id="head">
                <Cell displaytype="text" class="head_Excel"/>
                <Cell col="1" text="03일"/>
                <Cell col="2" text="KCAL"/>
                <Cell col="3" text="04일"/>
                <Cell col="4" text="KCAL"/>
                <Cell col="5" text="05일"/>
                <Cell col="6" text="KCAL"/>
                <Cell col="7" text="06일"/>
                <Cell col="8" text="KCAL"/>
                <Cell col="9" text="07일"/>
                <Cell col="10" text="KCAL"/>
                <Cell col="11" text="08일"/>
                <Cell col="12" text="KCAL"/>
                <Cell col="13" text="09일"/>
                <Cell col="14" text="KCAL"/>
              </Band>
              <Band id="body">
                <Cell displaytype="text" style="color:white;color2:white;background:#566572;background2:#566572;align:center;" text="bind:MENU_NAME" suppress="1" suppressalign="middle"/>
                <Cell col="1" displaytype="text" edittype="normal" style="border:#566572;background:EXPR(iif(KMENU_DATE20140103 == &quot;*열량합계&quot;,'#FEFCC0' ,'white'));background2:EXPR(iif(KMENU_DATE20140103 == &quot;*열량합계&quot;,'#FEFCC0' ,'white'));align:left;" text="bind:KMENU_DATE20140103"/>
                <Cell col="2" displaytype="number" edittype="normal" style="border:#566572;background:EXPR(iif(KMENU_DATE20140103 == &quot;*열량합계&quot;,'#FEFCC0' ,'white'));background2:EXPR(iif(KMENU_DATE20140103 == &quot;*열량합계&quot;,'#FEFCC0' ,'white'));align:right;" text="bind:KCAL20140103" mask="expr:iif(gfn_isNull(KCAL20140103),'','#,###.##');" maskchar="#"/>
                <Cell col="3" displaytype="text" edittype="normal" style="border:#566572;background:EXPR(iif(KMENU_DATE20140104 == &quot;*열량합계&quot;,'#FEFCC0' ,'white'));background2:EXPR(iif(KMENU_DATE20140104 == &quot;*열량합계&quot;,'#FEFCC0' ,'white'));align:left;" text="bind:KMENU_DATE20140104"/>
                <Cell col="4" displaytype="text" edittype="normal" style="border:#566572;background:EXPR(iif(KMENU_DATE20140104 == &quot;*열량합계&quot;,'#FEFCC0' ,'white'));background2:EXPR(iif(KMENU_DATE20140104 == &quot;*열량합계&quot;,'#FEFCC0' ,'white'));align:right;" text="bind:KCAL20140104"/>
                <Cell col="5" displaytype="text" edittype="normal" style="border:#566572;background:EXPR(iif(KMENU_DATE20140105 == &quot;*열량합계&quot;,'#FEFCC0' ,'white'));background2:EXPR(iif(KMENU_DATE20140105 == &quot;*열량합계&quot;,'#FEFCC0' ,'white'));align:left;" text="bind:KMENU_DATE20140105"/>
                <Cell col="6" displaytype="text" edittype="normal" style="border:#566572;background:EXPR(iif(KMENU_DATE20140105 == &quot;*열량합계&quot;,'#FEFCC0' ,'white'));background2:EXPR(iif(KMENU_DATE20140105 == &quot;*열량합계&quot;,'#FEFCC0' ,'white'));align:right;" text="bind:KCAL20140105"/>
                <Cell col="7" displaytype="text" edittype="normal" style="border:#566572;background:EXPR(iif(KMENU_DATE20140106 == &quot;*열량합계&quot;,'#FEFCC0' ,'white'));background2:EXPR(iif(KMENU_DATE20140106 == &quot;*열량합계&quot;,'#FEFCC0' ,'white'));align:left;" text="bind:KMENU_DATE20140106"/>
                <Cell col="8" displaytype="text" edittype="normal" style="border:#566572;background:EXPR(iif(KMENU_DATE20140106 == &quot;*열량합계&quot;,'#FEFCC0' ,'white'));background2:EXPR(iif(KMENU_DATE20140106 == &quot;*열량합계&quot;,'#FEFCC0' ,'white'));align:right;" text="bind:KCAL20140106"/>
                <Cell col="9" displaytype="text" edittype="normal" style="border:#566572;background:EXPR(iif(KMENU_DATE20140107 == &quot;*열량합계&quot;,'#FEFCC0' ,'white'));background2:EXPR(iif(KMENU_DATE20140107 == &quot;*열량합계&quot;,'#FEFCC0' ,'white'));align:left;" text="bind:KMENU_DATE20140107"/>
                <Cell col="10" displaytype="text" edittype="normal" style="border:#566572;background:EXPR(iif(KMENU_DATE20140107 == &quot;*열량합계&quot;,'#FEFCC0' ,'white'));background2:EXPR(iif(KMENU_DATE20140107 == &quot;*열량합계&quot;,'#FEFCC0' ,'white'));align:right;" text="bind:KCAL20140107"/>
                <Cell col="11" displaytype="text" edittype="normal" style="border:#566572;background:EXPR(iif(KMENU_DATE20140108 == &quot;*열량합계&quot;,'#FEFCC0' ,'white'));background2:EXPR(iif(KMENU_DATE20140108 == &quot;*열량합계&quot;,'#FEFCC0' ,'white'));align:left;" text="bind:KMENU_DATE20140108"/>
                <Cell col="12" displaytype="text" edittype="normal" style="border:#566572;background:EXPR(iif(KMENU_DATE20140108 == &quot;*열량합계&quot;,'#FEFCC0' ,'white'));background2:EXPR(iif(KMENU_DATE20140108 == &quot;*열량합계&quot;,'#FEFCC0' ,'white'));align:right;" text="bind:KCAL20140108"/>
                <Cell col="13" displaytype="text" edittype="normal" style="border:#566572;background:EXPR(iif(KMENU_DATE20140109 == &quot;*열량합계&quot;,'#FEFCC0' ,'white'));background2:EXPR(iif(KMENU_DATE20140109 == &quot;*열량합계&quot;,'#FEFCC0' ,'white'));align:left;" text="bind:KMENU_DATE20140109"/>
                <Cell col="14" displaytype="text" edittype="normal" style="border:#566572;background:EXPR(iif(KMENU_DATE20140109 == &quot;*열량합계&quot;,'#FEFCC0' ,'white'));background2:EXPR(iif(KMENU_DATE20140109 == &quot;*열량합계&quot;,'#FEFCC0' ,'white'));align:right;" text="bind:KCAL20140109"/>
              </Band>
            </Format>
          </Formats>
        </Grid>
      </Layout>
    </Layouts>
    <Objects>
      <Dataset id="ds_upjang_hall"/>
      <Dataset id="ds_input">
        <ColumnInfo>
          <Column id="UPJANG" size="256" type="STRING"/>
          <Column id="UPJANG_NM" size="256" type="STRING"/>
          <Column id="HALL_CD" size="256" type="STRING"/>
          <Column id="MEAL" size="256" type="STRING"/>
          <Column id="CORNER" size="256" type="STRING"/>
          <Column id="MENU_DATE" size="256" type="STRING"/>
          <Column id="MENU_SDATE" size="256" type="STRING"/>
          <Column id="MENU_EDATE" size="256" type="STRING"/>
          <Column id="CURR_DATE" size="256" type="STRING"/>
          <Column id="COPY_FLAG" size="256" type="STRING"/>
          <Column id="EMP_NO" type="STRING" size="256"/>
        </ColumnInfo>
        <Rows>
          <Row>
            <Col id="COPY_FLAG"/>
            <Col id="CURR_DATE"/>
            <Col id="EMP_NO"/>
            <Col id="HALL_CD"/>
            <Col id="MENU_DATE"/>
            <Col id="MENU_EDATE"/>
            <Col id="MENU_SDATE"/>
            <Col id="UPJANG"/>
            <Col id="UPJANG_NM"/>
            <Col id="CORNER"> </Col>
            <Col id="MEAL"> </Col>
          </Row>
        </Rows>
      </Dataset>
      <Dataset id="ds_upjang_hall_corner">
        <ColumnInfo>
          <Column id="CORNER" size="256" type="STRING"/>
          <Column id="CORNER_NAME" size="256" type="STRING"/>
        </ColumnInfo>
        <Rows>
          <Row>
            <Col id="CORNER"/>
            <Col id="CORNER_NAME"/>
          </Row>
        </Rows>
      </Dataset>
      <Dataset id="ds_upjang_hall_meal">
        <ColumnInfo>
          <Column id="MEAL" size="256" type="STRING"/>
          <Column id="MEAL_NAME" size="256" type="STRING"/>
        </ColumnInfo>
        <Rows>
          <Row>
            <Col id="MEAL"/>
            <Col id="MEAL_NAME"/>
          </Row>
        </Rows>
      </Dataset>
      <Dataset id="ds_list">
        <ColumnInfo>
          <Column id="MENU_CD" size="71" type="STRING"/>
          <Column id="MENU_DATE" size="10" type="STRING"/>
          <Column id="MENU_DAYS" size="10" type="STRING"/>
          <Column id="UPJANG" size="22" type="BIGDECIMAL"/>
          <Column id="HALL_CD" size="20" type="STRING"/>
          <Column id="MEAL" size="20" type="STRING"/>
          <Column id="MEAL_NAME" size="100" type="STRING"/>
          <Column id="CORNER" size="20" type="STRING"/>
          <Column id="CORNER_NAME" size="100" type="STRING"/>
          <Column id="RECIPE_INFO" size="20" type="STRING"/>
          <Column id="RECIPE_CD" size="20" type="STRING"/>
          <Column id="RECIPE_NAME" size="50" type="STRING"/>
          <Column id="RECIPE_CAL" size="22" type="BIGDECIMAL"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_list_pivot1" keystring="MEAL:MEAL_NAME:CORNER:CORNER_NAME:RECIPE_INFO"/>
      <Dataset id="ds_date">
        <ColumnInfo>
          <Column id="MENU_DATE" size="256" type="STRING"/>
          <Column id="MENU_DAYS" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_head">
        <ColumnInfo>
          <Column id="MENU_DATE" size="8" type="STRING"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_list_m">
        <ColumnInfo>
          <Column id="MENU_CD" size="71" type="STRING"/>
          <Column id="MENU_DATE" size="10" type="STRING"/>
          <Column id="MENU_DAYS" size="10" type="STRING"/>
          <Column id="UPJANG" size="22" type="BIGDECIMAL"/>
          <Column id="HALL_CD" size="20" type="STRING"/>
          <Column id="MEAL" size="20" type="STRING"/>
          <Column id="MEAL_NAME" size="100" type="STRING"/>
          <Column id="CORNER" size="20" type="STRING"/>
          <Column id="CORNER_NAME" size="100" type="STRING"/>
          <Column id="RECIPE_INFO" size="20" type="STRING"/>
          <Column id="RECIPE_CD" size="20" type="STRING"/>
          <Column id="RECIPE_NAME" size="50" type="STRING"/>
          <Column id="RECIPE_CAL" size="22" type="BIGDECIMAL"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_list_a">
        <ColumnInfo>
          <Column id="MENU_CD" size="71" type="STRING"/>
          <Column id="MENU_DATE" size="10" type="STRING"/>
          <Column id="MENU_DAYS" size="10" type="STRING"/>
          <Column id="UPJANG" size="22" type="BIGDECIMAL"/>
          <Column id="HALL_CD" size="20" type="STRING"/>
          <Column id="MEAL" size="20" type="STRING"/>
          <Column id="MEAL_NAME" size="100" type="STRING"/>
          <Column id="CORNER" size="20" type="STRING"/>
          <Column id="CORNER_NAME" size="100" type="STRING"/>
          <Column id="RECIPE_INFO" size="20" type="STRING"/>
          <Column id="RECIPE_CD" size="20" type="STRING"/>
          <Column id="RECIPE_NAME" size="50" type="STRING"/>
          <Column id="RECIPE_CAL" size="22" type="BIGDECIMAL"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_list_e">
        <ColumnInfo>
          <Column id="MENU_CD" size="71" type="STRING"/>
          <Column id="MENU_DATE" size="10" type="STRING"/>
          <Column id="MENU_DAYS" size="10" type="STRING"/>
          <Column id="UPJANG" size="22" type="BIGDECIMAL"/>
          <Column id="HALL_CD" size="20" type="STRING"/>
          <Column id="MEAL" size="20" type="STRING"/>
          <Column id="MEAL_NAME" size="100" type="STRING"/>
          <Column id="CORNER" size="20" type="STRING"/>
          <Column id="CORNER_NAME" size="100" type="STRING"/>
          <Column id="RECIPE_INFO" size="20" type="STRING"/>
          <Column id="RECIPE_CD" size="20" type="STRING"/>
          <Column id="RECIPE_NAME" size="50" type="STRING"/>
          <Column id="RECIPE_CAL" size="22" type="BIGDECIMAL"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_meal">
        <ColumnInfo>
          <Column id="HMC" size="256" type="STRING"/>
          <Column id="CNT" type="BIGDECIMAL" size="256"/>
          <Column id="ROW" type="BIGDECIMAL" size="256"/>
        </ColumnInfo>
      </Dataset>
    </Objects>
    <Bind>
      <BindItem id="ed_UPJANG_NM_value" compid="ed_UPJANG_NM" propid="value" datasetid="ds_input" columnid="UPJANG_NM"/>
      <BindItem id="cbo_upjang_hall_value" compid="cbo_upjang_hall" propid="value" datasetid="ds_input" columnid="HALL_CD"/>
      <BindItem id="cbo_upjang_hall_corner_value" compid="cbo_upjang_hall_corner" propid="value" datasetid="ds_input" columnid="CORNER"/>
      <BindItem id="cbo_upjang_hall_meal_value" compid="cbo_upjang_hall_meal" propid="value" datasetid="ds_input" columnid="MEAL"/>
      <BindItem id="cal_START_DATE_value" compid="cal_START_DATE" propid="value" datasetid="ds_input" columnid="MENU_SDATE"/>
      <BindItem id="cal_END_DATE_value" compid="cal_END_DATE" propid="value" datasetid="ds_input" columnid="MENU_EDATE"/>
    </Bind>
    <Script type="xscript4.0"><![CDATA[include "U_lib::lib_conversionCom.xjs";
/*
 ******************************************************************************************
 * 시스템구분   : IFIS/식단관리/식단표조회  
 * 프로그램명   : 단체급식 - 식단표조회
 * 기      능   : 식단표 조회
 * 작  성  자   : 한화 S&C SI 사업부 프로젝트 팀 박종세
 * 작성  일자   : 2008-02-25
 * ----------------------------------------------------------------------------------------
 * HISTORY    :
 ******************************************************************************************
 */
//=========================================================================================
// [ PART 1 ]
// Form에서 Include 할 내용을 정의
//
//========================================================================================= 
//@@컨버터에서 주석처리 #include "lib::tit_comm_0001.js"
//@@컨버터에서 주석처리 #include "LIB::lib_comm_0001.js"
//@@컨버터에서 주석처리 #include "lib::sc_comon.js"
//@@컨버터에서 주석처리 #include "lib::sc_sql_common.js"		// 사업장팝업용 Lib
//@@컨버터에서 주석처리 #include "lib::fs_common.js"

//=========================================================================================
// [ PART 2 ]
// Form에서 사용될 전역변수를 선언
//
//=========================================================================================
//=========================================================================================
// [ PART 3 ]
// Form Loading 시 작업 정의
//
//=========================================================================================
function form_onload(obj:Form, e:LoadEventInfo)
{
	gfn_formOnLoad(obj, false);

	//폼 초기화
	fn_InitForm(obj);
}

//폼 초기화
function fn_InitForm(obj)
{
	// action 정보 생성 초기화 
	fsp_init(this);		

	// 사업장 권한 셋팅
	fn_SetAuth("","","ed_UPJANG_NM","btn_UPJANG");
	
	
	// 폼 데이터 초기화
	fn_InitData(false);
}

// 폼데이터 초기화 
function fn_InitData(blnAllClear)
{
	this.cal_START_DATE.value=gfn_today();
	this.cal_END_DATE.value=gfn_addDate(gfn_today(),6);
	
	//로그인한 사용자 업장 셋팅
	ds_input.setColumn(0,"UPJANG_NM",g_UpjangNm);	
	ds_input.setColumn(0,"UPJANG",g_Upjang);	
	//초기화 후
	fn_After_InitData();
}

//초기화 콜백함수
function fn_After_InitData()
{
    //식당조회
	fn_Upjang_HallSearch();
}

//=========================================================================================
// [ PART 4 ]
// Main Process Event 정의(조회,입력,삭제,저장,인쇄,도움말,form닫기)
//
//=========================================================================================
/*------------------------------------------------------------
	1. Function ID : fn_Search()
	2. 개       요 : 업무프로세스에 따른 조회작업
	3. 기       능 : 검색버튼 입력 시 처리되는 작업
	4. 인 수 설 명:
*------------------------------------------------------------*/
function fn_search()
{

	  //필수 입력사항 체크-----------------------------------------------------------------------
	   if (!fn_Chk_SearchKey()) return false;
	   
	   ds_list.clearData();

	   
	  //조회 조건만들기-----------------------------------------------------------------------
	   var otherArg;
	   otherArg		= otherArg + " UPJANG="+gfn_nvl(ds_input.getColumn(0,"UPJANG"));
	   otherArg		= otherArg + " HALL_CD="+gfn_nvl(cbo_upjang_hall.value);
	   otherArg		= otherArg + " MEAL="+gfn_nvl(cbo_upjang_hall_meal.value);
	   otherArg		= otherArg + " CORNER="+gfn_nvl(cbo_upjang_hall_corner.value);
	   otherArg		= otherArg + " START_DATE="+gfn_nvl(cal_START_DATE.value);
	   otherArg		= otherArg + " END_DATE="+gfn_nvl(cal_END_DATE.value); 

	  // action 정보 삭제 초기화 
	   fsp_clear(this);

	  // 서버에서 조회할 정보 추가 ->>>>메뉴 레시피원가(chk_SEARCH_ALL가 UNCHECK이면 원가 조회안함.)
	  fsp_addSearch(this, "fs/fsm:FSM00330R_S001");

	  // 서버 호출 
	  http.Sync = true;
	  fsp_callService(this, "", "", "", "ds_list=ds_list" , otherArg, "fn_After_Search");	
	  //조회 실행-----------------------------------------------------------------------------
	  http.Sync = false;
	  
	
}

// 조회 후 콜백 함수 
function fn_After_Search()
{
    // 데이터셋 플래그 클리어
	//ds_list.applyChange();
	
	
	//trace('rowcount ==> ' + ds_list.rowcount);
	
	fn_crossTab(ds_list, grd_list_Pivot);
}

// 조회 조건 검색
function fn_Chk_SearchKey()
{
   //체크로직- 틀리면 return false;    
   return true;
}

       


/*------------------------------------------------------------
	1. Function ID : fn_Print()
	2. 개       요 : 업무프로세스에 따른 인쇄 처리
	3. 기       능 : 인쇄버튼 입력 시 처리되는 작업
	4. 인 수 설 명 : 
*------------------------------------------------------------*/
function fn_print()
{
}

/*------------------------------------------------------------
	1. Function ID : fn_Close()
	2. 개       요 : 업무프로세스에 따른 폼 종료 
	3. 기       능 : 닫기버튼 입력 시 처리되는 작업
	4. 인 수 설 명 : 
*------------------------------------------------------------*/
function fn_Close()
{
	this.close();
}

/*------------------------------------------------------------
	1. Function ID : fn_Help()
	2. 개       요 : 업무프로세스에 따른 도움말 
	3. 기       능 : 도움말버튼 입력 시 처리되는 작업
	4. 인 수 설 명 : 
*------------------------------------------------------------*/
function fn_help()
{
}

//=========================================================================================
// [ PART 5 ]
// Detail Process Event 정의 ( User Define function )
//
//=========================================================================================

//=========================================================================================
// [ PART 6 ]
// component Event 정의 ( User Define function )
// --> component Event의 기요,기능,동작 등 상세내용은 MiPlatform 메뉴얼을 참조하시기 바랍니다.
//=========================================================================================


/*
 ******************************************************************************************
 * 함  수  명   : btn_UPJANG_OnClick(obj)
 * 기      능   : 사업장 조회
 * 작  성  자   : 박종세
 * 작성  일자   : 2007-12-03  
 ******************************************************************************************
 */
function btn_UPJANG_OnClick(obj:Button, e:ClickEventInfo)
{
	fn_sql_common_setup(fn_MakeUpjangSQL(), 
						strMAQuery_UpjangKeyField, 
						strMAQuery_UpjangValueField, 
						strMAQuery_UpjangKeyFieldNM, 
						strMAQuery_UpjangValueFieldNM, 
						"", 
						"",
						"",   // 팀 비교
						strMAQuery_UpjangCaption,
						strMAQuery_UpjangAllField);
		
    if (gds_sql_common.getColumn(0, "ret_code") != "")
    {
		ds_input.setColumn(0,"UPJANG",gds_sql_common.getColumn(0, "ret_code"));
		ds_input.setColumn(0,"UPJANG_NM",gds_sql_common.getColumn(0, "ret_name"));
		
		//업장의 식당을 찾는다.
		fn_Upjang_HallSearch();

		//ds_upjang_hall.Filter("UPJANG=" + quote(gds_sql_common.GetColumn(0, "ret_code")));
		//cbo_upjang_hall.Index = 0;
		cbo_upjang_hall.setFocus();
    }
    else
    {
    	ds_input.setColumn(0,"UPJANG","");
		ds_input.setColumn(0,"UPJANG_NM","");
		ds_upjang_hall.filter("");
    }
}

function ed_UPJANG_NM_OnKeyDown(obj:Edit, e:KeyEventInfo)
{
	if(e.keycode == "13") {
		btn_UPJANG.click();
		return;
	}	
}

function ed_UPJANG_NM_OnChanged(obj:Edit, e:TextChangedEventInfo)
{
	fn_Upjang_HallSearch();
}







/*
 ******************************************************************************************
 * 함  수  명   : fn_Upjang_HallSearch()
 * 기      능   : 식당 정보를 콤보에 연결
 * 작  성  자   : 박종세
 * 작성  일자   : 2007-12-20 
 ******************************************************************************************
 */
function fn_Upjang_HallSearch()
{
	// 식당 조회
	var actionName, cmdName, inData, outData, otherArg, callBackFnc;
	
	inData			= "";
	outData			= "ds_upjang_hall=gds_Csqlout";
	callBackFnc		= "fn_Upjang_HallSearch_After";
	otherArg		= "UPJANG="+wrapQuote(ds_input.getColumn(0,"UPJANG"));

	fsp_clear(this); 
    fsp_addSearch(this, "fs/fsc:FSA_HALL_MST_S001");								// 조회 
	http.Sync = true;
    fsp_callService(this, actionName, cmdName, inData, outData, otherArg, callBackFnc);		// 서비스 호출 
	http.Sync = false;
	
	// 초기값 셋팅
	cbo_upjang_hall.index = 0;
	
	// 끼니조회
	fn_Upjang_Hall_MealSearch();
}

//조회 후 이벤트
function fn_Upjang_HallSearch_After(errCode, errMsg)
{
	if(errCode!=0)
	{
		g_Message("EE",	"서비스 오류:시스템 관리자에게 문의하십시오");
		return;
	}
	
	//행사식당은 제외한다. Filter사용.
	ds_upjang_hall.filter("gfn_subStr(HALL_CD,0,3)<>'010'");

}

////////////////////식당 변경시 이벤트///////////////////////
function cbo_upjang_hall_OnChanged(obj:Combo, e:ItemChangeEventInfo)
{

	// 끼니조회
	fn_Upjang_Hall_MealSearch();
	
}


/*
 ******************************************************************************************
 * 함  수  명   : fn_Upjang_CornerSearch()
 * 기      능   : 업장의 끼니 조회
 * 작  성  자   : 박종세
 * 작성  일자   : 2007-12-20 
 ******************************************************************************************
 */
//끼니 정의
function fn_Upjang_Hall_MealSearch()
{
	// 식당 조회
	var actionName, cmdName, inData, outData, otherArg, callBackFnc;
	
	inData			= "";
	outData			= "ds_upjang_hall_meal=ds_upjang_hall_meal";
	callBackFnc		= "fn_MealSearch_After";
	otherArg		= "UPJANG="+wrapQuote(ds_input.getColumn(0,"UPJANG"));
	otherArg		= otherArg + " HALL_CD="+wrapQuote(cbo_upjang_hall.value);
	//otherArg		= otherArg + " CORNER="+quote(cbo_upjang_hall_corner.Value);
	otherArg		= otherArg + " BLANK='A'";
	
	fsp_clear(this); 
    fsp_addSearch(this, "fs/fsc:FSC_UPJANG_HALL_MEAL_S001");						// 조회 
	http.Sync = true;
    fsp_callService(this, actionName, cmdName, inData, outData, otherArg, callBackFnc);		// 서비스 호출 
	http.Sync = false;
	
	
}

//조회 후 이벤트
function fn_MealSearch_After(errCode, errMsg)
{
	if(errCode!=0)
	{
		g_Message("EE",	"서비스 오류:시스템 관리자에게 문의하십시오");
		return;
	}
	
// 초기값 셋팅
	cbo_upjang_hall_meal.index = 0;
	
	
	// 코너조회
	fn_Upjang_CornerSearch();

}


////////////////////끼니  변경시 이벤트///////////////////////
function cbo_upjang_hall_meal_OnChanged(obj:Combo, e:ItemChangeEventInfo)
{
		
	// 코너조회
	fn_Upjang_CornerSearch();
}



/*
 ******************************************************************************************
 * 함  수  명   : fn_Upjang_CornerSearch()
 * 기      능   : 업장의 코너 조회
 * 작  성  자   : 박종세
 * 작성  일자   : 2007-12-20 
 ******************************************************************************************
 */
//코너 정의
function fn_Upjang_CornerSearch()
{
	// 식당 조회
	var actionName, cmdName, inData, outData, otherArg, callBackFnc;
	
	inData			= "";
	outData			= "ds_upjang_hall_corner=ds_upjang_hall_corner";
	callBackFnc		= "fn_CornerSearch_After";
	otherArg		= "UPJANG="+wrapQuote(ds_input.getColumn(0,"UPJANG"));
	otherArg		= otherArg + " HALL_CD="+wrapQuote(cbo_upjang_hall.value);
	otherArg		= otherArg + " MEAL="+wrapQuote(cbo_upjang_hall_meal.value);
	otherArg		= otherArg + " BLANK='A'";
	
	fsp_clear(this); 
    fsp_addSearch(this, "fs/fsc:FSC_UPJANG_HALL_CORNER_S001");								// 조회 
	http.Sync = true;
    fsp_callService(this, actionName, cmdName, inData, outData, otherArg, callBackFnc);		// 서비스 호출 
	http.Sync = false;
	

}

//조회 후 이벤트
function fn_CornerSearch_After(errCode, errMsg)
{
	if(errCode!=0)
	{
		g_Message("EE",	"서비스 오류:시스템 관리자에게 문의하십시오");
		return;
	}
	
	// 초기값 셋팅
	cbo_upjang_hall_corner.index = 0;	

}


/////////////////////////
/// 칼로리 보이기
////////////////////////
function chk_SHOW_CAL_OnClick(obj:CheckBox, e:ClickEventInfo)
{
	 //그리드 모양 바꾸기
//    if(obj.isChecked()==1)
//    { 
//  //	grd_list_Pivot.formatid="B";
//  //	ds_list_pivot.keystring = "MEAL:MEAL_NAME:CORNER:CORNER_NAME,RECIPE_INFO";
//    }
//    else
//    { 
//  //   grd_list_Pivot.formatid="Default";
//  //	ds_list_pivot.keystring = "MEAL:MEAL_NAME:CORNER:CORNER_NAME:RECIPE_INFO";
//    }
 
     fn_crossTab(ds_list,grd_list_Pivot);

}


/////////////////////
//식단표 엑셀 출력
/////////////////////
// function grd_list_Pivot_OnHeadClick(obj:Grid, e:GridClickEventInfo)
// {
// 	if (obj.getCellProperty("head",e.cell,"backgroundimage") == "ico_Excel"){
// 		gfn_exportExcel(obj, this.titletext);
// 	}
// }

function form_OnKeyDown(obj:Form, e:KeyEventInfo)
{
	// Ctrl + C 기능을 위해 Ctrl + C기능을 제회한 function 별도로 구현한다.
	fn_formKeyDown(obj, e); //(obj,e.fromreferenceobject,e.keycode,e.shiftKey,e.ctrlKey,e.altKey,-1,-1);
	//gfn_formKeyDown(obj, e); //(obj,e.fromreferenceobject,e.keycode,e.shiftKey,e.ctrlKey,e.altKey,-1,-1);
	//입고예정일에서 엔터시 조회
	if ( (e.keycode == 13) && (e.fromreferenceobject == cal_END_DATE) ) fn_search();
}
 
function fn_crossTab(objDs,objGrid)
{

 	//Dataset생성
 	var objPivotHeadDs = fn_makeHeadDs(objDs);
	
   // trace(objPivotHeadDs.saveXML());
	
     var objPivotBodyDs = fn_makeBodyDs(objDs,objPivotHeadDs);
	 
   //  trace(objPivotBodyDs.saveCSV());
	
  	fn_crossTabGrid(objGrid,objDs,objPivotHeadDs,objPivotBodyDs);
}
 
 function fn_makeHeadDs(objDs)
{ 
	var sPivotHeadDs = objDs.name + "_PivotHead";
	var objPivotHeadDs;
	
	var sCurrDate = '';
	var sPrevDate = '';
	
	var dRow = 0;
	
	var dCnt = 0;
	
	var i = 0;
	
	if ( this.isValidObject(sPivotHeadDs) ) {
		objPivotHeadDs = eval(sPivotHeadDs); 
		
	} else {
		objPivotHeadDs = new Dataset();
		objPivotHeadDs.name = sPivotHeadDs;
		this.addChild(objPivotHeadDs.name,objPivotHeadDs);
	}
 
    
	// 초기화
	objPivotHeadDs.clear(); 
	
    dCnt = objDs.rowcount;
    
   
     
     ds_date.clearData(); 
     
     ds_date.clear();
    
    sPrevDate = '';
    sCurrDate = '';
    
    ds_date.addColumn("MENU_DATE", "STRING", 256);
	ds_date.addColumn("MENU_DAYS", "STRING", 256); 
	
    //trace('1xxxxxxxxxxxxxxxxxxxxxxxx1');
    //trace(ds_date.saveXML());
    //trace('1xxxxxxxxxxxxxxxxxxxxxxxx1');
	
	objDs.keystring = "S:MENU_CD+MENU_DATE+RECIPE_INFO";
    
    for(i=0;i<dCnt;i++){
        sCurrDate = objDs.getColumn(i,"MENU_DATE"); 
		
		if ( sPrevDate != sCurrDate)
		{
		    dRow = ds_date.addRow();
		    
		    ds_date.setColumn(dRow, "MENU_DATE", objDs.getColumn(i,"MENU_DATE"));
		    ds_date.setColumn(dRow, "MENU_DAYS", objDs.getColumn(i,"MENU_DAYS")); 
		}
		  
		sPrevDate = sCurrDate;
    }
    
    
    //trace('xxxxxxxxxxxxxxxxxxxxxxxx');
    //trace(ds_date.saveXML());
    //trace('xxxxxxxxxxxxxxxxxxxxxxxx');
      
	il_cnt = ds_date.rowcount;
 
    for(i=0;i<il_cnt;i++) {
         objPivotHeadDs.addColumn("MENU_NAME","STRING", 256);
	     objPivotHeadDs.addColumn("MENU_DATE"+ds_date.getColumn(i,"MENU_DATE"),"STRING", 256);
	     objPivotHeadDs.addColumn("KMENU_DATE"+ds_date.getColumn(i,"MENU_DATE"),"STRING", 256);
	     objPivotHeadDs.addColumn("KCAL"+ds_date.getColumn(i,"MENU_DATE"),"STRING", 256);
	     objPivotHeadDs.addColumn("TKCAL"+ds_date.getColumn(i,"MENU_DATE"),"STRING", 256); 
    }
     
    
    objPivotHeadDs.addRow();
    
    for(i=0;i<il_cnt;i++) {
         objPivotHeadDs.setColumn(0,"MENU_NAME", "");
         objPivotHeadDs.setColumn(0,"MENU_DATE"+ds_date.getColumn(i,"MENU_DATE"),gfn_subStr(ds_date.getColumn(i,"MENU_DATE"),6,2)+'일('+ ds_date.getColumn(i,"MENU_DAYS")  +')');
	     objPivotHeadDs.setColumn(0,"KMENU_DATE"+ds_date.getColumn(i,"MENU_DATE"),gfn_subStr(ds_date.getColumn(i,"MENU_DATE"),6,2)+'일');
	     objPivotHeadDs.setColumn(0,"KCAL"+ds_date.getColumn(i,"MENU_DATE"),'KCAL'); 
    } 
     
    //trace('1======================>');    
    //trace(objPivotHeadDs.saveXML());   
       
    
    objDs.filter();
    objDs.filter('');
       
    return objPivotHeadDs;
    
}

//Pivot Dataset생성
function fn_makeBodyDs(objDs,objPivotHeadDs)
{
	var sPivotDs = objDs.name + "_Pivot";
	var objPivotDs;
	if ( this.isValidObject(sPivotDs) ) {
		objPivotDs = eval(sPivotDs); 
	} else {
		objPivotDs = new Dataset();
		objPivotDs.name = sPivotDs;
		this.addChild(objPivotDs.name,objPivotDs);
	}
	
	objPivotDs.clear(); 
	
	//Pivot컬럼 추가
    for(i=0;i<il_cnt;i++) {
        objPivotDs.addColumn("MENU_NAME","STRING", 256);
		objPivotDs.addColumn("MENU_DATE"+ds_date.getColumn(i,"MENU_DATE")    ,"STRING", 256);
		objPivotDs.addColumn("KMENU_DATE"+ds_date.getColumn(i,"MENU_DATE"),"STRING", 256);
	    objPivotDs.addColumn("KCAL"+ds_date.getColumn(i,"MENU_DATE"),"BIGDECIMAL", 256); 
    } 
	
	//Data생성
	objDs.keystring = "S:MENU_DATE+MENU_CD+HALL_CD+MEAL+CORNER+RECIPE_INFO";
	var nRowCnt 	= objDs.rowcount;
	var sPreKey 	  = "";
	var sPreGroupKey  = "";
	var sCurrKey 	  = "";
	var sCurrGroupKey = "";
	var nAddRow;
	var nAddRow0;
	var nAddRow1;
	var nAddRow2;
	var nAddRow3;
    var nAddRow4;
    var nAddRow5;
	
	var nSum = 0;
	var i = 0;
	var j = 0;
	var k = 0;
	var l = 0;
	
	var x = 0;
	var y = 0;
	var z = 0;
	
	var nMaxCnt   = 0;
	var nDate_seq = 0;
	var nCol_seq  = 0;
	var nTot_seq  = 0;
	
	var sCurrMenuCd = '';
	var sPrevMenuCd = ''; 
	
	var sCurrMenuDate = '';
	var sPrevMenuDate = ''; 
	
	var nMaxMenuCd = 0; 
	
	var nMaxMeal = 0;
	
	var il_idx = 0;
	
	var nRow = 0;
	var nIdx = 0;
	
	var rKcal = 0;
	var tKcal = 0;
	
	objDs.keystring = "S:HALL_CD+MEAL+CORNER";
	
    ds_meal.clearData();
    
    sPrevMenuCd = '';
    sCurrMenuCd = '';
	     	
	for(i=0;i<nRowCnt;i++) {
	
	     sCurrMenuCd = objDs.getColumn(i,"HALL_CD") + objDs.getColumn(i,"MEAL") + objDs.getColumn(i,"CORNER");
	     //trace(sCurrMenuCd);
	     if(sPrevMenuCd != sCurrMenuCd) { 
	         l = ds_meal.addRow();
	         ds_meal.setColumn(l, "HMC", sCurrMenuCd); 
	         
	         var sMax =  "HALL_CD=="    + wrapQuote(objDs.getColumn(i,"HALL_CD"))
	                  +  " && MEAL=="   + wrapQuote(objDs.getColumn(i,"MEAL"))
	                  +  " && CORNER==" + wrapQuote(objDs.getColumn(i,"CORNER")) ;
	                  
	         var nMax = objDs.getCaseMax(sMax, "RECIPE_INFO");
	         //trace(nMax);
	         if(chk_SHOW_CAL.isChecked()==1) { 
	            ds_meal.setColumn(l, "CNT", nMax+1);
	         } else {
	            ds_meal.setColumn(l, "CNT", nMax);
	         } 
	         
	         ds_meal.setColumn(l, "ROW", nRow);
	         
	         nRow+=1;
	     }
	
	     sPrevMenuCd = sCurrMenuCd;
	}
	
// 	trace(ds_meal.saveXML());
// 	
// 	trace('ds_meal.rowcount => ' + ds_meal.rowcount);
// 	
	nMaxMeal = ds_meal.rowcount;
	
	for(il_idx=0;il_idx<nMaxMeal;il_idx++) {
	
	    //trace('i ==> ' + i);
	
	    objDs.filter();
	    objDs.filter("");
	    
	    var vfilter =  "HALL_CD=="    + wrapQuote(gfn_subStr(ds_meal.getColumn(il_idx,"HMC"),0,5))
	                +  " && MEAL=="   + wrapQuote(gfn_subStr(ds_meal.getColumn(il_idx,"HMC"),5,3))
	                +  " && CORNER==" + wrapQuote(gfn_subStr(ds_meal.getColumn(il_idx,"HMC"),8,3)) ;
 
	    objDs.filter(vfilter);
	    
	    ds_list_m.clear();
	    
	    ds_list_m.copyData(objDs,true);  
	
		ds_list_m.addColumn("DATE_SEQ", "BIGDECIMAL", 15);
		ds_list_m.addColumn("COL_SEQ", "BIGDECIMAL", 15);
		
		//max row * column * item ==> seq
		sPrevDate = '';
		sCurrDate = '';
		
		//Max Row 
		
		for(i=0;i<ds_list_m.rowcount;i++) { 
		
		    for(j=0;j<ds_date.rowcount;j++) {
		    
		        if(ds_list_m.getColumn(i, "MENU_DATE") == ds_date.getColumn(j, "MENU_DATE")) {
		        
		            ds_list_m.setColumn(i, "DATE_SEQ", j);	        
		        }	    
		    }
		}
		
		for(i=0;i<ds_list_m.rowcount;i++) { 
		
	        sCurrDate = ds_list_m.getColumn(i,"MENU_DATE"); 
			
			if ( sPrevDate != sCurrDate)
			{
			 
			   k=0;
			   
			   ds_list_m.setColumn(i, "COL_SEQ", k);	
			     
			} else {
			   k+=1;
			   
			   ds_list_m.setColumn(i, "COL_SEQ", k);
			}
			  
			sPrevDate = sCurrDate;
		}
		  
	 //   trace(ds_list_m.saveXML());
	    
	    nMaxCnt = ds_list_m.getMax("COL_SEQ") + 1; 
	    
        nIdx = ds_meal.getColumn(il_idx,"CNT");
	      
		for(j=0;j<nIdx;j++){
		   objPivotDs.addRow();
		}
     
        ds_list_m.keystring = "S:MENU_CD+RECIPE_INFO";
        
        tKcal = 0;
        rKcal = 0;
        
	    for(i=0;i<ds_list_m.rowcount;i++){
	    
	       x = ds_list_m.getColumn(i,"DATE_SEQ");
	       y = ds_list_m.getColumn(i,"COL_SEQ");
	       
	       sCurrMenuCd = objDs.getColumn(i,"HALL_CD") + objDs.getColumn(i,"MEAL") + objDs.getColumn(i,"CORNER");
	       
	       k = ds_meal.findRow("HMC", sCurrMenuCd);
	       
// 	       trace('----------------->');
// 	       trace(ds_meal.getColumn(k,"CNT"));
// 	       trace(ds_meal.getColumn(k,"ROW"));
// 	       trace('<---------------->'); 
// 	       
	       nIdx = ds_meal.getColumn(k,"CNT");
	       nRow = ds_meal.getColumn(k,"ROW");
	       
	       if(nRow==0) {
	       
	          z = y;
	          
	          j = ds_meal.getColumn(k,"CNT") - 1;
	         
	       } else if(nRow == 1) { 
	            z = ds_meal.getColumn(k-1,"CNT") + ds_list_m.getColumn(i,"RECIPE_INFO") - 1;
	            
	            j = ds_meal.getColumn(k-1,"CNT") + ds_meal.getColumn(k,"CNT") - 1;
	            
	       } else if(nRow == 2) {
	            z = ds_meal.getColumn(k-2,"CNT") + ds_meal.getColumn(k-1,"CNT") + ds_list_m.getColumn(i,"RECIPE_INFO") - 1;
	            j = ds_meal.getColumn(k-2,"CNT") + ds_meal.getColumn(k-1,"CNT") + ds_meal.getColumn(k,"CNT") - 1;
	       } 
	         
		   objPivotDs.setColumn(z, "MENU_NAME", ds_list_m.getColumn(i, "MEAL_NAME")+ds_list_m.getColumn(i, "CORNER_NAME")); 
		   objPivotDs.setColumn(z, "MENU_DATE"+ds_date.getColumn(x,"MENU_DATE"), ds_list_m.getColumn(i, "RECIPE_NAME"));   
		   objPivotDs.setColumn(z, "KMENU_DATE"+ds_date.getColumn(x,"MENU_DATE"), ds_list_m.getColumn(i, "RECIPE_NAME"));
		   objPivotDs.setColumn(z, "KCAL"+ds_date.getColumn(x,"MENU_DATE"), ds_list_m.getColumn(i, "RECIPE_CAL"));
		   
		   if(chk_SHOW_CAL.isChecked()==1) { 
		   
			   objPivotDs.setColumn(j, "MENU_NAME", ds_list_m.getColumn(i, "MEAL_NAME")+ds_list_m.getColumn(i, "CORNER_NAME")); 
			   objPivotDs.setColumn(j, "MENU_DATE"+ds_date.getColumn(x,"MENU_DATE"), "*열량합계");   
			   objPivotDs.setColumn(j, "KMENU_DATE"+ds_date.getColumn(x,"MENU_DATE"), "*열량합계");
				
				rKcal =  gfn_nvl(ds_list_m.getColumn(i, "RECIPE_CAL"),0);
				tKcal =  gfn_nvl(objPivotDs.getColumn(j, "KCAL"+ds_date.getColumn(x,"MENU_DATE")),0);
				
				tKcal = tKcal + rKcal;
				
				objPivotDs.setColumn(j, "KCAL"+ds_date.getColumn(x,"MENU_DATE"), tKcal);
			}
 
	    }
	    
    }
    
    // trace('2======================>');    
    //trace(objPivotDs.saveXML()); 
    
    objDs.filter();
    objDs.filter('');
    
	return objPivotDs;
}

//Pivot 그리드포맷생성
function fn_crossTabGrid(objGrid,objDs,objPivotHeadDs,objPivotBodyDs)
{
	// GRID 작성
	var Contents_grd_lst	 = "";
	var Contents_grd_column  = "";
	var Contents_grd_rows    = "";
	var Contents_grd_head    = "";
	var Contents_grd_body    = "";
	var Contents_grd_summary = ""; 
	// 
	// Grid를 작성합니다.
	//
	
	 //trace(objPivotHeadDs.saveXML()); 
	 
	 // trace(objPivotBodyDs.saveXML()); 
	
	 Contents_grd_lst	 = "";
	 Contents_grd_column  = "";
	 Contents_grd_rows    = "";
	 Contents_grd_head    = "";
	 Contents_grd_body    = "";
	 Contents_grd_summary = ""; 	
	
	Contents_grd_lst  = '<Formats>' + '\n';
	Contents_grd_lst  += '<Format id="Default">' + '\n';
	
	// Grid columns를 작성합니다.
	Contents_grd_column  = ' <Columns>' + '\n';
	
	
	//trace(ds_date.saveXML());
 
    il_cnt = ds_date.rowcount;
    
    Contents_grd_column  += ' <Column size="71" band="left" />' + '\n';
 
	for(var i=0;i<il_cnt;i++) {
         Contents_grd_column  += ' <Column size="120" />' + '\n';
         
      if(chk_SHOW_CAL.isChecked()==1) {   
         Contents_grd_column  += ' <Column size="60" />' + '\n';
      }
	} 

	Contents_grd_column  += ' </Columns>' + '\n';

	Contents_grd_rows = ' <Rows>' + '\n';
    Contents_grd_rows += ' <Row size="26" band="head" />' + '\n';
    Contents_grd_rows += ' <Row size="24" />' + '\n';
	Contents_grd_rows += ' </Rows>' + '\n';

	Contents_grd_head = ' <Band id="head">' + '\n';
	
	Contents_grd_head += ' <Cell displaytype="text" class="head_Excel"/>' + '\n';
   
	 if(chk_SHOW_CAL.isChecked()==1) {  
			v_col1 = -1;
			v_col2 = 0;
	 } else {
			v_col1 = 0;
			v_col2 = 0;
	 }
	 
  	 for(i=0;i<il_cnt;i++){
  	    
  	     if(chk_SHOW_CAL.isChecked()==1) {  
			 v_col1 = v_col1 + 2;
			 v_col2 = v_col1 + 1;
	     } else {
	         v_col1 = v_col1 + 1
	     }
  	   
  	   
  	   if(chk_SHOW_CAL.isChecked()==1) {     
           Contents_grd_head += ' <Cell col="' + v_col1 + '" text="' + objPivotHeadDs.getColumn(0,"KMENU_DATE"+ds_date.getColumn(i,"MENU_DATE")) + '"/>' + '\n'; 
           Contents_grd_head += ' <Cell col="' + v_col2 + '" text="' + objPivotHeadDs.getColumn(0,"KCAL"+ds_date.getColumn(i,"MENU_DATE")) + '"/>' + '\n'; 
       } else {
           Contents_grd_head += ' <Cell col="' + v_col1 + '" text="' + objPivotHeadDs.getColumn(0,"MENU_DATE"+ds_date.getColumn(i,"MENU_DATE")) + '"/>' + '\n';      
       }
    }
 
	Contents_grd_head += ' </Band>' + '\n';
	
 
	// 	  Grid body를 작성합니다.
	Contents_grd_body = ' <Band id="body">' + '\n';

    Contents_grd_body  += ' <Cell col="0" displaytype="text" style="color:white;color2:white;background:#566572;background2:#566572;align:center;" text="bind:MENU_NAME" suppress="1" suppressalign="middle"/>' + '\n';


	 if(chk_SHOW_CAL.isChecked()==1) {  
			v_col1 = -1;
			v_col2 = 0;
	 } else {
			v_col1 = 0;
			v_col2 = 0;
	 }
	 
  	for(i=0;i<il_cnt;i++){
  	    
  	     if(chk_SHOW_CAL.isChecked()==1) {  
			 v_col1 = v_col1 + 2;
			 v_col2 = v_col1 + 1;
	     } else {
	         v_col1 = v_col1 + 1
	     }
  	     
  	  if(chk_SHOW_CAL.isChecked()==1) {    
         Contents_grd_body += ' <Cell col="' + v_col1 + '" displaytype="text" edittype="normal" style="border:#566572;background:EXPR(iif(KMENU_DATE'+ds_date.getColumn(i,"MENU_DATE")+'&#32;==&#32;&quot;*열량합계&quot;,&apos;#FEFCC0&apos;&#32;,&apos;white&apos;));background2:EXPR(iif(KMENU_DATE'+ds_date.getColumn(i,"MENU_DATE")+'&#32;==&#32;&quot;*열량합계&quot;,&apos;#FEFCC0&apos;&#32;,&apos;white&apos;));align:left;" text="bind:KMENU_DATE' + ds_date.getColumn(i,"MENU_DATE") + '"/>' + '\n';
         Contents_grd_body += ' <Cell col="' + v_col2 + '" displaytype="number" edittype="normal" style="border:#566572;background:EXPR(iif(KMENU_DATE'+ds_date.getColumn(i,"MENU_DATE")+'&#32;==&#32;&quot;*열량합계&quot;,&apos;#FEFCC0&apos;&#32;,&apos;white&apos;));background2:EXPR(iif(KMENU_DATE'+ds_date.getColumn(i,"MENU_DATE")+'&#32;==&#32;&quot;*열량합계&quot;,&apos;#FEFCC0&apos;&#32;,&apos;white&apos;));align:right;" text="bind:KCAL' + ds_date.getColumn(i,"MENU_DATE") + '" mask="expr:iif(gfn_isNull(KCAL' + ds_date.getColumn(i,"MENU_DATE") + '),&apos;&apos;,&apos;#,###.##&apos;);"/>' + '\n';
      } else {
         Contents_grd_body += ' <Cell col="' + v_col1 + '" displaytype="text" edittype="normal" style="border:#566572;background:EXPR(iif(MENU_DATE'+ds_date.getColumn(i,"MENU_DATE")+'&#32;==&#32;&quot;*열량합계&quot;,&apos;#FEFCC0&apos;&#32;,&apos;white&apos;));background2:EXPR(iif(MENU_DATE'+ds_date.getColumn(i,"MENU_DATE")+'&#32;==&#32;&quot;*열량합계&quot;,&apos;#FEFCC0&apos;&#32;,&apos;white&apos;));align:left;" text="bind:MENU_DATE' + ds_date.getColumn(i,"MENU_DATE") + '"/>' + '\n';
      }
    }
	
	Contents_grd_body	+= ' </Band>' + '\n'; 
	
	
	
// // 	Contents_grd_summary += ' <Band id="summary">' + '\n';
// // 
// //     Contents_grd_summary += ' <Cell colspan="3" displaytype="text" style="align:center;" text="합계"/>' + '\n';
// //     Contents_grd_summary += ' <Cell col="3" displaytype="number" style="align:right;" expr="expr:getSum(&apos;garb_qty&apos;)" mask="#,##0.0"/>' + '\n';
// //     Contents_grd_summary += ' <Cell col="4" displaytype="number" style="align:right;" expr="expr:getSum(&apos;sale_qty&apos;)" mask="#,##0"/>' + '\n';
// //     Contents_grd_summary += ' <Cell col="5" displaytype="number" style="align:right;" expr="expr:iif(getSum(&apos;sale_qty&apos;)==0,0,Math.round(1000*getSum(&apos;garb_qty&apos;)/getSum(&apos;sale_qty&apos;),0))" mask="#,##0"/>' + '\n';
//     
//     var v_col1 = 3;
//     var v_col2 = 0;
//     var v_col3 = 0;
//     var v_col4 = 0;
//     
// 	for(var j = 0; j < il_cnt; j++) { 
// 	    
// 	    v_col1 += 3;
// 	    v_col2 = v_col1 + 0;
// 	    v_col3 = v_col1 + 1;
// 	    v_col4 = v_col1 + 2;
// 	    
// 		Contents_grd_summary += ' <Cell col="' + v_col2 + '" displaytype="number" style="align:right;" expr="expr:getSum(&apos;garb_qty' + j + '&apos;)" mask="#,##0.0"/>' + '\n';
//         Contents_grd_summary += ' <Cell col="' + v_col3 + '" displaytype="number" style="align:tighy;" expr="expr:getSum(&apos;sale_qty' + j + '&apos;)" mask="#,##0"/>' + '\n';
//         Contents_grd_summary += ' <Cell col="' + v_col4 + '" displaytype="number" style="align:right;" expr="expr:iif(getSum(&apos;sale_qty' + j +'&apos;)==0,0,Math.round(1000*getSum(&apos;garb_qty' + j + '&apos;)/getSum(&apos;sale_qty' + j + '&apos;),0))" mask="#,##0"/>' + '\n';
// 	
// 	}
// 	
//     Contents_grd_summary += ' </Band>' + '\n';

  //  Contents_grd_lst += Contents_grd_column + Contents_grd_rows + Contents_grd_head + Contents_grd_body + Contents_grd_summary + '</Format>' + '\n' + '</Formats>';
 
    Contents_grd_lst += Contents_grd_column + Contents_grd_rows + Contents_grd_head + Contents_grd_body  + '</Format>' + '\n' + '</Formats>';
 
 // Contents_grd_lst += Contents_grd_column + Contents_grd_rows + Contents_grd_head +  '</Format>' + '\n' + '</Formats>';


    //Contents_grd_lst += Contents_grd_column + Contents_grd_rows + Contents_grd_head + '</Format>' + '\n' + '</Formats>';
 
    //trace(Contents_grd_lst);

	objGrid.enableredraw = false;	
	objGrid.formats      = Contents_grd_lst;
 	objGrid.formatid     = "Default"; 	
	objGrid.nodataimage  = gv_noData;	
	objGrid.binddataset  = objPivotBodyDs.name;
	//objGrid.autofittype   = "col";
	objGrid.scrollbars   = "autoboth";
	
	objGrid.enableredraw = true;
	
	objPivotBodyDs.rowposition = 0;
}

function grd_list_Pivot_onheadclick(obj:Grid, e:GridClickEventInfo)
{
	gfn_gridSort(obj, e); 
}

/*----------------------------------------------------------------------------------------------
 * 설명      : 공통적용 Key Event function을 Ctrl+C 기능을 제외하고 별도로 구현한다.
 *---------------------------------------------------------------------------------------------*/
function fn_formKeyDown(obj, e)
{
    var obj = getFocus();
    var componentType = gfn_getObjType(obj);
    var strCssclass = obj.class;					// CSS Class

    var objNextComponent = getNextComponent(obj);
    var nextComponentType = gfn_getObjType(objNextComponent);

    if(componentType == "Grid") {
        // Ctrl + P	: Grid 인쇄
        if (e.ctrlKey == true && e.keycode == 80) {
            application.alert("준비중입니다.");
        }
        // Ctrl + C	: Cell clipboard 복사
        else if(e.ctrlKey == true && e.keycode == 67) {
            // Grid Binddataset
			var strGrdDsNm = obj.binddataset;
			var v_clip = "";
			var strSeperate = "	";
			for (var i = obj.selectstartrow; i <= obj.selectendrow; i++) {
				for (var j = obj.selectstartcol; j <= obj.selectendcol; j++) {
					if (obj.getCellValue(i,j) == undefined) {
						v_clip += "";
					} else {
						if (j < obj.selectendcol) {
							v_clip += obj.getCellValue(i,j) + strSeperate;
						} else {
							v_clip += obj.getCellValue(i,j);
						}
					}
				}
				if (i < obj.selectendrow) {
					v_clip += "\r\n";
				}
			}
			v_clip += "\r\n";
			system.clearClipboard();
			system.setClipboard("CF_TEXT", v_clip);
        }
        // Ctrl + L	: Line clipboard 복사
        else if(e.ctrlKey == true && e.keycode == 76) {
            var v_clip = "";
            for ( var i = 0; i < obj.getCellCount("Body"); i++ ) {
                v_clip += ", " + obj.getCellText(obj.currentrow, i);
            }
            system.clearClipboard();
            system.setClipboard("CF_TEXT",gfn_subStr(v_clip,2));
        }
        // Ctrl + A	: 전체 clipboard 복사
        else if(e.ctrlKey == true && e.keycode == 65) {
            system.clearClipboard();
            system.setClipboard("CF_TEXT",obj.getCsvData(false));
        }
        // Ctrl + V	: Paste
        else if(e.ctrlKey == true && e.keycode == 86) {
            gfn_gridPaste(obj, e);
        }
        // Ctrl + E	: 엑셀 다운로드
        else if(e.ctrlKey == true && e.keycode == 69) {
            gfn_exportExcel(obj);
        }
        // Ctrl + M	: Multi Sort
        else if(e.ctrlKey == true && e.keycode == 77) {
            gfn_gridMultiSort(obj);
        }
        // Ctrl + F	: Find
        else if(e.ctrlKey == true && e.keycode == 70) {
            gfn_gridFind(this, obj);
        }
        // Ctrl + T	: Filter
        else if(e.ctrlKey == true && e.keycode == 84) {
            gfn_gridFilter(this, obj);
        }
        // Enter 키
        else if(e.keycode == 13) {
            var bSuccess = obj.moveToNextCell();	// 수정이 가능한 다음 셀로 이동
            if(!bSuccess) objNextComponent.setFocus();	// 수정이 가능한 다음 셀 없을때 Next Comp로 이동
        }
    }

    // Enter 키
    if(e.keycode == 13 && componentType != "Grid") {
        // 현재 Component 기준
        if(componentType == "TextArea") {
            return;
        }
        else if(componentType == "Tab") {
            var objTemp = obj.components[tabindex];
            objTemp.setFocus();
        }
        // Next Component 기준
        else if(nextComponentType == "Tab") {		// Tab은 필요할지 확인 필요
            var objTemp = objNextComponent.components[objNextComponent.tabindex];
            objTemp.setFocus();
        }
        else if(nextComponentType == "Combo") {
            objNextComponent.setFocus();
            objNextComponent.dropdown();
        }
        else {
            objNextComponent.setFocus();
        }
    }

    // 팝업에서 ESC 키 시 창닫기
    var objOpener = opener;
    if(e.keycode == 27 && gfn_isNull(objOpener) == false) {
        this.close();
    }
}]]></Script>
  </Form>
</FDL>
